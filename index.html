<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee Store - 学生作品展示平台</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-gradient: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            --glass-bg: rgba(255, 255, 255, 0.35);
            --glass-border: rgba(255, 255, 255, 0.25);
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(255, 255, 255, 0.4);
            --shadow-light: 0 8px 32px rgba(31, 38, 135, 0.37);
            --shadow-heavy: 0 15px 35px rgba(31, 38, 135, 0.5);
            --text-primary: #1a202c;
            --text-secondary: #2d3748;
            --border-radius: 20px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* 毛玻璃效果 */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 状态指示器 - 隐藏不显示给用户 */
        .status-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1002;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status-connected { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-syncing { background: #ff9500; color: white; }
        .status-local { background: #17a2b8; color: white; }
        .status-syncing { background: #ff9500; color: white; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* 头部样式 */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 500px;
        }

        .nav-stats {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .nav-slogan {
            font-size: 1rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }

        .nav-stat-item {
            text-align: center;
            color: var(--text-primary);
            min-width: 45px;
        }

        .nav-stat-item .number {
            font-size: 1.2rem;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
            line-height: 1.2;
        }

        .nav-stat-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            line-height: 1;
            margin-top: 0.1rem;
        }

        .logo {
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 2rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
            letter-spacing: -0.02em;
        }

        .logo:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .logo img {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            flex-shrink: 0;
        }

        .nav-search {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 0.4rem 0.8rem;
            transition: all 0.3s ease;
            min-width: 320px;
            max-width: 400px;
            width: 100%;
        }

        .nav-search:hover,
        .nav-search:focus-within {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .nav-search input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 0.9rem;
            padding: 0.25rem 0;
            outline: none;
        }

        .nav-search input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .nav-search-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-search .dropdown-trigger {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-search .dropdown-trigger:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--text-primary);
        }

        .nav-search .search-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            background: var(--primary-gradient);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-search .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        /* 主要内容区域 */
        .main-content {
            padding: 2rem 0; /* 增加顶部padding，因为删除了统计横幅 */
        }



        /* 移动端搜索栏样式 */
        .mobile-search-bar {
            padding: 0 1rem;
        }

        /* 桌面端布局 */
        .desktop-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        /* 移动端布局默认隐藏 */
        .mobile-layout {
            display: none;
        }

        .header-slogan {
            flex: 0 0 auto;
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            min-width: 200px;
        }

        .header-search {
            flex: 1;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            max-width: 600px;
        }

        .search-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            padding: 0;
            flex-shrink: 0;
            background: transparent !important;
            color: #ff9500 !important;
            border: none;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: rgba(255, 149, 0, 0.1) !important;
            transform: none;
            box-shadow: none;
        }

        .header-search .search-input {
            height: 40px;
            padding: 0 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 0;
            flex: 1;
        }

        .header-search .search-input:focus {
            outline: none;
            border-color: #ff9500;
        }

        .header-search .filter-select {
            height: 40px;
            padding: 0 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            box-sizing: border-box;
            background: white;
        }

        .header-search .filter-select:focus {
            outline: none;
            border-color: #ff9500;
        }

        /* 自定义下拉菜单样式 */
        .custom-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #ff9500;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .dropdown-trigger:hover {
            background: rgba(255, 149, 0, 0.1);
        }

        .dropdown-trigger.active {
            background: rgba(255, 149, 0, 0.15);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 120px;
            max-height: 250px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 149, 0, 0.1);
        }

        .dropdown-item.selected {
            background: rgba(255, 149, 0, 0.2);
            color: #ff6600;
            font-weight: 500;
        }

        .header-stats {
            flex: 0 0 auto;
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            min-width: 140px;
        }

        .stat-compact {
            text-align: center;
            color: #333;
        }

        .stat-compact .number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff9500;
            display: block;
        }

        .stat-compact .label {
            font-size: 0.8rem;
            color: #666;
        }

        /* 应用网格 */
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 0;
            padding: 1rem 0;
        }

        .app-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .app-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .app-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-heavy);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .app-card:hover::before {
            opacity: 0.03;
        }

        .app-screenshot {
            width: 100%;
            height: 140px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            overflow: hidden;
            position: relative;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .app-screenshot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .app-card:hover .app-screenshot::before {
            transform: translateX(100%);
        }

        .app-screenshot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-screenshot .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }

        .app-info h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.01em;
            line-height: 1.3;
            filter: drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9));
        }

        /* 产品描述展开功能 */
        .app-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            position: relative;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .app-description.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .app-description.collapsed.has-overflow::after {
            content: '...展开';
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(to right, transparent, white 30%, white);
            color: #ff9500;
            font-size: 0.85rem;
            padding-left: 20px;
            text-decoration: underline;
            pointer-events: auto;
            z-index: 2;
        }

        .app-description.collapsed.has-overflow::after:hover {
            color: #ff6600;
        }

        .app-description.expanded {
            display: block;
        }

        .description-toggle {
            color: #ff9500;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            margin-top: 0.25rem;
            text-decoration: underline;
        }

        .description-toggle:hover {
            color: #ff6600;
        }

        .app-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.7);
        }

        .app-stats {
            display: flex;
            gap: 1rem;
        }

        .app-url {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0;
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            background: var(--primary-gradient);
            color: white;
            transition: all 0.3s ease;
            font-weight: 600;
            vertical-align: middle;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .app-url:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
            filter: brightness(1.1);
        }

        .app-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .app-action-btn {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .app-action-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .app-action-btn.edit-btn {
            background: rgba(0, 123, 255, 0.9);
        }
        
        .app-action-btn.edit-btn:hover {
            background: #007bff;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 520px;
            box-shadow: var(--shadow-heavy);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        /* 截图方式行 */
        .capture-method-row {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin: 0.75rem 0 1rem;
        }

        .capture-method-row label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: normal;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff9500, #ff6600);
            color: #fff;
            border: none;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(255, 149, 0, 0.4);
        }

        .btn-secondary {
            border: 1px solid #ff9500;
            color: #ff9500;
            background: #fff;
        }

        .btn-secondary:hover {
            background: #ff9500;
            color: #fff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        /* 发布应用按钮 */
        .publish-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: var(--secondary-gradient);
            color: white;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(240, 147, 251, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .publish-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 40px rgba(240, 147, 251, 0.6);
            border-radius: 50%;
        }

        .publish-btn:active {
            transform: scale(0.95) rotate(90deg);
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
        }

        .empty-state p {
            color: #666;
            font-size: 1.1rem;
        }

        /* 用户信息 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #333;
        }

        /* 应用互动按钮 */
        .app-interactions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem 0;
            border-top: 1px solid #f0f0f0;
        }

        .interaction-group {
            display: flex;
            gap: 1rem;
        }

        .interaction-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: #666;
            transition: color 0.3s ease;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .interaction-btn:hover {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }

        .interaction-btn.active {
            color: #ff9500;
        }

        .interaction-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .interaction-btn:disabled:hover {
            color: #666;
            background: none;
        }

        /* 评论区域 */
        .comments-section {
            margin-top: 1rem;
            border-top: 1px solid #f0f0f0;
            padding-top: 1rem;
        }

        .comment-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #666;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
        }

        .comment-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .comment-delete {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem;
        }

        .comment-delete:hover {
            color: #c82333;
        }

        .comment-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .comment-input input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .comment-input button {
            padding: 0.5rem 1rem;
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .comment-input button:hover {
            background: #ff6600;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9500, #ff6600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 截图预览 */
        .screenshot-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .screenshot-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff9500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 页面加载动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* 应用加载动画到卡片 */
        .app-card {
            animation: fadeInUp 0.6s ease forwards;
        }

        .app-card:nth-child(1) { animation-delay: 0.1s; }
        .app-card:nth-child(2) { animation-delay: 0.2s; }
        .app-card:nth-child(3) { animation-delay: 0.3s; }
        .app-card:nth-child(4) { animation-delay: 0.4s; }
        .app-card:nth-child(5) { animation-delay: 0.5s; }
        .app-card:nth-child(6) { animation-delay: 0.6s; }

        /* 头部动画 */
        .header-integrated {
            animation: fadeInScale 0.8s ease forwards;
        }

        /* 加载时的闪烁效果 */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* 日志选项卡样式 */
        .log-tab {
            transition: all 0.3s ease;
            color: #666;
        }

        .log-tab:hover {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }

        .log-tab.active {
            color: #ff9500;
            border-bottom-color: #ff9500 !important;
            background: rgba(255, 149, 0, 0.05);
        }

        /* 搜索功能 */
        .search-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* 统计信息 */
        .stats-section {
            background: linear-gradient(135deg, #ff9500 0%, #ff6600 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: white;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-item p {
            opacity: 0.8;
        }

        /* 汉堡菜单样式 */
        .hamburger-menu {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 0.5rem;
            gap: 0.3rem;
        }

        .hamburger-line {
            width: 24px;
            height: 3px;
            background-color: #ff9500;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
        }

        .mobile-nav-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 2rem 1.5rem;
        }

        .mobile-nav-menu.active {
            right: 0;
        }

        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .mobile-nav-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9500;
        }

        .mobile-nav-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.25rem;
        }

        .mobile-nav-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mobile-nav-item {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .mobile-nav-item:hover {
            background: #ff9500;
            color: white;
            border-color: #ff9500;
        }

        .mobile-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .apps-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
                padding: 2rem;
            }
            
            .app-card {
                padding: 1.25rem;
            }
            
            .app-screenshot {
                height: 130px;
            }
            
            .nav-center {
                display: none;
            }
            
            .nav-stats {
                display: none;
            }
            
            .nav-buttons {
                display: none;
            }
            
            .mobile-search-bar {
                display: block !important;
            }

            .nav {
                justify-content: center;
            }

            .logo {
                margin: 0 auto;
            }

            .hamburger-menu {
                display: flex;
            }

            /* 头部整合响应式 */
            .header-integrated {
                padding: 0.75rem 1rem;
                margin-bottom: 1rem;
            }

            /* 移动端：隐藏桌面布局，显示移动布局 */
            .desktop-layout {
                display: none;
            }

            .mobile-layout {
                display: block;
            }

            /* 移动端第一行：标题和搜索框 */
            .mobile-header-row {
                display: flex;
                align-items: flex-end;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
                padding-top: 0.25rem;
            }

            .mobile-header-row .header-slogan {
                flex: 0 0 auto;
                font-size: 0.9rem;
                font-weight: 600;
                white-space: nowrap;
                line-height: 36px;
                align-self: center;
            }

            .mobile-header-row .search-input {
                flex: 1;
                min-width: 0;
                height: 36px;
                font-size: 0.9rem;
                padding: 0 0.5rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                box-sizing: border-box;
                margin-top: 0.25rem;
            }

            .mobile-header-row .search-input:focus {
                outline: none;
                border-color: #ff9500;
            }

            /* 移动端第二行：筛选器和搜索按钮 */
            .mobile-filters-row {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .mobile-filters-row .filter-select {
                height: 36px;
                font-size: 0.85rem;
                flex: 1;
                padding: 0 0.5rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                box-sizing: border-box;
                background: white;
            }

            .mobile-filters-row .filter-select:focus {
                outline: none;
                border-color: #ff9500;
            }

            .mobile-filters-row .search-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
                flex-shrink: 0;
            }

            /* 移动端自定义下拉菜单 */
            .mobile-filters-row .custom-dropdown {
                flex: 1;
            }

            .mobile-filters-row .dropdown-trigger {
                width: 100%;
                height: 36px;
                font-size: 1rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                background: white;
            }

            .mobile-filters-row .dropdown-trigger:hover {
                border-color: #ff9500;
                background: rgba(255, 149, 0, 0.05);
            }

            .mobile-filters-row .dropdown-trigger.active {
                border-color: #ff9500;
                background: rgba(255, 149, 0, 0.1);
            }

            .mobile-filters-row .dropdown-menu {
                min-width: 100%;
            }

            .interaction-group {
                gap: 0.5rem;
            }

            .interaction-btn {
                font-size: 0.8rem;
                padding: 0.2rem 0.4rem;
            }

            .comment-input {
                flex-direction: column;
                gap: 0.5rem;
            }

            .comment-input input {
                margin-bottom: 0;
            }



            .stats-row {
                flex-direction: column;
                gap: 1rem;
            }

            .logo {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 768px) {
            .apps-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 0.5rem 0;
            }
            
            .modal-content {
                width: 95%;
                margin: 0;
                padding: 1.5rem;
                transform: translate(-50%, -50%);
                border-radius: 16px;
            }

            body.no-scroll {
                overflow: hidden;
            }

            .app-card {
                padding: 1.25rem;
                border-radius: 14px;
            }
            
            .app-screenshot {
                height: 120px;
                border-radius: 10px;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .publish-btn {
                width: 60px;
                height: 60px;
                bottom: 1.5rem;
                right: 1.5rem;
            }

            /* 进一步减少移动端的间距 */
            .main-content {
                padding: 0.5rem 0;
            }

            .header-integrated {
                margin-bottom: 1rem;
                padding: 1.5rem;
                border-radius: 16px;
            }
        }
    </style>
</head>
<body>


    <div class="header">
        <div class="container">
            <nav class="nav">
                <a href="#" class="logo">
                    <img src="logo.png" alt="Bee Store Logo">
                    <span>Bee Store</span>
                </a>
                
                <div class="nav-center">
                    <div class="nav-search">
                        <input type="text" id="nav-search-input" placeholder="搜索作品名称、描述、创作者...">
                        <div class="nav-search-controls">
                            <!-- 分类下拉菜单 -->
                            <div class="custom-dropdown">
                                <button class="dropdown-trigger" id="nav-category-trigger" onclick="toggleDropdown('nav-category')" title="分类筛选">
                                    🏷️
                                </button>
                                <div class="dropdown-menu" id="nav-category-dropdown">
                                    <div class="dropdown-item selected" data-value="">全部分类</div>
                                    <div class="dropdown-item" data-value="工具">🔧 工具</div>
                                    <div class="dropdown-item" data-value="学习">📚 学习</div>
                                    <div class="dropdown-item" data-value="游戏">🎮 游戏</div>
                                    <div class="dropdown-item" data-value="艺术">🎨 艺术</div>
                                    <div class="dropdown-item" data-value="科技">💻 科技</div>
                                </div>
                            </div>
                            
                            <!-- 排序下拉菜单 -->
                            <div class="custom-dropdown">
                                <button class="dropdown-trigger" id="nav-sort-trigger" onclick="toggleDropdown('nav-sort')" title="排序方式">
                                    🔄
                                </button>
                                <div class="dropdown-menu" id="nav-sort-dropdown">
                                    <div class="dropdown-item selected" data-value="newest">最新发布</div>
                                    <div class="dropdown-item" data-value="oldest">最早发布</div>
                                    <div class="dropdown-item" data-value="name">按名称</div>
                                    <div class="dropdown-item" data-value="author">按作者</div>
                                </div>
                            </div>
                            
                            <button class="search-btn" onclick="searchApps()">🔍</button>
                        </div>
                    </div>
                </div>
                
                <div class="nav-stats">
    
                    <div class="nav-stat-item">
                        <span class="number" id="nav-total-apps">0</span>
                        <span class="label">作品总数</span>
                    </div>
                    <div class="nav-stat-item">
                        <span class="number" id="nav-total-users">0</span>
                        <span class="label">创作者</span>
                    </div>
                </div>
                
                <div class="nav-buttons">
                    <div id="guest-nav" style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="showLogin()">登录</button>
                        <button class="btn btn-primary" onclick="showRegister()">注册</button>
                    </div>
                    <div id="user-nav" style="display: none; align-items: center; gap: 1rem;">
                        <div class="user-info">
                            <div class="user-avatar" id="user-avatar"></div>
                            <span id="user-name"></span>
                        </div>
                        <button class="btn btn-secondary" onclick="goHome()">首页</button>
                        <button class="btn btn-secondary" onclick="showMyApps()">我的应用</button>
                        <button class="btn btn-secondary" onclick="showMyFavorites()">我的收藏</button>
                        <button class="btn btn-secondary" onclick="showLogViewer()" style="display: none;" id="log-viewer-btn">查看日志</button>
                        <button class="btn btn-secondary" onclick="showSnapshotViewer()" style="display: none;" id="snapshot-viewer-btn">数据快照</button>
                        <button class="btn btn-secondary" onclick="logout()">退出</button>
                    </div>
                </div>
                
                <!-- 汉堡菜单按钮 -->
                <div class="hamburger-menu" id="hamburger-menu" onclick="toggleMobileMenu()">
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                </div>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- 移动端搜索功能 -->
            <div class="mobile-search-bar" style="display: none;">
                <div class="nav-search" style="min-width: auto; width: 100%; margin-bottom: 1.5rem;">
                    <input type="text" id="mobile-search-input" placeholder="搜索作品名称、描述、创作者...">
                    <div class="nav-search-controls">
                        <!-- 分类下拉菜单 -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="mobile-category-trigger" onclick="toggleDropdown('mobile-category')" title="分类筛选">
                                🏷️
                            </button>
                            <div class="dropdown-menu" id="mobile-category-dropdown">
                                <div class="dropdown-item selected" data-value="">全部分类</div>
                                <div class="dropdown-item" data-value="工具">🔧 工具</div>
                                <div class="dropdown-item" data-value="学习">📚 学习</div>
                                <div class="dropdown-item" data-value="游戏">🎮 游戏</div>
                                <div class="dropdown-item" data-value="艺术">🎨 艺术</div>
                                <div class="dropdown-item" data-value="科技">💻 科技</div>
                            </div>
                        </div>
                        
                        <!-- 排序下拉菜单 -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="mobile-sort-trigger" onclick="toggleDropdown('mobile-sort')" title="排序方式">
                                🔄
                            </button>
                            <div class="dropdown-menu" id="mobile-sort-dropdown">
                                <div class="dropdown-item selected" data-value="newest">最新发布</div>
                                <div class="dropdown-item" data-value="oldest">最早发布</div>
                                <div class="dropdown-item" data-value="name">按名称</div>
                                <div class="dropdown-item" data-value="author">按作者</div>
                            </div>
                        </div>
                        
                        <button class="search-btn" onclick="searchApps()">🔍</button>
                    </div>
                </div>
            </div>
            
            <div id="apps-container">
                <div class="apps-grid" id="apps-grid">
                    <!-- 应用卡片将在这里动态加载 -->
                </div>
                
                <div class="empty-state" id="empty-state" style="display: none;">
                    <h3>暂无作品</h3>
                    <p>来展示你的第一个作品吧！</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 发布/编辑应用按钮 -->
    <button class="publish-btn" id="publish-btn" onclick="showPublishModal()" style="display: none;" title="发布应用">+</button>

    <!-- 移动端菜单 -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-nav-menu" id="mobile-nav-menu">
        <div class="mobile-nav-header">
            <div class="mobile-nav-title">菜单</div>
            <button class="mobile-nav-close" onclick="closeMobileMenu()">&times;</button>
        </div>
        
        <!-- 未登录状态菜单 -->
        <div id="mobile-guest-nav" style="display: none;">
            <div class="mobile-nav-items">
                <button class="mobile-nav-item" onclick="showLogin(); closeMobileMenu();">
                    👤 登录
                </button>
                <button class="mobile-nav-item" onclick="showRegister(); closeMobileMenu();">
                    ➕ 注册
                </button>
            </div>
        </div>
        
        <!-- 已登录状态菜单 -->
        <div id="mobile-user-nav" style="display: none;">
            <div class="mobile-user-info">
                <div class="user-avatar" id="mobile-user-avatar"></div>
                <span id="mobile-user-name"></span>
            </div>
            <div class="mobile-nav-items">
                <button class="mobile-nav-item" onclick="goHome(); closeMobileMenu();">
                    首页
                </button>
                <button class="mobile-nav-item" onclick="showPublishModal(); closeMobileMenu();" style="background: linear-gradient(45deg, #ff9500, #ff6600); color: white; border-color: #ff9500;">
                    发布作品
                </button>
                <button class="mobile-nav-item" onclick="showMyApps(); closeMobileMenu();">
                    我的应用
                </button>
                <button class="mobile-nav-item" onclick="showMyFavorites(); closeMobileMenu();">
                    我的收藏
                </button>
                <button class="mobile-nav-item" onclick="showLogViewer(); closeMobileMenu();" style="display: none;" id="mobile-log-viewer-btn">
                    查看日志
                </button>
                <button class="mobile-nav-item" onclick="showSnapshotViewer(); closeMobileMenu();" style="display: none;" id="mobile-snapshot-viewer-btn">
                    数据快照
                </button>
                <button class="mobile-nav-item" onclick="logout(); closeMobileMenu();">
                    退出登录
                </button>
            </div>
        </div>
    </div>

    <!-- 发布/编辑应用模态框 -->
    <div class="modal" id="publish-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="publish-modal-title">发布作品</h2>
                <button class="close-btn" onclick="closeModal('publish-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="app-name">作品名称 *</label>
                    <input type="text" id="app-name" placeholder="给你的作品起个名字" onchange="updatePublishButtonState()" oninput="updatePublishButtonState()">
                </div>
                <div class="form-group">
                    <label for="app-url">作品链接 *</label>
                    <input type="url" id="app-url" placeholder="https://example.com" onchange="updatePublishButtonState()" oninput="updatePublishButtonState()">
                </div>
                <div class="form-group">
                    <label for="app-description">作品描述 *</label>
                    <textarea id="app-description" placeholder="介绍一下你的作品，比如创作灵感、主要功能等..." onchange="updatePublishButtonState()" oninput="updatePublishButtonState()"></textarea>
                </div>
                <div class="form-group">
                    <label for="app-category">分类</label>
                    <select id="app-category">
                        <option value="其他">其他</option>
                        <option value="工具">工具</option>
                        <option value="学习">学习</option>
                        <option value="游戏">游戏</option>
                        <option value="艺术">艺术</option>
                        <option value="科技">科技</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>应用截图</label>
                    <div class="screenshot-preview" id="screenshot-preview">
                        <div class="placeholder">
                            <div style="font-size: 2rem;">📸</div>
                            <div>选择截图方式</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <div style="margin-bottom: 0.5rem;">
                            <label style="font-weight: normal; font-size: 0.9rem;">截图方式：</label>
                        </div>
                        <div class="capture-method-row">
                            <label>
                                <input type="radio" name="screenshot-method" value="api" checked onchange="toggleScreenshotMethod()">
                                <span>自动生成截图</span>
                            </label>
                            <label>
                                <input type="radio" name="screenshot-method" value="upload" onchange="toggleScreenshotMethod()">
                                <span>上传本地图片</span>
                            </label>
                        </div>
                        <div id="screenshot-api-section" style="display: block;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="generateScreenshot()">
                                    生成网页截图
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearScreenshot()" style="background: #dc3545; color: white;">
                                    清除截图
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                根据应用链接自动生成网页截图
                            </div>
                        </div>
                        <div id="screenshot-upload-section" style="display: none;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('screenshot-upload').click()">
                                    上传图片文件
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearScreenshot()" style="background: #dc3545; color: white;">
                                    清除截图
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                支持 JPG、PNG、GIF 格式，最大 5MB
                            </div>
                        </div>
                    </div>
                    <input type="file" id="screenshot-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('publish-modal')">取消</button>
                    <button type="button" class="btn btn-primary" id="save-app-btn" onclick="handleSaveApp()">发布</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">用户登录</h2>
                <button class="close-btn" onclick="closeModal('login-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="login-username">用户名</label>
                    <input type="text" id="login-username" placeholder="输入用户名">
                </div>
                <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" placeholder="输入密码">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('login-modal')">取消</button>
                    <button type="button" class="btn btn-primary" onclick="handleLogin()">登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">用户注册</h2>
                <button class="close-btn" onclick="closeModal('register-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="register-username">用户名</label>
                    <input type="text" id="register-username" placeholder="输入用户名">
                </div>
                <div class="form-group">
                    <label for="register-email">邮箱</label>
                    <input type="email" id="register-email" placeholder="输入邮箱">
                </div>
                <div class="form-group">
                    <label for="register-password">密码</label>
                    <input type="password" id="register-password" placeholder="至少6个字符">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('register-modal')">取消</button>
                    <button type="button" class="btn btn-primary" onclick="handleRegister()">注册</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志查看模态框 -->
    <div class="modal" id="log-viewer-modal">
        <div class="modal-content" style="max-width: 800px; height: 80vh;">
            <div class="modal-header">
                <h2 class="modal-title">系统日志</h2>
                <button class="close-btn" onclick="closeModal('log-viewer-modal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(80vh - 120px);">
                <!-- 选项卡 -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
                    <div style="display: flex;">
                        <button id="local-logs-tab" class="log-tab active" onclick="switchLogTab('local')" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500;">
                            本地日志
                        </button>
                        <button id="cloud-logs-tab" class="log-tab" onclick="switchLogTab('cloud')" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500;">
                            云端日志
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; padding: 0.5rem;">
                        云端日志自动保留48小时
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
                    <select id="log-level-filter" onchange="refreshLogs()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">全部级别</option>
                        <option value="INFO">信息</option>
                        <option value="WARN">警告</option>
                        <option value="ERROR">错误</option>
                    </select>
                    <input type="text" id="log-username-filter" placeholder="按用户名筛选..." onchange="refreshLogs()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn btn-secondary" onclick="refreshLogs()">刷新</button>
                    <button class="btn btn-secondary" onclick="clearCurrentLogs()">清空日志</button>
                    <button class="btn btn-secondary" onclick="manualCleanup()" style="background: #28a745; color: white;">清理过期</button>
                    <button class="btn btn-secondary" onclick="exportLogs()">导出日志</button>
                    <button class="btn btn-secondary" onclick="retryFailedLogs()" style="background: #17a2b8; color: white;">重试失败</button>
                </div>
                <div id="log-content" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.9rem; background: #f8f9fa;">
                    <!-- 日志内容将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 快照查看模态框 -->
    <div class="modal" id="snapshot-viewer-modal">
        <div class="modal-content" style="max-width: 900px; height: 85vh;">
            <div class="modal-header">
                <h2 class="modal-title">数据快照管理</h2>
                <button class="close-btn" onclick="closeModal('snapshot-viewer-modal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(85vh - 120px);">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
                    <select id="snapshot-type-filter" onchange="refreshSnapshots()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">全部类型</option>
                        <option value="app_edit_before">应用编辑前</option>
                        <option value="app_delete_before">应用删除前</option>
                        <option value="apps_before_add">新应用发布前</option>
                        <option value="users_before_add">用户注册前</option>
                        <option value="full_before_sync">数据同步前</option>
                        <option value="local_before_merge">数据合并前(本地)</option>
                        <option value="remote_before_merge">数据合并前(远程)</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshSnapshots()">刷新快照</button>
                    <button class="btn btn-secondary" onclick="clearSnapshots()">清空快照</button>
                    <button class="btn btn-secondary" onclick="exportSnapshots()">导出快照</button>
                </div>
                <div id="snapshot-content" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; background: #f8f9fa;">
                    <!-- 快照内容将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 快照恢复确认模态框 -->
    <div class="modal" id="snapshot-restore-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">确认数据恢复</h2>
                <button class="close-btn" onclick="closeModal('snapshot-restore-modal')">&times;</button>
            </div>
            <div>
                <div id="restore-info" style="margin-bottom: 1.5rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                    <!-- 恢复信息将在这里显示 -->
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="restore-type" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">恢复范围：</label>
                    <select id="restore-type" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="full">完整恢复（应用+用户）</option>
                        <option value="apps">仅恢复应用数据</option>
                        <option value="users">仅恢复用户数据</option>
                    </select>
                </div>
                <div style="color: #dc3545; font-size: 0.9rem; margin-bottom: 1rem;">
                    ⚠️ 警告：此操作将覆盖当前数据，无法撤销！建议先创建当前数据的快照。
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('snapshot-restore-modal')">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmRestore()" style="background: #dc3545;">确认恢复</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 云存储配置 - 使用JSONBin免费服务
        const CLOUD_CONFIG = {
            // JSONBin配置
            binId: '', // 将在 Netlify 函数中设置
            apiKey: '', // 将在 Netlify 函数中设置
            baseUrl: 'https://api.jsonbin.io/v3/b'
        };

        // 全局变量
        let currentUser = null;
        let currentEditingAppId = null; // 用于跟踪正在编辑的应用ID
        let isScreenshotReady = false; // 跟踪截图/图片是否准备就绪
        let cloudData = {
            users: [],
            apps: [],
            lastSync: null
        };

        // 🔥 步骤20: 重试配置
        const RETRY_CONFIG = {
            maxRetries: 3,
            retryDelay: [1000, 2000, 5000], // 递增延迟
            operations: ['like', 'favorite', 'comment', 'sync']
        };

        // 云存储API类
        class CloudStorage {
            constructor() {
                this.baseUrl = '/.netlify/functions/jsonbin-proxy';
            }

            async saveData(data) {
                try {
                    const response = await fetch(this.baseUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('保存失败');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('保存到云端失败:', error);
                    throw error;
                }
            }

            async loadData() {
                try {
                    // 增加移动端的超时时间
                    const isMobile = navigator.userAgent.includes('Mobile');
                    const timeoutMs = isMobile ? 15000 : 10000; // 移动端15秒，桌面端10秒
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const response = await fetch(this.baseUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`加载失败`);
                    }
                    
                    const result = await response.json();
                    return result.record || { users: [], apps: [], lastSync: null };
                } catch (error) {
                    console.error('从云端加载失败:', error);
                    throw error;
                }
            }
        }

        const cloudStorage = new CloudStorage();

        // 🔥 步骤3&4: 本地存储管理器类
        class LocalStorageManager {
            constructor() {
                this.key = 'beestoreLocalBackup';
            }
            
            // 保存到本地存储
            saveToLocal(data) {
                try {
                    // 🔥 步骤16: 保存前确保数据完整性
                    const cleanData = ensureDataIntegrity(data);
                    const backup = {
                        data: cleanData,
                        timestamp: new Date().toISOString(),
                        version: '1.0'
                    };
                    localStorage.setItem(this.key, JSON.stringify(backup));
                    console.log('[BeeStore] 数据已保存到本地存储');
                    return true;
                } catch (error) {
                    console.error('[BeeStore] 本地存储失败:', error);
                    return false;
                }
            }
            
            // 从本地存储加载
            loadFromLocal() {
                try {
                    const backup = localStorage.getItem(this.key);
                    if (backup) {
                        const parsed = JSON.parse(backup);
                        // 🔥 步骤17: 加载时确保数据完整性
                        return ensureDataIntegrity(parsed.data);
                    }
                    return null;
                } catch (error) {
                    console.error('[BeeStore] 本地存储读取失败:', error);
                    return null;
                }
            }
            
            // 清空本地存储
            clearLocal() {
                localStorage.removeItem(this.key);
            }
        }

        const localStorageManager = new LocalStorageManager();

        // 🔥 步骤3: 数据版本控制函数
        function updateAppLastModified(appId, operationType) {
            const app = cloudData.apps.find(app => app.id === appId);
            if (app) {
                app.lastModified = new Date().toISOString();
                console.log(`[BeeStore] 更新应用 ${appId} 最后修改时间: ${operationType}`);
            }
        }
        
        // 🔥 步骤4: 用户数据版本控制函数
        function updateUserLastModified(userId, operationType) {
            const user = cloudData.users.find(user => user.id === userId);
            if (user) {
                user.lastModified = new Date().toISOString();
                console.log(`[BeeStore] 更新用户 ${userId} 最后修改时间: ${operationType}`);
            }
        }
        
        // 🔥 步骤13: 数据完整性检查函数
        function ensureDataIntegrity(data) {
            if (!data) return data;
            
            // 确保所有应用都有lastModified字段
            if (data.apps) {
                data.apps.forEach(app => {
                    if (!app.lastModified) {
                        app.lastModified = app.createdAt || new Date().toISOString();
                        console.log(`[BeeStore] 为应用 ${app.id} 添加lastModified字段`);
                    }
                });
            }
            
            // 确保所有用户都有lastModified字段
            if (data.users) {
                data.users.forEach(user => {
                    if (!user.lastModified) {
                        user.lastModified = user.createdAt || new Date().toISOString();
                        console.log(`[BeeStore] 为用户 ${user.id} 添加lastModified字段`);
                    }
                });
            }
            
            return data;
        }
        
        // 🔥 步骤5: 数据冲突检测函数
        function detectDataConflicts(localData, remoteData) {
            const conflicts = [];
            
            // 检查应用数据冲突
            if (localData.apps && remoteData.apps) {
                localData.apps.forEach(localApp => {
                    const remoteApp = remoteData.apps.find(app => app.id === localApp.id);
                    if (remoteApp) {
                        const localLastModified = new Date(localApp.lastModified || localApp.createdAt);
                        const remoteLastModified = new Date(remoteApp.lastModified || remoteApp.createdAt);
                        
                        // 如果时间差小于5分钟，可能存在冲突
                        if (Math.abs(localLastModified - remoteLastModified) < 5 * 60 * 1000) {
                            conflicts.push({
                                type: 'app',
                                appId: localApp.id,
                                appName: localApp.name,
                                localLastModified,
                                remoteLastModified
                            });
                        }
                    }
                });
            }
            
            return conflicts;
        }
        
        // 🔥 步骤21: 通用重试函数
        async function retryOperation(operationType, operationFn, ...args) {
            let lastError;
            
            for (let attempt = 0; attempt <= RETRY_CONFIG.maxRetries; attempt++) {
                try {
                    return await operationFn(...args);
                } catch (error) {
                    lastError = error;
                    console.warn(`[BeeStore] ${operationType} 操作失败 (尝试 ${attempt + 1}/${RETRY_CONFIG.maxRetries + 1}):`, error);
                    
                    if (attempt < RETRY_CONFIG.maxRetries) {
                        const delay = RETRY_CONFIG.retryDelay[attempt] || RETRY_CONFIG.retryDelay[RETRY_CONFIG.retryDelay.length - 1];
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw lastError;
        }

        // 日志记录系统
        class Logger {
            constructor() {
                this.logs = JSON.parse(localStorage.getItem('beestoreLogs') || '[]');
                this.maxLogs = 1000; // 最多保存1000条日志
            }

            getFormattedLog(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const userInfo = currentUser ? {
                    id: currentUser.id,
                    username: currentUser.username
                } : { id: null, username: 'guest' };

                return {
                    timestamp,
                    level,
                    message,
                    user: userInfo,
                    data,
                    id: Date.now() + Math.random()
                };
            }

            info(message, data = null) {
                const log = this.getFormattedLog('INFO', message, data);
                this.logs.unshift(log);
                console.log(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // 异步发送到云端（不阻塞主流程）
                this.sendToCloud(log).catch(e => console.warn('发送日志到云端失败:', e));
                
                return log;
            }

            warn(message, data = null) {
                const log = this.getFormattedLog('WARN', message, data);
                this.logs.unshift(log);
                console.warn(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // 异步发送到云端（不阻塞主流程）
                this.sendToCloud(log).catch(e => console.warn('发送日志到云端失败:', e));
                
                return log;
            }

            error(message, data = null) {
                const log = this.getFormattedLog('ERROR', message, data);
                this.logs.unshift(log);
                console.error(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // 异步发送到云端（不阻塞主流程）
                this.sendToCloud(log).catch(e => console.warn('发送日志到云端失败:', e));
                
                return log;
            }

            saveLogs() {
                // 限制日志数量
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(0, this.maxLogs);
                }
                localStorage.setItem('beestoreLogs', JSON.stringify(this.logs));
            }

            // 发送关键日志到云端（供admin查看）
            async sendToCloud(log) {
                // 只发送关键的错误和重要操作到云端
                const shouldSendToCloud = this.shouldSendToCloud(log);
                
                if (!shouldSendToCloud) return;

                try {
                                         // 获取云端日志并清理过期日志
                    let cloudLogs = [];
                    try {
                        const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (response.ok) {
                            const result = await response.json();
                            const allLogs = result.record?.centralLogs || [];
                            
                            // 清理超过48小时的日志
                            cloudLogs = this.cleanExpiredLogs(allLogs);
                        }
                    } catch (e) {
                        console.warn('获取云端日志失败，将创建新的日志记录');
                    }

                    // 添加新日志到云端
                    cloudLogs.unshift({
                        ...log,
                        cloudId: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString(),
                            url: window.location.href
                        }
                    });

                    // 限制云端日志数量（最多500条）
                    if (cloudLogs.length > 500) {
                        const removedCount = cloudLogs.length - 500;
                        cloudLogs = cloudLogs.slice(0, 500);
                        console.log(`[BeeStore] 云端日志数量超限，移除最旧的 ${removedCount} 条日志`);
                    }

                    // 构建完整的云端数据
                    let fullCloudData = {
                        users: [],
                        apps: [],
                        lastSync: null,
                        centralLogs: cloudLogs
                    };

                    // 尝试保持现有的数据结构
                    try {
                        const existingResponse = await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (existingResponse.ok) {
                            const existingData = await existingResponse.json();
                            if (existingData.record) {
                                fullCloudData = {
                                    ...existingData.record,
                                    centralLogs: cloudLogs
                                };
                            }
                        }
                    } catch (e) {
                        console.warn('获取现有云端数据失败，使用默认结构');
                    }

                    // 发送到云端
                    await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullCloudData)
                    });

                } catch (error) {
                    console.error('发送日志到云端失败:', error);
                    // 失败时保存到本地待发送队列
                    this.saveToRetryQueue(log);
                }
            }

            shouldSendToCloud(log) {
                // 定义需要发送到云端的日志类型（只记录核心操作）
                const criticalMessages = [
                    // 应用相关操作
                    '应用发布',
                    '应用编辑',
                    '应用删除',
                    
                    // 图片/截图相关
                    '上传图片失败',
                    '截图上传失败', 
                    '截图生成失败',
                    '图片上传成功',
                    '截图生成并上传成功',
                    
                    // 用户互动
                    '点赞操作',
                    '收藏操作', 
                    '添加评论',
                    '删除评论',
                    
                    // 系统关键错误
                    '数据同步失败',
                    '数据恢复'
                ];

                // 只发送ERROR级别中与上述操作相关的日志
                if (log.level === 'ERROR') {
                    return criticalMessages.some(msg => log.message.includes(msg));
                }

                // 重要操作的信息级日志
                if (log.level === 'INFO' && criticalMessages.some(msg => log.message.includes(msg))) {
                    return true;
                }

                // 与核心操作相关的警告日志
                if (log.level === 'WARN' && criticalMessages.some(msg => log.message.includes(msg))) {
                    return true;
                }

                return false;
            }

            saveToRetryQueue(log) {
                try {
                    const retryQueue = JSON.parse(localStorage.getItem('beestoreLogRetryQueue') || '[]');
                    retryQueue.push({
                        ...log,
                        retryAttempts: 0,
                        queuedAt: new Date().toISOString()
                    });
                    
                    // 限制重试队列大小
                    if (retryQueue.length > 100) {
                        retryQueue.splice(100);
                    }
                    
                    localStorage.setItem('beestoreLogRetryQueue', JSON.stringify(retryQueue));
                } catch (e) {
                    console.error('保存重试队列失败:', e);
                }
            }

            async retryFailedLogs() {
                try {
                    const retryQueue = JSON.parse(localStorage.getItem('beestoreLogRetryQueue') || '[]');
                    if (retryQueue.length === 0) return;

                    const successfullyRetried = [];
                    
                    for (const queuedLog of retryQueue) {
                        if (queuedLog.retryAttempts < 3) {
                            try {
                                await this.sendToCloud(queuedLog);
                                successfullyRetried.push(queuedLog);
                            } catch (e) {
                                queuedLog.retryAttempts++;
                            }
                        } else {
                            // 超过重试次数，移除
                            successfullyRetried.push(queuedLog);
                        }
                    }

                    // 更新重试队列
                    const remainingQueue = retryQueue.filter(log => !successfullyRetried.includes(log));
                    localStorage.setItem('beestoreLogRetryQueue', JSON.stringify(remainingQueue));

                } catch (e) {
                    console.error('重试失败的日志时出错:', e);
                }
            }

            // 清理超过48小时的日志
            cleanExpiredLogs(logs) {
                if (!Array.isArray(logs)) return [];
                
                const fortyEightHoursAgo = new Date();
                fortyEightHoursAgo.setHours(fortyEightHoursAgo.getHours() - 48);
                
                const validLogs = logs.filter(log => {
                    try {
                        const logTime = new Date(log.timestamp);
                        return logTime > fortyEightHoursAgo;
                    } catch (e) {
                        // 如果时间戳解析失败，保留日志（安全起见）
                        return true;
                    }
                });
                
                const removedCount = logs.length - validLogs.length;
                if (removedCount > 0) {
                    console.log(`[BeeStore] 清理了 ${removedCount} 条超过48小时的云端日志，剩余 ${validLogs.length} 条`);
                    
                    // 记录清理操作到本地日志（不发送到云端避免循环）
                    const cleanupLog = this.getFormattedLog('INFO', `自动清理过期日志`, {
                        removedCount: removedCount,
                        remainingCount: validLogs.length,
                        operation: '系统维护'
                    });
                    this.logs.unshift(cleanupLog);
                    this.saveLogs();
                }
                
                return validLogs;
            }

            // 定期清理云端日志（定时任务）
            async cleanupCloudLogs() {
                try {
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) return;
                    
                    const result = await response.json();
                    const allLogs = result.record?.centralLogs || [];
                    const cleanedLogs = this.cleanExpiredLogs(allLogs);
                    
                    // 如果清理了日志，更新云端数据
                    if (cleanedLogs.length < allLogs.length) {
                        const fullCloudData = {
                            ...result.record,
                            centralLogs: cleanedLogs
                        };
                        
                        await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(fullCloudData)
                        });
                        
                        const removedCount = allLogs.length - cleanedLogs.length;
                        console.log(`[BeeStore] 定期清理完成，移除 ${removedCount} 条过期日志，剩余 ${cleanedLogs.length} 条`);
                        
                        // 记录定期清理操作到本地日志
                        const cleanupLog = this.getFormattedLog('INFO', `定期清理云端日志`, {
                            removedCount: removedCount,
                            remainingCount: cleanedLogs.length,
                            operation: '系统维护'
                        });
                        this.logs.unshift(cleanupLog);
                        this.saveLogs();
                    }
                } catch (error) {
                    console.warn('定期清理云端日志失败:', error);
                }
            }

            getLogs(limit = 100, level = null, username = null) {
                let filteredLogs = this.logs;

                if (level) {
                    filteredLogs = filteredLogs.filter(log => log.level === level);
                }

                if (username) {
                    filteredLogs = filteredLogs.filter(log => log.user.username === username);
                }

                return filteredLogs.slice(0, limit);
            }

            clearLogs() {
                this.logs = [];
                localStorage.removeItem('beestoreLogs');
                console.log('[BeeStore] 日志已清空');
            }

            // 获取云端日志（仅admin可用）
            async getCloudLogs(limit = 100, level = null, username = null) {
                try {
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error('获取云端日志失败');
                    }
                    
                    const result = await response.json();
                    const allLogs = result.record?.centralLogs || [];
                    
                    // 清理过期日志
                    let cloudLogs = this.cleanExpiredLogs(allLogs);
                    
                    // 应用筛选
                    if (level) {
                        cloudLogs = cloudLogs.filter(log => log.level === level);
                    }
                    
                    if (username) {
                        cloudLogs = cloudLogs.filter(log => 
                            log.user && log.user.username && log.user.username.toLowerCase().includes(username.toLowerCase())
                        );
                    }
                    
                    return cloudLogs.slice(0, limit);
                } catch (error) {
                    console.error('获取云端日志失败:', error);
                    throw error;
                }
            }

            // 清空云端日志（仅admin可用）
            async clearCloudLogs() {
                try {
                    // 获取现有数据结构
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    let fullCloudData = {
                        users: [],
                        apps: [],
                        lastSync: null,
                        centralLogs: []
                    };
                    
                    if (response.ok) {
                        const existingData = await response.json();
                        if (existingData.record) {
                            fullCloudData = {
                                ...existingData.record,
                                centralLogs: []
                            };
                        }
                    }
                    
                    // 保存清空后的数据
                    await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullCloudData)
                    });
                    
                    console.log('[BeeStore] 云端日志已清空');
                } catch (error) {
                    console.error('清空云端日志失败:', error);
                    throw error;
                }
            }

            // 数据快照功能
            snapshot(description, data, metadata = {}) {
                try {
                    // 🔥 步骤5-7: 创建深拷贝并确保包含完整信息
                    const snapshotData = JSON.parse(JSON.stringify(data));
                    
                    // 为快照数据添加完整的上下文信息
                    const enrichedData = {
                        ...snapshotData,
                        snapshotContext: {
                            currentUser: currentUser ? {
                                id: currentUser.id,
                                username: currentUser.username
                            } : null,
                            timestamp: new Date().toISOString(),
                            totalApps: cloudData.apps ? cloudData.apps.length : 0,
                            totalUsers: cloudData.users ? cloudData.users.length : 0
                        }
                    };
                    
                    const compressedData = this.compressData(enrichedData);
                    
                    const snapshot = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        description,
                        data: compressedData,
                        metadata: {
                            ...metadata,
                            dataSize: JSON.stringify(enrichedData).length,
                            compressedSize: JSON.stringify(compressedData).length,
                            user: currentUser ? {
                                id: currentUser.id,
                                username: currentUser.username
                            } : { id: null, username: 'guest' },
                            // 添加更多上下文信息
                            environment: {
                                userAgent: navigator.userAgent,
                                url: window.location.href,
                                timestamp: new Date().toISOString()
                            }
                        },
                        type: 'SNAPSHOT'
                    };

                    // 获取现有快照
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    snapshots.unshift(snapshot);

                    // 限制快照数量 (最多保存50个快照)
                    if (snapshots.length > 50) {
                        snapshots.splice(50);
                    }

                    localStorage.setItem('beestoreSnapshots', JSON.stringify(snapshots));
                    
                    this.info(`数据快照已创建: ${description}`, {
                        snapshotId: snapshot.id,
                        dataSize: snapshot.metadata.dataSize,
                        compressedSize: snapshot.metadata.compressedSize,
                        operation: '数据快照'
                    });

                    return snapshot;
                } catch (error) {
                    this.error('创建数据快照失败', { error: error.message, description });
                    throw error;
                }
            }

            compressData(data) {
                // 简单的数据压缩：移除不必要的字段，保留核心数据
                if (Array.isArray(data)) {
                    return data.map(item => this.compressData(item));
                }
                
                if (typeof data === 'object' && data !== null) {
                    const compressed = {};
                    for (const [key, value] of Object.entries(data)) {
                        // 跳过一些临时或不重要的字段
                        if (!['lastSync', 'id'].includes(key) || key === 'id') {
                            compressed[key] = this.compressData(value);
                        }
                    }
                    return compressed;
                }
                
                return data;
            }

            decompressData(compressedData) {
                // 解压缩数据（当前实现中压缩程度有限，主要是数据结构保持）
                return JSON.parse(JSON.stringify(compressedData));
            }

            getSnapshots(limit = 50, type = null) {
                try {
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    
                    let filteredSnapshots = snapshots;
                    if (type) {
                        filteredSnapshots = snapshots.filter(snapshot => 
                            snapshot.metadata.snapshotType === type
                        );
                    }

                    return filteredSnapshots.slice(0, limit);
                } catch (error) {
                    this.error('获取快照列表失败', { error: error.message });
                    return [];
                }
            }

            restoreFromSnapshot(snapshotId, targetType = 'full') {
                try {
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    const snapshot = snapshots.find(s => s.id === snapshotId);
                    
                    if (!snapshot) {
                        throw new Error('快照不存在');
                    }

                    // 解压缩数据
                    const restoredData = this.decompressData(snapshot.data);
                    
                    this.info(`开始从快照恢复数据: ${snapshot.description}`, {
                        snapshotId: snapshotId,
                        targetType: targetType,
                        operation: '数据恢复'
                    });

                    // 根据目标类型恢复数据
                    switch (targetType) {
                        case 'apps':
                            if (restoredData.apps) {
                                cloudData.apps = restoredData.apps;
                            } else if (Array.isArray(restoredData)) {
                                cloudData.apps = restoredData;
                            }
                            break;
                        case 'users':
                            if (restoredData.users) {
                                cloudData.users = restoredData.users;
                            } else if (Array.isArray(restoredData)) {
                                cloudData.users = restoredData;
                            }
                            break;
                        case 'full':
                        default:
                            if (restoredData.apps) cloudData.apps = restoredData.apps;
                            if (restoredData.users) cloudData.users = restoredData.users;
                            if (restoredData.lastSync) cloudData.lastSync = restoredData.lastSync;
                            break;
                    }

                    this.info(`数据恢复完成: ${snapshot.description}`, {
                        snapshotId: snapshotId,
                        targetType: targetType,
                        restoredApps: cloudData.apps?.length || 0,
                        restoredUsers: cloudData.users?.length || 0,
                        operation: '数据恢复完成'
                    });

                    return restoredData;
                } catch (error) {
                    this.error('数据恢复失败', { 
                        snapshotId, 
                        targetType, 
                        error: error.message 
                    });
                    throw error;
                }
            }

            clearSnapshots() {
                localStorage.removeItem('beestoreSnapshots');
                this.info('所有数据快照已清空', { operation: '清空快照' });
            }
        }

        const logger = new Logger();

        // 本地缓存管理类
        class LocalCache {
            constructor() {
                this.cacheKey = 'beestoreCloudData';
                this.metaKey = 'beestoreCloudMeta';
            }

            saveToLocal(data) {
                try {
                    const cacheData = {
                        data: data,
                        lastModified: new Date().toISOString(),
                        version: Date.now()
                    };
                    
                    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    
                    const meta = {
                        syncStatus: 'pending',
                        lastSyncAttempt: null,
                        pendingOperations: this.getPendingOperations().length
                    };
                    localStorage.setItem(this.metaKey, JSON.stringify(meta));
                    
                    return true;
                } catch (error) {
                    logger.error('保存本地缓存失败', { error: error.message });
                    return false;
                }
            }

            loadFromLocal() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (!cached) return null;
                    
                    const cacheData = JSON.parse(cached);
                    return cacheData.data;
                } catch (error) {
                    logger.error('加载本地缓存失败', { error: error.message });
                    return null;
                }
            }

            getLocalMeta() {
                try {
                    const meta = localStorage.getItem(this.metaKey);
                    return meta ? JSON.parse(meta) : null;
                } catch (error) {
                    return null;
                }
            }

            isCacheFresh() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (!cached) return false;
                    
                    const cacheData = JSON.parse(cached);
                    const cacheTime = new Date(cacheData.lastModified);
                    const now = new Date();
                    
                    // 移动端缓存时间稍长一些（10分钟），因为移动端网络不稳定
                    const isMobile = navigator.userAgent.includes('Mobile');
                    const cacheValidTime = isMobile ? 10 * 60 * 1000 : 5 * 60 * 1000; // 移动端10分钟，桌面端5分钟
                    const validTimeAgo = new Date(now.getTime() - cacheValidTime);
                    
                    return cacheTime > validTimeAgo;
                } catch (error) {
                    return false;
                }
            }

            isLocalNewer(localTime, remoteTime) {
                if (!localTime || !remoteTime) return false;
                return new Date(localTime) > new Date(remoteTime);
            }

            markSynced() {
                try {
                    const meta = this.getLocalMeta() || {};
                    meta.syncStatus = 'synced';
                    meta.lastSyncAttempt = new Date().toISOString();
                    localStorage.setItem(this.metaKey, JSON.stringify(meta));
                } catch (error) {
                    logger.error('标记同步状态失败', { error: error.message });
                }
            }

            addPendingOperation(operation) {
                try {
                    const operations = this.getPendingOperations();
                    operations.push({
                        ...operation,
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('beestorePendingOps', JSON.stringify(operations));
                } catch (error) {
                    logger.error('添加待同步操作失败', { error: error.message });
                }
            }

            getPendingOperations() {
                try {
                    const ops = localStorage.getItem('beestorePendingOps');
                    return ops ? JSON.parse(ops) : [];
                } catch (error) {
                    return [];
                }
            }

            clearPendingOperations() {
                localStorage.removeItem('beestorePendingOps');
            }
        }

        // 异步同步队列管理类
        class SyncQueue {
            constructor(localCache) {
                this.localCache = localCache;
                this.isProcessing = false;
                this.maxRetries = 3;
                this.retryDelay = 2000; // 2秒
            }

            async addOperation(operation) {
                // 对于可切换操作（点赞、收藏），移除冲突的旧操作
                this.removeConflictingOperations(operation);
                
                // 检查操作去重
                if (this.isDuplicateOperation(operation)) {
                    logger.info('跳过重复操作', { 
                        type: operation.type,
                        target: operation.appId || operation.userId,
                        operation: '操作去重'
                    });
                    return;
                }
                
                // 添加到本地队列
                this.localCache.addPendingOperation(operation);
                
                // 触发异步处理
                this.processQueueAsync();
            }

            isDuplicateOperation(newOperation) {
                const pendingOps = this.localCache.getPendingOperations();
                
                // 生成操作唯一标识
                const newOpKey = this.generateOperationKey(newOperation);
                
                // 检查是否存在相同操作（5分钟内的操作认为是重复）
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                
                return pendingOps.some(op => {
                    const opTime = new Date(op.timestamp);
                    const opKey = this.generateOperationKey(op);
                    
                    return opKey === newOpKey && opTime > fiveMinutesAgo;
                });
            }

            generateOperationKey(operation) {
                // 根据操作类型生成唯一标识
                switch (operation.type) {
                    case 'like':
                    case 'favorite':
                        return `${operation.type}_${operation.appId}_${operation.userId}`;
                    case 'comment_add':
                        // 评论按内容去重（防止短时间内重复提交相同评论）
                        return `${operation.type}_${operation.appId}_${operation.userId}_${operation.data?.commentContent}`;
                    case 'comment_delete':
                        return `${operation.type}_${operation.commentId}_${operation.userId}`;
                    case 'app_publish':
                    case 'app_edit':
                        return `${operation.type}_${operation.appId}_${operation.userId}`;
                    case 'user_register':
                        return `${operation.type}_${operation.userId}`;
                    default:
                        // 默认按类型+用户+时间去重
                        return `${operation.type}_${operation.userId}_${Math.floor(Date.now() / 60000)}`; // 按分钟去重
                }
            }

            removeConflictingOperations(newOperation) {
                // 对于可切换的操作（点赞、收藏），移除同一目标的旧操作
                if (newOperation.type === 'like' || newOperation.type === 'favorite') {
                    try {
                        const operations = this.localCache.getPendingOperations();
                        const conflictKey = `${newOperation.type}_${newOperation.appId}_${newOperation.userId}`;
                        
                        const filteredOps = operations.filter(op => {
                            const opKey = this.generateOperationKey(op);
                            return opKey !== conflictKey;
                        });
                        
                        const removedCount = operations.length - filteredOps.length;
                        if (removedCount > 0) {
                            localStorage.setItem('beestorePendingOps', JSON.stringify(filteredOps));
                            logger.info('移除冲突的待同步操作', {
                                type: newOperation.type,
                                target: newOperation.appId,
                                removedCount: removedCount,
                                operation: '操作冲突处理'
                            });
                        }
                    } catch (error) {
                        logger.error('移除冲突操作失败', { 
                            error: error.message,
                            operation: '操作冲突处理失败'
                        });
                    }
                }
            }

            async processQueueAsync() {
                if (this.isProcessing) return;
                
                // 延迟处理，避免频繁同步
                setTimeout(() => {
                    this.processQueue();
                }, 500);
            }

            async processQueue() {
                if (this.isProcessing) return;
                this.isProcessing = true;

                try {
                    const operations = this.localCache.getPendingOperations();
                    if (operations.length === 0) {
                        this.isProcessing = false;
                        return;
                    }

                    logger.info('开始处理同步队列', { 
                        operationsCount: operations.length,
                        operation: '队列同步'
                    });

                    updateStatus('☁️ 后台同步中...', 'syncing-background');

                    // 尝试后台同步
                    await syncData(0, true);
                    
                    // 同步成功，清空队列并清理过期操作
                    this.localCache.clearPendingOperations();
                    this.localCache.markSynced();
                    this.cleanupExpiredOperations();
                    
                    updateStatus('☁️ 同步完成', 'connected');
                    
                    logger.info('同步队列处理完成', { 
                        processedCount: operations.length,
                        operation: '队列同步完成'
                    });

                } catch (error) {
                    logger.error('同步队列处理失败', { 
                        error: error.message,
                        operation: '队列同步失败'
                    });
                    
                    updateStatus('⚠️ 同步失败，将重试', 'sync-failed');
                    
                    // 设置重试
                    setTimeout(() => {
                        this.retryFailedSync();
                    }, this.retryDelay);
                    
                } finally {
                    this.isProcessing = false;
                }
            }

            async retryFailedSync() {
                const operations = this.localCache.getPendingOperations();
                if (operations.length > 0) {
                    logger.info('重试失败的同步操作', { 
                        operationsCount: operations.length,
                        operation: '同步重试'
                    });
                    await this.processQueue();
                }
            }

            cleanupExpiredOperations() {
                try {
                    const operations = this.localCache.getPendingOperations();
                    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000); // 24小时前
                    
                    const validOperations = operations.filter(op => {
                        try {
                            const opTime = new Date(op.timestamp);
                            return opTime > oneDayAgo;
                        } catch (e) {
                            // 时间戳解析失败，保留操作（安全起见）
                            return true;
                        }
                    });
                    
                    const removedCount = operations.length - validOperations.length;
                    if (removedCount > 0) {
                        localStorage.setItem('beestorePendingOps', JSON.stringify(validOperations));
                        logger.info('清理过期的待同步操作', {
                            removedCount: removedCount,
                            remainingCount: validOperations.length,
                            operation: '操作队列清理'
                        });
                    }
                } catch (error) {
                    logger.error('清理过期操作失败', { 
                        error: error.message,
                        operation: '操作队列清理失败'
                    });
                }
            }
        }

        const localCache = new LocalCache();
        const syncQueue = new SyncQueue(localCache);

        // 界面初始化函数
        function initializeInterface() {
            // 确保数据结构兼容性（为旧数据添加新字段）
            if (cloudData.apps) {
                cloudData.apps.forEach(app => {
                    if (!app.likes) app.likes = [];
                    if (!app.favorites) app.favorites = [];
                    if (!app.comments) app.comments = [];
                });
            }
            
            // 检查本地登录状态
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    // 验证用户是否仍然存在
                    let user = cloudData.users.find(u => u.id === userData.id);
                    
                    if (user) {
                        // 用户状态完整性验证
                        if (!user.id || !user.username || !user.email) {
                            logger.warn('检测到用户状态不完整，清除本地登录状态', {
                                userId: user.id,
                                username: user.username,
                                hasEmail: !!user.email,
                                operation: '用户状态完整性检查'
                            });
                            localStorage.removeItem('currentUser');
                            showGuestNav();
                        } else {
                            currentUser = user;
                            showUserNav();
                        }
                    } else {
                        showGuestNav();
                    }
                } catch (error) {
                    logger.error('解析本地用户数据失败', { error: error.message });
                    localStorage.removeItem('currentUser');
                    showGuestNav();
                }
            } else {
                showGuestNav();
            }

            // 加载应用和更新统计
            loadApps();
            updateStats();
            
            // 设置搜索事件
            setupSearchEvents();
            
            // 初始化自定义下拉菜单状态
            initDropdowns();
        }

        // 数据合并函数
        function mergeCloudData(remoteData) {
            logger.info('开始合并云端和本地数据', { 
                localUsers: cloudData?.users?.length || 0,
                localApps: cloudData?.apps?.length || 0,
                remoteUsers: remoteData?.users?.length || 0,
                remoteApps: remoteData?.apps?.length || 0,
                operation: '数据合并'
            });
            
            // 如果没有本地数据，直接使用远程数据
            if (!cloudData || !cloudData.users || !cloudData.apps) {
                logger.info('无本地数据，使用远程数据', { operation: '数据合并' });
                return remoteData || { users: [], apps: [], lastSync: null };
            }

            // 如果没有远程数据，保持本地数据
            if (!remoteData || !remoteData.users || !remoteData.apps) {
                logger.info('无远程数据，保持本地数据', { operation: '数据合并' });
                return cloudData;
            }

            // 在数据合并前创建快照
            try {
                logger.snapshot('数据合并前本地数据快照', cloudData, {
                    snapshotType: 'local_before_merge',
                    operation: '数据合并前本地',
                    localUsers: cloudData.users.length,
                    localApps: cloudData.apps.length
                });
                
                logger.snapshot('数据合并前远程数据快照', remoteData, {
                    snapshotType: 'remote_before_merge',
                    operation: '数据合并前远程',
                    remoteUsers: remoteData.users.length,
                    remoteApps: remoteData.apps.length
                });
            } catch (snapshotError) {
                logger.warn('创建合并前快照失败，继续执行合并', { 
                    error: snapshotError.message 
                });
            }

            const merged = {
                users: [],
                apps: [],
                lastSync: remoteData.lastSync || new Date().toISOString()
            };

            // 🔥 步骤1: 合并用户数据（基于ID和lastModified时间）
            const allUsers = [...cloudData.users, ...remoteData.users];
            const userMap = new Map();
            
            allUsers.forEach(user => {
                const existing = userMap.get(user.id);
                const userLastModified = user.lastModified || user.createdAt;
                const existingLastModified = existing?.lastModified || existing?.createdAt;
                
                if (!existing || new Date(userLastModified) >= new Date(existingLastModified)) {
                    userMap.set(user.id, user);
                }
            });
            merged.users = Array.from(userMap.values());

            // 🔥 步骤2: 合并应用数据（基于ID和lastModified时间）
            const allApps = [...cloudData.apps, ...remoteData.apps];
            const appMap = new Map();
            
            allApps.forEach(app => {
                const existing = appMap.get(app.id);
                const appLastModified = app.lastModified || app.createdAt;
                const existingLastModified = existing?.lastModified || existing?.createdAt;
                
                if (!existing || new Date(appLastModified) >= new Date(existingLastModified)) {
                    appMap.set(app.id, app);
                }
            });
            merged.apps = Array.from(appMap.values());

            logger.info('数据合并完成', { 
                finalUsers: merged.users.length,
                finalApps: merged.apps.length,
                operation: '数据合并完成'
            });

            return merged;
        }

        // 状态管理 - 保留用于内部日志，不显示给用户
        function updateStatus(message, type = 'syncing') {
            // 只记录到控制台，不显示UI状态
            console.log(`[BeeStore Status] ${type.toUpperCase()}: ${message}`);
            
            // 记录状态变化到日志（用于调试）
            if (type === 'error' || type === 'sync-failed') {
                logger.warn('系统状态变化', { 
                    message: message, 
                    type: type,
                    operation: '状态更新'
                });
            }
        }

        // 🔥 步骤18: 提取登录状态检查逻辑
        function checkLoginStatus() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                const userData = JSON.parse(storedUser);
                let user = cloudData.users.find(u => u.id === userData.id);
                
                if (user) {
                    currentUser = user;
                    showUserNav();
                } else {
                    // 处理用户数据同步问题
                    const existingUserByName = cloudData.users.find(u => u.username === userData.username);
                    if (existingUserByName) {
                        currentUser = existingUserByName;
                        localStorage.setItem('currentUser', JSON.stringify(existingUserByName));
                        showUserNav();
                    } else {
                        localStorage.removeItem('currentUser');
                        showGuestNav();
                    }
                }
            } else {
                showGuestNav();
            }
        }

        // 🔥 修改为纯云端模式 - 完全不使用本地数据
        async function init() {
            logger.info('Bee Store 应用启动 - 纯云端模式', { 
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                operation: '应用启动 - 纯云端'
            });
            
            updateStatus('☁️ 从云端加载数据...', 'syncing');
            
            try {
                // ☁️ 直接从云端加载数据，不使用任何本地缓存
                console.log('[BeeStore] 🚀 启动纯云端模式，跳过所有本地数据');
                
                const remoteData = await cloudStorage.loadData();
                if (!remoteData || !remoteData.users || !remoteData.apps) {
                    throw new Error('云端数据格式错误或为空');
                }
                
                // 直接使用云端数据，不进行任何合并
                cloudData = ensureDataIntegrity(remoteData);
                console.log(`[BeeStore] ☁️ 云端数据加载成功: ${cloudData.apps.length} 个作品, ${cloudData.users.length} 个用户`);
                
                // 清除所有本地存储（确保不受旧数据影响）
                try {
                    localStorage.removeItem('beestoreLocalBackup');
                    console.log('[BeeStore] 🧹 已清除本地备份数据');
                } catch (clearError) {
                    console.warn('清除本地数据时出错:', clearError);
                }
                
                // 🔥 确保数据结构兼容性（为旧数据添加新字段）
                if (cloudData.apps) {
                    cloudData.apps.forEach(app => {
                        if (!app.likes) app.likes = [];
                        if (!app.favorites) app.favorites = [];
                        if (!app.comments) app.comments = [];
                        if (!app.lastModified) app.lastModified = app.createdAt;
                    });
                }
                
                if (cloudData.users) {
                    cloudData.users.forEach(user => {
                        if (!user.lastModified) user.lastModified = user.createdAt;
                    });
                }
                
                // 更新UI
                checkLoginStatus();
                loadApps();
                updateStats();
                updateStatus('☁️ 纯云端模式', 'connected');
                
                // 初始化下拉菜单状态
                updateDropdownSelection('category', '');
                updateDropdownSelection('sort', 'newest');
                updateDropdownSelection('category-mobile', '');
                updateDropdownSelection('sort-mobile', 'newest');
                
            } catch (cloudError) {
                console.error('云端数据加载失败:', cloudError);
                
                // 纯云端模式下，如果云端失败就初始化空数据
                initLocalData();
                updateStatus('❌ 云端连接失败，使用空数据', 'error');
                checkLoginStatus();
                loadApps();
                updateStats();
                
                // 初始化下拉菜单状态
                updateDropdownSelection('category', '');
                updateDropdownSelection('sort', 'newest');
                updateDropdownSelection('category-mobile', '');
                updateDropdownSelection('sort-mobile', 'newest');
                
                // 显示错误信息给用户
                alert(`云端数据加载失败: ${cloudError.message}\n\n请检查网络连接或稍后再试。`);
            }
        }

        // 初始化本地数据
        function initLocalData() {
            cloudData = {
                users: [
                    {
                        id: 1,
                        username: 'demo',
                        email: 'demo@example.com',
                        password: 'demo123',
                        createdAt: new Date().toISOString()
                    }
                ],
                apps: [
                    {
                        id: 1,
                        name: '2Brain',
                        url: 'https://portal.2brain.ai/',
                        description: '知识库型AI平台，建立知识库、智能体，包括模板写作、自然语言excel分析、智能出题考试判卷等功能',
                        category: '工具',
                        author: 'Beebee AI',
                        authorId: 1,
                        screenshot: '',
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Beebee Trademate',
                        url: 'https://beebee.com',
                        description: '商机包，商机搜索引擎，支持自然语言搜索、AI生成邮件一键发送',
                        category: '工具',
                        author: 'Beebee AI',
                        authorId: 1,
                        screenshot: '',
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    }
                ],
                lastSync: new Date().toISOString()
            };
        }

        // 同步数据到云端
        async function syncData(retryCount = 0, isBackground = false) {
            const maxRetries = 3;
            
            if (retryCount === 0) {
                logger.info('开始数据同步到云端', { 
                    usersCount: cloudData.users.length,
                    appsCount: cloudData.apps.length,
                    isBackground: isBackground,
                    operation: '数据同步'
                });
                
                if (isBackground) {
                    updateStatus('🔄 后台同步中...', 'syncing-background');
                } else {
                    updateStatus('☁️ 正在同步...', 'syncing');
                }
            } else {
                logger.warn(`数据同步重试 ${retryCount}/${maxRetries}`, { 
                    retryCount: retryCount,
                    maxRetries: maxRetries,
                    isBackground: isBackground,
                    operation: '数据同步重试'
                });
                
                if (isBackground) {
                    updateStatus(`🔄 后台重试 (${retryCount}/${maxRetries})...`, 'syncing-background');
                } else {
                    updateStatus(`☁️ 重试同步 (${retryCount}/${maxRetries})...`, 'syncing');
                }
            }
            
            try {
                // 用户数据一致性检查
                if (currentUser) {
                    const userInData = cloudData.users.find(u => u.id === currentUser.id);
                    if (!userInData) {
                        logger.warn('同步时发现用户数据不一致，添加当前用户到cloudData', {
                            currentUserId: currentUser.id,
                            currentUserName: currentUser.username,
                            operation: '用户数据一致性修复'
                        });
                        cloudData.users.push(currentUser);
                    } else if (userInData.username !== currentUser.username) {
                        logger.warn('同步时发现用户名不一致，更新cloudData中的用户信息', {
                            currentUserId: currentUser.id,
                            cloudUsername: userInData.username,
                            currentUsername: currentUser.username,
                            operation: '用户数据一致性修复'
                        });
                        userInData.username = currentUser.username;
                        userInData.email = currentUser.email;
                    }
                }
                
                cloudData.lastSync = new Date().toISOString();
                
                // 检查数据大小
                const dataSize = JSON.stringify(cloudData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB 限制
                
                logger.info('数据大小检查', { 
                    dataSize: dataSize,
                    dataSizeMB: Math.round(dataSize / 1024 / 1024 * 100) / 100,
                    maxSizeMB: Math.round(maxSize / 1024 / 1024),
                    operation: '数据大小检查'
                });
                
                if (dataSize > maxSize) {
                    logger.error('数据大小超过限制', { 
                        dataSize: dataSize,
                        dataSizeMB: Math.round(dataSize / 1024 / 1024 * 100) / 100,
                        maxSizeMB: Math.round(maxSize / 1024 / 1024),
                        operation: '数据大小超限'
                    });
                    console.warn(`数据大小过大: ${Math.round(dataSize / 1024 / 1024 * 100) / 100}MB`);
                    updateStatus('⚠️ 数据过大，建议清理', 'error');
                    throw new Error(`数据大小 ${Math.round(dataSize / 1024 / 1024 * 100) / 100}MB 超过限制 ${Math.round(maxSize / 1024 / 1024)}MB`);
                }
                
                // 在同步前创建快照
                try {
                    logger.snapshot('数据同步前快照', cloudData, {
                        snapshotType: 'full_before_sync',
                        operation: '数据同步前',
                        usersCount: cloudData.users.length,
                        appsCount: cloudData.apps.length,
                        retryCount: retryCount
                    });
                } catch (snapshotError) {
                    logger.warn('创建同步前快照失败，继续执行同步', { 
                        retryCount: retryCount,
                        error: snapshotError.message 
                    });
                }
                
                await cloudStorage.saveData(cloudData);
                logger.info('数据同步成功', { 
                    usersCount: cloudData.users.length,
                    appsCount: cloudData.apps.length,
                    retryCount: retryCount,
                    isBackground: isBackground,
                    operation: '数据同步成功'
                });
                
                if (isBackground) {
                    updateStatus('✅ 后台同步完成', 'connected');
                } else {
                    updateStatus('☁️ 同步成功', 'connected');
                }
                updateStats();
                return true;
            } catch (error) {
                logger.error(`数据同步失败 (尝试 ${retryCount + 1}/${maxRetries + 1})`, { 
                    error: error.message,
                    retryCount: retryCount,
                    maxRetries: maxRetries,
                    operation: '数据同步失败'
                });
                console.error(`同步失败 (尝试 ${retryCount + 1}/${maxRetries + 1}):`, error);
                
                if (retryCount < maxRetries) {
                    // 指数退避重试：第一次1秒，第二次2秒，第三次4秒
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return await syncData(retryCount + 1, isBackground);
                } else {
                    if (isBackground) {
                        updateStatus('⚠️ 后台同步失败', 'sync-failed');
                    } else {
                        updateStatus('❌ 同步失败', 'error');
                    }
                    throw error;
                }
            }
        }

        // 更新统计信息
        function updateStats() {
            const totalAppsElement = document.getElementById('nav-total-apps');
            const totalUsersElement = document.getElementById('nav-total-users');
            
            if (totalAppsElement) {
                totalAppsElement.textContent = cloudData.apps ? cloudData.apps.length : 0;
            }
            if (totalUsersElement) {
                totalUsersElement.textContent = cloudData.users ? cloudData.users.length : 0;
            }
            
            console.log(`[BeeStore] 📊 统计更新: ${cloudData.apps ? cloudData.apps.length : 0} 个作品, ${cloudData.users ? cloudData.users.length : 0} 个用户`);
        }

        // 设置搜索事件
        function setupSearchEvents() {
            // 桌面端搜索框
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchApps();
                    }
                });
                searchInput.addEventListener('input', debounce(searchApps, 300));
            }

            // 移动端搜索框
            const searchInputMobile = document.getElementById('search-input-mobile');
            if (searchInputMobile) {
                searchInputMobile.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchApps();
                    }
                });
                searchInputMobile.addEventListener('input', debounce(searchApps, 300));
            }

            // 同步搜索框内容
            function syncSearchInputs() {
                const desktopValue = searchInput ? searchInput.value : '';
                const mobileValue = searchInputMobile ? searchInputMobile.value : '';
                
                if (searchInput && searchInputMobile) {
                    if (document.activeElement === searchInput) {
                        searchInputMobile.value = desktopValue;
                    } else if (document.activeElement === searchInputMobile) {
                        searchInput.value = mobileValue;
                    }
                }
            }

            if (searchInput) searchInput.addEventListener('input', syncSearchInputs);
            if (searchInputMobile) searchInputMobile.addEventListener('input', syncSearchInputs);

            // 为移动端筛选器添加事件监听
            const categoryFilterMobile = document.getElementById('category-filter-mobile');
            const sortFilterMobile = document.getElementById('sort-filter-mobile');
            
            if (categoryFilterMobile) {
                categoryFilterMobile.addEventListener('change', searchApps);
            }
            if (sortFilterMobile) {
                sortFilterMobile.addEventListener('change', searchApps);
            }

            // 同步桌面端和移动端的筛选器值
            function syncFilters() {
                const categoryFilter = document.getElementById('category-filter');
                const sortFilter = document.getElementById('sort-filter');
                
                if (categoryFilter && categoryFilterMobile) {
                    categoryFilter.addEventListener('change', function() {
                        categoryFilterMobile.value = this.value;
                        searchApps();
                    });
                    categoryFilterMobile.addEventListener('change', function() {
                        categoryFilter.value = this.value;
                    });
                }
                
                if (sortFilter && sortFilterMobile) {
                    sortFilter.addEventListener('change', function() {
                        sortFilterMobile.value = this.value;
                        searchApps();
                    });
                    sortFilterMobile.addEventListener('change', function() {
                        sortFilter.value = this.value;
                    });
                }
            }
            
            syncFilters();
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 搜索应用
        function searchApps() {
            loadApps();
        }

        // 获取当前搜索条件（优先移动端，如果移动端可见的话）
        function getCurrentSearchTerms() {
            const isMobile = window.innerWidth <= 1024;
            
            let searchTerm = '';
            let categoryFilter = '';
            let sortFilter = '';
            
            if (isMobile) {
                // 移动端
                const searchInputMobile = document.getElementById('search-input-mobile');
                const categoryFilterMobile = document.getElementById('category-filter-mobile');
                const sortFilterMobile = document.getElementById('sort-filter-mobile');
                
                searchTerm = searchInputMobile ? searchInputMobile.value.toLowerCase() : '';
                categoryFilter = categoryFilterMobile ? categoryFilterMobile.value : '';
                sortFilter = sortFilterMobile ? sortFilterMobile.value : '';
            } else {
                // 桌面端
                const searchInput = document.getElementById('search-input');
                const categoryFilterDesktop = document.getElementById('category-filter');
                const sortFilterDesktop = document.getElementById('sort-filter');
                
                searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                categoryFilter = categoryFilterDesktop ? categoryFilterDesktop.value : '';
                sortFilter = sortFilterDesktop ? sortFilterDesktop.value : '';
            }
            
            return { searchTerm, categoryFilter, sortFilter };
        }

        // 加载应用
        function loadApps() {
            const { searchTerm, categoryFilter, sortFilter } = getCurrentSearchTerms();

            let filteredApps = cloudData.apps;

            // 搜索过滤
            if (searchTerm) {
                filteredApps = filteredApps.filter(app => 
                    app.name.toLowerCase().includes(searchTerm) ||
                    app.description.toLowerCase().includes(searchTerm) ||
                    app.author.toLowerCase().includes(searchTerm)
                );
            }

            // 分类过滤
            if (categoryFilter) {
                filteredApps = filteredApps.filter(app => app.category === categoryFilter);
            }

            // 排序
            switch (sortFilter) {
                case 'newest':
                    filteredApps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredApps.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'name':
                    filteredApps.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'author':
                    filteredApps.sort((a, b) => a.author.localeCompare(b.author));
                    break;
            }

            displayApps(filteredApps);
        }

        // 切换描述展开/收起
        function toggleDescription(appId) {
            const descElement = document.getElementById(`desc-${appId}`);
            const toggleButton = document.getElementById(`toggle-${appId}`);
            
            if (descElement.classList.contains('collapsed')) {
                // 展开
                descElement.classList.remove('collapsed');
                descElement.classList.add('expanded');
                descElement.style.cursor = 'default';
                if (toggleButton) toggleButton.style.display = 'inline-block';
            } else {
                // 收起
                descElement.classList.remove('expanded');
                descElement.classList.add('collapsed');
                descElement.style.cursor = 'pointer';
                if (toggleButton) toggleButton.style.display = 'none';
            }
        }

        // 检查描述是否需要展开按钮
        function checkDescriptionOverflow() {
            // 延迟执行，确保DOM已渲染
            setTimeout(() => {
                const descriptions = document.querySelectorAll('.app-description.collapsed');
                descriptions.forEach(desc => {
                    const appId = desc.id.replace('desc-', '');
                    const toggleButton = document.getElementById(`toggle-${appId}`);
                    
                    // 获取纯文本内容
                    const textContent = desc.textContent.trim();
                    
                    // 创建临时元素来测量完整文本高度
                    const tempDiv = document.createElement('div');
                    tempDiv.style.cssText = `
                        position: absolute;
                        visibility: hidden;
                        width: ${desc.offsetWidth}px;
                        font-size: ${window.getComputedStyle(desc).fontSize};
                        font-family: ${window.getComputedStyle(desc).fontFamily};
                        line-height: ${window.getComputedStyle(desc).lineHeight};
                        padding: 0;
                        margin: 0;
                        border: none;
                    `;
                    tempDiv.textContent = textContent;
                    document.body.appendChild(tempDiv);
                    
                    const fullHeight = tempDiv.offsetHeight;
                    document.body.removeChild(tempDiv);
                    
                    // 获取2行的预期高度（行高 * 2）
                    const lineHeight = parseFloat(window.getComputedStyle(desc).lineHeight);
                    const twoLineHeight = lineHeight * 2;
                    
                    // 如果完整高度超过2行高度，显示展开功能
                    if (fullHeight > twoLineHeight + 5) { // 5px容差
                        desc.classList.add('has-overflow');
                        desc.style.cursor = 'pointer';
                        
                        // 添加点击事件监听器（避免重复添加）
                        if (!desc.hasAttribute('data-click-added')) {
                            desc.addEventListener('click', function() {
                                toggleDescription(appId);
                            });
                            desc.setAttribute('data-click-added', 'true');
                        }
                        
                        if (toggleButton) toggleButton.style.display = 'none';
                    } else {
                        desc.classList.remove('has-overflow');
                        desc.style.cursor = 'default';
                        if (toggleButton) toggleButton.style.display = 'none';
                    }
                });
            }, 200);
        }

        // 显示应用
        function displayApps(apps, showActions = false) {
            const appsGrid = document.getElementById('apps-grid');
            const emptyState = document.getElementById('empty-state');

            if (apps.length === 0) {
                appsGrid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            appsGrid.innerHTML = apps.map(app => {
                const isLiked = currentUser && app.likes && app.likes.includes(currentUser.id);
                const isFavorited = currentUser && app.favorites && app.favorites.includes(currentUser.id);
                const likesCount = app.likes ? app.likes.length : 0;
                const commentsCount = app.comments ? app.comments.length : 0;
                
                return `
                <div class="app-card">
                    ${showActions && currentUser && currentUser.id === app.authorId ? `
                        <div class="app-actions">
                            <button class="app-action-btn edit-btn" onclick="showEditModal(${app.id})" title="编辑">✏️</button>
                            <button class="app-action-btn" onclick="deleteApp(${app.id})" title="删除">🗑️</button>
                        </div>
                    ` : ''}
                    <div class="app-screenshot">
                        ${app.screenshot && app.screenshot.trim() ? 
                            `<img src="${app.screenshot}" alt="${app.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'placeholder\\'><div style=\\'font-size: 2rem;\\'>🌐</div><div>暂无截图</div></div>'">` :
                            '<div class="placeholder"><div style="font-size: 2rem;">🌐</div><div>暂无截图</div></div>'
                        }
                    </div>
                    <div class="app-info">
                        <h3>${app.name}</h3>
                        <div class="app-description collapsed" id="desc-${app.id}" data-full-text="${app.description.replace(/"/g, '&quot;')}">${app.description}</div>
                        <button class="description-toggle" onclick="toggleDescription(${app.id})" id="toggle-${app.id}" style="display: none;">收起</button>
                        <div class="app-meta">
                            <span>👤 ${app.author}</span>
                            <span>📅 ${new Date(app.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="app-meta">
                            <span>🏷️ ${app.category}</span>
                            <a href="${app.url}" target="_blank" class="app-url" title="访问链接：${app.url}">🔗 访问链接</a>
                        </div>
                        
                        <!-- 互动按钮 -->
                        <div class="app-interactions">
                            <div class="interaction-group">
                                <button class="interaction-btn ${isLiked ? 'active' : ''}" onclick="toggleLike(${app.id})" ${!currentUser ? 'disabled title="请先登录"' : ''}>
                                    ${isLiked ? '❤️' : '🤍'} ${likesCount}
                                </button>
                                <button class="interaction-btn" onclick="showComments(${app.id})" ${!currentUser ? 'disabled title="请先登录"' : ''}>
                                    💬 ${commentsCount}
                                </button>
                                <button class="interaction-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${app.id})" ${!currentUser ? 'disabled title="请先登录"' : ''}>
                                    ${isFavorited ? '⭐' : '☆'} 收藏
                                </button>
                            </div>
                        </div>
                        
                        <!-- 评论区域 -->
                        <div class="comments-section" id="comments-${app.id}" style="display: none;">
                            <div id="comments-list-${app.id}">
                                ${app.comments ? app.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">${comment.author}</span>
                                            <div>
                                                <span>${new Date(comment.createdAt).toLocaleDateString()}</span>
                                                ${currentUser && currentUser.id === comment.authorId ? `
                                                    <button class="comment-delete" onclick="deleteComment(${app.id}, ${comment.id})">删除</button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="comment-content">${comment.content}</div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            ${currentUser ? `
                                <div class="comment-input">
                                    <input type="text" placeholder="写下你的评论..." id="comment-input-${app.id}" onkeypress="if(event.key==='Enter') addComment(${app.id})">
                                    <button onclick="addComment(${app.id})">发送</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // 检查哪些描述需要展开按钮
            checkDescriptionOverflow();
        }

        // 删除应用
        async function deleteApp(appId) {
            if (!confirm('确定要删除这个应用吗？')) return;

            try {
                // 在删除前创建快照
                const appToDelete = cloudData.apps.find(app => app.id === appId);
                if (appToDelete) {
                    try {
                        logger.snapshot(`删除应用前快照: ${appToDelete.name}`, appToDelete, {
                            snapshotType: 'app_delete_before',
                            appId: appId,
                            operation: '应用删除前'
                        });
                    } catch (snapshotError) {
                        logger.warn('创建删除前快照失败，继续执行删除', { 
                            appId: appId, 
                            error: snapshotError.message 
                        });
                    }

                    // 记录删除操作
                    logger.info('应用删除', {
                        appId: appId,
                        appName: appToDelete.name,
                        appUrl: appToDelete.url,
                        authorId: appToDelete.authorId,
                        operation: '应用管理'
                    });
                }

                cloudData.apps = cloudData.apps.filter(app => app.id !== appId);
                
                // 🔥 步骤24: 立即保存到本地存储
                localStorageManager.saveToLocal(cloudData);
                
                // 立即更新UI
                loadApps();
                
                // 异步同步到云端
                try {
                    await syncData();
                    alert('删除成功！');
                } catch (error) {
                    alert('删除成功！但云端同步失败，数据已保存到本地。');
                }
            } catch (error) {
                logger.error('应用删除失败', {
                    appId: appId,
                    error: error.message,
                    operation: '应用管理失败'
                });
                alert('删除失败: ' + error.message);
            }
        }

        // 显示我的应用
        function showMyApps() {
            if (!currentUser) {
                alert('请先登录');
                return;
            }

            // 验证用户状态完整性
            if (!currentUser.id || !currentUser.username) {
                alert('用户状态异常，请重新登录');
                logout();
                return;
            }

            const myApps = cloudData.apps.filter(app => app.authorId === currentUser.id);
            displayApps(myApps, true);
        }

        // 显示我的收藏
        function showMyFavorites() {
            if (!currentUser) {
                alert('请先登录');
                return;
            }

            // 验证用户状态完整性
            if (!currentUser.id || !currentUser.username) {
                alert('用户状态异常，请重新登录');
                logout();
                return;
            }

            const myFavorites = cloudData.apps.filter(app => 
                app.favorites && app.favorites.includes(currentUser.id)
            );
            displayApps(myFavorites, false);
        }

        // 点赞功能
        async function toggleLike(appId) {
            if (!currentUser) {
                alert('请先登录');
                return;
            }

            // 验证用户状态完整性
            if (!currentUser.id || !currentUser.username) {
                alert('用户状态异常，请重新登录');
                logout();
                return;
            }

            // 验证用户在云端数据中的存在性
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('用户数据同步异常，请重新登录');
                logout();
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.likes) app.likes = [];

                const likedIndex = app.likes.indexOf(currentUser.id);
                const isLiking = likedIndex === -1;
                
                if (likedIndex > -1) {
                    app.likes.splice(likedIndex, 1);
                } else {
                    app.likes.push(currentUser.id);
                }

                // 🔥 步骤6: 更新应用最后修改时间
                updateAppLastModified(appId, isLiking ? '点赞' : '取消点赞');

                // 🔥 步骤8: 立即保存到本地存储
                localStorageManager.saveToLocal(cloudData);
                
                // 🔥 步骤9: 立即更新UI
                loadApps();
                
                // 🔥 步骤23: 异步同步到云端（不阻塞用户体验）
                updateStatus('☁️ 正在同步点赞数据...', 'syncing');
                
                // 使用重试机制进行同步
                retryOperation('点赞同步', syncData).then(() => {
                    updateStatus('☁️ 点赞同步成功', 'connected');
                }).catch((error) => {
                    console.error('点赞同步最终失败:', error);
                    updateStatus('⚠️ 点赞已保存本地，云端同步失败', 'error');
                });

                // 记录点赞操作
                logger.info('点赞操作', {
                    appId: appId,
                    appName: app.name,
                    action: isLiking ? '点赞' : '取消点赞',
                    authorId: app.authorId,
                    operation: '用户互动'
                });

            } catch (error) {
                logger.error('点赞操作失败', {
                    appId: appId,
                    error: error.message,
                    operation: '用户互动失败'
                });
                alert('操作失败: ' + error.message);
            }
        }

        // 收藏功能
        async function toggleFavorite(appId) {
            if (!currentUser) {
                alert('请先登录');
                return;
            }

            // 验证用户状态完整性
            if (!currentUser.id || !currentUser.username) {
                alert('用户状态异常，请重新登录');
                logout();
                return;
            }

            // 验证用户在云端数据中的存在性
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('用户数据同步异常，请重新登录');
                logout();
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.favorites) app.favorites = [];

                const favoritedIndex = app.favorites.indexOf(currentUser.id);
                const isFavoriting = favoritedIndex === -1;
                
                if (favoritedIndex > -1) {
                    app.favorites.splice(favoritedIndex, 1);
                } else {
                    app.favorites.push(currentUser.id);
                }

                // 🔥 步骤7: 更新应用最后修改时间
                updateAppLastModified(appId, isFavoriting ? '收藏' : '取消收藏');

                // 🔥 步骤12: 立即保存到本地存储
                localStorageManager.saveToLocal(cloudData);
                
                // 🔥 步骤12: 立即更新UI
                loadApps();
                
                // 🔥 步骤23: 异步同步到云端（不阻塞用户体验）
                updateStatus('☁️ 正在同步收藏数据...', 'syncing');
                
                // 使用重试机制进行同步
                retryOperation('收藏同步', syncData).then(() => {
                    updateStatus('☁️ 收藏同步成功', 'connected');
                }).catch((error) => {
                    console.error('收藏同步最终失败:', error);
                    updateStatus('⚠️ 收藏已保存本地，云端同步失败', 'error');
                });

                // 记录收藏操作
                logger.info('收藏操作', {
                    appId: appId,
                    appName: app.name,
                    action: isFavoriting ? '收藏' : '取消收藏',
                    authorId: app.authorId,
                    operation: '用户互动'
                });

            } catch (error) {
                logger.error('收藏操作失败', {
                    appId: appId,
                    error: error.message,
                    operation: '用户互动失败'
                });
                alert('操作失败: ' + error.message);
            }
        }

        // 显示/隐藏评论
        function showComments(appId) {
            const commentsSection = document.getElementById(`comments-${appId}`);
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
            } else {
                commentsSection.style.display = 'none';
            }
        }

        // 添加评论
        async function addComment(appId) {
            if (!currentUser) {
                alert('请先登录');
                return;
            }

            // 验证用户状态完整性
            if (!currentUser.id || !currentUser.username) {
                alert('用户状态异常，请重新登录');
                logout();
                return;
            }

            // 验证用户在云端数据中的存在性
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('用户数据同步异常，请重新登录');
                logout();
                return;
            }

            const input = document.getElementById(`comment-input-${appId}`);
            const content = input.value.trim();
            
            if (!content) {
                alert('请输入评论内容');
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.comments) app.comments = [];

                const newComment = {
                    id: Date.now(),
                    content,
                    author: currentUser.username,
                    authorId: currentUser.id,
                    createdAt: new Date().toISOString()
                };

                app.comments.push(newComment);
                input.value = '';

                // 🔥 步骤8: 更新应用最后修改时间
                updateAppLastModified(appId, '添加评论');

                // 🔥 步骤13: 立即保存到本地存储
                localStorageManager.saveToLocal(cloudData);
                
                // 🔥 步骤13: 立即更新UI
                loadApps();
                
                // 🔥 步骤23: 异步同步到云端（不阻塞用户体验）
                updateStatus('☁️ 正在同步评论数据...', 'syncing');
                
                // 使用重试机制进行同步
                retryOperation('评论同步', syncData).then(() => {
                    updateStatus('☁️ 评论同步成功', 'connected');
                }).catch((error) => {
                    console.error('评论同步最终失败:', error);
                    updateStatus('⚠️ 评论已保存本地，云端同步失败', 'error');
                });

                // 记录评论操作
                logger.info('添加评论', {
                    appId: appId,
                    appName: app.name,
                    commentId: newComment.id,
                    commentContent: content.substring(0, 50) + (content.length > 50 ? '...' : ''),
                    authorId: app.authorId,
                    operation: '用户互动'
                });

            } catch (error) {
                logger.error('添加评论失败', {
                    appId: appId,
                    error: error.message,
                    operation: '用户互动失败'
                });
                alert('评论失败: ' + error.message);
            }
        }

        // 删除评论
        async function deleteComment(appId, commentId) {
            if (!currentUser) {
                alert('请先登录');
                return;
            }

            // 验证用户状态完整性
            if (!currentUser.id || !currentUser.username) {
                alert('用户状态异常，请重新登录');
                logout();
                return;
            }

            // 验证用户在云端数据中的存在性
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('用户数据同步异常，请重新登录');
                logout();
                return;
            }

            if (!confirm('确定要删除这条评论吗？')) return;

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app || !app.comments) return;

                const comment = app.comments.find(c => c.id === commentId);
                if (!comment || comment.authorId !== currentUser.id) {
                    alert('只能删除自己的评论');
                    return;
                }

                app.comments = app.comments.filter(c => c.id !== commentId);

                // 记录删除评论操作
                logger.info('删除评论', {
                    appId: appId,
                    appName: app.name,
                    commentId: commentId,
                    deletedContent: comment.content.substring(0, 50) + (comment.content.length > 50 ? '...' : ''),
                    authorId: app.authorId,
                    operation: '用户互动'
                });

                // 本地优先策略：立即更新UI和本地缓存
                localCache.saveToLocal(cloudData);
                loadApps(); // 立即更新UI，用户看到即时效果
                
                // 添加到异步同步队列
                await syncQueue.addOperation({
                    type: 'comment_delete',
                    appId: appId,
                    userId: currentUser.id,
                    commentId: commentId,
                    action: '删除评论',
                    data: {
                        appName: app.name,
                        deletedContent: comment.content.substring(0, 50) + (comment.content.length > 50 ? '...' : ''),
                        authorId: app.authorId
                    }
                });

                // 显示操作完成状态
                updateStatus('✅ 评论已删除', 'connected');
            } catch (error) {
                logger.error('删除评论失败', {
                    appId: appId,
                    commentId: commentId,
                    error: error.message,
                    operation: '用户互动失败'
                });
                alert('删除失败: ' + error.message);
            }
        }

        // 移动端菜单控制
        function toggleMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            const isOpen = menu.classList.contains('active');
            
            if (isOpen) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            hamburger.classList.add('active');
            overlay.style.display = 'block';
            
            // 延迟添加active类以触发动画
            setTimeout(() => {
                overlay.classList.add('active');
                menu.classList.add('active');
            }, 10);
            
            // 禁止背景滚动
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            hamburger.classList.remove('active');
            overlay.classList.remove('active');
            menu.classList.remove('active');
            
            // 延迟隐藏遮罩层以完成动画
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            
            // 恢复背景滚动
            document.body.style.overflow = '';
        }

        // 显示导航
        function showGuestNav() {
            // 桌面端导航
            document.getElementById('guest-nav').style.display = 'flex';
            document.getElementById('user-nav').style.display = 'none';
            document.getElementById('publish-btn').style.display = 'none';
            
            // 移动端导航
            document.getElementById('mobile-guest-nav').style.display = 'block';
            document.getElementById('mobile-user-nav').style.display = 'none';
        }

        function showUserNav() {
            // 桌面端导航
            document.getElementById('guest-nav').style.display = 'none';
            document.getElementById('user-nav').style.display = 'flex';
            document.getElementById('publish-btn').style.display = 'block';

            if (currentUser) {
                // 桌面端用户信息
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
                
                // 移动端用户信息
                document.getElementById('mobile-user-name').textContent = currentUser.username;
                document.getElementById('mobile-user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
            }
            
            // 移动端导航
            document.getElementById('mobile-guest-nav').style.display = 'none';
            document.getElementById('mobile-user-nav').style.display = 'block';
        }

        // 模态框操作
        function showModal(modalId) {
            document.body.classList.add('no-scroll');
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.body.classList.remove('no-scroll');
            document.getElementById(modalId).style.display = 'none';
            
            // 如果是发布模态框，重置表单和状态
            if (modalId === 'publish-modal') {
                resetPublishModal();
                currentEditingAppId = null;
            }
        }

        function resetPublishModal() {
            document.getElementById('app-name').value = '';
            document.getElementById('app-url').value = '';
            document.getElementById('app-description').value = '';
            document.getElementById('app-category').value = '其他';
            document.getElementById('screenshot-upload').value = '';
            document.getElementById('screenshot-preview').innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">📸</div><div>选择截图方式</div></div>';
            
            // 重置截图方式为API生成
            document.querySelector('input[name="screenshot-method"][value="api"]').checked = true;
            toggleScreenshotMethod();
            
            // 重置截图准备状态为true（允许无截图发布）
            isScreenshotReady = true;
            updatePublishButtonState();
        }

        // 更新发布按钮状态
        function updatePublishButtonState() {
            const publishBtn = document.getElementById('save-app-btn');
            if (!publishBtn) return;
            
            const name = document.getElementById('app-name').value.trim();
            const url = document.getElementById('app-url').value.trim();
            const description = document.getElementById('app-description').value.trim();
            
            // 检查必填字段和截图状态
            const allFieldsValid = name && url && description;
            const hasScreenshot = hasScreenshotContent();
            const canPublish = allFieldsValid && (isScreenshotReady || !hasScreenshot);
            
            publishBtn.disabled = !canPublish;
            
            if (!canPublish) {
                publishBtn.style.opacity = '0.6';
                publishBtn.style.cursor = 'not-allowed';
                publishBtn.style.transform = 'none';
                publishBtn.style.boxShadow = 'none';
                
                if (!allFieldsValid) {
                    const missingFields = [];
                    if (!name) missingFields.push('名称');
                    if (!url) missingFields.push('链接');
                    if (!description) missingFields.push('描述');
                    publishBtn.textContent = `请填写: ${missingFields.join('、')}`;
                } else if (!isScreenshotReady && hasScreenshot) {
                    publishBtn.textContent = '⏳ 截图处理中...';
                }
            } else {
                publishBtn.style.opacity = '1';
                publishBtn.style.cursor = 'pointer';
                publishBtn.style.transform = '';
                publishBtn.style.boxShadow = '';
                publishBtn.textContent = currentEditingAppId ? '💾 保存更改' : '🚀 发布';
            }
        }

        // 检查是否有截图内容（但未准备就绪）
        function hasScreenshotContent() {
            const preview = document.getElementById('screenshot-preview');
            const hasImg = preview.querySelector('img');
            const hasLoading = preview.querySelector('.loading');
            return hasImg || hasLoading;
        }

        // 设置截图准备就绪状态
        function setScreenshotReady(ready = true) {
            isScreenshotReady = ready;
            updatePublishButtonState();
        }

        // 清除截图
        function clearScreenshot() {
            const preview = document.getElementById('screenshot-preview');
            const uploadInput = document.getElementById('screenshot-upload');
            
            // 重置预览区域
            preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">📸</div><div>选择截图方式</div></div>';
            
            // 清空文件输入
            if (uploadInput) {
                uploadInput.value = '';
            }
            
            // 重置截图状态为准备就绪（允许无截图发布）
            setScreenshotReady(true);
        }

        function showLogin() {
            showModal('login-modal');
        }

        function showRegister() {
            showModal('register-modal');
        }

        function showPublishModal() {
            currentEditingAppId = null;
            document.getElementById('publish-modal-title').textContent = '发布作品';
            document.getElementById('save-app-btn').textContent = '发布';
            
            // 确保URL字段可编辑
            document.getElementById('app-url').readOnly = false;
            document.getElementById('app-url').style.background = '';
            
            // 重置表单并显示模态框（resetPublishModal中已包含状态重置）
            resetPublishModal();
            showModal('publish-modal');
        }

        function showEditModal(appId) {
            currentEditingAppId = appId;
            const app = cloudData.apps.find(a => a.id === appId);
            if (!app) return;

            document.getElementById('publish-modal-title').textContent = '编辑作品';
            document.getElementById('save-app-btn').textContent = '保存更改';
            
            // 填充表单
            document.getElementById('app-name').value = app.name;
            document.getElementById('app-url').value = app.url;
            document.getElementById('app-description').value = app.description;
            document.getElementById('app-category').value = app.category;
            
            const preview = document.getElementById('screenshot-preview');
            if (app.screenshot && app.screenshot.trim()) {
                preview.innerHTML = `<img src="${app.screenshot}" alt="应用截图" data-url="${app.screenshot}">`;
                // 编辑模式下，如果已有截图，标记为准备就绪
                setScreenshotReady(true);
            } else {
                preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">📸</div><div>选择截图方式</div></div>';
                // 没有截图时，标记为准备就绪（可以不需要截图发布）
                setScreenshotReady(true);
            }

            // URL在编辑时不可更改
            document.getElementById('app-url').readOnly = true;
            document.getElementById('app-url').style.background = '#f1f1f1';

            // 更新发布按钮状态
            updatePublishButtonState();

            showModal('publish-modal');
        }

        // 处理登录
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!username || !password) {
                alert('请填写用户名和密码');
                return;
            }

            // 检查数据状态
            console.log('登录尝试:', username);

            // 确保cloudData已初始化
            if (!cloudData || !cloudData.users || cloudData.users.length === 0) {
                logger.warn('登录时发现cloudData未初始化，尝试重新加载', {
                    username: username,
                    cloudDataExists: !!cloudData,
                    usersExists: !!(cloudData?.users),
                    operation: '登录数据检查'
                });
                
                // 尝试重新加载数据
                try {
                    updateStatus('🔄 正在加载用户数据...', 'syncing');
                    const remoteData = await cloudStorage.loadData();
                    if (remoteData && remoteData.users) {
                        cloudData = remoteData;
                        logger.info('重新加载数据成功', { 
                            usersCount: cloudData.users.length,
                            operation: '登录时数据重载'
                        });
                    }
                } catch (error) {
                    logger.error('重新加载数据失败', { 
                        error: error.message,
                        operation: '登录时数据重载失败'
                    });
                    alert('数据加载失败，请刷新页面重试');
                    return;
                }
            }

            const user = cloudData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showUserNav();
                closeModal('login-modal');
                
                // 🔥 步骤2: 重新加载应用列表以更新互动按钮状态
                loadApps();
                
                alert('登录成功！');
                
                // 登录成功后刷新应用列表，确保显示最新数据
                loadApps();
            } else {
                logger.warn('登录失败', {
                    username: username,
                    availableUsers: cloudData.users.map(u => u.username),
                    operation: '登录失败'
                });
                alert('用户名或密码错误');
            }
        }

        // 处理注册
        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();



            if (!username || !email || !password) {
                alert('请填写所有字段');
                return;
            }

            if (password.length < 6) {
                alert('密码至少需要6个字符');
                return;
            }

            // 检查用户名是否已存在
            if (cloudData.users.some(u => u.username === username)) {
                alert('用户名已存在');
                return;
            }

            // 检查邮箱是否已存在
            if (cloudData.users.some(u => u.email === email)) {
                alert('邮箱已存在');
                return;
            }

            let newUser;
            try {
                newUser = {
                    id: Date.now(),
                    username,
                    email,
                    password,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString() // 🔥 步骤11: 初始化新用户的lastModified字段
                };

                // 在添加用户前创建快照
                try {
                    logger.snapshot('用户注册前快照', cloudData.users, {
                        snapshotType: 'users_before_add',
                        operation: '用户注册前',
                        usersCount: cloudData.users.length,
                        newUsername: username
                    });
                } catch (snapshotError) {
                    logger.warn('创建用户注册前快照失败，继续执行注册', { 
                        username: username, 
                        error: snapshotError.message 
                    });
                }

                // 添加用户到本地数据
                cloudData.users.push(newUser);
                
                // 🔥 步骤24: 立即保存到本地存储（确保数据不丢失）
                localStorageManager.saveToLocal(cloudData);
                
                // 立即设置当前用户和本地存储（确保即使同步失败也能保持登录状态）
                currentUser = newUser;
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                showUserNav();
                closeModal('register-modal');
                updateStats();
                
                // 🔥 步骤1: 重新加载应用列表以更新互动按钮状态
                loadApps();

                // 尝试同步到云端，但不阻塞用户体验
                updateStatus('☁️ 正在保存用户数据...', 'syncing');
                
                try {
                    await syncData();
                    alert('注册成功！用户数据已同步到云端');
                } catch (syncError) {
                    console.error('用户数据同步失败:', syncError);
                    alert('注册成功！但数据同步失败，数据已保存到本地。请检查网络连接。');
                    updateStatus('⚠️ 数据仅保存在本地', 'error');
                    
                    // 设置定时重试同步
                    setTimeout(async () => {
                        try {
                            await syncData();
                            updateStatus('☁️ 数据同步成功', 'connected');
                        } catch (retryError) {
                            console.error('重试同步失败:', retryError);
                        }
                    }, 5000); // 5秒后重试
                }

            } catch (error) {
                // 移除已添加的用户数据（如果添加失败）
                cloudData.users = cloudData.users.filter(u => u.id !== newUser?.id);
                alert('注册失败: ' + error.message);
            }
        }

        // 处理发布/编辑应用
        async function handleSaveApp() {
            const name = document.getElementById('app-name').value.trim();
            const url = document.getElementById('app-url').value.trim();
            const description = document.getElementById('app-description').value.trim();
            const category = document.getElementById('app-category').value;

            if (!name || !url || !description) {
                alert('请填写所有必需字段');
                return;
            }

            // 记录应用保存操作开始
            const operationType = currentEditingAppId ? '编辑应用' : '发布新应用';
            logger.info(`${operationType}操作开始`, {
                appId: currentEditingAppId,
                appName: name,
                appUrl: url,
                category: category,
                operation: operationType
            });

            // 获取截图数据
            const previewImg = document.querySelector('#screenshot-preview img');
            let screenshot = '';
            
            if (previewImg) {
                // 只使用 data-url 属性，确保只存储URL
                const urlData = previewImg.getAttribute('data-url');
                const base64Data = previewImg.getAttribute('data-base64');
                
                if (urlData) {
                    screenshot = urlData;
                    logger.info('使用已上传的截图URL', { screenshotUrl: urlData, source: '外部存储' });
                } else if (base64Data) {
                    // 如果存在Base64数据，先上传后获取URL
                    logger.info('检测到Base64截图数据，开始上传', { source: 'Base64转换' });
                    try {
                        screenshot = await uploadImageToStorage(base64Data, true);
                        logger.info('Base64截图上传成功', { screenshotUrl: screenshot });
                    } catch (error) {
                        logger.error('Base64截图上传失败', { error: error.message });
                        console.error('上传截图失败:', error);
                        alert('截图上传失败，请重新选择截图');
                        return;
                    }
                }
            }
            
            // 记录截图来源信息
            const screenshotSource = previewImg ? 
                (previewImg.getAttribute('data-url') ? '外部存储URL' : 
                 previewImg.getAttribute('data-base64') ? 'API生成截图' : '无截图') : '无截图';
            logger.info('截图信息确认', { 
                hasScreenshot: !!screenshot, 
                source: screenshotSource,
                screenshotUrl: screenshot ? screenshot.substring(0, 100) + '...' : null 
            });
            
            // 在数据修改前创建快照
            try {
                if (currentEditingAppId) {
                    // 编辑模式：保存修改前的应用数据
                    const originalApp = cloudData.apps.find(a => a.id === currentEditingAppId);
                    if (originalApp) {
                        logger.snapshot(`编辑应用前快照: ${originalApp.name}`, originalApp, {
                            snapshotType: 'app_edit_before',
                            appId: currentEditingAppId,
                            operation: '应用编辑前'
                        });
                    }
                } else {
                    // 发布新应用模式：保存添加前的apps数组状态
                    logger.snapshot('发布新应用前快照', cloudData.apps, {
                        snapshotType: 'apps_before_add',
                        operation: '新应用发布前',
                        appsCount: cloudData.apps.length
                    });
                }
            } catch (snapshotError) {
                logger.warn('创建数据快照失败，继续执行操作', { error: snapshotError.message });
            }
            
            try {
                if (currentEditingAppId) {
                    // 编辑模式
                    const app = cloudData.apps.find(a => a.id === currentEditingAppId);
                    if (app) {
                        app.name = name;
                        app.description = description;
                        app.category = category;
                        app.screenshot = screenshot;
                        app.lastModified = new Date().toISOString(); // 🔥 步骤10: 更新编辑应用的lastModified
                    }
                } else {
                    // 发布新应用模式
                    const newApp = {
                        id: Date.now(),
                        name,
                        url,
                        description,
                        category,
                        author: currentUser.username,
                        authorId: currentUser.id,
                        screenshot,
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString() // 🔥 步骤9: 初始化lastModified字段
                    };
                    cloudData.apps.push(newApp);
                }

                // 🔥 步骤24: 立即保存到本地存储（确保数据不丢失）
                localStorageManager.saveToLocal(cloudData);
                
                // 先更新UI，确保用户能立即看到变化
                closeModal('publish-modal');
                updateStats();
                loadApps();

                // 添加到异步同步队列
                await syncQueue.addOperation({
                    type: currentEditingAppId ? 'app_edit' : 'app_publish',
                    appId: currentEditingAppId || Date.now(),
                    userId: currentUser.id,
                    action: currentEditingAppId ? '编辑应用' : '发布应用',
                    data: {
                        appName: name,
                        appUrl: url,
                        category: category,
                        hasScreenshot: !!screenshot
                    }
                });

                // 显示操作完成状态
                updateStatus(currentEditingAppId ? '✅ 应用已更新' : '✅ 应用已发布', 'connected');
                alert(currentEditingAppId ? '应用更新成功！' : '应用发布成功！');

            } catch (error) {
                alert('操作失败: ' + error.message);
            } finally {
                currentEditingAppId = null; // 操作完成后重置
            }
        }

        // 统一图片上传处理函数
        async function uploadImageToStorage(imageData, isBase64 = false) {
            logger.info('开始图片上传处理', { 
                dataType: isBase64 ? 'Base64' : 'URL',
                dataSize: imageData ? imageData.length : 0,
                operation: '图片上传'
            });
            
            try {
                let base64Payload;
                
                if (isBase64) {
                    // 如果已经是Base64，提取payload部分
                    if (imageData.startsWith('data:')) {
                        base64Payload = imageData.split(',')[1];
                    } else {
                        base64Payload = imageData;
                    }
                } else {
                    // 如果是URL，先转换为Base64
                    const response = await fetch(imageData);
                    const blob = await response.blob();
                    
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            base64Payload = e.target.result.split(',')[1];
                            
                            try {
                                const res = await fetch('/.netlify/functions/upload-image', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ image: base64Payload })
                                });
                                const result = await res.json();
                                if (!res.ok) throw new Error(result.error || 'Upload failed');
                                resolve(result.url);
                            } catch (err) {
                                reject(err);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                }
                
                // 上传Base64数据
                const res = await fetch('/.netlify/functions/upload-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Payload })
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Upload failed');
                
                logger.info('图片上传成功', { 
                    uploadedUrl: result.url,
                    operation: '图片上传成功'
                });
                return result.url;
            } catch (error) {
                logger.error('图片上传失败', { 
                    error: error.message,
                    operation: '图片上传失败'
                });
                console.error('上传图片失败:', error);
                throw error;
            }
        }

        // 生成截图
        function generateScreenshot() {
            const url = document.getElementById('app-url').value.trim();
            if (!url) {
                alert('请先填写"作品链接"字段，然后再生成截图');
                return;
            }

            // 验证URL格式
            try {
                new URL(url);
            } catch (e) {
                alert('请输入有效的网址链接（如：https://example.com）');
                return;
            }

            // 设置截图未准备就绪状态
            setScreenshotReady(false);

            // 记录截图API调用开始
            logger.info('开始调用截图API', { 
                targetUrl: url, 
                timestamp: new Date().toISOString(),
                operation: '自动生成截图'
            });

            const preview = document.getElementById('screenshot-preview');
            preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">正在生成截图...</span>';

            // 使用多个备用截图服务
            const screenshotServices = [
                `/.netlify/functions/screenshot-proxy?url=${encodeURIComponent(url)}`,
                `https://image.thum.io/get/width/1200/crop/800/noanimate/${encodeURIComponent(url)}`,
                `https://mini.s-shot.ru/1200x800/PNG/?${encodeURIComponent(url)}`
            ];

            let currentServiceIndex = 0;

            function tryNextService() {
                if (currentServiceIndex >= screenshotServices.length) {
                    logger.error('所有截图服务都失败', { 
                        targetUrl: url, 
                        attemptedServices: screenshotServices.length,
                        operation: '截图API调用失败'
                    });
                    preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">❌</div><div>截图生成失败，请手动上传图片</div></div>';
                    
                    // 所有截图服务都失败，截图未准备就绪
                    setScreenshotReady(false);
                    return;
                }

                const screenshotUrl = screenshotServices[currentServiceIndex];
                logger.info(`尝试截图服务 ${currentServiceIndex + 1}`, { 
                    service: screenshotUrl, 
                    serviceIndex: currentServiceIndex,
                    operation: '截图服务调用'
                });
                const img = new Image();
                
                img.onload = function() {
                    preview.innerHTML = `<img src="${screenshotUrl}" alt="网站截图">`;
                    
                    // 显示转换状态
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(255,149,0,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                    statusDiv.textContent = '正在优化截图...';
                    preview.style.position = 'relative';
                    preview.appendChild(statusDiv);
                    
                    // 上传截图到外部存储
                    uploadImageToStorage(screenshotUrl, false).then(function(uploadedUrl) {
                        // 移除状态提示
                        if (statusDiv.parentNode) {
                            statusDiv.remove();
                        }
                        
                        if (uploadedUrl) {
                            // 如果上传成功，设置URL并标记截图准备就绪
                            logger.info('截图生成并上传成功', { 
                                service: screenshotUrl, 
                                serviceIndex: currentServiceIndex,
                                uploadedUrl: uploadedUrl,
                                operation: '截图API成功'
                            });
                            const previewImg = preview.querySelector('img');
                            if (previewImg) {
                                previewImg.setAttribute('data-url', uploadedUrl);
                                
                                // 显示成功状态
                                const successDiv = document.createElement('div');
                                successDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(40,167,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                                successDiv.textContent = '✓ 截图已就绪';
                                preview.appendChild(successDiv);
                                
                                // 设置截图准备就绪
                                setScreenshotReady(true);
                                
                                // 3秒后移除成功提示
                                setTimeout(() => {
                                    if (successDiv.parentNode) {
                                        successDiv.remove();
                                    }
                                }, 3000);
                            }
                        } else {
                            // 上传失败，截图未准备就绪
                            logger.warn('截图生成成功但上传失败', { 
                                service: screenshotUrl, 
                                serviceIndex: currentServiceIndex,
                                operation: '截图上传失败'
                            });
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(220,53,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                            errorDiv.textContent = '⚠ 截图上传失败';
                            preview.appendChild(errorDiv);
                            
                            // 截图上传失败，保持未准备就绪状态
                            setScreenshotReady(false);
                            
                            // 5秒后移除错误提示
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    }).catch(function(error) {
                        // 移除状态提示
                        if (statusDiv.parentNode) {
                            statusDiv.remove();
                        }
                        
                        logger.error('截图上传异常', { 
                            service: screenshotUrl, 
                            serviceIndex: currentServiceIndex,
                            error: error.message,
                            operation: '截图上传异常'
                        });
                        console.error('截图上传失败:', error);
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(220,53,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                        errorDiv.textContent = '⚠ 截图上传失败';
                        preview.appendChild(errorDiv);
                        
                        // 截图上传失败，保持未准备就绪状态
                        setScreenshotReady(false);
                        
                        // 5秒后移除错误提示
                        setTimeout(() => {
                            if (errorDiv.parentNode) {
                                errorDiv.remove();
                            }
                        }, 5000);
                    });
                };
                
                img.onerror = function() {
                    logger.warn(`截图服务 ${currentServiceIndex + 1} 失败`, { 
                        service: screenshotUrl, 
                        serviceIndex: currentServiceIndex,
                        operation: '截图服务失败',
                        nextAttempt: currentServiceIndex + 1 < screenshotServices.length
                    });
                    console.log(`截图服务 ${currentServiceIndex + 1} 失败: ${screenshotUrl}`);
                    currentServiceIndex++;
                    setTimeout(tryNextService, 1000);
                };
                
                img.src = screenshotUrl;
            }

            setTimeout(tryNextService, 2000);
        }

        // 切换截图方式
        function toggleScreenshotMethod() {
            const apiSection = document.getElementById('screenshot-api-section');
            const uploadSection = document.getElementById('screenshot-upload-section');
            const selectedMethod = document.querySelector('input[name="screenshot-method"]:checked').value;

            if (selectedMethod === 'api') {
                apiSection.style.display = 'block';
                uploadSection.style.display = 'none';
            } else {
                apiSection.style.display = 'none';
                uploadSection.style.display = 'block';
            }
        }

        // 处理图片上传
        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // 设置截图未准备就绪状态
            setScreenshotReady(false);

            // 记录手动上传开始
            logger.info('用户开始手动上传图片', { 
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                operation: '手动上传图片'
            });

            if (!file.type.startsWith('image/')) {
                logger.warn('用户尝试上传非图片文件', { fileName: file.name, fileType: file.type });
                alert('请选择图片文件');
                // 上传失败，保持未准备就绪状态
                setScreenshotReady(false);
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB 初始限制，后续会自动压缩
                logger.warn('用户上传文件过大', { fileName: file.name, fileSize: file.size });
                alert('图片文件不能超过10MB');
                // 上传失败，保持未准备就绪状态
                setScreenshotReady(false);
                return;
            }
            
            const preview = document.getElementById('screenshot-preview');
            preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">正在压缩图片...</span>';

            const options = {
                maxSizeMB: 0.2, // 压缩到约200KB
                maxWidthOrHeight: 1024,
                fileType: 'image/jpeg',
                useWebWorker: true,
                onProgress: (p) => {
                    const progressSpan = preview.querySelector('span');
                    if (progressSpan) {
                        progressSpan.textContent = `正在压缩图片... ${p}%`;
                    }
                },
            };

            try {
                const compressedFile = await imageCompression(file, options);
                
                logger.info('图片压缩成功', { 
                    originalSize: file.size,
                    compressedSize: compressedFile.size,
                    compressionRatio: Math.round((1 - compressedFile.size / file.size) * 100),
                    operation: '图片压缩成功'
                });
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64DataFull = e.target.result;
                    const base64Payload = base64DataFull.split(',')[1];

                    preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">正在上传图片...</span>';

                    try {
                        const res = await fetch('/.netlify/functions/upload-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: base64Payload })
                        });
                        const result = await res.json();
                        if (!res.ok) throw new Error(result.error || 'Upload failed');

                        const imgUrl = result.url;
                        logger.info('手动上传图片成功', { 
                            uploadedUrl: imgUrl,
                            finalSize: compressedFile.size,
                            operation: '手动上传成功'
                        });
                        const img = `<img src="${imgUrl}" alt="上传的截图" data-url="${imgUrl}">`;
                        preview.innerHTML = img;

                        // 图片上传成功，设置截图准备就绪
                        setScreenshotReady(true);

                    } catch (err) {
                        logger.error('手动上传图片失败', { 
                            error: err.message,
                            operation: '手动上传失败'
                        });
                        console.error(err);
                        alert('图片上传失败');
                        preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">❌</div><div>上传失败</div></div>';
                        
                        // 图片上传失败，保持未准备就绪状态
                        setScreenshotReady(false);
                    }
                };
                reader.readAsDataURL(compressedFile);

            } catch (error) {
                console.error(error);
                alert('图片压缩失败，请尝试其他图片或换个浏览器。');
                preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">❌</div><div>压缩失败</div></div>';
                
                // 图片压缩失败，保持未准备就绪状态
                setScreenshotReady(false);
            }
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showGuestNav();
            loadApps();
        }

        // 重置所有搜索条件
        function resetSearchConditions() {
            // 桌面端
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');
            const sortFilter = document.getElementById('sort-filter');
            
            if (searchInput) searchInput.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (sortFilter) sortFilter.value = 'newest';
            
            // 移动端
            const searchInputMobile = document.getElementById('search-input-mobile');
            const categoryFilterMobile = document.getElementById('category-filter-mobile');
            const sortFilterMobile = document.getElementById('sort-filter-mobile');
            
            if (searchInputMobile) searchInputMobile.value = '';
            if (categoryFilterMobile) categoryFilterMobile.value = '';
            if (sortFilterMobile) sortFilterMobile.value = 'newest';

            // 重置自定义下拉菜单的显示状态
            updateDropdownSelection('category', '');
            updateDropdownSelection('sort', 'newest');
            updateDropdownSelection('category-mobile', '');
            updateDropdownSelection('sort-mobile', 'newest');
        }

        // 返回首页
        function goHome() {
            resetSearchConditions();
            loadApps();
        }

        // 刷新数据
        async function forceRefreshData() {
            try {
                updateStatus('🔄 正在刷新...', 'syncing');
                
                // 清除本地缓存
                localCache.clearPendingOperations();
                localStorage.removeItem('beestoreCloudData');
                localStorage.removeItem('beestoreCloudMeta');
                
                // 重新加载云端数据
                const remoteData = await cloudStorage.loadData();
                
                if (remoteData && remoteData.users && Array.isArray(remoteData.users)) {
                    cloudData = remoteData;
                    localCache.saveToLocal(cloudData);
                    
                    // 重新初始化界面
                    initializeInterface();
                    
                    logger.info('刷新数据成功', {
                        usersCount: cloudData.users?.length || 0,
                        appsCount: cloudData.apps?.length || 0,
                        operation: '刷新数据'
                    });
                    
                    updateStatus('📱 已连接', 'connected');
                } else {
                    throw new Error('数据格式异常');
                }
            } catch (error) {
                logger.error('刷新数据失败', {
                    error: error.message,
                    operation: '刷新失败'
                });
                updateStatus('📱 已连接', 'connected');
            }
        }



        // 窗口大小改变时处理
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1024) {
                // 桌面端模式下关闭移动端菜单
                closeMobileMenu();
            }
        });

        // 键盘事件处理
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });

        // 自定义下拉菜单功能
        function toggleDropdown(type) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            const isShow = dropdown.classList.contains('show');
            
            // 关闭所有其他下拉菜单
            closeAllDropdowns();
            
            if (!isShow) {
                dropdown.classList.add('show');
                trigger.classList.add('active');
                
                // 添加点击事件到下拉菜单项
                const items = dropdown.querySelectorAll('.dropdown-item');
                items.forEach(item => {
                    item.onclick = function() {
                        selectDropdownItem(type, this);
                    };
                });
            }
        }

        function selectDropdownItem(type, item) {
            const value = item.getAttribute('data-value');
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            
            // 更新选中状态
            dropdown.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            // 更新隐藏的select值
            if (type.includes('category')) {
                const selectId = type.includes('mobile') ? 'category-filter-mobile' : 'category-filter';
                document.getElementById(selectId).value = value;
                
                // 更新按钮图标（可选）
                if (value) {
                    const emoji = item.textContent.split(' ')[0]; // 获取emoji
                    trigger.textContent = emoji;
                } else {
                    trigger.textContent = '🏷️';
                }
            } else if (type.includes('sort')) {
                const selectId = type.includes('mobile') ? 'sort-filter-mobile' : 'sort-filter';
                document.getElementById(selectId).value = value;
                
                // 更新按钮图标
                if (value === 'newest' || value === 'oldest') {
                    trigger.textContent = '📅';
                } else if (value === 'name') {
                    trigger.textContent = '🔤';
                } else if (value === 'author') {
                    trigger.textContent = '👤';
                }
            }
            
            // 关闭下拉菜单
            dropdown.classList.remove('show');
            trigger.classList.remove('active');
            
            // 触发搜索
            searchApps();
        }

        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            const triggers = document.querySelectorAll('.dropdown-trigger');
            
            dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
            triggers.forEach(trigger => trigger.classList.remove('active'));
        }

        // 点击外部关闭下拉菜单
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-dropdown')) {
                closeAllDropdowns();
            }
        });

        // 同步桌面端和移动端的筛选器选择
        function syncCustomDropdowns() {
            // 同步分类选择
            const categoryDesktop = document.getElementById('category-filter').value;
            const categoryMobile = document.getElementById('category-filter-mobile').value;
            
            if (categoryDesktop !== categoryMobile) {
                // 更新移动端
                updateDropdownSelection('category-mobile', categoryDesktop);
                document.getElementById('category-filter-mobile').value = categoryDesktop;
            }
            
            // 同步排序选择
            const sortDesktop = document.getElementById('sort-filter').value;
            const sortMobile = document.getElementById('sort-filter-mobile').value;
            
            if (sortDesktop !== sortMobile) {
                // 更新移动端
                updateDropdownSelection('sort-mobile', sortDesktop);
                document.getElementById('sort-filter-mobile').value = sortDesktop;
            }
        }

        function updateDropdownSelection(type, value) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            
            if (!dropdown || !trigger) return;
            
            // 更新选中状态
            dropdown.querySelectorAll('.dropdown-item').forEach(i => {
                i.classList.remove('selected');
                if (i.getAttribute('data-value') === value) {
                    i.classList.add('selected');
                    
                    // 更新按钮图标
                    if (type.includes('category')) {
                        if (value) {
                            const emoji = i.textContent.split(' ')[0];
                            trigger.textContent = emoji;
                        } else {
                            trigger.textContent = '🏷️';
                        }
                    } else if (type.includes('sort')) {
                        if (value === 'newest' || value === 'oldest') {
                            trigger.textContent = '📅';
                        } else if (value === 'name') {
                            trigger.textContent = '🔤';
                        } else if (value === 'author') {
                            trigger.textContent = '👤';
                        }
                    }
                }
            });
        }

        // 日志查看功能
        let currentLogTab = 'local'; // 当前选中的日志选项卡

        function showLogViewer() {
            // 只有admin账号可以查看日志
            if (!currentUser || currentUser.username !== 'admin') {
                alert('您没有权限查看系统日志，仅限admin账号访问');
                return;
            }
            
            showModal('log-viewer-modal');
            // 启动重试机制
            logger.retryFailedLogs().catch(e => console.warn('重试失败日志时出错:', e));
            refreshLogs();
        }

        function switchLogTab(tab) {
            currentLogTab = tab;
            
            // 更新选项卡样式
            document.getElementById('local-logs-tab').classList.toggle('active', tab === 'local');
            document.getElementById('cloud-logs-tab').classList.toggle('active', tab === 'cloud');
            
            // 刷新日志内容
            refreshLogs();
        }

        async function refreshLogs() {
            const levelFilter = document.getElementById('log-level-filter').value;
            const usernameFilter = document.getElementById('log-username-filter').value.trim();
            const logContent = document.getElementById('log-content');
            
            // 显示加载状态
            logContent.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;"><div class="loading" style="margin: 0 auto;"></div><br/>正在加载日志...</div>';
            
            let logs = [];
            
            try {
                if (currentLogTab === 'cloud') {
                    // 获取云端日志
                    logs = await logger.getCloudLogs(200, levelFilter || null, usernameFilter || null);
                } else {
                    // 获取本地日志
                    logs = logger.getLogs(200, levelFilter || null, usernameFilter || null);
                }
            } catch (error) {
                logContent.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 2rem;">
                    <div style="font-size: 2rem;">❌</div>
                    <div>加载日志失败: ${error.message}</div>
                    <button onclick="refreshLogs()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">重试</button>
                </div>`;
                return;
            }
            
            if (logs.length === 0) {
                const tabName = currentLogTab === 'cloud' ? '云端' : '本地';
                logContent.innerHTML = `<div style="text-align: center; color: #666; padding: 2rem;">暂无${tabName}日志记录</div>`;
                return;
            }
            
            const logHtml = logs.map(log => {
                const levelColor = {
                    'INFO': '#28a745',
                    'WARN': '#ffc107', 
                    'ERROR': '#dc3545'
                }[log.level] || '#6c757d';
                
                const timeStr = new Date(log.timestamp).toLocaleString('zh-CN');
                const dataStr = log.data ? JSON.stringify(log.data, null, 2) : '';
                
                // 检查是否包含快照ID
                const hasSnapshot = log.data && log.data.snapshotId && log.message.includes('数据快照已创建');
                const snapshotButton = hasSnapshot ? 
                    `<button onclick="openSnapshotFromLog('${log.data.snapshotId}')" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">📸 查看快照</button>` : '';
                
                // 云端日志额外信息
                const isCloudLog = currentLogTab === 'cloud' && log.deviceInfo;
                const cloudBadge = isCloudLog ? '<span style="margin-left: 0.5rem; background: #17a2b8; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">🌐 云端</span>' : '';
                const deviceInfo = isCloudLog ? 
                    `<div style="margin-bottom: 0.25rem; font-size: 0.85rem; color: #666;">
                        <strong>设备信息:</strong> ${log.deviceInfo.userAgent.split(' ')[0]}... | 
                        <strong>页面:</strong> ${new URL(log.deviceInfo.url).pathname}
                    </div>` : '';
                
                return `
                    <div style="margin-bottom: 1rem; padding: 0.5rem; border-left: 4px solid ${levelColor}; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                            <div style="display: flex; align-items: center;">
                                <span style="font-weight: bold; color: ${levelColor};">[${log.level}]</span>
                                ${cloudBadge}
                                ${hasSnapshot ? '<span style="margin-left: 0.5rem; background: #17a2b8; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">📸 快照</span>' : ''}
                            </div>
                            <span style="color: #666; font-size: 0.8rem;">${timeStr}</span>
                        </div>
                        <div style="margin-bottom: 0.25rem;">
                            <strong>用户:</strong> ${log.user.username} (ID: ${log.user.id})
                        </div>
                        ${deviceInfo}
                        <div style="margin-bottom: 0.25rem; display: flex; align-items: center;">
                            <strong>消息:</strong> ${log.message}
                            ${snapshotButton}
                        </div>
                        ${dataStr ? `<details style="margin-top: 0.5rem;"><summary style="cursor: pointer; color: #007bff;">查看详细数据</summary><pre style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; overflow-x: auto;">${dataStr}</pre></details>` : ''}
                    </div>
                `;
            }).join('');
            
            logContent.innerHTML = logHtml;
        }

        async function clearCurrentLogs() {
            const tabName = currentLogTab === 'cloud' ? '云端' : '本地';
            if (confirm(`确定要清空所有${tabName}日志吗？此操作不可恢复。`)) {
                try {
                    if (currentLogTab === 'cloud') {
                        await logger.clearCloudLogs();
                    } else {
                        logger.clearLogs();
                    }
                    await refreshLogs();
                    alert(`${tabName}日志已清空`);
                } catch (error) {
                    alert(`清空${tabName}日志失败: ` + error.message);
                }
            }
        }

        async function retryFailedLogs() {
            try {
                await logger.retryFailedLogs();
                alert('重试完成！请刷新云端日志查看结果。');
                if (currentLogTab === 'cloud') {
                    await refreshLogs();
                }
            } catch (error) {
                alert('重试失败: ' + error.message);
            }
        }

        async function manualCleanup() {
            if (currentLogTab === 'cloud') {
                if (confirm('确定要手动清理过期的云端日志吗？将移除超过48小时的日志记录。')) {
                    try {
                        await logger.cleanupCloudLogs();
                        alert('清理完成！请刷新查看结果。');
                        await refreshLogs();
                    } catch (error) {
                        alert('清理失败: ' + error.message);
                    }
                }
            } else {
                alert('清理过期日志功能仅适用于云端日志');
            }
        }

        async function exportLogs() {
            try {
                let logs = [];
                const tabName = currentLogTab === 'cloud' ? '云端' : '本地';
                
                if (currentLogTab === 'cloud') {
                    logs = await logger.getCloudLogs(1000);
                } else {
                    logs = logger.getLogs(1000);
                }
                
                const logText = logs.map(log => {
                    const timeStr = new Date(log.timestamp).toISOString();
                    const dataStr = log.data ? JSON.stringify(log.data) : '';
                    const deviceStr = log.deviceInfo ? `[${log.deviceInfo.userAgent}]` : '';
                    return `[${timeStr}] [${log.level}] ${log.user.username}: ${log.message} ${deviceStr} ${dataStr}`;
                }).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bee-store-${currentLogTab}-logs-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                alert('导出日志失败: ' + error.message);
            }
        }

        // 显示日志查看按钮（仅admin账号）
        function updateLogViewerVisibility() {
            const showLogBtn = currentUser && currentUser.username === 'admin';
            const logBtn = document.getElementById('log-viewer-btn');
            const mobileLogBtn = document.getElementById('mobile-log-viewer-btn');
            const snapshotBtn = document.getElementById('snapshot-viewer-btn');
            const mobileSnapshotBtn = document.getElementById('mobile-snapshot-viewer-btn');
            
            if (logBtn) logBtn.style.display = showLogBtn ? 'inline-block' : 'none';
            if (mobileLogBtn) mobileLogBtn.style.display = showLogBtn ? 'block' : 'none';
            if (snapshotBtn) snapshotBtn.style.display = showLogBtn ? 'inline-block' : 'none';
            if (mobileSnapshotBtn) mobileSnapshotBtn.style.display = showLogBtn ? 'block' : 'none';
        }

        // 快照查看和恢复功能
        let currentRestoreSnapshotId = null;

        function showSnapshotViewer() {
            // 只有admin账号可以查看快照
            if (!currentUser || currentUser.username !== 'admin') {
                alert('您没有权限查看数据快照，仅限admin账号访问');
                return;
            }
            
            showModal('snapshot-viewer-modal');
            refreshSnapshots();
        }

        function refreshSnapshots() {
            const typeFilter = document.getElementById('snapshot-type-filter').value;
            const snapshotContent = document.getElementById('snapshot-content');
            
            const snapshots = logger.getSnapshots(100, typeFilter || null);
            
            if (snapshots.length === 0) {
                snapshotContent.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">暂无数据快照</div>';
                return;
            }
            
            const snapshotHtml = snapshots.map(snapshot => {
                const timeStr = new Date(snapshot.timestamp).toLocaleString('zh-CN');
                const typeColor = {
                    'app_edit_before': '#007bff',
                    'app_delete_before': '#dc3545',
                    'apps_before_add': '#28a745',
                    'users_before_add': '#17a2b8',
                    'full_before_sync': '#6f42c1',
                    'local_before_merge': '#fd7e14',
                    'remote_before_merge': '#20c997'
                }[snapshot.metadata.snapshotType] || '#6c757d';
                
                const dataPreview = JSON.stringify(snapshot.data, null, 2).substring(0, 200) + '...';
                
                return `
                    <div style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid ${typeColor}; background: white; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div>
                                <h4 style="margin: 0; color: ${typeColor};">${snapshot.description}</h4>
                                <small style="color: #666;">${timeStr} | 用户: ${snapshot.metadata.user.username}</small>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="viewSnapshotDetails('${snapshot.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">详情</button>
                                <button class="btn btn-primary" onclick="prepareRestore('${snapshot.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #28a745;">恢复</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <strong>类型:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            <strong>大小:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB 
                            (压缩后: ${Math.round(snapshot.metadata.compressedSize / 1024)}KB)
                        </div>
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #007bff;">预览数据</summary>
                            <pre style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; overflow-x: auto; font-size: 0.8rem;">${dataPreview}</pre>
                        </details>
                    </div>
                `;
            }).join('');
            
            snapshotContent.innerHTML = snapshotHtml;
        }

        function getSnapshotTypeLabel(type) {
            const labels = {
                'app_edit_before': '应用编辑前',
                'app_delete_before': '应用删除前',
                'apps_before_add': '新应用发布前',
                'users_before_add': '用户注册前',
                'full_before_sync': '数据同步前',
                'local_before_merge': '数据合并前(本地)',
                'remote_before_merge': '数据合并前(远程)'
            };
            return labels[type] || type;
        }

        function viewSnapshotDetails(snapshotId) {
            const snapshots = logger.getSnapshots(1000);
            const snapshot = snapshots.find(s => s.id === snapshotId);
            
            if (!snapshot) {
                alert('快照不存在');
                return;
            }
            
            const detailsWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            detailsWindow.document.write(`
                <html>
                <head>
                    <title>快照详情 - ${snapshot.description}</title>
                    <style>
                        body { font-family: 'Courier New', monospace; margin: 20px; }
                        .header { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${snapshot.description}</h2>
                        <p><strong>时间:</strong> ${new Date(snapshot.timestamp).toLocaleString('zh-CN')}</p>
                        <p><strong>用户:</strong> ${snapshot.metadata.user.username}</p>
                        <p><strong>类型:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}</p>
                        <p><strong>数据大小:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB</p>
                    </div>
                    <h3>数据内容:</h3>
                    <pre>${JSON.stringify(snapshot.data, null, 2)}</pre>
                </body>
                </html>
            `);
        }

        function prepareRestore(snapshotId) {
            const snapshots = logger.getSnapshots(1000);
            const snapshot = snapshots.find(s => s.id === snapshotId);
            
            if (!snapshot) {
                alert('快照不存在');
                return;
            }
            
            currentRestoreSnapshotId = snapshotId;
            
            const restoreInfo = document.getElementById('restore-info');
            restoreInfo.innerHTML = `
                <h4>${snapshot.description}</h4>
                <p><strong>创建时间:</strong> ${new Date(snapshot.timestamp).toLocaleString('zh-CN')}</p>
                <p><strong>创建用户:</strong> ${snapshot.metadata.user.username}</p>
                <p><strong>快照类型:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}</p>
                <p><strong>数据大小:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB</p>
            `;
            
            // 根据快照类型设置默认恢复选项
            const restoreType = document.getElementById('restore-type');
            if (snapshot.metadata.snapshotType?.includes('app')) {
                restoreType.value = 'apps';
            } else if (snapshot.metadata.snapshotType?.includes('user')) {
                restoreType.value = 'users';
            } else {
                restoreType.value = 'full';
            }
            
            showModal('snapshot-restore-modal');
        }

        function confirmRestore() {
            if (!currentRestoreSnapshotId) {
                alert('未选择快照');
                return;
            }
            
            const restoreType = document.getElementById('restore-type').value;
            
            if (!confirm('确定要恢复数据吗？此操作将覆盖当前数据！')) {
                return;
            }
            
            try {
                // 在恢复前创建当前数据的备份快照
                logger.snapshot('数据恢复前自动备份', cloudData, {
                    snapshotType: 'auto_backup_before_restore',
                    operation: '恢复前自动备份',
                    restoreSnapshotId: currentRestoreSnapshotId
                });
                
                // 执行恢复
                logger.restoreFromSnapshot(currentRestoreSnapshotId, restoreType);
                
                // 更新UI
                updateStats();
                loadApps();
                
                closeModal('snapshot-restore-modal');
                closeModal('snapshot-viewer-modal');
                
                alert('数据恢复成功！页面将刷新以显示最新数据。');
                
                // 刷新页面以确保UI完全更新
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                alert('数据恢复失败: ' + error.message);
            } finally {
                currentRestoreSnapshotId = null;
            }
        }

        function clearSnapshots() {
            if (confirm('确定要清空所有数据快照吗？此操作不可恢复。')) {
                logger.clearSnapshots();
                refreshSnapshots();
                alert('快照已清空');
            }
        }

        function exportSnapshots() {
            const snapshots = logger.getSnapshots(1000);
            const exportData = {
                exportTime: new Date().toISOString(),
                totalSnapshots: snapshots.length,
                snapshots: snapshots
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bee-store-snapshots-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 从日志快速访问快照
        function openSnapshotFromLog(snapshotId) {
            closeModal('log-viewer-modal');
            showSnapshotViewer();
            
            // 等待快照查看器加载完成后定位到特定快照
            setTimeout(() => {
                const snapshotContent = document.getElementById('snapshot-content');
                const targetElement = snapshotContent.querySelector(`[onclick*="${snapshotId}"]`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // 高亮显示目标快照
                    const snapshotDiv = targetElement.closest('div[style*="border-left"]');
                    if (snapshotDiv) {
                        snapshotDiv.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.6)';
                        snapshotDiv.style.background = '#fff3cd';
                        setTimeout(() => {
                            snapshotDiv.style.boxShadow = '';
                            snapshotDiv.style.background = 'white';
                        }, 3000);
                    }
                }
            }, 500);
        }

        // 修改showUserNav函数以包含日志按钮可见性更新
        const originalShowUserNav = showUserNav;
        showUserNav = function() {
            originalShowUserNav();
            updateLogViewerVisibility();
        };

        const originalShowGuestNav = showGuestNav;
        showGuestNav = function() {
            originalShowGuestNav();
            updateLogViewerVisibility();
        };

        // 初始化应用
        init();

        // 启动定期重试机制（每5分钟重试一次失败的日志）
        setInterval(() => {
            logger.retryFailedLogs().catch(e => console.warn('定期重试失败:', e));
        }, 5 * 60 * 1000);

        // 启动定期清理机制（每12小时清理一次过期日志）
        setInterval(() => {
            logger.cleanupCloudLogs().catch(e => console.warn('定期清理失败:', e));
        }, 12 * 60 * 60 * 1000);

        // 启动定期后台同步机制（每1小时检查一次待同步操作）
        setInterval(() => {
            const pendingOps = localCache.getPendingOperations();
            if (pendingOps.length > 0) {
                logger.info('定期检查：发现待同步操作', { 
                    operationsCount: pendingOps.length,
                    operation: '定期同步检查'
                });
                syncQueue.retryFailedSync().catch(e => console.warn('定期同步失败:', e));
            }
        }, 60 * 60 * 1000); // 每1小时检查一次

        // 启动定期操作队列清理机制（每小时清理一次过期操作）
        setInterval(() => {
            syncQueue.cleanupExpiredOperations();
        }, 60 * 60 * 1000); // 每小时清理一次

        // 应用启动时执行一次清理
        setTimeout(() => {
            logger.cleanupCloudLogs().catch(e => console.warn('启动清理失败:', e));
        }, 10000); // 10秒后执行，确保应用初始化完成
    </script>
</body>
</html>

