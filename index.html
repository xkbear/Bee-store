<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee Store - å­¦ç”Ÿä½œå“å±•ç¤ºå¹³å°</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3EğŸ%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ - éšè—ä¸æ˜¾ç¤ºç»™ç”¨æˆ· */
        .status-indicator {
            display: none !important;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff9500;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff9500, #ff6600);
            color: white;
        }

        .btn-secondary {
            background: #ffffff;
            color: #ff9500;
            border: 1px solid #ff9500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            padding: 1rem 0; /* å‡å°‘é¡¶éƒ¨padding */
        }



        /* å¤´éƒ¨æ•´åˆå¸ƒå±€ */
        .header-integrated {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem; /* å‡å°‘é—´è· */
        }

        /* æ¡Œé¢ç«¯å¸ƒå±€ */
        .desktop-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        /* ç§»åŠ¨ç«¯å¸ƒå±€é»˜è®¤éšè— */
        .mobile-layout {
            display: none;
        }

        .header-slogan {
            flex: 0 0 auto;
            font-size: 1.1rem;
            font-weight: 600;
            color: #ff9500;
            white-space: nowrap;
        }

        .header-search {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            padding: 0;
            flex-shrink: 0;
            background: transparent !important;
            color: #ff9500 !important;
            border: none;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: rgba(255, 149, 0, 0.1) !important;
            transform: none;
            box-shadow: none;
        }

        .header-search .search-input {
            height: 40px;
            padding: 0 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 0;
            flex: 1;
        }

        .header-search .search-input:focus {
            outline: none;
            border-color: #ff9500;
        }

        .header-search .filter-select {
            height: 40px;
            padding: 0 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            box-sizing: border-box;
            background: white;
        }

        .header-search .filter-select:focus {
            outline: none;
            border-color: #ff9500;
        }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰èœå•æ ·å¼ */
        .custom-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #ff9500;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .dropdown-trigger:hover {
            background: rgba(255, 149, 0, 0.1);
        }

        .dropdown-trigger.active {
            background: rgba(255, 149, 0, 0.15);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 120px;
            max-height: 250px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 149, 0, 0.1);
        }

        .dropdown-item.selected {
            background: rgba(255, 149, 0, 0.2);
            color: #ff6600;
            font-weight: 500;
        }

        .header-stats {
            flex: 0 0 auto;
            display: flex;
            gap: 1.5rem;
            font-size: 0.9rem;
        }

        .stat-compact {
            text-align: center;
            color: #333;
        }

        .stat-compact .number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff9500;
            display: block;
        }

        .stat-compact .label {
            font-size: 0.8rem;
            color: #666;
        }

        /* åº”ç”¨ç½‘æ ¼ */
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem; /* å‡å°‘é—´è· */
            margin-top: 0; /* ç§»é™¤é¡¶éƒ¨é—´è· */
        }

        .app-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .app-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 149, 0, 0.15);
            border-color: #ff9500;
        }

        .app-screenshot {
            width: 100%;
            height: 140px; /* å‡å°é«˜åº¦ */
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
            overflow: hidden;
            position: relative;
        }

        .app-screenshot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-screenshot .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }

        .app-info h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        /* äº§å“æè¿°å±•å¼€åŠŸèƒ½ */
        .app-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            position: relative;
        }

        .app-description.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .app-description.collapsed.has-overflow::after {
            content: '...å±•å¼€';
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(to right, transparent, white 30%, white);
            color: #ff9500;
            font-size: 0.85rem;
            padding-left: 20px;
            text-decoration: underline;
            pointer-events: auto;
            z-index: 2;
        }

        .app-description.collapsed.has-overflow::after:hover {
            color: #ff6600;
        }

        .app-description.expanded {
            display: block;
        }

        .description-toggle {
            color: #ff9500;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            margin-top: 0.25rem;
            text-decoration: underline;
        }

        .description-toggle:hover {
            color: #ff6600;
        }

        .app-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: #888;
        }

        .app-stats {
            display: flex;
            gap: 1rem;
        }

        .app-url {
            color: #ff6600;
            text-decoration: none;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0;
            margin-left: 0.5rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            background: rgba(255, 102, 0, 0.1);
            transition: all 0.3s ease;
            font-weight: 500;
            vertical-align: middle;
        }

        .app-url:hover {
            background: rgba(255, 102, 0, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 102, 0, 0.2);
        }

        .app-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .app-action-btn {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .app-action-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .app-action-btn.edit-btn {
            background: rgba(0, 123, 255, 0.9);
        }
        
        .app-action-btn.edit-btn:hover {
            background: #007bff;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        /* æˆªå›¾æ–¹å¼è¡Œ */
        .capture-method-row {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin: 0.75rem 0 1rem;
        }

        .capture-method-row label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: normal;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff9500, #ff6600);
            color: #fff;
            border: none;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(255, 149, 0, 0.4);
        }

        .btn-secondary {
            border: 1px solid #ff9500;
            color: #ff9500;
            background: #fff;
        }

        .btn-secondary:hover {
            background: #ff9500;
            color: #fff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff9500;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        /* å‘å¸ƒåº”ç”¨æŒ‰é’® */
        .publish-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9500, #ff6600);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .publish-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
        }

        .empty-state p {
            color: #666;
            font-size: 1.1rem;
        }

        /* ç”¨æˆ·ä¿¡æ¯ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #333;
        }

        /* åº”ç”¨äº’åŠ¨æŒ‰é’® */
        .app-interactions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem 0;
            border-top: 1px solid #f0f0f0;
        }

        .interaction-group {
            display: flex;
            gap: 1rem;
        }

        .interaction-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: #666;
            transition: color 0.3s ease;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .interaction-btn:hover {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }

        .interaction-btn.active {
            color: #ff9500;
        }

        .interaction-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .interaction-btn:disabled:hover {
            color: #666;
            background: none;
        }

        /* è¯„è®ºåŒºåŸŸ */
        .comments-section {
            margin-top: 1rem;
            border-top: 1px solid #f0f0f0;
            padding-top: 1rem;
        }

        .comment-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #666;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
        }

        .comment-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .comment-delete {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem;
        }

        .comment-delete:hover {
            color: #c82333;
        }

        .comment-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .comment-input input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .comment-input button {
            padding: 0.5rem 1rem;
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .comment-input button:hover {
            background: #ff6600;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9500, #ff6600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æˆªå›¾é¢„è§ˆ */
        .screenshot-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .screenshot-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff9500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ—¥å¿—é€‰é¡¹å¡æ ·å¼ */
        .log-tab {
            transition: all 0.3s ease;
            color: #666;
        }

        .log-tab:hover {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }

        .log-tab.active {
            color: #ff9500;
            border-bottom-color: #ff9500 !important;
            background: rgba(255, 149, 0, 0.05);
        }

        /* æœç´¢åŠŸèƒ½ */
        .search-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-section {
            background: linear-gradient(135deg, #ff9500 0%, #ff6600 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: white;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-item p {
            opacity: 0.8;
        }

        /* æ±‰å ¡èœå•æ ·å¼ */
        .hamburger-menu {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 0.5rem;
            gap: 0.3rem;
        }

        .hamburger-line {
            width: 24px;
            height: 3px;
            background-color: #ff9500;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
        }

        .mobile-nav-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 2rem 1.5rem;
        }

        .mobile-nav-menu.active {
            right: 0;
        }

        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .mobile-nav-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9500;
        }

        .mobile-nav-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.25rem;
        }

        .mobile-nav-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mobile-nav-item {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .mobile-nav-item:hover {
            background: #ff9500;
            color: white;
            border-color: #ff9500;
        }

        .mobile-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .apps-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
            }
            
            .nav-buttons {
                display: none;
            }

            .nav {
                justify-content: center;
            }

            .logo {
                margin: 0 auto;
            }

            .hamburger-menu {
                display: flex;
            }

            /* å¤´éƒ¨æ•´åˆå“åº”å¼ */
            .header-integrated {
                padding: 0.75rem 1rem;
                margin-bottom: 1rem;
            }

            /* ç§»åŠ¨ç«¯ï¼šéšè—æ¡Œé¢å¸ƒå±€ï¼Œæ˜¾ç¤ºç§»åŠ¨å¸ƒå±€ */
            .desktop-layout {
                display: none;
            }

            .mobile-layout {
                display: block;
            }

            /* ç§»åŠ¨ç«¯ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜å’Œæœç´¢æ¡† */
            .mobile-header-row {
                display: flex;
                align-items: flex-end;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
                padding-top: 0.25rem;
            }

            .mobile-header-row .header-slogan {
                flex: 0 0 auto;
                font-size: 0.9rem;
                font-weight: 600;
                white-space: nowrap;
                line-height: 36px;
                align-self: center;
            }

            .mobile-header-row .search-input {
                flex: 1;
                min-width: 0;
                height: 36px;
                font-size: 0.9rem;
                padding: 0 0.5rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                box-sizing: border-box;
                margin-top: 0.25rem;
            }

            .mobile-header-row .search-input:focus {
                outline: none;
                border-color: #ff9500;
            }

            /* ç§»åŠ¨ç«¯ç¬¬äºŒè¡Œï¼šç­›é€‰å™¨å’Œæœç´¢æŒ‰é’® */
            .mobile-filters-row {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .mobile-filters-row .filter-select {
                height: 36px;
                font-size: 0.85rem;
                flex: 1;
                padding: 0 0.5rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                box-sizing: border-box;
                background: white;
            }

            .mobile-filters-row .filter-select:focus {
                outline: none;
                border-color: #ff9500;
            }

            .mobile-filters-row .search-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
                flex-shrink: 0;
            }

            /* ç§»åŠ¨ç«¯è‡ªå®šä¹‰ä¸‹æ‹‰èœå• */
            .mobile-filters-row .custom-dropdown {
                flex: 1;
            }

            .mobile-filters-row .dropdown-trigger {
                width: 100%;
                height: 36px;
                font-size: 1rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                background: white;
            }

            .mobile-filters-row .dropdown-trigger:hover {
                border-color: #ff9500;
                background: rgba(255, 149, 0, 0.05);
            }

            .mobile-filters-row .dropdown-trigger.active {
                border-color: #ff9500;
                background: rgba(255, 149, 0, 0.1);
            }

            .mobile-filters-row .dropdown-menu {
                min-width: 100%;
            }

            .interaction-group {
                gap: 0.5rem;
            }

            .interaction-btn {
                font-size: 0.8rem;
                padding: 0.2rem 0.4rem;
            }

            .comment-input {
                flex-direction: column;
                gap: 0.5rem;
            }

            .comment-input input {
                margin-bottom: 0;
            }



            .stats-row {
                flex-direction: column;
                gap: 1rem;
            }

            .logo {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 768px) {
            .apps-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 0;
                transform: translate(-50%, -50%);
            }

            body.no-scroll {
                overflow: hidden;
            }

            /* è¿›ä¸€æ­¥å‡å°‘ç§»åŠ¨ç«¯çš„é—´è· */
            .main-content {
                padding: 0.5rem 0;
            }

            .header-integrated {
                margin-bottom: 0.75rem;
            }
        }
    </style>
</head>
<body>


    <div class="header">
        <div class="container">
            <nav class="nav">
                <a href="#" class="logo">
                    <span>ğŸ</span>
                    <span>Bee Store</span>
                </a>
                <div class="nav-buttons">
                    <div id="guest-nav" style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="showLogin()">ç™»å½•</button>
                        <button class="btn btn-primary" onclick="showRegister()">æ³¨å†Œ</button>
                    </div>
                    <div id="user-nav" style="display: none; align-items: center; gap: 1rem;">
                        <div class="user-info">
                            <div class="user-avatar" id="user-avatar"></div>
                            <span id="user-name"></span>
                        </div>
                        <button class="btn btn-secondary" onclick="goHome()">é¦–é¡µ</button>
                        <button class="btn btn-secondary" onclick="showMyApps()">æˆ‘çš„åº”ç”¨</button>
                        <button class="btn btn-secondary" onclick="showMyFavorites()">æˆ‘çš„æ”¶è—</button>
                        <button class="btn btn-secondary" onclick="showLogViewer()" style="display: none;" id="log-viewer-btn">ğŸ“‹ æŸ¥çœ‹æ—¥å¿—</button>
                        <button class="btn btn-secondary" onclick="showSnapshotViewer()" style="display: none;" id="snapshot-viewer-btn">ğŸ“¸ æ•°æ®å¿«ç…§</button>
                        <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
                    </div>
                </div>
                
                <!-- æ±‰å ¡èœå•æŒ‰é’® -->
                <div class="hamburger-menu" id="hamburger-menu" onclick="toggleMobileMenu()">
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                </div>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- æ•´åˆçš„å¤´éƒ¨ï¼šsloganã€æœç´¢ã€ç»Ÿè®¡ -->
            <div class="header-integrated">
                <!-- æ¡Œé¢ç«¯å¸ƒå±€ -->
                <div class="desktop-layout">
                    
                    <div class="header-search">
                        <input type="text" class="search-input" id="search-input" placeholder="æœç´¢ä½œå“åç§°ã€æè¿°ã€åˆ›ä½œè€…...">
                        
                        <!-- åˆ†ç±»ä¸‹æ‹‰èœå• -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="category-trigger" onclick="toggleDropdown('category')" title="åˆ†ç±»ç­›é€‰">
                                ğŸ·ï¸
                            </button>
                            <div class="dropdown-menu" id="category-dropdown">
                                <div class="dropdown-item selected" data-value="">å…¨éƒ¨åˆ†ç±»</div>
                                <div class="dropdown-item" data-value="å·¥å…·">ğŸ”§ å·¥å…·</div>
                                <div class="dropdown-item" data-value="å­¦ä¹ ">ğŸ“š å­¦ä¹ </div>
                                <div class="dropdown-item" data-value="æ¸¸æˆ">ğŸ® æ¸¸æˆ</div>
                                <div class="dropdown-item" data-value="è‰ºæœ¯">ğŸ¨ è‰ºæœ¯</div>
                                <div class="dropdown-item" data-value="ç§‘æŠ€">ğŸ’» ç§‘æŠ€</div>
                            </div>
                        </div>
                        
                        <!-- æ’åºä¸‹æ‹‰èœå• -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="sort-trigger" onclick="toggleDropdown('sort')" title="æ’åºæ–¹å¼">
                                ğŸ“…
                            </button>
                            <div class="dropdown-menu" id="sort-dropdown">
                                <div class="dropdown-item selected" data-value="newest">ğŸ“… æœ€æ–°å‘å¸ƒ</div>
                                <div class="dropdown-item" data-value="oldest">ğŸ“… æœ€æ—©å‘å¸ƒ</div>
                                <div class="dropdown-item" data-value="name">ğŸ”¤ æŒ‰åç§°</div>
                                <div class="dropdown-item" data-value="author">ğŸ‘¤ æŒ‰ä½œè€…</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary search-btn" onclick="searchApps()">ğŸ”</button>
                        
                        <!-- éšè—çš„åŸå§‹selectå…ƒç´ ï¼Œç”¨äºä¿æŒåŠŸèƒ½ -->
                        <select class="filter-select" id="category-filter" style="display: none;">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="å·¥å…·">å·¥å…·</option>
                            <option value="å­¦ä¹ ">å­¦ä¹ </option>
                            <option value="æ¸¸æˆ">æ¸¸æˆ</option>
                            <option value="è‰ºæœ¯">è‰ºæœ¯</option>
                            <option value="ç§‘æŠ€">ç§‘æŠ€</option>
                        </select>
                        <select class="filter-select" id="sort-filter" style="display: none;">
                            <option value="newest">æœ€æ–°å‘å¸ƒ</option>
                            <option value="oldest">æœ€æ—©å‘å¸ƒ</option>
                            <option value="name">æŒ‰åç§°</option>
                            <option value="author">æŒ‰ä½œè€…</option>
                        </select>
                    </div>
                    
                    <div class="header-stats">
                        <div class="stat-compact">
                            <span class="number" id="total-apps">0</span>
                            <span class="label">ä½œå“æ€»æ•°</span>
                        </div>
                        <div class="stat-compact">
                            <span class="number" id="total-users">0</span>
                            <span class="label">åˆ›ä½œè€…</span>
                        </div>
                    </div>
                </div>

                <!-- ç§»åŠ¨ç«¯å¸ƒå±€ -->
                <div class="mobile-layout">
                    <!-- ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜å’Œæœç´¢æ¡† -->
                    <div class="mobile-header-row">
                        <input type="text" class="search-input" id="search-input-mobile" placeholder="æœç´¢ä½œå“...">
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œï¼šç­›é€‰å™¨å’Œæœç´¢æŒ‰é’® -->
                    <div class="mobile-filters-row">
                        <!-- ç§»åŠ¨ç«¯åˆ†ç±»ä¸‹æ‹‰èœå• -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="category-trigger-mobile" onclick="toggleDropdown('category-mobile')" title="åˆ†ç±»ç­›é€‰">
                                ğŸ·ï¸
                            </button>
                            <div class="dropdown-menu" id="category-dropdown-mobile">
                                <div class="dropdown-item selected" data-value="">å…¨éƒ¨åˆ†ç±»</div>
                                <div class="dropdown-item" data-value="å·¥å…·">ğŸ”§ å·¥å…·</div>
                                <div class="dropdown-item" data-value="å­¦ä¹ ">ğŸ“š å­¦ä¹ </div>
                                <div class="dropdown-item" data-value="æ¸¸æˆ">ğŸ® æ¸¸æˆ</div>
                                <div class="dropdown-item" data-value="è‰ºæœ¯">ğŸ¨ è‰ºæœ¯</div>
                                <div class="dropdown-item" data-value="ç§‘æŠ€">ğŸ’» ç§‘æŠ€</div>
                            </div>
                        </div>
                        
                        <!-- ç§»åŠ¨ç«¯æ’åºä¸‹æ‹‰èœå• -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="sort-trigger-mobile" onclick="toggleDropdown('sort-mobile')" title="æ’åºæ–¹å¼">
                                ğŸ“…
                            </button>
                            <div class="dropdown-menu" id="sort-dropdown-mobile">
                                <div class="dropdown-item selected" data-value="newest">ğŸ“… æœ€æ–°å‘å¸ƒ</div>
                                <div class="dropdown-item" data-value="oldest">ğŸ“… æœ€æ—©å‘å¸ƒ</div>
                                <div class="dropdown-item" data-value="name">ğŸ”¤ æŒ‰åç§°</div>
                                <div class="dropdown-item" data-value="author">ğŸ‘¤ æŒ‰ä½œè€…</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary search-btn" onclick="searchApps()">ğŸ”</button>
                        
                        <!-- éšè—çš„åŸå§‹selectå…ƒç´ ï¼Œç”¨äºä¿æŒåŠŸèƒ½ -->
                        <select class="filter-select" id="category-filter-mobile" style="display: none;">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="å·¥å…·">å·¥å…·</option>
                            <option value="å­¦ä¹ ">å­¦ä¹ </option>
                            <option value="æ¸¸æˆ">æ¸¸æˆ</option>
                            <option value="è‰ºæœ¯">è‰ºæœ¯</option>
                            <option value="ç§‘æŠ€">ç§‘æŠ€</option>
                        </select>
                        <select class="filter-select" id="sort-filter-mobile" style="display: none;">
                            <option value="newest">æœ€æ–°å‘å¸ƒ</option>
                            <option value="oldest">æœ€æ—©å‘å¸ƒ</option>
                            <option value="name">æŒ‰åç§°</option>
                            <option value="author">æŒ‰ä½œè€…</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="apps-container">
                <div class="apps-grid" id="apps-grid">
                    <!-- åº”ç”¨å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
                
                <div class="empty-state" id="empty-state" style="display: none;">
                    <h3>æš‚æ— ä½œå“</h3>
                    <p>æ¥å±•ç¤ºä½ çš„ç¬¬ä¸€ä¸ªä½œå“å§ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒ/ç¼–è¾‘åº”ç”¨æŒ‰é’® -->
    <button class="publish-btn" id="publish-btn" onclick="showPublishModal()" style="display: none;" title="å‘å¸ƒåº”ç”¨">+</button>

    <!-- ç§»åŠ¨ç«¯èœå• -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-nav-menu" id="mobile-nav-menu">
        <div class="mobile-nav-header">
            <div class="mobile-nav-title">èœå•</div>
            <button class="mobile-nav-close" onclick="closeMobileMenu()">&times;</button>
        </div>
        
        <!-- æœªç™»å½•çŠ¶æ€èœå• -->
        <div id="mobile-guest-nav" style="display: none;">
            <div class="mobile-nav-items">
                <button class="mobile-nav-item" onclick="showLogin(); closeMobileMenu();">
                    ğŸ‘¤ ç™»å½•
                </button>
                <button class="mobile-nav-item" onclick="showRegister(); closeMobileMenu();">
                    âœ¨ æ³¨å†Œ
                </button>
            </div>
        </div>
        
        <!-- å·²ç™»å½•çŠ¶æ€èœå• -->
        <div id="mobile-user-nav" style="display: none;">
            <div class="mobile-user-info">
                <div class="user-avatar" id="mobile-user-avatar"></div>
                <span id="mobile-user-name"></span>
            </div>
            <div class="mobile-nav-items">
                <button class="mobile-nav-item" onclick="goHome(); closeMobileMenu();">
                    ğŸ  é¦–é¡µ
                </button>
                <button class="mobile-nav-item" onclick="showPublishModal(); closeMobileMenu();" style="background: linear-gradient(45deg, #ff9500, #ff6600); color: white; border-color: #ff9500;">
                    â• å‘å¸ƒä½œå“
                </button>
                <button class="mobile-nav-item" onclick="showMyApps(); closeMobileMenu();">
                    ğŸ“± æˆ‘çš„åº”ç”¨
                </button>
                <button class="mobile-nav-item" onclick="showMyFavorites(); closeMobileMenu();">
                    â­ æˆ‘çš„æ”¶è—
                </button>
                <button class="mobile-nav-item" onclick="showLogViewer(); closeMobileMenu();" style="display: none;" id="mobile-log-viewer-btn">
                    ğŸ“‹ æŸ¥çœ‹æ—¥å¿—
                </button>
                <button class="mobile-nav-item" onclick="showSnapshotViewer(); closeMobileMenu();" style="display: none;" id="mobile-snapshot-viewer-btn">
                    ğŸ“¸ æ•°æ®å¿«ç…§
                </button>
                <button class="mobile-nav-item" onclick="logout(); closeMobileMenu();">
                    ğŸšª é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒ/ç¼–è¾‘åº”ç”¨æ¨¡æ€æ¡† -->
    <div class="modal" id="publish-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="publish-modal-title">å‘å¸ƒä½œå“</h2>
                <button class="close-btn" onclick="closeModal('publish-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="app-name">ä½œå“åç§° *</label>
                    <input type="text" id="app-name" placeholder="ç»™ä½ çš„ä½œå“èµ·ä¸ªåå­—" onchange="updatePublishButtonState()" oninput="updatePublishButtonState()">
                </div>
                <div class="form-group">
                    <label for="app-url">ä½œå“é“¾æ¥ *</label>
                    <input type="url" id="app-url" placeholder="https://example.com" onchange="updatePublishButtonState()" oninput="updatePublishButtonState()">
                </div>
                <div class="form-group">
                    <label for="app-description">ä½œå“æè¿° *</label>
                    <textarea id="app-description" placeholder="ä»‹ç»ä¸€ä¸‹ä½ çš„ä½œå“ï¼Œæ¯”å¦‚åˆ›ä½œçµæ„Ÿã€ä¸»è¦åŠŸèƒ½ç­‰..." onchange="updatePublishButtonState()" oninput="updatePublishButtonState()"></textarea>
                </div>
                <div class="form-group">
                    <label for="app-category">åˆ†ç±»</label>
                    <select id="app-category">
                        <option value="å…¶ä»–">å…¶ä»–</option>
                        <option value="å·¥å…·">å·¥å…·</option>
                        <option value="å­¦ä¹ ">å­¦ä¹ </option>
                        <option value="æ¸¸æˆ">æ¸¸æˆ</option>
                        <option value="è‰ºæœ¯">è‰ºæœ¯</option>
                        <option value="ç§‘æŠ€">ç§‘æŠ€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åº”ç”¨æˆªå›¾</label>
                    <div class="screenshot-preview" id="screenshot-preview">
                        <div class="placeholder">
                            <div style="font-size: 2rem;">ğŸ“¸</div>
                            <div>é€‰æ‹©æˆªå›¾æ–¹å¼</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <div style="margin-bottom: 0.5rem;">
                            <label style="font-weight: normal; font-size: 0.9rem;">æˆªå›¾æ–¹å¼ï¼š</label>
                        </div>
                        <div class="capture-method-row">
                            <label>
                                <input type="radio" name="screenshot-method" value="api" checked onchange="toggleScreenshotMethod()">
                                <span>è‡ªåŠ¨ç”Ÿæˆæˆªå›¾</span>
                            </label>
                            <label>
                                <input type="radio" name="screenshot-method" value="upload" onchange="toggleScreenshotMethod()">
                                <span>ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</span>
                            </label>
                        </div>
                        <div id="screenshot-api-section" style="display: block;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="generateScreenshot()">
                                    ğŸŒ ç”Ÿæˆç½‘é¡µæˆªå›¾
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearScreenshot()" style="background: #dc3545; color: white;">
                                    ğŸ—‘ï¸ æ¸…é™¤æˆªå›¾
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                æ ¹æ®åº”ç”¨é“¾æ¥è‡ªåŠ¨ç”Ÿæˆç½‘é¡µæˆªå›¾
                            </div>
                        </div>
                        <div id="screenshot-upload-section" style="display: none;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('screenshot-upload').click()">
                                    ğŸ“ ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearScreenshot()" style="background: #dc3545; color: white;">
                                    ğŸ—‘ï¸ æ¸…é™¤æˆªå›¾
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 5MB
                            </div>
                        </div>
                    </div>
                    <input type="file" id="screenshot-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('publish-modal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="save-app-btn" onclick="handleSaveApp()">å‘å¸ƒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç”¨æˆ·ç™»å½•</h2>
                <button class="close-btn" onclick="closeModal('login-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="login-username">ç”¨æˆ·å</label>
                    <input type="text" id="login-username" placeholder="è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="login-password">å¯†ç </label>
                    <input type="password" id="login-password" placeholder="è¾“å…¥å¯†ç ">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('login-modal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="handleLogin()">ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç”¨æˆ·æ³¨å†Œ</h2>
                <button class="close-btn" onclick="closeModal('register-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="register-username">ç”¨æˆ·å</label>
                    <input type="text" id="register-username" placeholder="è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="register-email">é‚®ç®±</label>
                    <input type="email" id="register-email" placeholder="è¾“å…¥é‚®ç®±">
                </div>
                <div class="form-group">
                    <label for="register-password">å¯†ç </label>
                    <input type="password" id="register-password" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('register-modal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="handleRegister()">æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥å¿—æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="log-viewer-modal">
        <div class="modal-content" style="max-width: 800px; height: 80vh;">
            <div class="modal-header">
                <h2 class="modal-title">ç³»ç»Ÿæ—¥å¿—</h2>
                <button class="close-btn" onclick="closeModal('log-viewer-modal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(80vh - 120px);">
                <!-- é€‰é¡¹å¡ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
                    <div style="display: flex;">
                        <button id="local-logs-tab" class="log-tab active" onclick="switchLogTab('local')" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500;">
                            æœ¬åœ°æ—¥å¿—
                        </button>
                        <button id="cloud-logs-tab" class="log-tab" onclick="switchLogTab('cloud')" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500;">
                            äº‘ç«¯æ—¥å¿— ğŸŒ
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; padding: 0.5rem;">
                        ğŸ•’ äº‘ç«¯æ—¥å¿—è‡ªåŠ¨ä¿ç•™48å°æ—¶
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
                    <select id="log-level-filter" onchange="refreshLogs()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">å…¨éƒ¨çº§åˆ«</option>
                        <option value="INFO">ä¿¡æ¯</option>
                        <option value="WARN">è­¦å‘Š</option>
                        <option value="ERROR">é”™è¯¯</option>
                    </select>
                    <input type="text" id="log-username-filter" placeholder="æŒ‰ç”¨æˆ·åç­›é€‰..." onchange="refreshLogs()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn btn-secondary" onclick="refreshLogs()">åˆ·æ–°</button>
                    <button class="btn btn-secondary" onclick="clearCurrentLogs()">æ¸…ç©ºæ—¥å¿—</button>
                    <button class="btn btn-secondary" onclick="manualCleanup()" style="background: #28a745; color: white;">æ¸…ç†è¿‡æœŸ</button>
                    <button class="btn btn-secondary" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
                    <button class="btn btn-secondary" onclick="retryFailedLogs()" style="background: #17a2b8; color: white;">é‡è¯•å¤±è´¥</button>
                </div>
                <div id="log-content" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.9rem; background: #f8f9fa;">
                    <!-- æ—¥å¿—å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«ç…§æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="snapshot-viewer-modal">
        <div class="modal-content" style="max-width: 900px; height: 85vh;">
            <div class="modal-header">
                <h2 class="modal-title">æ•°æ®å¿«ç…§ç®¡ç†</h2>
                <button class="close-btn" onclick="closeModal('snapshot-viewer-modal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(85vh - 120px);">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
                    <select id="snapshot-type-filter" onchange="refreshSnapshots()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="app_edit_before">åº”ç”¨ç¼–è¾‘å‰</option>
                        <option value="app_delete_before">åº”ç”¨åˆ é™¤å‰</option>
                        <option value="apps_before_add">æ–°åº”ç”¨å‘å¸ƒå‰</option>
                        <option value="users_before_add">ç”¨æˆ·æ³¨å†Œå‰</option>
                        <option value="full_before_sync">æ•°æ®åŒæ­¥å‰</option>
                        <option value="local_before_merge">æ•°æ®åˆå¹¶å‰(æœ¬åœ°)</option>
                        <option value="remote_before_merge">æ•°æ®åˆå¹¶å‰(è¿œç¨‹)</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshSnapshots()">åˆ·æ–°å¿«ç…§</button>
                    <button class="btn btn-secondary" onclick="clearSnapshots()">æ¸…ç©ºå¿«ç…§</button>
                    <button class="btn btn-secondary" onclick="exportSnapshots()">å¯¼å‡ºå¿«ç…§</button>
                </div>
                <div id="snapshot-content" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; background: #f8f9fa;">
                    <!-- å¿«ç…§å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«ç…§æ¢å¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="snapshot-restore-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">ç¡®è®¤æ•°æ®æ¢å¤</h2>
                <button class="close-btn" onclick="closeModal('snapshot-restore-modal')">&times;</button>
            </div>
            <div>
                <div id="restore-info" style="margin-bottom: 1.5rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                    <!-- æ¢å¤ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="restore-type" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">æ¢å¤èŒƒå›´ï¼š</label>
                    <select id="restore-type" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="full">å®Œæ•´æ¢å¤ï¼ˆåº”ç”¨+ç”¨æˆ·ï¼‰</option>
                        <option value="apps">ä»…æ¢å¤åº”ç”¨æ•°æ®</option>
                        <option value="users">ä»…æ¢å¤ç”¨æˆ·æ•°æ®</option>
                    </select>
                </div>
                <div style="color: #dc3545; font-size: 0.9rem; margin-bottom: 1rem;">
                    âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ•°æ®ï¼Œæ— æ³•æ’¤é”€ï¼å»ºè®®å…ˆåˆ›å»ºå½“å‰æ•°æ®çš„å¿«ç…§ã€‚
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('snapshot-restore-modal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmRestore()" style="background: #dc3545;">ç¡®è®¤æ¢å¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // äº‘å­˜å‚¨é…ç½® - ä½¿ç”¨JSONBinå…è´¹æœåŠ¡
        const CLOUD_CONFIG = {
            // JSONBiné…ç½®
            binId: '', // å°†åœ¨ Netlify å‡½æ•°ä¸­è®¾ç½®
            apiKey: '', // å°†åœ¨ Netlify å‡½æ•°ä¸­è®¾ç½®
            baseUrl: 'https://api.jsonbin.io/v3/b'
        };

        // å…¨å±€å˜é‡
        let currentUser = null;
        let currentEditingAppId = null; // ç”¨äºè·Ÿè¸ªæ­£åœ¨ç¼–è¾‘çš„åº”ç”¨ID
        let isScreenshotReady = false; // è·Ÿè¸ªæˆªå›¾/å›¾ç‰‡æ˜¯å¦å‡†å¤‡å°±ç»ª
        let cloudData = {
            users: [],
            apps: [],
            lastSync: null
        };

        // äº‘å­˜å‚¨APIç±»
        class CloudStorage {
            constructor() {
                this.baseUrl = '/.netlify/functions/jsonbin-proxy';
            }

            async saveData(data) {
                try {
                    const response = await fetch(this.baseUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('ä¿å­˜å¤±è´¥');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
                    throw error;
                }
            }

            async loadData() {
                try {
                    const response = await fetch(this.baseUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('åŠ è½½å¤±è´¥');
                    }
                    
                    const result = await response.json();
                    return result.record || { users: [], apps: [], lastSync: null };
                } catch (error) {
                    console.error('ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error);
                    throw error;
                }
            }
        }

        const cloudStorage = new CloudStorage();

        // æ—¥å¿—è®°å½•ç³»ç»Ÿ
        class Logger {
            constructor() {
                this.logs = JSON.parse(localStorage.getItem('beestoreLogs') || '[]');
                this.maxLogs = 1000; // æœ€å¤šä¿å­˜1000æ¡æ—¥å¿—
            }

            getFormattedLog(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const userInfo = currentUser ? {
                    id: currentUser.id,
                    username: currentUser.username
                } : { id: null, username: 'guest' };

                return {
                    timestamp,
                    level,
                    message,
                    user: userInfo,
                    data,
                    id: Date.now() + Math.random()
                };
            }

            info(message, data = null) {
                const log = this.getFormattedLog('INFO', message, data);
                this.logs.unshift(log);
                console.log(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // å¼‚æ­¥å‘é€åˆ°äº‘ç«¯ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                this.sendToCloud(log).catch(e => console.warn('å‘é€æ—¥å¿—åˆ°äº‘ç«¯å¤±è´¥:', e));
                
                return log;
            }

            warn(message, data = null) {
                const log = this.getFormattedLog('WARN', message, data);
                this.logs.unshift(log);
                console.warn(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // å¼‚æ­¥å‘é€åˆ°äº‘ç«¯ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                this.sendToCloud(log).catch(e => console.warn('å‘é€æ—¥å¿—åˆ°äº‘ç«¯å¤±è´¥:', e));
                
                return log;
            }

            error(message, data = null) {
                const log = this.getFormattedLog('ERROR', message, data);
                this.logs.unshift(log);
                console.error(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // å¼‚æ­¥å‘é€åˆ°äº‘ç«¯ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                this.sendToCloud(log).catch(e => console.warn('å‘é€æ—¥å¿—åˆ°äº‘ç«¯å¤±è´¥:', e));
                
                return log;
            }

            saveLogs() {
                // é™åˆ¶æ—¥å¿—æ•°é‡
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(0, this.maxLogs);
                }
                localStorage.setItem('beestoreLogs', JSON.stringify(this.logs));
            }

            // å‘é€å…³é”®æ—¥å¿—åˆ°äº‘ç«¯ï¼ˆä¾›adminæŸ¥çœ‹ï¼‰
            async sendToCloud(log) {
                // åªå‘é€å…³é”®çš„é”™è¯¯å’Œé‡è¦æ“ä½œåˆ°äº‘ç«¯
                const shouldSendToCloud = this.shouldSendToCloud(log);
                
                if (!shouldSendToCloud) return;

                try {
                                         // è·å–äº‘ç«¯æ—¥å¿—å¹¶æ¸…ç†è¿‡æœŸæ—¥å¿—
                    let cloudLogs = [];
                    try {
                        const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (response.ok) {
                            const result = await response.json();
                            const allLogs = result.record?.centralLogs || [];
                            
                            // æ¸…ç†è¶…è¿‡48å°æ—¶çš„æ—¥å¿—
                            cloudLogs = this.cleanExpiredLogs(allLogs);
                        }
                    } catch (e) {
                        console.warn('è·å–äº‘ç«¯æ—¥å¿—å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°çš„æ—¥å¿—è®°å½•');
                    }

                    // æ·»åŠ æ–°æ—¥å¿—åˆ°äº‘ç«¯
                    cloudLogs.unshift({
                        ...log,
                        cloudId: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString(),
                            url: window.location.href
                        }
                    });

                    // é™åˆ¶äº‘ç«¯æ—¥å¿—æ•°é‡ï¼ˆæœ€å¤š500æ¡ï¼‰
                    if (cloudLogs.length > 500) {
                        const removedCount = cloudLogs.length - 500;
                        cloudLogs = cloudLogs.slice(0, 500);
                        console.log(`[BeeStore] äº‘ç«¯æ—¥å¿—æ•°é‡è¶…é™ï¼Œç§»é™¤æœ€æ—§çš„ ${removedCount} æ¡æ—¥å¿—`);
                    }

                    // æ„å»ºå®Œæ•´çš„äº‘ç«¯æ•°æ®
                    let fullCloudData = {
                        users: [],
                        apps: [],
                        lastSync: null,
                        centralLogs: cloudLogs
                    };

                    // å°è¯•ä¿æŒç°æœ‰çš„æ•°æ®ç»“æ„
                    try {
                        const existingResponse = await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (existingResponse.ok) {
                            const existingData = await existingResponse.json();
                            if (existingData.record) {
                                fullCloudData = {
                                    ...existingData.record,
                                    centralLogs: cloudLogs
                                };
                            }
                        }
                    } catch (e) {
                        console.warn('è·å–ç°æœ‰äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç»“æ„');
                    }

                    // å‘é€åˆ°äº‘ç«¯
                    await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullCloudData)
                    });

                } catch (error) {
                    console.error('å‘é€æ—¥å¿—åˆ°äº‘ç«¯å¤±è´¥:', error);
                    // å¤±è´¥æ—¶ä¿å­˜åˆ°æœ¬åœ°å¾…å‘é€é˜Ÿåˆ—
                    this.saveToRetryQueue(log);
                }
            }

            shouldSendToCloud(log) {
                // å®šä¹‰éœ€è¦å‘é€åˆ°äº‘ç«¯çš„æ—¥å¿—ç±»å‹ï¼ˆåªè®°å½•æ ¸å¿ƒæ“ä½œï¼‰
                const criticalMessages = [
                    // åº”ç”¨ç›¸å…³æ“ä½œ
                    'åº”ç”¨å‘å¸ƒ',
                    'åº”ç”¨ç¼–è¾‘',
                    'åº”ç”¨åˆ é™¤',
                    
                    // å›¾ç‰‡/æˆªå›¾ç›¸å…³
                    'ä¸Šä¼ å›¾ç‰‡å¤±è´¥',
                    'æˆªå›¾ä¸Šä¼ å¤±è´¥', 
                    'æˆªå›¾ç”Ÿæˆå¤±è´¥',
                    'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ',
                    'æˆªå›¾ç”Ÿæˆå¹¶ä¸Šä¼ æˆåŠŸ',
                    
                    // ç”¨æˆ·äº’åŠ¨
                    'ç‚¹èµæ“ä½œ',
                    'æ”¶è—æ“ä½œ', 
                    'æ·»åŠ è¯„è®º',
                    'åˆ é™¤è¯„è®º',
                    
                    // ç³»ç»Ÿå…³é”®é”™è¯¯
                    'æ•°æ®åŒæ­¥å¤±è´¥',
                    'æ•°æ®æ¢å¤'
                ];

                // åªå‘é€ERRORçº§åˆ«ä¸­ä¸ä¸Šè¿°æ“ä½œç›¸å…³çš„æ—¥å¿—
                if (log.level === 'ERROR') {
                    return criticalMessages.some(msg => log.message.includes(msg));
                }

                // é‡è¦æ“ä½œçš„ä¿¡æ¯çº§æ—¥å¿—
                if (log.level === 'INFO' && criticalMessages.some(msg => log.message.includes(msg))) {
                    return true;
                }

                // ä¸æ ¸å¿ƒæ“ä½œç›¸å…³çš„è­¦å‘Šæ—¥å¿—
                if (log.level === 'WARN' && criticalMessages.some(msg => log.message.includes(msg))) {
                    return true;
                }

                return false;
            }

            saveToRetryQueue(log) {
                try {
                    const retryQueue = JSON.parse(localStorage.getItem('beestoreLogRetryQueue') || '[]');
                    retryQueue.push({
                        ...log,
                        retryAttempts: 0,
                        queuedAt: new Date().toISOString()
                    });
                    
                    // é™åˆ¶é‡è¯•é˜Ÿåˆ—å¤§å°
                    if (retryQueue.length > 100) {
                        retryQueue.splice(100);
                    }
                    
                    localStorage.setItem('beestoreLogRetryQueue', JSON.stringify(retryQueue));
                } catch (e) {
                    console.error('ä¿å­˜é‡è¯•é˜Ÿåˆ—å¤±è´¥:', e);
                }
            }

            async retryFailedLogs() {
                try {
                    const retryQueue = JSON.parse(localStorage.getItem('beestoreLogRetryQueue') || '[]');
                    if (retryQueue.length === 0) return;

                    const successfullyRetried = [];
                    
                    for (const queuedLog of retryQueue) {
                        if (queuedLog.retryAttempts < 3) {
                            try {
                                await this.sendToCloud(queuedLog);
                                successfullyRetried.push(queuedLog);
                            } catch (e) {
                                queuedLog.retryAttempts++;
                            }
                        } else {
                            // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œç§»é™¤
                            successfullyRetried.push(queuedLog);
                        }
                    }

                    // æ›´æ–°é‡è¯•é˜Ÿåˆ—
                    const remainingQueue = retryQueue.filter(log => !successfullyRetried.includes(log));
                    localStorage.setItem('beestoreLogRetryQueue', JSON.stringify(remainingQueue));

                } catch (e) {
                    console.error('é‡è¯•å¤±è´¥çš„æ—¥å¿—æ—¶å‡ºé”™:', e);
                }
            }

            // æ¸…ç†è¶…è¿‡48å°æ—¶çš„æ—¥å¿—
            cleanExpiredLogs(logs) {
                if (!Array.isArray(logs)) return [];
                
                const fortyEightHoursAgo = new Date();
                fortyEightHoursAgo.setHours(fortyEightHoursAgo.getHours() - 48);
                
                const validLogs = logs.filter(log => {
                    try {
                        const logTime = new Date(log.timestamp);
                        return logTime > fortyEightHoursAgo;
                    } catch (e) {
                        // å¦‚æœæ—¶é—´æˆ³è§£æå¤±è´¥ï¼Œä¿ç•™æ—¥å¿—ï¼ˆå®‰å…¨èµ·è§ï¼‰
                        return true;
                    }
                });
                
                const removedCount = logs.length - validLogs.length;
                if (removedCount > 0) {
                    console.log(`[BeeStore] æ¸…ç†äº† ${removedCount} æ¡è¶…è¿‡48å°æ—¶çš„äº‘ç«¯æ—¥å¿—ï¼Œå‰©ä½™ ${validLogs.length} æ¡`);
                    
                    // è®°å½•æ¸…ç†æ“ä½œåˆ°æœ¬åœ°æ—¥å¿—ï¼ˆä¸å‘é€åˆ°äº‘ç«¯é¿å…å¾ªç¯ï¼‰
                    const cleanupLog = this.getFormattedLog('INFO', `è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ—¥å¿—`, {
                        removedCount: removedCount,
                        remainingCount: validLogs.length,
                        operation: 'ç³»ç»Ÿç»´æŠ¤'
                    });
                    this.logs.unshift(cleanupLog);
                    this.saveLogs();
                }
                
                return validLogs;
            }

            // å®šæœŸæ¸…ç†äº‘ç«¯æ—¥å¿—ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
            async cleanupCloudLogs() {
                try {
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) return;
                    
                    const result = await response.json();
                    const allLogs = result.record?.centralLogs || [];
                    const cleanedLogs = this.cleanExpiredLogs(allLogs);
                    
                    // å¦‚æœæ¸…ç†äº†æ—¥å¿—ï¼Œæ›´æ–°äº‘ç«¯æ•°æ®
                    if (cleanedLogs.length < allLogs.length) {
                        const fullCloudData = {
                            ...result.record,
                            centralLogs: cleanedLogs
                        };
                        
                        await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(fullCloudData)
                        });
                        
                        const removedCount = allLogs.length - cleanedLogs.length;
                        console.log(`[BeeStore] å®šæœŸæ¸…ç†å®Œæˆï¼Œç§»é™¤ ${removedCount} æ¡è¿‡æœŸæ—¥å¿—ï¼Œå‰©ä½™ ${cleanedLogs.length} æ¡`);
                        
                        // è®°å½•å®šæœŸæ¸…ç†æ“ä½œåˆ°æœ¬åœ°æ—¥å¿—
                        const cleanupLog = this.getFormattedLog('INFO', `å®šæœŸæ¸…ç†äº‘ç«¯æ—¥å¿—`, {
                            removedCount: removedCount,
                            remainingCount: cleanedLogs.length,
                            operation: 'ç³»ç»Ÿç»´æŠ¤'
                        });
                        this.logs.unshift(cleanupLog);
                        this.saveLogs();
                    }
                } catch (error) {
                    console.warn('å®šæœŸæ¸…ç†äº‘ç«¯æ—¥å¿—å¤±è´¥:', error);
                }
            }

            getLogs(limit = 100, level = null, username = null) {
                let filteredLogs = this.logs;

                if (level) {
                    filteredLogs = filteredLogs.filter(log => log.level === level);
                }

                if (username) {
                    filteredLogs = filteredLogs.filter(log => log.user.username === username);
                }

                return filteredLogs.slice(0, limit);
            }

            clearLogs() {
                this.logs = [];
                localStorage.removeItem('beestoreLogs');
                console.log('[BeeStore] æ—¥å¿—å·²æ¸…ç©º');
            }

            // è·å–äº‘ç«¯æ—¥å¿—ï¼ˆä»…adminå¯ç”¨ï¼‰
            async getCloudLogs(limit = 100, level = null, username = null) {
                try {
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error('è·å–äº‘ç«¯æ—¥å¿—å¤±è´¥');
                    }
                    
                    const result = await response.json();
                    const allLogs = result.record?.centralLogs || [];
                    
                    // æ¸…ç†è¿‡æœŸæ—¥å¿—
                    let cloudLogs = this.cleanExpiredLogs(allLogs);
                    
                    // åº”ç”¨ç­›é€‰
                    if (level) {
                        cloudLogs = cloudLogs.filter(log => log.level === level);
                    }
                    
                    if (username) {
                        cloudLogs = cloudLogs.filter(log => 
                            log.user && log.user.username && log.user.username.toLowerCase().includes(username.toLowerCase())
                        );
                    }
                    
                    return cloudLogs.slice(0, limit);
                } catch (error) {
                    console.error('è·å–äº‘ç«¯æ—¥å¿—å¤±è´¥:', error);
                    throw error;
                }
            }

            // æ¸…ç©ºäº‘ç«¯æ—¥å¿—ï¼ˆä»…adminå¯ç”¨ï¼‰
            async clearCloudLogs() {
                try {
                    // è·å–ç°æœ‰æ•°æ®ç»“æ„
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    let fullCloudData = {
                        users: [],
                        apps: [],
                        lastSync: null,
                        centralLogs: []
                    };
                    
                    if (response.ok) {
                        const existingData = await response.json();
                        if (existingData.record) {
                            fullCloudData = {
                                ...existingData.record,
                                centralLogs: []
                            };
                        }
                    }
                    
                    // ä¿å­˜æ¸…ç©ºåçš„æ•°æ®
                    await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullCloudData)
                    });
                    
                    console.log('[BeeStore] äº‘ç«¯æ—¥å¿—å·²æ¸…ç©º');
                } catch (error) {
                    console.error('æ¸…ç©ºäº‘ç«¯æ—¥å¿—å¤±è´¥:', error);
                    throw error;
                }
            }

            // æ•°æ®å¿«ç…§åŠŸèƒ½
            snapshot(description, data, metadata = {}) {
                try {
                    // åˆ›å»ºæ·±æ‹·è´å¹¶å‹ç¼©æ•°æ®
                    const snapshotData = JSON.parse(JSON.stringify(data));
                    const compressedData = this.compressData(snapshotData);
                    
                    // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä¼˜å…ˆcurrentUserï¼Œå¤‡é€‰localStorageï¼‰
                    let userInfo = { id: null, username: 'guest' };
                    if (currentUser && currentUser.id && currentUser.username) {
                        userInfo = {
                            id: currentUser.id,
                            username: currentUser.username
                        };
                    } else {
                        // ä»localStorageè·å–å¤‡é€‰ç”¨æˆ·ä¿¡æ¯
                        try {
                            const storedUser = localStorage.getItem('currentUser');
                            if (storedUser) {
                                const userData = JSON.parse(storedUser);
                                if (userData.id && userData.username) {
                                    userInfo = {
                                        id: userData.id,
                                        username: userData.username
                                    };
                                }
                            }
                        } catch (e) {
                            console.warn('æ— æ³•ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯:', e);
                        }
                    }

                    const snapshot = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        description,
                        data: compressedData,
                        metadata: {
                            ...metadata,
                            dataSize: JSON.stringify(data).length,
                            compressedSize: JSON.stringify(compressedData).length,
                            user: userInfo,
                            userVerified: currentUser ? true : false,
                            userSource: currentUser ? 'currentUser' : 'localStorage'
                        },
                        type: 'SNAPSHOT'
                    };

                    // è·å–ç°æœ‰å¿«ç…§
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    snapshots.unshift(snapshot);

                    // é™åˆ¶å¿«ç…§æ•°é‡ (æœ€å¤šä¿å­˜50ä¸ªå¿«ç…§)
                    if (snapshots.length > 50) {
                        snapshots.splice(50);
                    }

                    localStorage.setItem('beestoreSnapshots', JSON.stringify(snapshots));
                    
                    this.info(`æ•°æ®å¿«ç…§å·²åˆ›å»º: ${description}`, {
                        snapshotId: snapshot.id,
                        dataSize: snapshot.metadata.dataSize,
                        compressedSize: snapshot.metadata.compressedSize,
                        operation: 'æ•°æ®å¿«ç…§'
                    });

                    return snapshot;
                } catch (error) {
                    this.error('åˆ›å»ºæ•°æ®å¿«ç…§å¤±è´¥', { error: error.message, description });
                    throw error;
                }
            }

            compressData(data) {
                // ç®€å•çš„æ•°æ®å‹ç¼©ï¼šç§»é™¤ä¸å¿…è¦çš„å­—æ®µï¼Œä¿ç•™æ ¸å¿ƒæ•°æ®
                if (Array.isArray(data)) {
                    return data.map(item => this.compressData(item));
                }
                
                if (typeof data === 'object' && data !== null) {
                    const compressed = {};
                    for (const [key, value] of Object.entries(data)) {
                        // è·³è¿‡ä¸€äº›ä¸´æ—¶æˆ–ä¸é‡è¦çš„å­—æ®µ
                        if (!['lastSync', 'id'].includes(key) || key === 'id') {
                            compressed[key] = this.compressData(value);
                        }
                    }
                    return compressed;
                }
                
                return data;
            }

            decompressData(compressedData) {
                // è§£å‹ç¼©æ•°æ®ï¼ˆå½“å‰å®ç°ä¸­å‹ç¼©ç¨‹åº¦æœ‰é™ï¼Œä¸»è¦æ˜¯æ•°æ®ç»“æ„ä¿æŒï¼‰
                return JSON.parse(JSON.stringify(compressedData));
            }

            getSnapshots(limit = 50, type = null) {
                try {
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    
                    let filteredSnapshots = snapshots;
                    if (type) {
                        filteredSnapshots = snapshots.filter(snapshot => 
                            snapshot.metadata.snapshotType === type
                        );
                    }

                    return filteredSnapshots.slice(0, limit);
                } catch (error) {
                    this.error('è·å–å¿«ç…§åˆ—è¡¨å¤±è´¥', { error: error.message });
                    return [];
                }
            }

            restoreFromSnapshot(snapshotId, targetType = 'full') {
                try {
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    const snapshot = snapshots.find(s => s.id === snapshotId);
                    
                    if (!snapshot) {
                        throw new Error('å¿«ç…§ä¸å­˜åœ¨');
                    }

                    // è§£å‹ç¼©æ•°æ®
                    const restoredData = this.decompressData(snapshot.data);
                    
                    this.info(`å¼€å§‹ä»å¿«ç…§æ¢å¤æ•°æ®: ${snapshot.description}`, {
                        snapshotId: snapshotId,
                        targetType: targetType,
                        operation: 'æ•°æ®æ¢å¤'
                    });

                    // æ ¹æ®ç›®æ ‡ç±»å‹æ¢å¤æ•°æ®
                    switch (targetType) {
                        case 'apps':
                            if (restoredData.apps) {
                                cloudData.apps = restoredData.apps;
                            } else if (Array.isArray(restoredData)) {
                                cloudData.apps = restoredData;
                            }
                            break;
                        case 'users':
                            if (restoredData.users) {
                                cloudData.users = restoredData.users;
                            } else if (Array.isArray(restoredData)) {
                                cloudData.users = restoredData;
                            }
                            break;
                        case 'full':
                        default:
                            if (restoredData.apps) cloudData.apps = restoredData.apps;
                            if (restoredData.users) cloudData.users = restoredData.users;
                            if (restoredData.lastSync) cloudData.lastSync = restoredData.lastSync;
                            break;
                    }

                    this.info(`æ•°æ®æ¢å¤å®Œæˆ: ${snapshot.description}`, {
                        snapshotId: snapshotId,
                        targetType: targetType,
                        restoredApps: cloudData.apps?.length || 0,
                        restoredUsers: cloudData.users?.length || 0,
                        operation: 'æ•°æ®æ¢å¤å®Œæˆ'
                    });

                    return restoredData;
                } catch (error) {
                    this.error('æ•°æ®æ¢å¤å¤±è´¥', { 
                        snapshotId, 
                        targetType, 
                        error: error.message 
                    });
                    throw error;
                }
            }

            clearSnapshots() {
                localStorage.removeItem('beestoreSnapshots');
                this.info('æ‰€æœ‰æ•°æ®å¿«ç…§å·²æ¸…ç©º', { operation: 'æ¸…ç©ºå¿«ç…§' });
            }
        }

        const logger = new Logger();

        // æœ¬åœ°ç¼“å­˜ç®¡ç†ç±»
        class LocalCache {
            constructor() {
                this.cacheKey = 'beestoreCloudData';
                this.metaKey = 'beestoreCloudMeta';
            }

            saveToLocal(data) {
                try {
                    const cacheData = {
                        data: data,
                        lastModified: new Date().toISOString(),
                        version: Date.now()
                    };
                    
                    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    
                    const meta = {
                        syncStatus: 'pending',
                        lastSyncAttempt: null,
                        pendingOperations: this.getPendingOperations().length
                    };
                    localStorage.setItem(this.metaKey, JSON.stringify(meta));
                    
                    return true;
                } catch (error) {
                    logger.error('ä¿å­˜æœ¬åœ°ç¼“å­˜å¤±è´¥', { error: error.message });
                    return false;
                }
            }

            loadFromLocal() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (!cached) return null;
                    
                    const cacheData = JSON.parse(cached);
                    return cacheData.data;
                } catch (error) {
                    logger.error('åŠ è½½æœ¬åœ°ç¼“å­˜å¤±è´¥', { error: error.message });
                    return null;
                }
            }

            getLocalMeta() {
                try {
                    const meta = localStorage.getItem(this.metaKey);
                    return meta ? JSON.parse(meta) : null;
                } catch (error) {
                    return null;
                }
            }

            isLocalNewer(localTime, remoteTime) {
                if (!localTime || !remoteTime) return false;
                return new Date(localTime) > new Date(remoteTime);
            }

            markSynced() {
                try {
                    const meta = this.getLocalMeta() || {};
                    meta.syncStatus = 'synced';
                    meta.lastSyncAttempt = new Date().toISOString();
                    localStorage.setItem(this.metaKey, JSON.stringify(meta));
                } catch (error) {
                    logger.error('æ ‡è®°åŒæ­¥çŠ¶æ€å¤±è´¥', { error: error.message });
                }
            }

            addPendingOperation(operation) {
                try {
                    const operations = this.getPendingOperations();
                    operations.push({
                        ...operation,
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('beestorePendingOps', JSON.stringify(operations));
                } catch (error) {
                    logger.error('æ·»åŠ å¾…åŒæ­¥æ“ä½œå¤±è´¥', { error: error.message });
                }
            }

            getPendingOperations() {
                try {
                    const ops = localStorage.getItem('beestorePendingOps');
                    return ops ? JSON.parse(ops) : [];
                } catch (error) {
                    return [];
                }
            }

            clearPendingOperations() {
                localStorage.removeItem('beestorePendingOps');
            }
        }

        // å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—ç®¡ç†ç±»
        class SyncQueue {
            constructor(localCache) {
                this.localCache = localCache;
                this.isProcessing = false;
                this.maxRetries = 3;
                this.retryDelay = 2000; // 2ç§’
            }

            async addOperation(operation) {
                // å¯¹äºå¯åˆ‡æ¢æ“ä½œï¼ˆç‚¹èµã€æ”¶è—ï¼‰ï¼Œç§»é™¤å†²çªçš„æ—§æ“ä½œ
                this.removeConflictingOperations(operation);
                
                // æ£€æŸ¥æ“ä½œå»é‡
                if (this.isDuplicateOperation(operation)) {
                    logger.info('è·³è¿‡é‡å¤æ“ä½œ', { 
                        type: operation.type,
                        target: operation.appId || operation.userId,
                        operation: 'æ“ä½œå»é‡'
                    });
                    return;
                }
                
                // æ·»åŠ åˆ°æœ¬åœ°é˜Ÿåˆ—
                this.localCache.addPendingOperation(operation);
                
                // è§¦å‘å¼‚æ­¥å¤„ç†
                this.processQueueAsync();
            }

            isDuplicateOperation(newOperation) {
                const pendingOps = this.localCache.getPendingOperations();
                
                // ç”Ÿæˆæ“ä½œå”¯ä¸€æ ‡è¯†
                const newOpKey = this.generateOperationKey(newOperation);
                
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒæ“ä½œï¼ˆ5åˆ†é’Ÿå†…çš„æ“ä½œè®¤ä¸ºæ˜¯é‡å¤ï¼‰
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                
                return pendingOps.some(op => {
                    const opTime = new Date(op.timestamp);
                    const opKey = this.generateOperationKey(op);
                    
                    return opKey === newOpKey && opTime > fiveMinutesAgo;
                });
            }

            generateOperationKey(operation) {
                // æ ¹æ®æ“ä½œç±»å‹ç”Ÿæˆå”¯ä¸€æ ‡è¯†
                switch (operation.type) {
                    case 'like':
                    case 'favorite':
                        return `${operation.type}_${operation.appId}_${operation.userId}`;
                    case 'comment_add':
                        // è¯„è®ºæŒ‰å†…å®¹å»é‡ï¼ˆé˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤æäº¤ç›¸åŒè¯„è®ºï¼‰
                        return `${operation.type}_${operation.appId}_${operation.userId}_${operation.data?.commentContent}`;
                    case 'comment_delete':
                        return `${operation.type}_${operation.commentId}_${operation.userId}`;
                    case 'app_publish':
                    case 'app_edit':
                        return `${operation.type}_${operation.appId}_${operation.userId}`;
                    case 'user_register':
                        return `${operation.type}_${operation.userId}`;
                    default:
                        // é»˜è®¤æŒ‰ç±»å‹+ç”¨æˆ·+æ—¶é—´å»é‡
                        return `${operation.type}_${operation.userId}_${Math.floor(Date.now() / 60000)}`; // æŒ‰åˆ†é’Ÿå»é‡
                }
            }

            removeConflictingOperations(newOperation) {
                // å¯¹äºå¯åˆ‡æ¢çš„æ“ä½œï¼ˆç‚¹èµã€æ”¶è—ï¼‰ï¼Œç§»é™¤åŒä¸€ç›®æ ‡çš„æ—§æ“ä½œ
                if (newOperation.type === 'like' || newOperation.type === 'favorite') {
                    try {
                        const operations = this.localCache.getPendingOperations();
                        const conflictKey = `${newOperation.type}_${newOperation.appId}_${newOperation.userId}`;
                        
                        const filteredOps = operations.filter(op => {
                            const opKey = this.generateOperationKey(op);
                            return opKey !== conflictKey;
                        });
                        
                        const removedCount = operations.length - filteredOps.length;
                        if (removedCount > 0) {
                            localStorage.setItem('beestorePendingOps', JSON.stringify(filteredOps));
                            logger.info('ç§»é™¤å†²çªçš„å¾…åŒæ­¥æ“ä½œ', {
                                type: newOperation.type,
                                target: newOperation.appId,
                                removedCount: removedCount,
                                operation: 'æ“ä½œå†²çªå¤„ç†'
                            });
                        }
                    } catch (error) {
                        logger.error('ç§»é™¤å†²çªæ“ä½œå¤±è´¥', { 
                            error: error.message,
                            operation: 'æ“ä½œå†²çªå¤„ç†å¤±è´¥'
                        });
                    }
                }
            }

            async processQueueAsync() {
                if (this.isProcessing) return;
                
                // å»¶è¿Ÿå¤„ç†ï¼Œé¿å…é¢‘ç¹åŒæ­¥
                setTimeout(() => {
                    this.processQueue();
                }, 500);
            }

            async processQueue() {
                if (this.isProcessing) return;
                this.isProcessing = true;

                try {
                    const operations = this.localCache.getPendingOperations();
                    if (operations.length === 0) {
                        this.isProcessing = false;
                        return;
                    }

                    logger.info('å¼€å§‹å¤„ç†åŒæ­¥é˜Ÿåˆ—', { 
                        operationsCount: operations.length,
                        operation: 'é˜Ÿåˆ—åŒæ­¥'
                    });

                    updateStatus('â˜ï¸ åå°åŒæ­¥ä¸­...', 'syncing-background');

                    // å°è¯•åå°åŒæ­¥
                    await syncData(0, true);
                    
                    // åŒæ­¥æˆåŠŸï¼Œæ¸…ç©ºé˜Ÿåˆ—å¹¶æ¸…ç†è¿‡æœŸæ“ä½œ
                    this.localCache.clearPendingOperations();
                    this.localCache.markSynced();
                    this.cleanupExpiredOperations();
                    
                    updateStatus('â˜ï¸ åŒæ­¥å®Œæˆ', 'connected');
                    
                    logger.info('åŒæ­¥é˜Ÿåˆ—å¤„ç†å®Œæˆ', { 
                        processedCount: operations.length,
                        operation: 'é˜Ÿåˆ—åŒæ­¥å®Œæˆ'
                    });

                } catch (error) {
                    logger.error('åŒæ­¥é˜Ÿåˆ—å¤„ç†å¤±è´¥', { 
                        error: error.message,
                        operation: 'é˜Ÿåˆ—åŒæ­¥å¤±è´¥'
                    });
                    
                    updateStatus('âš ï¸ åŒæ­¥å¤±è´¥ï¼Œå°†é‡è¯•', 'sync-failed');
                    
                    // è®¾ç½®é‡è¯•
                    setTimeout(() => {
                        this.retryFailedSync();
                    }, this.retryDelay);
                    
                } finally {
                    this.isProcessing = false;
                }
            }

            async retryFailedSync() {
                const operations = this.localCache.getPendingOperations();
                if (operations.length > 0) {
                    logger.info('é‡è¯•å¤±è´¥çš„åŒæ­¥æ“ä½œ', { 
                        operationsCount: operations.length,
                        operation: 'åŒæ­¥é‡è¯•'
                    });
                    await this.processQueue();
                }
            }

            cleanupExpiredOperations() {
                try {
                    const operations = this.localCache.getPendingOperations();
                    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000); // 24å°æ—¶å‰
                    
                    const validOperations = operations.filter(op => {
                        try {
                            const opTime = new Date(op.timestamp);
                            return opTime > oneDayAgo;
                        } catch (e) {
                            // æ—¶é—´æˆ³è§£æå¤±è´¥ï¼Œä¿ç•™æ“ä½œï¼ˆå®‰å…¨èµ·è§ï¼‰
                            return true;
                        }
                    });
                    
                    const removedCount = operations.length - validOperations.length;
                    if (removedCount > 0) {
                        localStorage.setItem('beestorePendingOps', JSON.stringify(validOperations));
                        logger.info('æ¸…ç†è¿‡æœŸçš„å¾…åŒæ­¥æ“ä½œ', {
                            removedCount: removedCount,
                            remainingCount: validOperations.length,
                            operation: 'æ“ä½œé˜Ÿåˆ—æ¸…ç†'
                        });
                    }
                } catch (error) {
                    logger.error('æ¸…ç†è¿‡æœŸæ“ä½œå¤±è´¥', { 
                        error: error.message,
                        operation: 'æ“ä½œé˜Ÿåˆ—æ¸…ç†å¤±è´¥'
                    });
                }
            }
        }

        const localCache = new LocalCache();
        const syncQueue = new SyncQueue(localCache);

        // ç•Œé¢åˆå§‹åŒ–å‡½æ•°
        function initializeInterface() {
            // ç¡®ä¿æ•°æ®ç»“æ„å…¼å®¹æ€§ï¼ˆä¸ºæ—§æ•°æ®æ·»åŠ æ–°å­—æ®µï¼‰
            if (cloudData.apps) {
                cloudData.apps.forEach(app => {
                    if (!app.likes) app.likes = [];
                    if (!app.favorites) app.favorites = [];
                    if (!app.comments) app.comments = [];
                });
            }
            
            // æ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    // éªŒè¯ç”¨æˆ·æ˜¯å¦ä»ç„¶å­˜åœ¨
                    let user = cloudData.users.find(u => u.id === userData.id);
                    
                    if (user) {
                        // ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§éªŒè¯
                        if (!user.id || !user.username || !user.email) {
                            logger.warn('æ£€æµ‹åˆ°ç”¨æˆ·çŠ¶æ€ä¸å®Œæ•´ï¼Œæ¸…é™¤æœ¬åœ°ç™»å½•çŠ¶æ€', {
                                userId: user.id,
                                username: user.username,
                                hasEmail: !!user.email,
                                operation: 'ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§æ£€æŸ¥'
                            });
                            localStorage.removeItem('currentUser');
                            showGuestNav();
                        } else {
                            currentUser = user;
                            showUserNav();
                        }
                    } else {
                        showGuestNav();
                    }
                } catch (error) {
                    logger.error('è§£ææœ¬åœ°ç”¨æˆ·æ•°æ®å¤±è´¥', { error: error.message });
                    localStorage.removeItem('currentUser');
                    showGuestNav();
                }
            } else {
                showGuestNav();
            }

            // åŠ è½½åº”ç”¨å’Œæ›´æ–°ç»Ÿè®¡
            loadApps();
            updateStats();
            
            // è®¾ç½®æœç´¢äº‹ä»¶
            setupSearchEvents();
            
            // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰èœå•çŠ¶æ€
            initDropdowns();
        }

        // æ•°æ®åˆå¹¶å‡½æ•°
        function mergeCloudData(remoteData) {
            logger.info('å¼€å§‹åˆå¹¶äº‘ç«¯å’Œæœ¬åœ°æ•°æ®', { 
                localUsers: cloudData?.users?.length || 0,
                localApps: cloudData?.apps?.length || 0,
                remoteUsers: remoteData?.users?.length || 0,
                remoteApps: remoteData?.apps?.length || 0,
                operation: 'æ•°æ®åˆå¹¶'
            });
            
            // å¦‚æœæ²¡æœ‰æœ¬åœ°æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨è¿œç¨‹æ•°æ®
            if (!cloudData || !cloudData.users || !cloudData.apps) {
                logger.info('æ— æœ¬åœ°æ•°æ®ï¼Œä½¿ç”¨è¿œç¨‹æ•°æ®', { operation: 'æ•°æ®åˆå¹¶' });
                return remoteData || { users: [], apps: [], lastSync: null };
            }

            // å¦‚æœæ²¡æœ‰è¿œç¨‹æ•°æ®ï¼Œä¿æŒæœ¬åœ°æ•°æ®
            if (!remoteData || !remoteData.users || !remoteData.apps) {
                logger.info('æ— è¿œç¨‹æ•°æ®ï¼Œä¿æŒæœ¬åœ°æ•°æ®', { operation: 'æ•°æ®åˆå¹¶' });
                return cloudData;
            }

            // åœ¨æ•°æ®åˆå¹¶å‰åˆ›å»ºå¿«ç…§
            try {
                logger.snapshot('æ•°æ®åˆå¹¶å‰æœ¬åœ°æ•°æ®å¿«ç…§', cloudData, {
                    snapshotType: 'local_before_merge',
                    operation: 'æ•°æ®åˆå¹¶å‰æœ¬åœ°',
                    localUsers: cloudData.users.length,
                    localApps: cloudData.apps.length
                });
                
                logger.snapshot('æ•°æ®åˆå¹¶å‰è¿œç¨‹æ•°æ®å¿«ç…§', remoteData, {
                    snapshotType: 'remote_before_merge',
                    operation: 'æ•°æ®åˆå¹¶å‰è¿œç¨‹',
                    remoteUsers: remoteData.users.length,
                    remoteApps: remoteData.apps.length
                });
            } catch (snapshotError) {
                logger.warn('åˆ›å»ºåˆå¹¶å‰å¿«ç…§å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåˆå¹¶', { 
                    error: snapshotError.message 
                });
            }

            const merged = {
                users: [],
                apps: [],
                lastSync: remoteData.lastSync || new Date().toISOString()
            };

            // åˆå¹¶ç”¨æˆ·æ•°æ®ï¼ˆåŸºäºIDå’Œåˆ›å»ºæ—¶é—´ï¼‰
            const allUsers = [...cloudData.users, ...remoteData.users];
            const userMap = new Map();
            
            allUsers.forEach(user => {
                const existing = userMap.get(user.id);
                if (!existing || new Date(user.createdAt) >= new Date(existing.createdAt)) {
                    userMap.set(user.id, user);
                }
            });
            merged.users = Array.from(userMap.values());

            // åˆå¹¶åº”ç”¨æ•°æ®ï¼ˆåŸºäºIDå’Œåˆ›å»ºæ—¶é—´ï¼‰
            const allApps = [...cloudData.apps, ...remoteData.apps];
            const appMap = new Map();
            
            allApps.forEach(app => {
                const existing = appMap.get(app.id);
                if (!existing || new Date(app.createdAt) >= new Date(existing.createdAt)) {
                    appMap.set(app.id, app);
                }
            });
            merged.apps = Array.from(appMap.values());

            logger.info('æ•°æ®åˆå¹¶å®Œæˆ', { 
                finalUsers: merged.users.length,
                finalApps: merged.apps.length,
                operation: 'æ•°æ®åˆå¹¶å®Œæˆ'
            });

            return merged;
        }

        // çŠ¶æ€ç®¡ç† - ä¿ç•™ç”¨äºå†…éƒ¨æ—¥å¿—ï¼Œä¸æ˜¾ç¤ºç»™ç”¨æˆ·
        function updateStatus(message, type = 'syncing') {
            // åªè®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸æ˜¾ç¤ºUIçŠ¶æ€
            console.log(`[BeeStore Status] ${type.toUpperCase()}: ${message}`);
            
            // è®°å½•çŠ¶æ€å˜åŒ–åˆ°æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            if (type === 'error' || type === 'sync-failed') {
                logger.warn('ç³»ç»ŸçŠ¶æ€å˜åŒ–', { 
                    message: message, 
                    type: type,
                    operation: 'çŠ¶æ€æ›´æ–°'
                });
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            logger.info('Bee Store åº”ç”¨å¯åŠ¨', { 
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                operation: 'åº”ç”¨å¯åŠ¨'
            });
            
            // ä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜åŠ è½½ï¼Œå¿«é€Ÿå¯åŠ¨
            const cachedData = localCache.loadFromLocal();
            if (cachedData) {
                cloudData = cachedData;
                updateStatus('ğŸ“± ä»æœ¬åœ°ç¼“å­˜åŠ è½½', 'connected');
                logger.info('ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®å¿«é€Ÿå¯åŠ¨', { 
                    localUsers: cloudData.users?.length || 0,
                    localApps: cloudData.apps?.length || 0,
                    operation: 'æœ¬åœ°ç¼“å­˜å¯åŠ¨'
                });
                
                // ç«‹å³æ˜¾ç¤ºç•Œé¢
                initializeInterface();
            } else {
                updateStatus('â˜ï¸ æ­£åœ¨åŒæ­¥æ•°æ®...', 'syncing');
            }
            
            try {
                // åå°å¼‚æ­¥ä»äº‘ç«¯åŠ è½½æ•°æ®å¹¶åˆå¹¶
                updateStatus('ğŸ”„ åå°åŒæ­¥ä¸­...', 'syncing-background');
                const remoteData = await cloudStorage.loadData();
                
                if (cachedData) {
                    // æ™ºèƒ½åˆå¹¶æœ¬åœ°å’Œè¿œç¨‹æ•°æ®
                    cloudData = mergeCloudData(remoteData);
                } else {
                    // é¦–æ¬¡åŠ è½½ï¼Œç›´æ¥ä½¿ç”¨è¿œç¨‹æ•°æ®
                    cloudData = await mergeCloudData(remoteData);
                }
                
                // ä¿å­˜åˆå¹¶åçš„æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜
                localCache.saveToLocal(cloudData);
                
                updateStatus('â˜ï¸ æ•°æ®åŒæ­¥æˆåŠŸ', 'connected');
                
                // å¦‚æœä¹‹å‰æ²¡æœ‰æœ¬åœ°ç¼“å­˜ï¼Œç°åœ¨åˆå§‹åŒ–ç•Œé¢
                if (!cachedData) {
                    initializeInterface();
                } else {
                    // æœ‰æœ¬åœ°ç¼“å­˜æ—¶ï¼Œåªæ›´æ–°ç•Œé¢
                    loadApps();
                    updateStats();
                }
                
                // å¤„ç†å¾…åŒæ­¥çš„æ“ä½œ
                updateDropdownSelection('category', '');
                updateDropdownSelection('sort', 'newest');
                updateDropdownSelection('category-mobile', '');
                updateDropdownSelection('sort-mobile', 'newest');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('âŒ äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
                // ä½¿ç”¨æœ¬åœ°æ•°æ®æˆ–ç¤ºä¾‹æ•°æ®
                initLocalData();
                showGuestNav();
                loadApps();
                updateStats();
                
                // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰èœå•çŠ¶æ€
                updateDropdownSelection('category', '');
                updateDropdownSelection('sort', 'newest');
                updateDropdownSelection('category-mobile', '');
                updateDropdownSelection('sort-mobile', 'newest');
                
                // æç¤ºç”¨æˆ·æ£€æŸ¥ç½‘ç»œè¿æ¥
                setTimeout(() => {
                    console.log('æç¤ºï¼šå¦‚æœæ˜¯é¦–æ¬¡è®¿é—®æˆ–ç¯å¢ƒå˜é‡æœªé…ç½®ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚æ•°æ®å°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨ã€‚');
                }, 2000);
            }
            
            // æ·»åŠ é¡µé¢åˆ·æ–°ä¿æŠ¤
            setupPageRefreshProtection();
        }

        // é¡µé¢åˆ·æ–°ä¿æŠ¤
        function setupPageRefreshProtection() {
            window.addEventListener('beforeunload', (event) => {
                const pendingOps = localCache.getPendingOperations();
                if (pendingOps.length > 0) {
                    const message = `æ‚¨æœ‰ ${pendingOps.length} ä¸ªæ“ä½œæ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯ï¼Œåˆ·æ–°å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ`;
                    event.preventDefault();
                    event.returnValue = message;
                    return message;
                }
            });
        }

        // åˆå§‹åŒ–æœ¬åœ°æ•°æ®
        function initLocalData() {
            cloudData = {
                users: [
                    {
                        id: 1,
                        username: 'demo',
                        email: 'demo@example.com',
                        password: 'demo123',
                        createdAt: new Date().toISOString()
                    }
                ],
                apps: [
                    {
                        id: 1,
                        name: '2Brain',
                        url: 'https://portal.2brain.ai/',
                        description: 'çŸ¥è¯†åº“å‹AIå¹³å°ï¼Œå»ºç«‹çŸ¥è¯†åº“ã€æ™ºèƒ½ä½“ï¼ŒåŒ…æ‹¬æ¨¡æ¿å†™ä½œã€è‡ªç„¶è¯­è¨€excelåˆ†æã€æ™ºèƒ½å‡ºé¢˜è€ƒè¯•åˆ¤å·ç­‰åŠŸèƒ½',
                        category: 'å·¥å…·',
                        author: 'Beebee AI',
                        authorId: 1,
                        screenshot: '',
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Beebee Trademate',
                        url: 'https://beebee.com',
                        description: 'å•†æœºåŒ…ï¼Œå•†æœºæœç´¢å¼•æ“ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æœç´¢ã€AIç”Ÿæˆé‚®ä»¶ä¸€é”®å‘é€',
                        category: 'å·¥å…·',
                        author: 'Beebee AI',
                        authorId: 1,
                        screenshot: '',
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    }
                ],
                lastSync: new Date().toISOString()
            };
        }

        // åŒæ­¥æ•°æ®åˆ°äº‘ç«¯
        async function syncData(retryCount = 0, isBackground = false) {
            const maxRetries = 3;
            
            if (retryCount === 0) {
                logger.info('å¼€å§‹æ•°æ®åŒæ­¥åˆ°äº‘ç«¯', { 
                    usersCount: cloudData.users.length,
                    appsCount: cloudData.apps.length,
                    isBackground: isBackground,
                    operation: 'æ•°æ®åŒæ­¥'
                });
                
                if (isBackground) {
                    updateStatus('ğŸ”„ åå°åŒæ­¥ä¸­...', 'syncing-background');
                } else {
                    updateStatus('â˜ï¸ æ­£åœ¨åŒæ­¥...', 'syncing');
                }
            } else {
                logger.warn(`æ•°æ®åŒæ­¥é‡è¯• ${retryCount}/${maxRetries}`, { 
                    retryCount: retryCount,
                    maxRetries: maxRetries,
                    isBackground: isBackground,
                    operation: 'æ•°æ®åŒæ­¥é‡è¯•'
                });
                
                if (isBackground) {
                    updateStatus(`ğŸ”„ åå°é‡è¯• (${retryCount}/${maxRetries})...`, 'syncing-background');
                } else {
                    updateStatus(`â˜ï¸ é‡è¯•åŒæ­¥ (${retryCount}/${maxRetries})...`, 'syncing');
                }
            }
            
            try {
                // ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
                if (currentUser) {
                    const userInData = cloudData.users.find(u => u.id === currentUser.id);
                    if (!userInData) {
                        logger.warn('åŒæ­¥æ—¶å‘ç°ç”¨æˆ·æ•°æ®ä¸ä¸€è‡´ï¼Œæ·»åŠ å½“å‰ç”¨æˆ·åˆ°cloudData', {
                            currentUserId: currentUser.id,
                            currentUserName: currentUser.username,
                            operation: 'ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§ä¿®å¤'
                        });
                        cloudData.users.push(currentUser);
                    } else if (userInData.username !== currentUser.username) {
                        logger.warn('åŒæ­¥æ—¶å‘ç°ç”¨æˆ·åä¸ä¸€è‡´ï¼Œæ›´æ–°cloudDataä¸­çš„ç”¨æˆ·ä¿¡æ¯', {
                            currentUserId: currentUser.id,
                            cloudUsername: userInData.username,
                            currentUsername: currentUser.username,
                            operation: 'ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§ä¿®å¤'
                        });
                        userInData.username = currentUser.username;
                        userInData.email = currentUser.email;
                    }
                }
                
                cloudData.lastSync = new Date().toISOString();
                
                // æ£€æŸ¥æ•°æ®å¤§å°
                const dataSize = JSON.stringify(cloudData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB é™åˆ¶
                
                logger.info('æ•°æ®å¤§å°æ£€æŸ¥', { 
                    dataSize: dataSize,
                    dataSizeMB: Math.round(dataSize / 1024 / 1024 * 100) / 100,
                    maxSizeMB: Math.round(maxSize / 1024 / 1024),
                    operation: 'æ•°æ®å¤§å°æ£€æŸ¥'
                });
                
                if (dataSize > maxSize) {
                    logger.error('æ•°æ®å¤§å°è¶…è¿‡é™åˆ¶', { 
                        dataSize: dataSize,
                        dataSizeMB: Math.round(dataSize / 1024 / 1024 * 100) / 100,
                        maxSizeMB: Math.round(maxSize / 1024 / 1024),
                        operation: 'æ•°æ®å¤§å°è¶…é™'
                    });
                    console.warn(`æ•°æ®å¤§å°è¿‡å¤§: ${Math.round(dataSize / 1024 / 1024 * 100) / 100}MB`);
                    updateStatus('âš ï¸ æ•°æ®è¿‡å¤§ï¼Œå»ºè®®æ¸…ç†', 'error');
                    throw new Error(`æ•°æ®å¤§å° ${Math.round(dataSize / 1024 / 1024 * 100) / 100}MB è¶…è¿‡é™åˆ¶ ${Math.round(maxSize / 1024 / 1024)}MB`);
                }
                
                // åœ¨åŒæ­¥å‰åˆ›å»ºå¿«ç…§
                try {
                    logger.snapshot('æ•°æ®åŒæ­¥å‰å¿«ç…§', cloudData, {
                        snapshotType: 'full_before_sync',
                        operation: 'æ•°æ®åŒæ­¥å‰',
                        usersCount: cloudData.users.length,
                        appsCount: cloudData.apps.length,
                        retryCount: retryCount
                    });
                } catch (snapshotError) {
                    logger.warn('åˆ›å»ºåŒæ­¥å‰å¿«ç…§å¤±è´¥ï¼Œç»§ç»­æ‰§è¡ŒåŒæ­¥', { 
                        retryCount: retryCount,
                        error: snapshotError.message 
                    });
                }
                
                await cloudStorage.saveData(cloudData);
                logger.info('æ•°æ®åŒæ­¥æˆåŠŸ', { 
                    usersCount: cloudData.users.length,
                    appsCount: cloudData.apps.length,
                    retryCount: retryCount,
                    isBackground: isBackground,
                    operation: 'æ•°æ®åŒæ­¥æˆåŠŸ'
                });
                
                if (isBackground) {
                    updateStatus('âœ… åå°åŒæ­¥å®Œæˆ', 'connected');
                } else {
                    updateStatus('â˜ï¸ åŒæ­¥æˆåŠŸ', 'connected');
                }
                updateStats();
                return true;
            } catch (error) {
                logger.error(`æ•°æ®åŒæ­¥å¤±è´¥ (å°è¯• ${retryCount + 1}/${maxRetries + 1})`, { 
                    error: error.message,
                    retryCount: retryCount,
                    maxRetries: maxRetries,
                    operation: 'æ•°æ®åŒæ­¥å¤±è´¥'
                });
                console.error(`åŒæ­¥å¤±è´¥ (å°è¯• ${retryCount + 1}/${maxRetries + 1}):`, error);
                
                if (retryCount < maxRetries) {
                    // æŒ‡æ•°é€€é¿é‡è¯•ï¼šç¬¬ä¸€æ¬¡1ç§’ï¼Œç¬¬äºŒæ¬¡2ç§’ï¼Œç¬¬ä¸‰æ¬¡4ç§’
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return await syncData(retryCount + 1, isBackground);
                } else {
                    if (isBackground) {
                        updateStatus('âš ï¸ åå°åŒæ­¥å¤±è´¥', 'sync-failed');
                    } else {
                        updateStatus('âŒ åŒæ­¥å¤±è´¥', 'error');
                    }
                    throw error;
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalAppsElement = document.getElementById('total-apps');
            const totalUsersElement = document.getElementById('total-users');
            
            if (totalAppsElement) {
                totalAppsElement.textContent = cloudData.apps ? cloudData.apps.length : 0;
            }
            if (totalUsersElement) {
                totalUsersElement.textContent = cloudData.users ? cloudData.users.length : 0;
            }
        }

        // è®¾ç½®æœç´¢äº‹ä»¶
        function setupSearchEvents() {
            // æ¡Œé¢ç«¯æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchApps();
                    }
                });
                searchInput.addEventListener('input', debounce(searchApps, 300));
            }

            // ç§»åŠ¨ç«¯æœç´¢æ¡†
            const searchInputMobile = document.getElementById('search-input-mobile');
            if (searchInputMobile) {
                searchInputMobile.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchApps();
                    }
                });
                searchInputMobile.addEventListener('input', debounce(searchApps, 300));
            }

            // åŒæ­¥æœç´¢æ¡†å†…å®¹
            function syncSearchInputs() {
                const desktopValue = searchInput ? searchInput.value : '';
                const mobileValue = searchInputMobile ? searchInputMobile.value : '';
                
                if (searchInput && searchInputMobile) {
                    if (document.activeElement === searchInput) {
                        searchInputMobile.value = desktopValue;
                    } else if (document.activeElement === searchInputMobile) {
                        searchInput.value = mobileValue;
                    }
                }
            }

            if (searchInput) searchInput.addEventListener('input', syncSearchInputs);
            if (searchInputMobile) searchInputMobile.addEventListener('input', syncSearchInputs);

            // ä¸ºç§»åŠ¨ç«¯ç­›é€‰å™¨æ·»åŠ äº‹ä»¶ç›‘å¬
            const categoryFilterMobile = document.getElementById('category-filter-mobile');
            const sortFilterMobile = document.getElementById('sort-filter-mobile');
            
            if (categoryFilterMobile) {
                categoryFilterMobile.addEventListener('change', searchApps);
            }
            if (sortFilterMobile) {
                sortFilterMobile.addEventListener('change', searchApps);
            }

            // åŒæ­¥æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯çš„ç­›é€‰å™¨å€¼
            function syncFilters() {
                const categoryFilter = document.getElementById('category-filter');
                const sortFilter = document.getElementById('sort-filter');
                
                if (categoryFilter && categoryFilterMobile) {
                    categoryFilter.addEventListener('change', function() {
                        categoryFilterMobile.value = this.value;
                        searchApps();
                    });
                    categoryFilterMobile.addEventListener('change', function() {
                        categoryFilter.value = this.value;
                    });
                }
                
                if (sortFilter && sortFilterMobile) {
                    sortFilter.addEventListener('change', function() {
                        sortFilterMobile.value = this.value;
                        searchApps();
                    });
                    sortFilterMobile.addEventListener('change', function() {
                        sortFilter.value = this.value;
                    });
                }
            }
            
            syncFilters();
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æœç´¢åº”ç”¨
        function searchApps() {
            loadApps();
        }

        // è·å–å½“å‰æœç´¢æ¡ä»¶ï¼ˆä¼˜å…ˆç§»åŠ¨ç«¯ï¼Œå¦‚æœç§»åŠ¨ç«¯å¯è§çš„è¯ï¼‰
        function getCurrentSearchTerms() {
            const isMobile = window.innerWidth <= 1024;
            
            let searchTerm = '';
            let categoryFilter = '';
            let sortFilter = '';
            
            if (isMobile) {
                // ç§»åŠ¨ç«¯
                const searchInputMobile = document.getElementById('search-input-mobile');
                const categoryFilterMobile = document.getElementById('category-filter-mobile');
                const sortFilterMobile = document.getElementById('sort-filter-mobile');
                
                searchTerm = searchInputMobile ? searchInputMobile.value.toLowerCase() : '';
                categoryFilter = categoryFilterMobile ? categoryFilterMobile.value : '';
                sortFilter = sortFilterMobile ? sortFilterMobile.value : '';
            } else {
                // æ¡Œé¢ç«¯
                const searchInput = document.getElementById('search-input');
                const categoryFilterDesktop = document.getElementById('category-filter');
                const sortFilterDesktop = document.getElementById('sort-filter');
                
                searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                categoryFilter = categoryFilterDesktop ? categoryFilterDesktop.value : '';
                sortFilter = sortFilterDesktop ? sortFilterDesktop.value : '';
            }
            
            return { searchTerm, categoryFilter, sortFilter };
        }

        // åŠ è½½åº”ç”¨
        function loadApps() {
            const { searchTerm, categoryFilter, sortFilter } = getCurrentSearchTerms();

            let filteredApps = cloudData.apps;

            // æœç´¢è¿‡æ»¤
            if (searchTerm) {
                filteredApps = filteredApps.filter(app => 
                    app.name.toLowerCase().includes(searchTerm) ||
                    app.description.toLowerCase().includes(searchTerm) ||
                    app.author.toLowerCase().includes(searchTerm)
                );
            }

            // åˆ†ç±»è¿‡æ»¤
            if (categoryFilter) {
                filteredApps = filteredApps.filter(app => app.category === categoryFilter);
            }

            // æ’åº
            switch (sortFilter) {
                case 'newest':
                    filteredApps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredApps.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'name':
                    filteredApps.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'author':
                    filteredApps.sort((a, b) => a.author.localeCompare(b.author));
                    break;
            }

            displayApps(filteredApps);
        }

        // åˆ‡æ¢æè¿°å±•å¼€/æ”¶èµ·
        function toggleDescription(appId) {
            const descElement = document.getElementById(`desc-${appId}`);
            const toggleButton = document.getElementById(`toggle-${appId}`);
            
            if (descElement.classList.contains('collapsed')) {
                // å±•å¼€
                descElement.classList.remove('collapsed');
                descElement.classList.add('expanded');
                descElement.style.cursor = 'default';
                if (toggleButton) toggleButton.style.display = 'inline-block';
            } else {
                // æ”¶èµ·
                descElement.classList.remove('expanded');
                descElement.classList.add('collapsed');
                descElement.style.cursor = 'pointer';
                if (toggleButton) toggleButton.style.display = 'none';
            }
        }

        // æ£€æŸ¥æè¿°æ˜¯å¦éœ€è¦å±•å¼€æŒ‰é’®
        function checkDescriptionOverflow() {
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
            setTimeout(() => {
                const descriptions = document.querySelectorAll('.app-description.collapsed');
                descriptions.forEach(desc => {
                    const appId = desc.id.replace('desc-', '');
                    const toggleButton = document.getElementById(`toggle-${appId}`);
                    
                    // è·å–çº¯æ–‡æœ¬å†…å®¹
                    const textContent = desc.textContent.trim();
                    
                    // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥æµ‹é‡å®Œæ•´æ–‡æœ¬é«˜åº¦
                    const tempDiv = document.createElement('div');
                    tempDiv.style.cssText = `
                        position: absolute;
                        visibility: hidden;
                        width: ${desc.offsetWidth}px;
                        font-size: ${window.getComputedStyle(desc).fontSize};
                        font-family: ${window.getComputedStyle(desc).fontFamily};
                        line-height: ${window.getComputedStyle(desc).lineHeight};
                        padding: 0;
                        margin: 0;
                        border: none;
                    `;
                    tempDiv.textContent = textContent;
                    document.body.appendChild(tempDiv);
                    
                    const fullHeight = tempDiv.offsetHeight;
                    document.body.removeChild(tempDiv);
                    
                    // è·å–2è¡Œçš„é¢„æœŸé«˜åº¦ï¼ˆè¡Œé«˜ * 2ï¼‰
                    const lineHeight = parseFloat(window.getComputedStyle(desc).lineHeight);
                    const twoLineHeight = lineHeight * 2;
                    
                    // å¦‚æœå®Œæ•´é«˜åº¦è¶…è¿‡2è¡Œé«˜åº¦ï¼Œæ˜¾ç¤ºå±•å¼€åŠŸèƒ½
                    if (fullHeight > twoLineHeight + 5) { // 5pxå®¹å·®
                        desc.classList.add('has-overflow');
                        desc.style.cursor = 'pointer';
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
                        if (!desc.hasAttribute('data-click-added')) {
                            desc.addEventListener('click', function() {
                                toggleDescription(appId);
                            });
                            desc.setAttribute('data-click-added', 'true');
                        }
                        
                        if (toggleButton) toggleButton.style.display = 'none';
                    } else {
                        desc.classList.remove('has-overflow');
                        desc.style.cursor = 'default';
                        if (toggleButton) toggleButton.style.display = 'none';
                    }
                });
            }, 200);
        }

        // æ˜¾ç¤ºåº”ç”¨
        function displayApps(apps, showActions = false) {
            const appsGrid = document.getElementById('apps-grid');
            const emptyState = document.getElementById('empty-state');

            if (apps.length === 0) {
                appsGrid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            appsGrid.innerHTML = apps.map(app => {
                const isLiked = currentUser && app.likes && app.likes.includes(currentUser.id);
                const isFavorited = currentUser && app.favorites && app.favorites.includes(currentUser.id);
                const likesCount = app.likes ? app.likes.length : 0;
                const commentsCount = app.comments ? app.comments.length : 0;
                
                return `
                <div class="app-card">
                    ${showActions && currentUser && currentUser.id === app.authorId ? `
                        <div class="app-actions">
                            <button class="app-action-btn edit-btn" onclick="showEditModal(${app.id})" title="ç¼–è¾‘">âœï¸</button>
                            <button class="app-action-btn" onclick="deleteApp(${app.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    ` : ''}
                    <div class="app-screenshot">
                        ${app.screenshot && app.screenshot.trim() ? 
                            `<img src="${app.screenshot}" alt="${app.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'placeholder\\'><div style=\\'font-size: 2rem;\\'>ğŸŒ</div><div>æš‚æ— æˆªå›¾</div></div>'">` :
                            '<div class="placeholder"><div style="font-size: 2rem;">ğŸŒ</div><div>æš‚æ— æˆªå›¾</div></div>'
                        }
                    </div>
                    <div class="app-info">
                        <h3>${app.name}</h3>
                        <div class="app-description collapsed" id="desc-${app.id}" data-full-text="${app.description.replace(/"/g, '&quot;')}">${app.description}</div>
                        <button class="description-toggle" onclick="toggleDescription(${app.id})" id="toggle-${app.id}" style="display: none;">æ”¶èµ·</button>
                        <div class="app-meta">
                            <span>ğŸ‘¤ ${app.author}</span>
                            <span>ğŸ“… ${new Date(app.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="app-meta">
                            <span>ğŸ·ï¸ ${app.category}</span>
                            <a href="${app.url}" target="_blank" class="app-url" title="è®¿é—®é“¾æ¥ï¼š${app.url}">ğŸ”— è®¿é—®é“¾æ¥</a>
                        </div>
                        
                        <!-- äº’åŠ¨æŒ‰é’® -->
                        <div class="app-interactions">
                            <div class="interaction-group">
                                <button class="interaction-btn ${isLiked ? 'active' : ''}" onclick="toggleLike(${app.id})" ${!currentUser ? 'disabled title="è¯·å…ˆç™»å½•"' : ''}>
                                    ${isLiked ? 'â¤ï¸' : 'ğŸ¤'} ${likesCount}
                                </button>
                                <button class="interaction-btn" onclick="showComments(${app.id})" ${!currentUser ? 'disabled title="è¯·å…ˆç™»å½•"' : ''}>
                                    ğŸ’¬ ${commentsCount}
                                </button>
                                <button class="interaction-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${app.id})" ${!currentUser ? 'disabled title="è¯·å…ˆç™»å½•"' : ''}>
                                    ${isFavorited ? 'â­' : 'â˜†'} æ”¶è—
                                </button>
                            </div>
                        </div>
                        
                        <!-- è¯„è®ºåŒºåŸŸ -->
                        <div class="comments-section" id="comments-${app.id}" style="display: none;">
                            <div id="comments-list-${app.id}">
                                ${app.comments ? app.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">${comment.author}</span>
                                            <div>
                                                <span>${new Date(comment.createdAt).toLocaleDateString()}</span>
                                                ${currentUser && currentUser.id === comment.authorId ? `
                                                    <button class="comment-delete" onclick="deleteComment(${app.id}, ${comment.id})">åˆ é™¤</button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="comment-content">${comment.content}</div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            ${currentUser ? `
                                <div class="comment-input">
                                    <input type="text" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." id="comment-input-${app.id}" onkeypress="if(event.key==='Enter') addComment(${app.id})">
                                    <button onclick="addComment(${app.id})">å‘é€</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // æ£€æŸ¥å“ªäº›æè¿°éœ€è¦å±•å¼€æŒ‰é’®
            checkDescriptionOverflow();
        }

        // åˆ é™¤åº”ç”¨
        async function deleteApp(appId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåº”ç”¨å—ï¼Ÿ')) return;

            try {
                // åœ¨åˆ é™¤å‰åˆ›å»ºå¿«ç…§
                const appToDelete = cloudData.apps.find(app => app.id === appId);
                if (appToDelete) {
                    try {
                        logger.snapshot(`åˆ é™¤åº”ç”¨å‰å¿«ç…§: ${appToDelete.name}`, appToDelete, {
                            snapshotType: 'app_delete_before',
                            appId: appId,
                            operation: 'åº”ç”¨åˆ é™¤å‰'
                        });
                    } catch (snapshotError) {
                        logger.warn('åˆ›å»ºåˆ é™¤å‰å¿«ç…§å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåˆ é™¤', { 
                            appId: appId, 
                            error: snapshotError.message 
                        });
                    }

                    // è®°å½•åˆ é™¤æ“ä½œ
                    logger.info('åº”ç”¨åˆ é™¤', {
                        appId: appId,
                        appName: appToDelete.name,
                        appUrl: appToDelete.url,
                        authorId: appToDelete.authorId,
                        operation: 'åº”ç”¨ç®¡ç†'
                    });
                }

                cloudData.apps = cloudData.apps.filter(app => app.id !== appId);
                await syncData();
                loadApps();
                alert('åˆ é™¤æˆåŠŸï¼');
            } catch (error) {
                logger.error('åº”ç”¨åˆ é™¤å¤±è´¥', {
                    appId: appId,
                    error: error.message,
                    operation: 'åº”ç”¨ç®¡ç†å¤±è´¥'
                });
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæˆ‘çš„åº”ç”¨
        function showMyApps() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            // éªŒè¯ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§
            if (!currentUser.id || !currentUser.username) {
                alert('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            const myApps = cloudData.apps.filter(app => app.authorId === currentUser.id);
            displayApps(myApps, true);
        }

        // æ˜¾ç¤ºæˆ‘çš„æ”¶è—
        function showMyFavorites() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            // éªŒè¯ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§
            if (!currentUser.id || !currentUser.username) {
                alert('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            const myFavorites = cloudData.apps.filter(app => 
                app.favorites && app.favorites.includes(currentUser.id)
            );
            displayApps(myFavorites, false);
        }

        // ç‚¹èµåŠŸèƒ½
        async function toggleLike(appId) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            // éªŒè¯ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§
            if (!currentUser.id || !currentUser.username) {
                alert('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            // éªŒè¯ç”¨æˆ·åœ¨äº‘ç«¯æ•°æ®ä¸­çš„å­˜åœ¨æ€§
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('ç”¨æˆ·æ•°æ®åŒæ­¥å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.likes) app.likes = [];

                const likedIndex = app.likes.indexOf(currentUser.id);
                const isLiking = likedIndex === -1;
                
                if (likedIndex > -1) {
                    app.likes.splice(likedIndex, 1);
                } else {
                    app.likes.push(currentUser.id);
                }

                // è®°å½•ç‚¹èµæ“ä½œ
                logger.info('ç‚¹èµæ“ä½œ', {
                    appId: appId,
                    appName: app.name,
                    action: isLiking ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ',
                    authorId: app.authorId,
                    operation: 'ç”¨æˆ·äº’åŠ¨'
                });

                // æœ¬åœ°ä¼˜å…ˆç­–ç•¥ï¼šç«‹å³æ›´æ–°UIå’Œæœ¬åœ°ç¼“å­˜
                localCache.saveToLocal(cloudData);
                loadApps(); // ç«‹å³æ›´æ–°UIï¼Œç”¨æˆ·çœ‹åˆ°å³æ—¶æ•ˆæœ
                
                // æ·»åŠ åˆ°å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—
                await syncQueue.addOperation({
                    type: 'like',
                    appId: appId,
                    userId: currentUser.id,
                    action: isLiking ? 'ç‚¹èµ' : 'å–æ¶ˆç‚¹èµ',
                    data: {
                        appName: app.name,
                        authorId: app.authorId
                    }
                });

                // æ˜¾ç¤ºæ“ä½œå®ŒæˆçŠ¶æ€
                updateStatus('âœ… ç‚¹èµå·²æ›´æ–°', 'connected');
            } catch (error) {
                logger.error('ç‚¹èµæ“ä½œå¤±è´¥', {
                    appId: appId,
                    error: error.message,
                    operation: 'ç”¨æˆ·äº’åŠ¨å¤±è´¥'
                });
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // æ”¶è—åŠŸèƒ½
        async function toggleFavorite(appId) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            // éªŒè¯ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§
            if (!currentUser.id || !currentUser.username) {
                alert('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            // éªŒè¯ç”¨æˆ·åœ¨äº‘ç«¯æ•°æ®ä¸­çš„å­˜åœ¨æ€§
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('ç”¨æˆ·æ•°æ®åŒæ­¥å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.favorites) app.favorites = [];

                const favoritedIndex = app.favorites.indexOf(currentUser.id);
                const isFavoriting = favoritedIndex === -1;
                
                if (favoritedIndex > -1) {
                    app.favorites.splice(favoritedIndex, 1);
                } else {
                    app.favorites.push(currentUser.id);
                }

                // è®°å½•æ”¶è—æ“ä½œ
                logger.info('æ”¶è—æ“ä½œ', {
                    appId: appId,
                    appName: app.name,
                    action: isFavoriting ? 'æ”¶è—' : 'å–æ¶ˆæ”¶è—',
                    authorId: app.authorId,
                    operation: 'ç”¨æˆ·äº’åŠ¨'
                });

                // æœ¬åœ°ä¼˜å…ˆç­–ç•¥ï¼šç«‹å³æ›´æ–°UIå’Œæœ¬åœ°ç¼“å­˜
                localCache.saveToLocal(cloudData);
                loadApps(); // ç«‹å³æ›´æ–°UIï¼Œç”¨æˆ·çœ‹åˆ°å³æ—¶æ•ˆæœ
                
                // æ·»åŠ åˆ°å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—
                await syncQueue.addOperation({
                    type: 'favorite',
                    appId: appId,
                    userId: currentUser.id,
                    action: isFavoriting ? 'æ”¶è—' : 'å–æ¶ˆæ”¶è—',
                    data: {
                        appName: app.name,
                        authorId: app.authorId
                    }
                });

                // æ˜¾ç¤ºæ“ä½œå®ŒæˆçŠ¶æ€
                updateStatus('âœ… æ”¶è—å·²æ›´æ–°', 'connected');
            } catch (error) {
                logger.error('æ”¶è—æ“ä½œå¤±è´¥', {
                    appId: appId,
                    error: error.message,
                    operation: 'ç”¨æˆ·äº’åŠ¨å¤±è´¥'
                });
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤º/éšè—è¯„è®º
        function showComments(appId) {
            const commentsSection = document.getElementById(`comments-${appId}`);
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
            } else {
                commentsSection.style.display = 'none';
            }
        }

        // æ·»åŠ è¯„è®º
        async function addComment(appId) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            // éªŒè¯ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§
            if (!currentUser.id || !currentUser.username) {
                alert('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            // éªŒè¯ç”¨æˆ·åœ¨äº‘ç«¯æ•°æ®ä¸­çš„å­˜åœ¨æ€§
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('ç”¨æˆ·æ•°æ®åŒæ­¥å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            const input = document.getElementById(`comment-input-${appId}`);
            const content = input.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.comments) app.comments = [];

                const newComment = {
                    id: Date.now(),
                    content,
                    author: currentUser.username,
                    authorId: currentUser.id,
                    createdAt: new Date().toISOString()
                };

                app.comments.push(newComment);
                input.value = '';

                // è®°å½•è¯„è®ºæ“ä½œ
                logger.info('æ·»åŠ è¯„è®º', {
                    appId: appId,
                    appName: app.name,
                    commentId: newComment.id,
                    commentContent: content.substring(0, 50) + (content.length > 50 ? '...' : ''),
                    authorId: app.authorId,
                    operation: 'ç”¨æˆ·äº’åŠ¨'
                });

                // æœ¬åœ°ä¼˜å…ˆç­–ç•¥ï¼šç«‹å³æ›´æ–°UIå’Œæœ¬åœ°ç¼“å­˜
                localCache.saveToLocal(cloudData);
                loadApps(); // ç«‹å³æ›´æ–°UIï¼Œç”¨æˆ·çœ‹åˆ°å³æ—¶æ•ˆæœ
                
                // æ·»åŠ åˆ°å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—
                await syncQueue.addOperation({
                    type: 'comment_add',
                    appId: appId,
                    userId: currentUser.id,
                    commentId: newComment.id,
                    action: 'æ·»åŠ è¯„è®º',
                    data: {
                        appName: app.name,
                        commentContent: content.substring(0, 50) + (content.length > 50 ? '...' : ''),
                        authorId: app.authorId
                    }
                });

                // æ˜¾ç¤ºæ“ä½œå®ŒæˆçŠ¶æ€
                updateStatus('âœ… è¯„è®ºå·²æ·»åŠ ', 'connected');
            } catch (error) {
                logger.error('æ·»åŠ è¯„è®ºå¤±è´¥', {
                    appId: appId,
                    error: error.message,
                    operation: 'ç”¨æˆ·äº’åŠ¨å¤±è´¥'
                });
                alert('è¯„è®ºå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤è¯„è®º
        async function deleteComment(appId, commentId) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            // éªŒè¯ç”¨æˆ·çŠ¶æ€å®Œæ•´æ€§
            if (!currentUser.id || !currentUser.username) {
                alert('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            // éªŒè¯ç”¨æˆ·åœ¨äº‘ç«¯æ•°æ®ä¸­çš„å­˜åœ¨æ€§
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('ç”¨æˆ·æ•°æ®åŒæ­¥å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                logout();
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app || !app.comments) return;

                const comment = app.comments.find(c => c.id === commentId);
                if (!comment || comment.authorId !== currentUser.id) {
                    alert('åªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®º');
                    return;
                }

                app.comments = app.comments.filter(c => c.id !== commentId);

                // è®°å½•åˆ é™¤è¯„è®ºæ“ä½œ
                logger.info('åˆ é™¤è¯„è®º', {
                    appId: appId,
                    appName: app.name,
                    commentId: commentId,
                    deletedContent: comment.content.substring(0, 50) + (comment.content.length > 50 ? '...' : ''),
                    authorId: app.authorId,
                    operation: 'ç”¨æˆ·äº’åŠ¨'
                });

                // æœ¬åœ°ä¼˜å…ˆç­–ç•¥ï¼šç«‹å³æ›´æ–°UIå’Œæœ¬åœ°ç¼“å­˜
                localCache.saveToLocal(cloudData);
                loadApps(); // ç«‹å³æ›´æ–°UIï¼Œç”¨æˆ·çœ‹åˆ°å³æ—¶æ•ˆæœ
                
                // æ·»åŠ åˆ°å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—
                await syncQueue.addOperation({
                    type: 'comment_delete',
                    appId: appId,
                    userId: currentUser.id,
                    commentId: commentId,
                    action: 'åˆ é™¤è¯„è®º',
                    data: {
                        appName: app.name,
                        deletedContent: comment.content.substring(0, 50) + (comment.content.length > 50 ? '...' : ''),
                        authorId: app.authorId
                    }
                });

                // æ˜¾ç¤ºæ“ä½œå®ŒæˆçŠ¶æ€
                updateStatus('âœ… è¯„è®ºå·²åˆ é™¤', 'connected');
            } catch (error) {
                logger.error('åˆ é™¤è¯„è®ºå¤±è´¥', {
                    appId: appId,
                    commentId: commentId,
                    error: error.message,
                    operation: 'ç”¨æˆ·äº’åŠ¨å¤±è´¥'
                });
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        function toggleMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            const isOpen = menu.classList.contains('active');
            
            if (isOpen) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            hamburger.classList.add('active');
            overlay.style.display = 'block';
            
            // å»¶è¿Ÿæ·»åŠ activeç±»ä»¥è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                overlay.classList.add('active');
                menu.classList.add('active');
            }, 10);
            
            // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            hamburger.classList.remove('active');
            overlay.classList.remove('active');
            menu.classList.remove('active');
            
            // å»¶è¿Ÿéšè—é®ç½©å±‚ä»¥å®ŒæˆåŠ¨ç”»
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            
            // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = '';
        }

        // æ˜¾ç¤ºå¯¼èˆª
        function showGuestNav() {
            // æ¡Œé¢ç«¯å¯¼èˆª
            document.getElementById('guest-nav').style.display = 'flex';
            document.getElementById('user-nav').style.display = 'none';
            document.getElementById('publish-btn').style.display = 'none';
            
            // ç§»åŠ¨ç«¯å¯¼èˆª
            document.getElementById('mobile-guest-nav').style.display = 'block';
            document.getElementById('mobile-user-nav').style.display = 'none';
        }

        function showUserNav() {
            // æ¡Œé¢ç«¯å¯¼èˆª
            document.getElementById('guest-nav').style.display = 'none';
            document.getElementById('user-nav').style.display = 'flex';
            document.getElementById('publish-btn').style.display = 'block';

            if (currentUser) {
                // æ¡Œé¢ç«¯ç”¨æˆ·ä¿¡æ¯
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
                
                // ç§»åŠ¨ç«¯ç”¨æˆ·ä¿¡æ¯
                document.getElementById('mobile-user-name').textContent = currentUser.username;
                document.getElementById('mobile-user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
            }
            
            // ç§»åŠ¨ç«¯å¯¼èˆª
            document.getElementById('mobile-guest-nav').style.display = 'none';
            document.getElementById('mobile-user-nav').style.display = 'block';
        }

        // æ¨¡æ€æ¡†æ“ä½œ
        function showModal(modalId) {
            document.body.classList.add('no-scroll');
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.body.classList.remove('no-scroll');
            document.getElementById(modalId).style.display = 'none';
            
            // å¦‚æœæ˜¯å‘å¸ƒæ¨¡æ€æ¡†ï¼Œé‡ç½®è¡¨å•å’ŒçŠ¶æ€
            if (modalId === 'publish-modal') {
                resetPublishModal();
                currentEditingAppId = null;
            }
        }

        function resetPublishModal() {
            document.getElementById('app-name').value = '';
            document.getElementById('app-url').value = '';
            document.getElementById('app-description').value = '';
            document.getElementById('app-category').value = 'å…¶ä»–';
            document.getElementById('screenshot-upload').value = '';
            document.getElementById('screenshot-preview').innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">ğŸ“¸</div><div>é€‰æ‹©æˆªå›¾æ–¹å¼</div></div>';
            
            // é‡ç½®æˆªå›¾æ–¹å¼ä¸ºAPIç”Ÿæˆ
            document.querySelector('input[name="screenshot-method"][value="api"]').checked = true;
            toggleScreenshotMethod();
            
            // é‡ç½®æˆªå›¾å‡†å¤‡çŠ¶æ€ä¸ºtrueï¼ˆå…è®¸æ— æˆªå›¾å‘å¸ƒï¼‰
            isScreenshotReady = true;
            updatePublishButtonState();
        }

        // æ›´æ–°å‘å¸ƒæŒ‰é’®çŠ¶æ€
        function updatePublishButtonState() {
            const publishBtn = document.getElementById('save-app-btn');
            if (!publishBtn) return;
            
            const name = document.getElementById('app-name').value.trim();
            const url = document.getElementById('app-url').value.trim();
            const description = document.getElementById('app-description').value.trim();
            
            // æ£€æŸ¥å¿…å¡«å­—æ®µå’Œæˆªå›¾çŠ¶æ€
            const allFieldsValid = name && url && description;
            const hasScreenshot = hasScreenshotContent();
            const canPublish = allFieldsValid && (isScreenshotReady || !hasScreenshot);
            
            publishBtn.disabled = !canPublish;
            
            if (!canPublish) {
                publishBtn.style.opacity = '0.6';
                publishBtn.style.cursor = 'not-allowed';
                publishBtn.style.transform = 'none';
                publishBtn.style.boxShadow = 'none';
                
                if (!allFieldsValid) {
                    const missingFields = [];
                    if (!name) missingFields.push('åç§°');
                    if (!url) missingFields.push('é“¾æ¥');
                    if (!description) missingFields.push('æè¿°');
                    publishBtn.textContent = `è¯·å¡«å†™: ${missingFields.join('ã€')}`;
                } else if (!isScreenshotReady && hasScreenshot) {
                    publishBtn.textContent = 'â³ æˆªå›¾å¤„ç†ä¸­...';
                }
            } else {
                publishBtn.style.opacity = '1';
                publishBtn.style.cursor = 'pointer';
                publishBtn.style.transform = '';
                publishBtn.style.boxShadow = '';
                publishBtn.textContent = currentEditingAppId ? 'ğŸ’¾ ä¿å­˜æ›´æ”¹' : 'ğŸš€ å‘å¸ƒ';
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æˆªå›¾å†…å®¹ï¼ˆä½†æœªå‡†å¤‡å°±ç»ªï¼‰
        function hasScreenshotContent() {
            const preview = document.getElementById('screenshot-preview');
            const hasImg = preview.querySelector('img');
            const hasLoading = preview.querySelector('.loading');
            return hasImg || hasLoading;
        }

        // è®¾ç½®æˆªå›¾å‡†å¤‡å°±ç»ªçŠ¶æ€
        function setScreenshotReady(ready = true) {
            isScreenshotReady = ready;
            updatePublishButtonState();
        }

        // æ¸…é™¤æˆªå›¾
        function clearScreenshot() {
            const preview = document.getElementById('screenshot-preview');
            const uploadInput = document.getElementById('screenshot-upload');
            
            // é‡ç½®é¢„è§ˆåŒºåŸŸ
            preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">ğŸ“¸</div><div>é€‰æ‹©æˆªå›¾æ–¹å¼</div></div>';
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            if (uploadInput) {
                uploadInput.value = '';
            }
            
            // é‡ç½®æˆªå›¾çŠ¶æ€ä¸ºå‡†å¤‡å°±ç»ªï¼ˆå…è®¸æ— æˆªå›¾å‘å¸ƒï¼‰
            setScreenshotReady(true);
        }

        function showLogin() {
            showModal('login-modal');
        }

        function showRegister() {
            showModal('register-modal');
        }

        function showPublishModal() {
            currentEditingAppId = null;
            document.getElementById('publish-modal-title').textContent = 'å‘å¸ƒä½œå“';
            document.getElementById('save-app-btn').textContent = 'å‘å¸ƒ';
            
            // ç¡®ä¿URLå­—æ®µå¯ç¼–è¾‘
            document.getElementById('app-url').readOnly = false;
            document.getElementById('app-url').style.background = '';
            
            // é‡ç½®è¡¨å•å¹¶æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆresetPublishModalä¸­å·²åŒ…å«çŠ¶æ€é‡ç½®ï¼‰
            resetPublishModal();
            showModal('publish-modal');
        }

        function showEditModal(appId) {
            currentEditingAppId = appId;
            const app = cloudData.apps.find(a => a.id === appId);
            if (!app) return;

            document.getElementById('publish-modal-title').textContent = 'ç¼–è¾‘ä½œå“';
            document.getElementById('save-app-btn').textContent = 'ä¿å­˜æ›´æ”¹';
            
            // å¡«å……è¡¨å•
            document.getElementById('app-name').value = app.name;
            document.getElementById('app-url').value = app.url;
            document.getElementById('app-description').value = app.description;
            document.getElementById('app-category').value = app.category;
            
            const preview = document.getElementById('screenshot-preview');
            if (app.screenshot && app.screenshot.trim()) {
                preview.innerHTML = `<img src="${app.screenshot}" alt="åº”ç”¨æˆªå›¾" data-url="${app.screenshot}">`;
                // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœå·²æœ‰æˆªå›¾ï¼Œæ ‡è®°ä¸ºå‡†å¤‡å°±ç»ª
                setScreenshotReady(true);
            } else {
                preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">ğŸ“¸</div><div>é€‰æ‹©æˆªå›¾æ–¹å¼</div></div>';
                // æ²¡æœ‰æˆªå›¾æ—¶ï¼Œæ ‡è®°ä¸ºå‡†å¤‡å°±ç»ªï¼ˆå¯ä»¥ä¸éœ€è¦æˆªå›¾å‘å¸ƒï¼‰
                setScreenshotReady(true);
            }

            // URLåœ¨ç¼–è¾‘æ—¶ä¸å¯æ›´æ”¹
            document.getElementById('app-url').readOnly = true;
            document.getElementById('app-url').style.background = '#f1f1f1';

            // æ›´æ–°å‘å¸ƒæŒ‰é’®çŠ¶æ€
            updatePublishButtonState();

            showModal('publish-modal');
        }

        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!username || !password) {
                alert('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            const user = cloudData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showUserNav();
                closeModal('login-modal');
                alert('ç™»å½•æˆåŠŸï¼');
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();



            if (!username || !email || !password) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }

            if (password.length < 6) {
                alert('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                return;
            }

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            if (cloudData.users.some(u => u.username === username)) {
                alert('ç”¨æˆ·åå·²å­˜åœ¨');
                return;
            }

            // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
            if (cloudData.users.some(u => u.email === email)) {
                alert('é‚®ç®±å·²å­˜åœ¨');
                return;
            }

            let newUser;
            try {
                newUser = {
                    id: Date.now(),
                    username,
                    email,
                    password,
                    createdAt: new Date().toISOString()
                };

                // åœ¨æ·»åŠ ç”¨æˆ·å‰åˆ›å»ºå¿«ç…§
                try {
                    logger.snapshot('ç”¨æˆ·æ³¨å†Œå‰å¿«ç…§', cloudData.users, {
                        snapshotType: 'users_before_add',
                        operation: 'ç”¨æˆ·æ³¨å†Œå‰',
                        usersCount: cloudData.users.length,
                        newUsername: username
                    });
                } catch (snapshotError) {
                    logger.warn('åˆ›å»ºç”¨æˆ·æ³¨å†Œå‰å¿«ç…§å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œæ³¨å†Œ', { 
                        username: username, 
                        error: snapshotError.message 
                    });
                }

                // æ·»åŠ ç”¨æˆ·åˆ°æœ¬åœ°æ•°æ®
                cloudData.users.push(newUser);
                
                // ç«‹å³è®¾ç½®å½“å‰ç”¨æˆ·å’Œæœ¬åœ°å­˜å‚¨ï¼ˆç¡®ä¿å³ä½¿åŒæ­¥å¤±è´¥ä¹Ÿèƒ½ä¿æŒç™»å½•çŠ¶æ€ï¼‰
                currentUser = newUser;
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                showUserNav();
                closeModal('register-modal');
                updateStats();
                loadApps(); // é‡æ–°æ¸²æŸ“åº”ç”¨åˆ—è¡¨ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€

                // æœ¬åœ°ä¼˜å…ˆç­–ç•¥ï¼šç«‹å³ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                localCache.saveToLocal(cloudData);
                
                // æ·»åŠ åˆ°å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—
                await syncQueue.addOperation({
                    type: 'user_register',
                    userId: newUser.id,
                    action: 'ç”¨æˆ·æ³¨å†Œ',
                    data: {
                        username: newUser.username,
                        email: newUser.email
                    }
                });
                
                // æ˜¾ç¤ºæ³¨å†ŒæˆåŠŸçŠ¶æ€
                updateStatus('âœ… æ³¨å†ŒæˆåŠŸ', 'connected');
                alert('æ³¨å†ŒæˆåŠŸï¼');

            } catch (error) {
                // ç§»é™¤å·²æ·»åŠ çš„ç”¨æˆ·æ•°æ®ï¼ˆå¦‚æœæ·»åŠ å¤±è´¥ï¼‰
                cloudData.users = cloudData.users.filter(u => u.id !== newUser?.id);
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            }
        }

        // å¤„ç†å‘å¸ƒ/ç¼–è¾‘åº”ç”¨
        async function handleSaveApp() {
            const name = document.getElementById('app-name').value.trim();
            const url = document.getElementById('app-url').value.trim();
            const description = document.getElementById('app-description').value.trim();
            const category = document.getElementById('app-category').value;

            if (!name || !url || !description) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ');
                return;
            }

            // è®°å½•åº”ç”¨ä¿å­˜æ“ä½œå¼€å§‹
            const operationType = currentEditingAppId ? 'ç¼–è¾‘åº”ç”¨' : 'å‘å¸ƒæ–°åº”ç”¨';
            logger.info(`${operationType}æ“ä½œå¼€å§‹`, {
                appId: currentEditingAppId,
                appName: name,
                appUrl: url,
                category: category,
                operation: operationType
            });

            // è·å–æˆªå›¾æ•°æ®
            const previewImg = document.querySelector('#screenshot-preview img');
            let screenshot = '';
            
            if (previewImg) {
                // åªä½¿ç”¨ data-url å±æ€§ï¼Œç¡®ä¿åªå­˜å‚¨URL
                const urlData = previewImg.getAttribute('data-url');
                const base64Data = previewImg.getAttribute('data-base64');
                
                if (urlData) {
                    screenshot = urlData;
                    logger.info('ä½¿ç”¨å·²ä¸Šä¼ çš„æˆªå›¾URL', { screenshotUrl: urlData, source: 'å¤–éƒ¨å­˜å‚¨' });
                } else if (base64Data) {
                    // å¦‚æœå­˜åœ¨Base64æ•°æ®ï¼Œå…ˆä¸Šä¼ åè·å–URL
                    logger.info('æ£€æµ‹åˆ°Base64æˆªå›¾æ•°æ®ï¼Œå¼€å§‹ä¸Šä¼ ', { source: 'Base64è½¬æ¢' });
                    try {
                        screenshot = await uploadImageToStorage(base64Data, true);
                        logger.info('Base64æˆªå›¾ä¸Šä¼ æˆåŠŸ', { screenshotUrl: screenshot });
                    } catch (error) {
                        logger.error('Base64æˆªå›¾ä¸Šä¼ å¤±è´¥', { error: error.message });
                        console.error('ä¸Šä¼ æˆªå›¾å¤±è´¥:', error);
                        alert('æˆªå›¾ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©æˆªå›¾');
                        return;
                    }
                }
            }
            
            // è®°å½•æˆªå›¾æ¥æºä¿¡æ¯
            const screenshotSource = previewImg ? 
                (previewImg.getAttribute('data-url') ? 'å¤–éƒ¨å­˜å‚¨URL' : 
                 previewImg.getAttribute('data-base64') ? 'APIç”Ÿæˆæˆªå›¾' : 'æ— æˆªå›¾') : 'æ— æˆªå›¾';
            logger.info('æˆªå›¾ä¿¡æ¯ç¡®è®¤', { 
                hasScreenshot: !!screenshot, 
                source: screenshotSource,
                screenshotUrl: screenshot ? screenshot.substring(0, 100) + '...' : null 
            });
            
            // åœ¨æ•°æ®ä¿®æ”¹å‰åˆ›å»ºå¿«ç…§
            try {
                if (currentEditingAppId) {
                    // ç¼–è¾‘æ¨¡å¼ï¼šä¿å­˜ä¿®æ”¹å‰çš„åº”ç”¨æ•°æ®
                    const originalApp = cloudData.apps.find(a => a.id === currentEditingAppId);
                    if (originalApp) {
                        logger.snapshot(`ç¼–è¾‘åº”ç”¨å‰å¿«ç…§: ${originalApp.name}`, originalApp, {
                            snapshotType: 'app_edit_before',
                            appId: currentEditingAppId,
                            operation: 'åº”ç”¨ç¼–è¾‘å‰'
                        });
                    }
                } else {
                    // å‘å¸ƒæ–°åº”ç”¨æ¨¡å¼ï¼šä¿å­˜æ·»åŠ å‰çš„appsæ•°ç»„çŠ¶æ€
                    logger.snapshot('å‘å¸ƒæ–°åº”ç”¨å‰å¿«ç…§', cloudData.apps, {
                        snapshotType: 'apps_before_add',
                        operation: 'æ–°åº”ç”¨å‘å¸ƒå‰',
                        appsCount: cloudData.apps.length
                    });
                }
            } catch (snapshotError) {
                logger.warn('åˆ›å»ºæ•°æ®å¿«ç…§å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œæ“ä½œ', { error: snapshotError.message });
            }
            
            try {
                if (currentEditingAppId) {
                    // ç¼–è¾‘æ¨¡å¼
                    const app = cloudData.apps.find(a => a.id === currentEditingAppId);
                    if (app) {
                        app.name = name;
                        app.description = description;
                        app.category = category;
                        app.screenshot = screenshot;
                    }
                } else {
                    // å‘å¸ƒæ–°åº”ç”¨æ¨¡å¼
                    const newApp = {
                        id: Date.now(),
                        name,
                        url,
                        description,
                        category,
                        author: currentUser.username,
                        authorId: currentUser.id,
                        screenshot,
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    };
                    cloudData.apps.push(newApp);
                }

                // æœ¬åœ°ä¼˜å…ˆç­–ç•¥ï¼šç«‹å³æ›´æ–°UIå’Œæœ¬åœ°ç¼“å­˜
                localCache.saveToLocal(cloudData);
                closeModal('publish-modal');
                updateStats();
                loadApps();

                // æ·»åŠ åˆ°å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—
                await syncQueue.addOperation({
                    type: currentEditingAppId ? 'app_edit' : 'app_publish',
                    appId: currentEditingAppId || Date.now(),
                    userId: currentUser.id,
                    action: currentEditingAppId ? 'ç¼–è¾‘åº”ç”¨' : 'å‘å¸ƒåº”ç”¨',
                    data: {
                        appName: name,
                        appUrl: url,
                        category: category,
                        hasScreenshot: !!screenshot
                    }
                });

                // æ˜¾ç¤ºæ“ä½œå®ŒæˆçŠ¶æ€
                updateStatus(currentEditingAppId ? 'âœ… åº”ç”¨å·²æ›´æ–°' : 'âœ… åº”ç”¨å·²å‘å¸ƒ', 'connected');
                alert(currentEditingAppId ? 'åº”ç”¨æ›´æ–°æˆåŠŸï¼' : 'åº”ç”¨å‘å¸ƒæˆåŠŸï¼');

            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                currentEditingAppId = null; // æ“ä½œå®Œæˆåé‡ç½®
            }
        }

        // ç»Ÿä¸€å›¾ç‰‡ä¸Šä¼ å¤„ç†å‡½æ•°
        async function uploadImageToStorage(imageData, isBase64 = false) {
            logger.info('å¼€å§‹å›¾ç‰‡ä¸Šä¼ å¤„ç†', { 
                dataType: isBase64 ? 'Base64' : 'URL',
                dataSize: imageData ? imageData.length : 0,
                operation: 'å›¾ç‰‡ä¸Šä¼ '
            });
            
            try {
                let base64Payload;
                
                if (isBase64) {
                    // å¦‚æœå·²ç»æ˜¯Base64ï¼Œæå–payloadéƒ¨åˆ†
                    if (imageData.startsWith('data:')) {
                        base64Payload = imageData.split(',')[1];
                    } else {
                        base64Payload = imageData;
                    }
                } else {
                    // å¦‚æœæ˜¯URLï¼Œå…ˆè½¬æ¢ä¸ºBase64
                    const response = await fetch(imageData);
                    const blob = await response.blob();
                    
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            base64Payload = e.target.result.split(',')[1];
                            
                            try {
                                const res = await fetch('/.netlify/functions/upload-image', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ image: base64Payload })
                                });
                                const result = await res.json();
                                if (!res.ok) throw new Error(result.error || 'Upload failed');
                                resolve(result.url);
                            } catch (err) {
                                reject(err);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                }
                
                // ä¸Šä¼ Base64æ•°æ®
                const res = await fetch('/.netlify/functions/upload-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Payload })
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Upload failed');
                
                logger.info('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', { 
                    uploadedUrl: result.url,
                    operation: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ'
                });
                return result.url;
            } catch (error) {
                logger.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', { 
                    error: error.message,
                    operation: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥'
                });
                console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                throw error;
            }
        }

        // ç”Ÿæˆæˆªå›¾
        function generateScreenshot() {
            const url = document.getElementById('app-url').value.trim();
            if (!url) {
                alert('è¯·å…ˆå¡«å†™"ä½œå“é“¾æ¥"å­—æ®µï¼Œç„¶åå†ç”Ÿæˆæˆªå›¾');
                return;
            }

            // éªŒè¯URLæ ¼å¼
            try {
                new URL(url);
            } catch (e) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€é“¾æ¥ï¼ˆå¦‚ï¼šhttps://example.comï¼‰');
                return;
            }

            // è®¾ç½®æˆªå›¾æœªå‡†å¤‡å°±ç»ªçŠ¶æ€
            setScreenshotReady(false);

            // è®°å½•æˆªå›¾APIè°ƒç”¨å¼€å§‹
            logger.info('å¼€å§‹è°ƒç”¨æˆªå›¾API', { 
                targetUrl: url, 
                timestamp: new Date().toISOString(),
                operation: 'è‡ªåŠ¨ç”Ÿæˆæˆªå›¾'
            });

            const preview = document.getElementById('screenshot-preview');
            preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">æ­£åœ¨ç”Ÿæˆæˆªå›¾...</span>';

            // ä½¿ç”¨å¤šä¸ªå¤‡ç”¨æˆªå›¾æœåŠ¡
            const screenshotServices = [
                `/.netlify/functions/screenshot-proxy?url=${encodeURIComponent(url)}`,
                `https://image.thum.io/get/width/1200/crop/800/noanimate/${encodeURIComponent(url)}`,
                `https://mini.s-shot.ru/1200x800/PNG/?${encodeURIComponent(url)}`
            ];

            let currentServiceIndex = 0;

            function tryNextService() {
                if (currentServiceIndex >= screenshotServices.length) {
                    logger.error('æ‰€æœ‰æˆªå›¾æœåŠ¡éƒ½å¤±è´¥', { 
                        targetUrl: url, 
                        attemptedServices: screenshotServices.length,
                        operation: 'æˆªå›¾APIè°ƒç”¨å¤±è´¥'
                    });
                    preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">âŒ</div><div>æˆªå›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ å›¾ç‰‡</div></div>';
                    
                    // æ‰€æœ‰æˆªå›¾æœåŠ¡éƒ½å¤±è´¥ï¼Œæˆªå›¾æœªå‡†å¤‡å°±ç»ª
                    setScreenshotReady(false);
                    return;
                }

                const screenshotUrl = screenshotServices[currentServiceIndex];
                logger.info(`å°è¯•æˆªå›¾æœåŠ¡ ${currentServiceIndex + 1}`, { 
                    service: screenshotUrl, 
                    serviceIndex: currentServiceIndex,
                    operation: 'æˆªå›¾æœåŠ¡è°ƒç”¨'
                });
                const img = new Image();
                
                img.onload = function() {
                    preview.innerHTML = `<img src="${screenshotUrl}" alt="ç½‘ç«™æˆªå›¾">`;
                    
                    // æ˜¾ç¤ºè½¬æ¢çŠ¶æ€
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(255,149,0,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                    statusDiv.textContent = 'æ­£åœ¨ä¼˜åŒ–æˆªå›¾...';
                    preview.style.position = 'relative';
                    preview.appendChild(statusDiv);
                    
                    // ä¸Šä¼ æˆªå›¾åˆ°å¤–éƒ¨å­˜å‚¨
                    uploadImageToStorage(screenshotUrl, false).then(function(uploadedUrl) {
                        // ç§»é™¤çŠ¶æ€æç¤º
                        if (statusDiv.parentNode) {
                            statusDiv.remove();
                        }
                        
                        if (uploadedUrl) {
                            // å¦‚æœä¸Šä¼ æˆåŠŸï¼Œè®¾ç½®URLå¹¶æ ‡è®°æˆªå›¾å‡†å¤‡å°±ç»ª
                            logger.info('æˆªå›¾ç”Ÿæˆå¹¶ä¸Šä¼ æˆåŠŸ', { 
                                service: screenshotUrl, 
                                serviceIndex: currentServiceIndex,
                                uploadedUrl: uploadedUrl,
                                operation: 'æˆªå›¾APIæˆåŠŸ'
                            });
                            const previewImg = preview.querySelector('img');
                            if (previewImg) {
                                previewImg.setAttribute('data-url', uploadedUrl);
                                
                                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                                const successDiv = document.createElement('div');
                                successDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(40,167,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                                successDiv.textContent = 'âœ“ æˆªå›¾å·²å°±ç»ª';
                                preview.appendChild(successDiv);
                                
                                // è®¾ç½®æˆªå›¾å‡†å¤‡å°±ç»ª
                                setScreenshotReady(true);
                                
                                // 3ç§’åç§»é™¤æˆåŠŸæç¤º
                                setTimeout(() => {
                                    if (successDiv.parentNode) {
                                        successDiv.remove();
                                    }
                                }, 3000);
                            }
                        } else {
                            // ä¸Šä¼ å¤±è´¥ï¼Œæˆªå›¾æœªå‡†å¤‡å°±ç»ª
                            logger.warn('æˆªå›¾ç”ŸæˆæˆåŠŸä½†ä¸Šä¼ å¤±è´¥', { 
                                service: screenshotUrl, 
                                serviceIndex: currentServiceIndex,
                                operation: 'æˆªå›¾ä¸Šä¼ å¤±è´¥'
                            });
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(220,53,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                            errorDiv.textContent = 'âš  æˆªå›¾ä¸Šä¼ å¤±è´¥';
                            preview.appendChild(errorDiv);
                            
                            // æˆªå›¾ä¸Šä¼ å¤±è´¥ï¼Œä¿æŒæœªå‡†å¤‡å°±ç»ªçŠ¶æ€
                            setScreenshotReady(false);
                            
                            // 5ç§’åç§»é™¤é”™è¯¯æç¤º
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    }).catch(function(error) {
                        // ç§»é™¤çŠ¶æ€æç¤º
                        if (statusDiv.parentNode) {
                            statusDiv.remove();
                        }
                        
                        logger.error('æˆªå›¾ä¸Šä¼ å¼‚å¸¸', { 
                            service: screenshotUrl, 
                            serviceIndex: currentServiceIndex,
                            error: error.message,
                            operation: 'æˆªå›¾ä¸Šä¼ å¼‚å¸¸'
                        });
                        console.error('æˆªå›¾ä¸Šä¼ å¤±è´¥:', error);
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(220,53,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                        errorDiv.textContent = 'âš  æˆªå›¾ä¸Šä¼ å¤±è´¥';
                        preview.appendChild(errorDiv);
                        
                        // æˆªå›¾ä¸Šä¼ å¤±è´¥ï¼Œä¿æŒæœªå‡†å¤‡å°±ç»ªçŠ¶æ€
                        setScreenshotReady(false);
                        
                        // 5ç§’åç§»é™¤é”™è¯¯æç¤º
                        setTimeout(() => {
                            if (errorDiv.parentNode) {
                                errorDiv.remove();
                            }
                        }, 5000);
                    });
                };
                
                img.onerror = function() {
                    logger.warn(`æˆªå›¾æœåŠ¡ ${currentServiceIndex + 1} å¤±è´¥`, { 
                        service: screenshotUrl, 
                        serviceIndex: currentServiceIndex,
                        operation: 'æˆªå›¾æœåŠ¡å¤±è´¥',
                        nextAttempt: currentServiceIndex + 1 < screenshotServices.length
                    });
                    console.log(`æˆªå›¾æœåŠ¡ ${currentServiceIndex + 1} å¤±è´¥: ${screenshotUrl}`);
                    currentServiceIndex++;
                    setTimeout(tryNextService, 1000);
                };
                
                img.src = screenshotUrl;
            }

            setTimeout(tryNextService, 2000);
        }

        // åˆ‡æ¢æˆªå›¾æ–¹å¼
        function toggleScreenshotMethod() {
            const apiSection = document.getElementById('screenshot-api-section');
            const uploadSection = document.getElementById('screenshot-upload-section');
            const selectedMethod = document.querySelector('input[name="screenshot-method"]:checked').value;

            if (selectedMethod === 'api') {
                apiSection.style.display = 'block';
                uploadSection.style.display = 'none';
            } else {
                apiSection.style.display = 'none';
                uploadSection.style.display = 'block';
            }
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // è®¾ç½®æˆªå›¾æœªå‡†å¤‡å°±ç»ªçŠ¶æ€
            setScreenshotReady(false);

            // è®°å½•æ‰‹åŠ¨ä¸Šä¼ å¼€å§‹
            logger.info('ç”¨æˆ·å¼€å§‹æ‰‹åŠ¨ä¸Šä¼ å›¾ç‰‡', { 
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                operation: 'æ‰‹åŠ¨ä¸Šä¼ å›¾ç‰‡'
            });

            if (!file.type.startsWith('image/')) {
                logger.warn('ç”¨æˆ·å°è¯•ä¸Šä¼ éå›¾ç‰‡æ–‡ä»¶', { fileName: file.name, fileType: file.type });
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                // ä¸Šä¼ å¤±è´¥ï¼Œä¿æŒæœªå‡†å¤‡å°±ç»ªçŠ¶æ€
                setScreenshotReady(false);
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB åˆå§‹é™åˆ¶ï¼Œåç»­ä¼šè‡ªåŠ¨å‹ç¼©
                logger.warn('ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶è¿‡å¤§', { fileName: file.name, fileSize: file.size });
                alert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡10MB');
                // ä¸Šä¼ å¤±è´¥ï¼Œä¿æŒæœªå‡†å¤‡å°±ç»ªçŠ¶æ€
                setScreenshotReady(false);
                return;
            }
            
            const preview = document.getElementById('screenshot-preview');
            preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">æ­£åœ¨å‹ç¼©å›¾ç‰‡...</span>';

            const options = {
                maxSizeMB: 0.2, // å‹ç¼©åˆ°çº¦200KB
                maxWidthOrHeight: 1024,
                fileType: 'image/jpeg',
                useWebWorker: true,
                onProgress: (p) => {
                    const progressSpan = preview.querySelector('span');
                    if (progressSpan) {
                        progressSpan.textContent = `æ­£åœ¨å‹ç¼©å›¾ç‰‡... ${p}%`;
                    }
                },
            };

            try {
                const compressedFile = await imageCompression(file, options);
                
                logger.info('å›¾ç‰‡å‹ç¼©æˆåŠŸ', { 
                    originalSize: file.size,
                    compressedSize: compressedFile.size,
                    compressionRatio: Math.round((1 - compressedFile.size / file.size) * 100),
                    operation: 'å›¾ç‰‡å‹ç¼©æˆåŠŸ'
                });
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64DataFull = e.target.result;
                    const base64Payload = base64DataFull.split(',')[1];

                    preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...</span>';

                    try {
                        const res = await fetch('/.netlify/functions/upload-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: base64Payload })
                        });
                        const result = await res.json();
                        if (!res.ok) throw new Error(result.error || 'Upload failed');

                        const imgUrl = result.url;
                        logger.info('æ‰‹åŠ¨ä¸Šä¼ å›¾ç‰‡æˆåŠŸ', { 
                            uploadedUrl: imgUrl,
                            finalSize: compressedFile.size,
                            operation: 'æ‰‹åŠ¨ä¸Šä¼ æˆåŠŸ'
                        });
                        const img = `<img src="${imgUrl}" alt="ä¸Šä¼ çš„æˆªå›¾" data-url="${imgUrl}">`;
                        preview.innerHTML = img;

                        // å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè®¾ç½®æˆªå›¾å‡†å¤‡å°±ç»ª
                        setScreenshotReady(true);

                    } catch (err) {
                        logger.error('æ‰‹åŠ¨ä¸Šä¼ å›¾ç‰‡å¤±è´¥', { 
                            error: err.message,
                            operation: 'æ‰‹åŠ¨ä¸Šä¼ å¤±è´¥'
                        });
                        console.error(err);
                        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                        preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">âŒ</div><div>ä¸Šä¼ å¤±è´¥</div></div>';
                        
                        // å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œä¿æŒæœªå‡†å¤‡å°±ç»ªçŠ¶æ€
                        setScreenshotReady(false);
                    }
                };
                reader.readAsDataURL(compressedFile);

            } catch (error) {
                console.error(error);
                alert('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–å›¾ç‰‡æˆ–æ¢ä¸ªæµè§ˆå™¨ã€‚');
                preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">âŒ</div><div>å‹ç¼©å¤±è´¥</div></div>';
                
                // å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä¿æŒæœªå‡†å¤‡å°±ç»ªçŠ¶æ€
                setScreenshotReady(false);
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showGuestNav();
            loadApps();
        }

        // é‡ç½®æ‰€æœ‰æœç´¢æ¡ä»¶
        function resetSearchConditions() {
            // æ¡Œé¢ç«¯
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');
            const sortFilter = document.getElementById('sort-filter');
            
            if (searchInput) searchInput.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (sortFilter) sortFilter.value = 'newest';
            
            // ç§»åŠ¨ç«¯
            const searchInputMobile = document.getElementById('search-input-mobile');
            const categoryFilterMobile = document.getElementById('category-filter-mobile');
            const sortFilterMobile = document.getElementById('sort-filter-mobile');
            
            if (searchInputMobile) searchInputMobile.value = '';
            if (categoryFilterMobile) categoryFilterMobile.value = '';
            if (sortFilterMobile) sortFilterMobile.value = 'newest';

            // é‡ç½®è‡ªå®šä¹‰ä¸‹æ‹‰èœå•çš„æ˜¾ç¤ºçŠ¶æ€
            updateDropdownSelection('category', '');
            updateDropdownSelection('sort', 'newest');
            updateDropdownSelection('category-mobile', '');
            updateDropdownSelection('sort-mobile', 'newest');
        }

        // è¿”å›é¦–é¡µ
        function goHome() {
            resetSearchConditions();
            loadApps();
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶å¤„ç†
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1024) {
                // æ¡Œé¢ç«¯æ¨¡å¼ä¸‹å…³é—­ç§»åŠ¨ç«¯èœå•
                closeMobileMenu();
            }
        });

        // é”®ç›˜äº‹ä»¶å¤„ç†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });

        // è‡ªå®šä¹‰ä¸‹æ‹‰èœå•åŠŸèƒ½
        function toggleDropdown(type) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            const isShow = dropdown.classList.contains('show');
            
            // å…³é—­æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰èœå•
            closeAllDropdowns();
            
            if (!isShow) {
                dropdown.classList.add('show');
                trigger.classList.add('active');
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶åˆ°ä¸‹æ‹‰èœå•é¡¹
                const items = dropdown.querySelectorAll('.dropdown-item');
                items.forEach(item => {
                    item.onclick = function() {
                        selectDropdownItem(type, this);
                    };
                });
            }
        }

        function selectDropdownItem(type, item) {
            const value = item.getAttribute('data-value');
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            dropdown.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            // æ›´æ–°éšè—çš„selectå€¼
            if (type.includes('category')) {
                const selectId = type.includes('mobile') ? 'category-filter-mobile' : 'category-filter';
                document.getElementById(selectId).value = value;
                
                // æ›´æ–°æŒ‰é’®å›¾æ ‡ï¼ˆå¯é€‰ï¼‰
                if (value) {
                    const emoji = item.textContent.split(' ')[0]; // è·å–emoji
                    trigger.textContent = emoji;
                } else {
                    trigger.textContent = 'ğŸ·ï¸';
                }
            } else if (type.includes('sort')) {
                const selectId = type.includes('mobile') ? 'sort-filter-mobile' : 'sort-filter';
                document.getElementById(selectId).value = value;
                
                // æ›´æ–°æŒ‰é’®å›¾æ ‡
                if (value === 'newest' || value === 'oldest') {
                    trigger.textContent = 'ğŸ“…';
                } else if (value === 'name') {
                    trigger.textContent = 'ğŸ”¤';
                } else if (value === 'author') {
                    trigger.textContent = 'ğŸ‘¤';
                }
            }
            
            // å…³é—­ä¸‹æ‹‰èœå•
            dropdown.classList.remove('show');
            trigger.classList.remove('active');
            
            // è§¦å‘æœç´¢
            searchApps();
        }

        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            const triggers = document.querySelectorAll('.dropdown-trigger');
            
            dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
            triggers.forEach(trigger => trigger.classList.remove('active'));
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-dropdown')) {
                closeAllDropdowns();
            }
        });

        // åŒæ­¥æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯çš„ç­›é€‰å™¨é€‰æ‹©
        function syncCustomDropdowns() {
            // åŒæ­¥åˆ†ç±»é€‰æ‹©
            const categoryDesktop = document.getElementById('category-filter').value;
            const categoryMobile = document.getElementById('category-filter-mobile').value;
            
            if (categoryDesktop !== categoryMobile) {
                // æ›´æ–°ç§»åŠ¨ç«¯
                updateDropdownSelection('category-mobile', categoryDesktop);
                document.getElementById('category-filter-mobile').value = categoryDesktop;
            }
            
            // åŒæ­¥æ’åºé€‰æ‹©
            const sortDesktop = document.getElementById('sort-filter').value;
            const sortMobile = document.getElementById('sort-filter-mobile').value;
            
            if (sortDesktop !== sortMobile) {
                // æ›´æ–°ç§»åŠ¨ç«¯
                updateDropdownSelection('sort-mobile', sortDesktop);
                document.getElementById('sort-filter-mobile').value = sortDesktop;
            }
        }

        function updateDropdownSelection(type, value) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            
            if (!dropdown || !trigger) return;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            dropdown.querySelectorAll('.dropdown-item').forEach(i => {
                i.classList.remove('selected');
                if (i.getAttribute('data-value') === value) {
                    i.classList.add('selected');
                    
                    // æ›´æ–°æŒ‰é’®å›¾æ ‡
                    if (type.includes('category')) {
                        if (value) {
                            const emoji = i.textContent.split(' ')[0];
                            trigger.textContent = emoji;
                        } else {
                            trigger.textContent = 'ğŸ·ï¸';
                        }
                    } else if (type.includes('sort')) {
                        if (value === 'newest' || value === 'oldest') {
                            trigger.textContent = 'ğŸ“…';
                        } else if (value === 'name') {
                            trigger.textContent = 'ğŸ”¤';
                        } else if (value === 'author') {
                            trigger.textContent = 'ğŸ‘¤';
                        }
                    }
                }
            });
        }

        // æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½
        let currentLogTab = 'local'; // å½“å‰é€‰ä¸­çš„æ—¥å¿—é€‰é¡¹å¡

        function showLogViewer() {
            // åªæœ‰adminè´¦å·å¯ä»¥æŸ¥çœ‹æ—¥å¿—
            if (!currentUser || currentUser.username !== 'admin') {
                alert('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼Œä»…é™adminè´¦å·è®¿é—®');
                return;
            }
            
            showModal('log-viewer-modal');
            // å¯åŠ¨é‡è¯•æœºåˆ¶
            logger.retryFailedLogs().catch(e => console.warn('é‡è¯•å¤±è´¥æ—¥å¿—æ—¶å‡ºé”™:', e));
            refreshLogs();
        }

        function switchLogTab(tab) {
            currentLogTab = tab;
            
            // æ›´æ–°é€‰é¡¹å¡æ ·å¼
            document.getElementById('local-logs-tab').classList.toggle('active', tab === 'local');
            document.getElementById('cloud-logs-tab').classList.toggle('active', tab === 'cloud');
            
            // åˆ·æ–°æ—¥å¿—å†…å®¹
            refreshLogs();
        }

        async function refreshLogs() {
            const levelFilter = document.getElementById('log-level-filter').value;
            const usernameFilter = document.getElementById('log-username-filter').value.trim();
            const logContent = document.getElementById('log-content');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            logContent.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;"><div class="loading" style="margin: 0 auto;"></div><br/>æ­£åœ¨åŠ è½½æ—¥å¿—...</div>';
            
            let logs = [];
            
            try {
                if (currentLogTab === 'cloud') {
                    // è·å–äº‘ç«¯æ—¥å¿—
                    logs = await logger.getCloudLogs(200, levelFilter || null, usernameFilter || null);
                } else {
                    // è·å–æœ¬åœ°æ—¥å¿—
                    logs = logger.getLogs(200, levelFilter || null, usernameFilter || null);
                }
            } catch (error) {
                logContent.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 2rem;">
                    <div style="font-size: 2rem;">âŒ</div>
                    <div>åŠ è½½æ—¥å¿—å¤±è´¥: ${error.message}</div>
                    <button onclick="refreshLogs()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•</button>
                </div>`;
                return;
            }
            
            if (logs.length === 0) {
                const tabName = currentLogTab === 'cloud' ? 'äº‘ç«¯' : 'æœ¬åœ°';
                logContent.innerHTML = `<div style="text-align: center; color: #666; padding: 2rem;">æš‚æ— ${tabName}æ—¥å¿—è®°å½•</div>`;
                return;
            }
            
            const logHtml = logs.map(log => {
                const levelColor = {
                    'INFO': '#28a745',
                    'WARN': '#ffc107', 
                    'ERROR': '#dc3545'
                }[log.level] || '#6c757d';
                
                const timeStr = new Date(log.timestamp).toLocaleString('zh-CN');
                const dataStr = log.data ? JSON.stringify(log.data, null, 2) : '';
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å¿«ç…§ID
                const hasSnapshot = log.data && log.data.snapshotId && log.message.includes('æ•°æ®å¿«ç…§å·²åˆ›å»º');
                const snapshotButton = hasSnapshot ? 
                    `<button onclick="openSnapshotFromLog('${log.data.snapshotId}')" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">ğŸ“¸ æŸ¥çœ‹å¿«ç…§</button>` : '';
                
                // äº‘ç«¯æ—¥å¿—é¢å¤–ä¿¡æ¯
                const isCloudLog = currentLogTab === 'cloud' && log.deviceInfo;
                const cloudBadge = isCloudLog ? '<span style="margin-left: 0.5rem; background: #17a2b8; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">ğŸŒ äº‘ç«¯</span>' : '';
                const deviceInfo = isCloudLog ? 
                    `<div style="margin-bottom: 0.25rem; font-size: 0.85rem; color: #666;">
                        <strong>è®¾å¤‡ä¿¡æ¯:</strong> ${log.deviceInfo.userAgent.split(' ')[0]}... | 
                        <strong>é¡µé¢:</strong> ${new URL(log.deviceInfo.url).pathname}
                    </div>` : '';
                
                return `
                    <div style="margin-bottom: 1rem; padding: 0.5rem; border-left: 4px solid ${levelColor}; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                            <div style="display: flex; align-items: center;">
                                <span style="font-weight: bold; color: ${levelColor};">[${log.level}]</span>
                                ${cloudBadge}
                                ${hasSnapshot ? '<span style="margin-left: 0.5rem; background: #17a2b8; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">ğŸ“¸ å¿«ç…§</span>' : ''}
                            </div>
                            <span style="color: #666; font-size: 0.8rem;">${timeStr}</span>
                        </div>
                        <div style="margin-bottom: 0.25rem;">
                            <strong>ç”¨æˆ·:</strong> ${log.user.username} (ID: ${log.user.id})
                        </div>
                        ${deviceInfo}
                        <div style="margin-bottom: 0.25rem; display: flex; align-items: center;">
                            <strong>æ¶ˆæ¯:</strong> ${log.message}
                            ${snapshotButton}
                        </div>
                        ${dataStr ? `<details style="margin-top: 0.5rem;"><summary style="cursor: pointer; color: #007bff;">æŸ¥çœ‹è¯¦ç»†æ•°æ®</summary><pre style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; overflow-x: auto;">${dataStr}</pre></details>` : ''}
                    </div>
                `;
            }).join('');
            
            logContent.innerHTML = logHtml;
        }

        async function clearCurrentLogs() {
            const tabName = currentLogTab === 'cloud' ? 'äº‘ç«¯' : 'æœ¬åœ°';
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${tabName}æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                try {
                    if (currentLogTab === 'cloud') {
                        await logger.clearCloudLogs();
                    } else {
                        logger.clearLogs();
                    }
                    await refreshLogs();
                    alert(`${tabName}æ—¥å¿—å·²æ¸…ç©º`);
                } catch (error) {
                    alert(`æ¸…ç©º${tabName}æ—¥å¿—å¤±è´¥: ` + error.message);
                }
            }
        }

        async function retryFailedLogs() {
            try {
                await logger.retryFailedLogs();
                alert('é‡è¯•å®Œæˆï¼è¯·åˆ·æ–°äº‘ç«¯æ—¥å¿—æŸ¥çœ‹ç»“æœã€‚');
                if (currentLogTab === 'cloud') {
                    await refreshLogs();
                }
            } catch (error) {
                alert('é‡è¯•å¤±è´¥: ' + error.message);
            }
        }

        async function manualCleanup() {
            if (currentLogTab === 'cloud') {
                if (confirm('ç¡®å®šè¦æ‰‹åŠ¨æ¸…ç†è¿‡æœŸçš„äº‘ç«¯æ—¥å¿—å—ï¼Ÿå°†ç§»é™¤è¶…è¿‡48å°æ—¶çš„æ—¥å¿—è®°å½•ã€‚')) {
                    try {
                        await logger.cleanupCloudLogs();
                        alert('æ¸…ç†å®Œæˆï¼è¯·åˆ·æ–°æŸ¥çœ‹ç»“æœã€‚');
                        await refreshLogs();
                    } catch (error) {
                        alert('æ¸…ç†å¤±è´¥: ' + error.message);
                    }
                }
            } else {
                alert('æ¸…ç†è¿‡æœŸæ—¥å¿—åŠŸèƒ½ä»…é€‚ç”¨äºäº‘ç«¯æ—¥å¿—');
            }
        }

        async function exportLogs() {
            try {
                let logs = [];
                const tabName = currentLogTab === 'cloud' ? 'äº‘ç«¯' : 'æœ¬åœ°';
                
                if (currentLogTab === 'cloud') {
                    logs = await logger.getCloudLogs(1000);
                } else {
                    logs = logger.getLogs(1000);
                }
                
                const logText = logs.map(log => {
                    const timeStr = new Date(log.timestamp).toISOString();
                    const dataStr = log.data ? JSON.stringify(log.data) : '';
                    const deviceStr = log.deviceInfo ? `[${log.deviceInfo.userAgent}]` : '';
                    return `[${timeStr}] [${log.level}] ${log.user.username}: ${log.message} ${deviceStr} ${dataStr}`;
                }).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bee-store-${currentLogTab}-logs-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                alert('å¯¼å‡ºæ—¥å¿—å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ—¥å¿—æŸ¥çœ‹æŒ‰é’®ï¼ˆä»…adminè´¦å·ï¼‰
        function updateLogViewerVisibility() {
            const showLogBtn = currentUser && currentUser.username === 'admin';
            const logBtn = document.getElementById('log-viewer-btn');
            const mobileLogBtn = document.getElementById('mobile-log-viewer-btn');
            const snapshotBtn = document.getElementById('snapshot-viewer-btn');
            const mobileSnapshotBtn = document.getElementById('mobile-snapshot-viewer-btn');
            
            if (logBtn) logBtn.style.display = showLogBtn ? 'inline-block' : 'none';
            if (mobileLogBtn) mobileLogBtn.style.display = showLogBtn ? 'block' : 'none';
            if (snapshotBtn) snapshotBtn.style.display = showLogBtn ? 'inline-block' : 'none';
            if (mobileSnapshotBtn) mobileSnapshotBtn.style.display = showLogBtn ? 'block' : 'none';
        }

        // å¿«ç…§æŸ¥çœ‹å’Œæ¢å¤åŠŸèƒ½
        let currentRestoreSnapshotId = null;

        function showSnapshotViewer() {
            // åªæœ‰adminè´¦å·å¯ä»¥æŸ¥çœ‹å¿«ç…§
            if (!currentUser || currentUser.username !== 'admin') {
                alert('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ•°æ®å¿«ç…§ï¼Œä»…é™adminè´¦å·è®¿é—®');
                return;
            }
            
            showModal('snapshot-viewer-modal');
            refreshSnapshots();
        }

        function refreshSnapshots() {
            const typeFilter = document.getElementById('snapshot-type-filter').value;
            const snapshotContent = document.getElementById('snapshot-content');
            
            const snapshots = logger.getSnapshots(100, typeFilter || null);
            
            if (snapshots.length === 0) {
                snapshotContent.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">æš‚æ— æ•°æ®å¿«ç…§</div>';
                return;
            }
            
            const snapshotHtml = snapshots.map(snapshot => {
                const timeStr = new Date(snapshot.timestamp).toLocaleString('zh-CN');
                const typeColor = {
                    'app_edit_before': '#007bff',
                    'app_delete_before': '#dc3545',
                    'apps_before_add': '#28a745',
                    'users_before_add': '#17a2b8',
                    'full_before_sync': '#6f42c1',
                    'local_before_merge': '#fd7e14',
                    'remote_before_merge': '#20c997'
                }[snapshot.metadata.snapshotType] || '#6c757d';
                
                const dataPreview = JSON.stringify(snapshot.data, null, 2).substring(0, 200) + '...';
                
                return `
                    <div style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid ${typeColor}; background: white; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div>
                                <h4 style="margin: 0; color: ${typeColor};">${snapshot.description}</h4>
                                <small style="color: #666;">${timeStr} | ç”¨æˆ·: ${snapshot.metadata.user.username}</small>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="viewSnapshotDetails('${snapshot.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">è¯¦æƒ…</button>
                                <button class="btn btn-primary" onclick="prepareRestore('${snapshot.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #28a745;">æ¢å¤</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <strong>ç±»å‹:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            <strong>å¤§å°:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB 
                            (å‹ç¼©å: ${Math.round(snapshot.metadata.compressedSize / 1024)}KB)
                        </div>
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #007bff;">é¢„è§ˆæ•°æ®</summary>
                            <pre style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; overflow-x: auto; font-size: 0.8rem;">${dataPreview}</pre>
                        </details>
                    </div>
                `;
            }).join('');
            
            snapshotContent.innerHTML = snapshotHtml;
        }

        function getSnapshotTypeLabel(type) {
            const labels = {
                'app_edit_before': 'åº”ç”¨ç¼–è¾‘å‰',
                'app_delete_before': 'åº”ç”¨åˆ é™¤å‰',
                'apps_before_add': 'æ–°åº”ç”¨å‘å¸ƒå‰',
                'users_before_add': 'ç”¨æˆ·æ³¨å†Œå‰',
                'full_before_sync': 'æ•°æ®åŒæ­¥å‰',
                'local_before_merge': 'æ•°æ®åˆå¹¶å‰(æœ¬åœ°)',
                'remote_before_merge': 'æ•°æ®åˆå¹¶å‰(è¿œç¨‹)'
            };
            return labels[type] || type;
        }

        function viewSnapshotDetails(snapshotId) {
            const snapshots = logger.getSnapshots(1000);
            const snapshot = snapshots.find(s => s.id === snapshotId);
            
            if (!snapshot) {
                alert('å¿«ç…§ä¸å­˜åœ¨');
                return;
            }
            
            const detailsWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            detailsWindow.document.write(`
                <html>
                <head>
                    <title>å¿«ç…§è¯¦æƒ… - ${snapshot.description}</title>
                    <style>
                        body { font-family: 'Courier New', monospace; margin: 20px; }
                        .header { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${snapshot.description}</h2>
                        <p><strong>æ—¶é—´:</strong> ${new Date(snapshot.timestamp).toLocaleString('zh-CN')}</p>
                        <p><strong>ç”¨æˆ·:</strong> ${snapshot.metadata.user.username}</p>
                        <p><strong>ç±»å‹:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}</p>
                        <p><strong>æ•°æ®å¤§å°:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB</p>
                    </div>
                    <h3>æ•°æ®å†…å®¹:</h3>
                    <pre>${JSON.stringify(snapshot.data, null, 2)}</pre>
                </body>
                </html>
            `);
        }

        function prepareRestore(snapshotId) {
            const snapshots = logger.getSnapshots(1000);
            const snapshot = snapshots.find(s => s.id === snapshotId);
            
            if (!snapshot) {
                alert('å¿«ç…§ä¸å­˜åœ¨');
                return;
            }
            
            currentRestoreSnapshotId = snapshotId;
            
            const restoreInfo = document.getElementById('restore-info');
            restoreInfo.innerHTML = `
                <h4>${snapshot.description}</h4>
                <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(snapshot.timestamp).toLocaleString('zh-CN')}</p>
                <p><strong>åˆ›å»ºç”¨æˆ·:</strong> ${snapshot.metadata.user.username}</p>
                <p><strong>å¿«ç…§ç±»å‹:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}</p>
                <p><strong>æ•°æ®å¤§å°:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB</p>
            `;
            
            // æ ¹æ®å¿«ç…§ç±»å‹è®¾ç½®é»˜è®¤æ¢å¤é€‰é¡¹
            const restoreType = document.getElementById('restore-type');
            if (snapshot.metadata.snapshotType?.includes('app')) {
                restoreType.value = 'apps';
            } else if (snapshot.metadata.snapshotType?.includes('user')) {
                restoreType.value = 'users';
            } else {
                restoreType.value = 'full';
            }
            
            showModal('snapshot-restore-modal');
        }

        function confirmRestore() {
            if (!currentRestoreSnapshotId) {
                alert('æœªé€‰æ‹©å¿«ç…§');
                return;
            }
            
            const restoreType = document.getElementById('restore-type').value;
            
            if (!confirm('ç¡®å®šè¦æ¢å¤æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ•°æ®ï¼')) {
                return;
            }
            
            try {
                // åœ¨æ¢å¤å‰åˆ›å»ºå½“å‰æ•°æ®çš„å¤‡ä»½å¿«ç…§
                logger.snapshot('æ•°æ®æ¢å¤å‰è‡ªåŠ¨å¤‡ä»½', cloudData, {
                    snapshotType: 'auto_backup_before_restore',
                    operation: 'æ¢å¤å‰è‡ªåŠ¨å¤‡ä»½',
                    restoreSnapshotId: currentRestoreSnapshotId
                });
                
                // æ‰§è¡Œæ¢å¤
                logger.restoreFromSnapshot(currentRestoreSnapshotId, restoreType);
                
                // æ›´æ–°UI
                updateStats();
                loadApps();
                
                closeModal('snapshot-restore-modal');
                closeModal('snapshot-viewer-modal');
                
                alert('æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚');
                
                // åˆ·æ–°é¡µé¢ä»¥ç¡®ä¿UIå®Œå…¨æ›´æ–°
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                alert('æ•°æ®æ¢å¤å¤±è´¥: ' + error.message);
            } finally {
                currentRestoreSnapshotId = null;
            }
        }

        function clearSnapshots() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å¿«ç…§å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                logger.clearSnapshots();
                refreshSnapshots();
                alert('å¿«ç…§å·²æ¸…ç©º');
            }
        }

        function exportSnapshots() {
            const snapshots = logger.getSnapshots(1000);
            const exportData = {
                exportTime: new Date().toISOString(),
                totalSnapshots: snapshots.length,
                snapshots: snapshots
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bee-store-snapshots-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ä»æ—¥å¿—å¿«é€Ÿè®¿é—®å¿«ç…§
        function openSnapshotFromLog(snapshotId) {
            closeModal('log-viewer-modal');
            showSnapshotViewer();
            
            // ç­‰å¾…å¿«ç…§æŸ¥çœ‹å™¨åŠ è½½å®Œæˆåå®šä½åˆ°ç‰¹å®šå¿«ç…§
            setTimeout(() => {
                const snapshotContent = document.getElementById('snapshot-content');
                const targetElement = snapshotContent.querySelector(`[onclick*="${snapshotId}"]`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // é«˜äº®æ˜¾ç¤ºç›®æ ‡å¿«ç…§
                    const snapshotDiv = targetElement.closest('div[style*="border-left"]');
                    if (snapshotDiv) {
                        snapshotDiv.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.6)';
                        snapshotDiv.style.background = '#fff3cd';
                        setTimeout(() => {
                            snapshotDiv.style.boxShadow = '';
                            snapshotDiv.style.background = 'white';
                        }, 3000);
                    }
                }
            }, 500);
        }

        // ä¿®æ”¹showUserNavå‡½æ•°ä»¥åŒ…å«æ—¥å¿—æŒ‰é’®å¯è§æ€§æ›´æ–°
        const originalShowUserNav = showUserNav;
        showUserNav = function() {
            originalShowUserNav();
            updateLogViewerVisibility();
        };

        const originalShowGuestNav = showGuestNav;
        showGuestNav = function() {
            originalShowGuestNav();
            updateLogViewerVisibility();
        };

        // åˆå§‹åŒ–åº”ç”¨
        init();

        // å¯åŠ¨å®šæœŸé‡è¯•æœºåˆ¶ï¼ˆæ¯5åˆ†é’Ÿé‡è¯•ä¸€æ¬¡å¤±è´¥çš„æ—¥å¿—ï¼‰
        setInterval(() => {
            logger.retryFailedLogs().catch(e => console.warn('å®šæœŸé‡è¯•å¤±è´¥:', e));
        }, 5 * 60 * 1000);

        // å¯åŠ¨å®šæœŸæ¸…ç†æœºåˆ¶ï¼ˆæ¯12å°æ—¶æ¸…ç†ä¸€æ¬¡è¿‡æœŸæ—¥å¿—ï¼‰
        setInterval(() => {
            logger.cleanupCloudLogs().catch(e => console.warn('å®šæœŸæ¸…ç†å¤±è´¥:', e));
        }, 12 * 60 * 60 * 1000);

        // å¯åŠ¨å®šæœŸåå°åŒæ­¥æœºåˆ¶ï¼ˆæ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¾…åŒæ­¥æ“ä½œï¼‰
        setInterval(() => {
            const pendingOps = localCache.getPendingOperations();
            if (pendingOps.length > 0) {
                logger.info('å®šæœŸæ£€æŸ¥ï¼šå‘ç°å¾…åŒæ­¥æ“ä½œ', { 
                    operationsCount: pendingOps.length,
                    operation: 'å®šæœŸåŒæ­¥æ£€æŸ¥'
                });
                syncQueue.retryFailedSync().catch(e => console.warn('å®šæœŸåŒæ­¥å¤±è´¥:', e));
            }
        }, 2 * 60 * 1000); // æ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

        // å¯åŠ¨å®šæœŸæ“ä½œé˜Ÿåˆ—æ¸…ç†æœºåˆ¶ï¼ˆæ¯å°æ—¶æ¸…ç†ä¸€æ¬¡è¿‡æœŸæ“ä½œï¼‰
        setInterval(() => {
            syncQueue.cleanupExpiredOperations();
        }, 60 * 60 * 1000); // æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡

        // åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†
        setTimeout(() => {
            logger.cleanupCloudLogs().catch(e => console.warn('å¯åŠ¨æ¸…ç†å¤±è´¥:', e));
        }, 10000); // 10ç§’åæ‰§è¡Œï¼Œç¡®ä¿åº”ç”¨åˆå§‹åŒ–å®Œæˆ
    </script>
</body>
</html>

