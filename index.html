<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee Store - Â≠¶Áîü‰ΩúÂìÅÂ±ïÁ§∫Âπ≥Âè∞</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --card-gradient: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            --glass-bg: rgba(255, 255, 255, 0.35);
            --glass-border: rgba(255, 255, 255, 0.25);
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(255, 255, 255, 0.4);
            --shadow-light: 0 8px 32px rgba(31, 38, 135, 0.37);
            --shadow-heavy: 0 15px 35px rgba(31, 38, 135, 0.5);
            --text-primary: #1a202c;
            --text-secondary: #2d3748;
            --border-radius: 20px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ÊØõÁéªÁíÉÊïàÊûú */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Áä∂ÊÄÅÊåáÁ§∫Âô® - ÈöêËóè‰∏çÊòæÁ§∫ÁªôÁî®Êà∑ */
        .status-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1002;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status-connected { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-syncing { background: #ff9500; color: white; }
        .status-local { background: #17a2b8; color: white; }
        .status-syncing { background: #ff9500; color: white; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Â§¥ÈÉ®Ê†∑Âºè */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 500px;
        }

        .nav-stats {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .nav-slogan {
            font-size: 1rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }

        .nav-stat-item {
            text-align: center;
            color: var(--text-primary);
            min-width: 45px;
        }

        .nav-stat-item .number {
            font-size: 1.2rem;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
            line-height: 1.2;
        }

        .nav-stat-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            line-height: 1;
            margin-top: 0.1rem;
        }

        .logo {
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 2rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
            letter-spacing: -0.02em;
        }

        .logo:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .logo img {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            flex-shrink: 0;
        }

        .nav-search {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 0.4rem 0.8rem;
            transition: all 0.3s ease;
            min-width: 320px;
            max-width: 400px;
            width: 100%;
        }

        .nav-search:hover,
        .nav-search:focus-within {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .nav-search input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 0.9rem;
            padding: 0.25rem 0;
            outline: none;
        }

        .nav-search input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .nav-search-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-search .dropdown-trigger {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-search .dropdown-trigger:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--text-primary);
        }

        .nav-search .search-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            background: var(--primary-gradient);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-search .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        /* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            padding: 2rem 0; /* Â¢ûÂä†È°∂ÈÉ®paddingÔºåÂõ†‰∏∫Âà†Èô§‰∫ÜÁªüËÆ°Ê®™ÂπÖ */
        }



        /* ÁßªÂä®Á´ØÊêúÁ¥¢Ê†èÊ†∑Âºè */
        .mobile-search-bar {
            padding: 0 1rem;
        }

        /* Ê°åÈù¢Á´ØÂ∏ÉÂ±Ä */
        .desktop-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        /* ÁßªÂä®Á´ØÂ∏ÉÂ±ÄÈªòËÆ§ÈöêËóè */
        .mobile-layout {
            display: none;
        }

        .header-slogan {
            flex: 0 0 auto;
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            min-width: 200px;
        }

        .header-search {
            flex: 1;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            max-width: 600px;
        }

        .search-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            padding: 0;
            flex-shrink: 0;
            background: transparent !important;
            color: #ff9500 !important;
            border: none;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: rgba(255, 149, 0, 0.1) !important;
            transform: none;
            box-shadow: none;
        }

        .header-search .search-input {
            height: 40px;
            padding: 0 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 0;
            flex: 1;
        }

        .header-search .search-input:focus {
            outline: none;
            border-color: #ff9500;
        }

        .header-search .filter-select {
            height: 40px;
            padding: 0 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            box-sizing: border-box;
            background: white;
        }

        .header-search .filter-select:focus {
            outline: none;
            border-color: #ff9500;
        }

        /* Ëá™ÂÆö‰πâ‰∏ãÊãâËèúÂçïÊ†∑Âºè */
        .custom-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-trigger {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #ff9500;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .dropdown-trigger:hover {
            background: rgba(255, 149, 0, 0.1);
        }

        .dropdown-trigger.active {
            background: rgba(255, 149, 0, 0.15);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 120px;
            max-height: 250px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 149, 0, 0.1);
        }

        .dropdown-item.selected {
            background: rgba(255, 149, 0, 0.2);
            color: #ff6600;
            font-weight: 500;
        }

        .header-stats {
            flex: 0 0 auto;
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            min-width: 140px;
        }

        .stat-compact {
            text-align: center;
            color: #333;
        }

        .stat-compact .number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff9500;
            display: block;
        }

        .stat-compact .label {
            font-size: 0.8rem;
            color: #666;
        }

        /* Â∫îÁî®ÁΩëÊ†º */
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 0;
            padding: 1rem 0;
        }

        .app-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .app-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .app-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-heavy);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .app-card:hover::before {
            opacity: 0.03;
        }

        .app-screenshot {
            width: 100%;
            height: 140px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            overflow: hidden;
            position: relative;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .app-screenshot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .app-card:hover .app-screenshot::before {
            transform: translateX(100%);
        }

        .app-screenshot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-screenshot .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }

        .app-info h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.01em;
            line-height: 1.3;
            filter: drop-shadow(0 1px 2px rgba(255, 255, 255, 0.9));
        }

        /* ‰∫ßÂìÅÊèèËø∞Â±ïÂºÄÂäüËÉΩ */
        .app-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            position: relative;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .app-description.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .app-description.collapsed.has-overflow::after {
            content: '...Â±ïÂºÄ';
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(to right, transparent, white 30%, white);
            color: #ff9500;
            font-size: 0.85rem;
            padding-left: 20px;
            text-decoration: underline;
            pointer-events: auto;
            z-index: 2;
        }

        .app-description.collapsed.has-overflow::after:hover {
            color: #ff6600;
        }

        .app-description.expanded {
            display: block;
        }

        .description-toggle {
            color: #ff9500;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            margin-top: 0.25rem;
            text-decoration: underline;
        }

        .description-toggle:hover {
            color: #ff6600;
        }

        .app-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.7);
        }

        .app-stats {
            display: flex;
            gap: 1rem;
        }

        .app-url {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0;
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            background: var(--primary-gradient);
            color: white;
            transition: all 0.3s ease;
            font-weight: 600;
            vertical-align: middle;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .app-url:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
            filter: brightness(1.1);
        }

        .app-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .app-action-btn {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .app-action-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .app-action-btn.edit-btn {
            background: rgba(0, 123, 255, 0.9);
        }
        
        .app-action-btn.edit-btn:hover {
            background: #007bff;
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 520px;
            box-shadow: var(--shadow-heavy);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        /* Êà™ÂõæÊñπÂºèË°å */
        .capture-method-row {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin: 0.75rem 0 1rem;
        }

        .capture-method-row label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: normal;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff9500, #ff6600);
            color: #fff;
            border: none;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(255, 149, 0, 0.4);
        }

        .btn-secondary {
            border: 1px solid #ff9500;
            color: #ff9500;
            background: #fff;
        }

        .btn-secondary:hover {
            background: #ff9500;
            color: #fff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        /* ÂèëÂ∏ÉÂ∫îÁî®ÊåâÈíÆ */
        .publish-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: var(--secondary-gradient);
            color: white;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(240, 147, 251, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .publish-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 40px rgba(240, 147, 251, 0.6);
            border-radius: 50%;
        }

        .publish-btn:active {
            transform: scale(0.95) rotate(90deg);
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
        }

        .empty-state p {
            color: #666;
            font-size: 1.1rem;
        }

        /* Áî®Êà∑‰ø°ÊÅØ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #333;
        }

        /* Â∫îÁî®‰∫íÂä®ÊåâÈíÆ */
        .app-interactions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem 0;
            border-top: 1px solid #f0f0f0;
        }

        .interaction-group {
            display: flex;
            gap: 1rem;
        }

        .interaction-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: #666;
            transition: color 0.3s ease;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .interaction-btn:hover {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }

        .interaction-btn.active {
            color: #ff9500;
        }

        .interaction-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .interaction-btn:disabled:hover {
            color: #666;
            background: none;
        }

        /* ËØÑËÆ∫Âå∫Âüü */
        .comments-section {
            margin-top: 1rem;
            border-top: 1px solid #f0f0f0;
            padding-top: 1rem;
        }

        .comment-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #666;
        }

        .comment-author {
            font-weight: bold;
            color: #333;
        }

        .comment-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .comment-delete {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem;
        }

        .comment-delete:hover {
            color: #c82333;
        }

        .comment-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .comment-input input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .comment-input button {
            padding: 0.5rem 1rem;
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .comment-input button:hover {
            background: #ff6600;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9500, #ff6600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Êà™ÂõæÈ¢ÑËßà */
        .screenshot-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .screenshot-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff9500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* È°µÈù¢Âä†ËΩΩÂä®Áîª */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Â∫îÁî®Âä†ËΩΩÂä®ÁîªÂà∞Âç°Áâá */
        .app-card {
            animation: fadeInUp 0.6s ease forwards;
        }

        .app-card:nth-child(1) { animation-delay: 0.1s; }
        .app-card:nth-child(2) { animation-delay: 0.2s; }
        .app-card:nth-child(3) { animation-delay: 0.3s; }
        .app-card:nth-child(4) { animation-delay: 0.4s; }
        .app-card:nth-child(5) { animation-delay: 0.5s; }
        .app-card:nth-child(6) { animation-delay: 0.6s; }

        /* Â§¥ÈÉ®Âä®Áîª */
        .header-integrated {
            animation: fadeInScale 0.8s ease forwards;
        }

        /* Âä†ËΩΩÊó∂ÁöÑÈó™ÁÉÅÊïàÊûú */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Êó•ÂøóÈÄâÈ°πÂç°Ê†∑Âºè */
        .log-tab {
            transition: all 0.3s ease;
            color: #666;
        }

        .log-tab:hover {
            color: #ff9500;
            background: rgba(255, 149, 0, 0.1);
        }

        .log-tab.active {
            color: #ff9500;
            border-bottom-color: #ff9500 !important;
            background: rgba(255, 149, 0, 0.05);
        }

        /* ÊêúÁ¥¢ÂäüËÉΩ */
        .search-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* ÁªüËÆ°‰ø°ÊÅØ */
        .stats-section {
            background: linear-gradient(135deg, #ff9500 0%, #ff6600 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: white;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-item p {
            opacity: 0.8;
        }

        /* Ê±âÂ†°ËèúÂçïÊ†∑Âºè */
        .hamburger-menu {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 0.5rem;
            gap: 0.3rem;
        }

        .hamburger-line {
            width: 24px;
            height: 3px;
            background-color: #ff9500;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
        }

        .mobile-nav-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 2rem 1.5rem;
        }

        .mobile-nav-menu.active {
            right: 0;
        }

        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .mobile-nav-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9500;
        }

        .mobile-nav-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.25rem;
        }

        .mobile-nav-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mobile-nav-item {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .mobile-nav-item:hover {
            background: #ff9500;
            color: white;
            border-color: #ff9500;
        }

        .mobile-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1024px) {
            .apps-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
                padding: 2rem;
            }
            
            .app-card {
                padding: 1.25rem;
            }
            
            .app-screenshot {
                height: 130px;
            }
            
            .nav-center {
                display: none;
            }
            
            .nav-stats {
                display: none;
            }
            
            .nav-buttons {
                display: none;
            }
            
            .mobile-search-bar {
                display: block !important;
            }

            .nav {
                justify-content: center;
            }

            .logo {
                margin: 0 auto;
            }

            .hamburger-menu {
                display: flex;
            }

            /* Â§¥ÈÉ®Êï¥ÂêàÂìçÂ∫îÂºè */
            .header-integrated {
                padding: 0.75rem 1rem;
                margin-bottom: 1rem;
            }

            /* ÁßªÂä®Á´ØÔºöÈöêËóèÊ°åÈù¢Â∏ÉÂ±ÄÔºåÊòæÁ§∫ÁßªÂä®Â∏ÉÂ±Ä */
            .desktop-layout {
                display: none;
            }

            .mobile-layout {
                display: block;
            }

            /* ÁßªÂä®Á´ØÁ¨¨‰∏ÄË°åÔºöÊ†áÈ¢òÂíåÊêúÁ¥¢Ê°Ü */
            .mobile-header-row {
                display: flex;
                align-items: flex-end;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
                padding-top: 0.25rem;
            }

            .mobile-header-row .header-slogan {
                flex: 0 0 auto;
                font-size: 0.9rem;
                font-weight: 600;
                white-space: nowrap;
                line-height: 36px;
                align-self: center;
            }

            .mobile-header-row .search-input {
                flex: 1;
                min-width: 0;
                height: 36px;
                font-size: 0.9rem;
                padding: 0 0.5rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                box-sizing: border-box;
                margin-top: 0.25rem;
            }

            .mobile-header-row .search-input:focus {
                outline: none;
                border-color: #ff9500;
            }

            /* ÁßªÂä®Á´ØÁ¨¨‰∫åË°åÔºöÁ≠õÈÄâÂô®ÂíåÊêúÁ¥¢ÊåâÈíÆ */
            .mobile-filters-row {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .mobile-filters-row .filter-select {
                height: 36px;
                font-size: 0.85rem;
                flex: 1;
                padding: 0 0.5rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                box-sizing: border-box;
                background: white;
            }

            .mobile-filters-row .filter-select:focus {
                outline: none;
                border-color: #ff9500;
            }

            .mobile-filters-row .search-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
                flex-shrink: 0;
            }

            /* ÁßªÂä®Á´ØËá™ÂÆö‰πâ‰∏ãÊãâËèúÂçï */
            .mobile-filters-row .custom-dropdown {
                flex: 1;
            }

            .mobile-filters-row .dropdown-trigger {
                width: 100%;
                height: 36px;
                font-size: 1rem;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                background: white;
            }

            .mobile-filters-row .dropdown-trigger:hover {
                border-color: #ff9500;
                background: rgba(255, 149, 0, 0.05);
            }

            .mobile-filters-row .dropdown-trigger.active {
                border-color: #ff9500;
                background: rgba(255, 149, 0, 0.1);
            }

            .mobile-filters-row .dropdown-menu {
                min-width: 100%;
            }

            .interaction-group {
                gap: 0.5rem;
            }

            .interaction-btn {
                font-size: 0.8rem;
                padding: 0.2rem 0.4rem;
            }

            .comment-input {
                flex-direction: column;
                gap: 0.5rem;
            }

            .comment-input input {
                margin-bottom: 0;
            }



            .stats-row {
                flex-direction: column;
                gap: 1rem;
            }

            .logo {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 768px) {
            .apps-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 0.5rem 0;
            }
            
            .modal-content {
                width: 95%;
                margin: 0;
                padding: 1.5rem;
                transform: translate(-50%, -50%);
                border-radius: 16px;
            }

            body.no-scroll {
                overflow: hidden;
            }

            .app-card {
                padding: 1.25rem;
                border-radius: 14px;
            }
            
            .app-screenshot {
                height: 120px;
                border-radius: 10px;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .publish-btn {
                width: 60px;
                height: 60px;
                bottom: 1.5rem;
                right: 1.5rem;
            }

            /* Ëøõ‰∏ÄÊ≠•ÂáèÂ∞ëÁßªÂä®Á´ØÁöÑÈó¥Ë∑ù */
            .main-content {
                padding: 0.5rem 0;
            }

            .header-integrated {
                margin-bottom: 1rem;
                padding: 1.5rem;
                border-radius: 16px;
            }
        }
    </style>
</head>
<body>


    <div class="header">
        <div class="container">
            <nav class="nav">
                <a href="#" class="logo">
                    <img src="logo.png" alt="Bee Store Logo">
                    <span>Bee Store</span>
                </a>
                
                <div class="nav-center">
                    <div class="nav-search">
                        <input type="text" id="nav-search-input" placeholder="ÊêúÁ¥¢‰ΩúÂìÅÂêçÁß∞„ÄÅÊèèËø∞„ÄÅÂàõ‰ΩúËÄÖ...">
                        <div class="nav-search-controls">
                            <!-- ÂàÜÁ±ª‰∏ãÊãâËèúÂçï -->
                            <div class="custom-dropdown">
                                <button class="dropdown-trigger" id="nav-category-trigger" onclick="toggleDropdown('nav-category')" title="ÂàÜÁ±ªÁ≠õÈÄâ">
                                    üè∑Ô∏è
                                </button>
                                <div class="dropdown-menu" id="nav-category-dropdown">
                                    <div class="dropdown-item selected" data-value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</div>
                                    <div class="dropdown-item" data-value="Â∑•ÂÖ∑">üîß Â∑•ÂÖ∑</div>
                                    <div class="dropdown-item" data-value="Â≠¶‰π†">üìö Â≠¶‰π†</div>
                                    <div class="dropdown-item" data-value="Ê∏∏Êàè">üéÆ Ê∏∏Êàè</div>
                                    <div class="dropdown-item" data-value="Ëâ∫ÊúØ">üé® Ëâ∫ÊúØ</div>
                                    <div class="dropdown-item" data-value="ÁßëÊäÄ">üíª ÁßëÊäÄ</div>
                                </div>
                            </div>
                            
                            <!-- ÊéíÂ∫è‰∏ãÊãâËèúÂçï -->
                            <div class="custom-dropdown">
                                <button class="dropdown-trigger" id="nav-sort-trigger" onclick="toggleDropdown('nav-sort')" title="ÊéíÂ∫èÊñπÂºè">
                                    üîÑ
                                </button>
                                <div class="dropdown-menu" id="nav-sort-dropdown">
                                    <div class="dropdown-item selected" data-value="newest">ÊúÄÊñ∞ÂèëÂ∏É</div>
                                    <div class="dropdown-item" data-value="oldest">ÊúÄÊó©ÂèëÂ∏É</div>
                                    <div class="dropdown-item" data-value="name">ÊåâÂêçÁß∞</div>
                                    <div class="dropdown-item" data-value="author">Êåâ‰ΩúËÄÖ</div>
                                </div>
                            </div>
                            
                            <button class="search-btn" onclick="searchApps()">üîç</button>
                        </div>
                    </div>
                </div>
                
                <div class="nav-stats">
    
                    <div class="nav-stat-item">
                        <span class="number" id="nav-total-apps">0</span>
                        <span class="label">‰ΩúÂìÅÊÄªÊï∞</span>
                    </div>
                    <div class="nav-stat-item">
                        <span class="number" id="nav-total-users">0</span>
                        <span class="label">Âàõ‰ΩúËÄÖ</span>
                    </div>
                </div>
                
                <div class="nav-buttons">
                    <div id="guest-nav" style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="showLogin()">ÁôªÂΩï</button>
                        <button class="btn btn-primary" onclick="showRegister()">Ê≥®ÂÜå</button>
                    </div>
                    <div id="user-nav" style="display: none; align-items: center; gap: 1rem;">
                        <div class="user-info">
                            <div class="user-avatar" id="user-avatar"></div>
                            <span id="user-name"></span>
                        </div>
                        <button class="btn btn-secondary" onclick="goHome()">È¶ñÈ°µ</button>
                        <button class="btn btn-secondary" onclick="showMyApps()">ÊàëÁöÑÂ∫îÁî®</button>
                        <button class="btn btn-secondary" onclick="showMyFavorites()">ÊàëÁöÑÊî∂Ëóè</button>
                        <button class="btn btn-secondary" onclick="showLogViewer()" style="display: none;" id="log-viewer-btn">Êü•ÁúãÊó•Âøó</button>
                        <button class="btn btn-secondary" onclick="showSnapshotViewer()" style="display: none;" id="snapshot-viewer-btn">Êï∞ÊçÆÂø´ÁÖß</button>
                        <button class="btn btn-secondary" onclick="logout()">ÈÄÄÂá∫</button>
                    </div>
                </div>
                
                <!-- Ê±âÂ†°ËèúÂçïÊåâÈíÆ -->
                <div class="hamburger-menu" id="hamburger-menu" onclick="toggleMobileMenu()">
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                </div>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- ÁßªÂä®Á´ØÊêúÁ¥¢ÂäüËÉΩ -->
            <div class="mobile-search-bar" style="display: none;">
                <div class="nav-search" style="min-width: auto; width: 100%; margin-bottom: 1.5rem;">
                    <input type="text" id="mobile-search-input" placeholder="ÊêúÁ¥¢‰ΩúÂìÅÂêçÁß∞„ÄÅÊèèËø∞„ÄÅÂàõ‰ΩúËÄÖ...">
                    <div class="nav-search-controls">
                        <!-- ÂàÜÁ±ª‰∏ãÊãâËèúÂçï -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="mobile-category-trigger" onclick="toggleDropdown('mobile-category')" title="ÂàÜÁ±ªÁ≠õÈÄâ">
                                üè∑Ô∏è
                            </button>
                            <div class="dropdown-menu" id="mobile-category-dropdown">
                                <div class="dropdown-item selected" data-value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</div>
                                <div class="dropdown-item" data-value="Â∑•ÂÖ∑">üîß Â∑•ÂÖ∑</div>
                                <div class="dropdown-item" data-value="Â≠¶‰π†">üìö Â≠¶‰π†</div>
                                <div class="dropdown-item" data-value="Ê∏∏Êàè">üéÆ Ê∏∏Êàè</div>
                                <div class="dropdown-item" data-value="Ëâ∫ÊúØ">üé® Ëâ∫ÊúØ</div>
                                <div class="dropdown-item" data-value="ÁßëÊäÄ">üíª ÁßëÊäÄ</div>
                            </div>
                        </div>
                        
                        <!-- ÊéíÂ∫è‰∏ãÊãâËèúÂçï -->
                        <div class="custom-dropdown">
                            <button class="dropdown-trigger" id="mobile-sort-trigger" onclick="toggleDropdown('mobile-sort')" title="ÊéíÂ∫èÊñπÂºè">
                                üîÑ
                            </button>
                            <div class="dropdown-menu" id="mobile-sort-dropdown">
                                <div class="dropdown-item selected" data-value="newest">ÊúÄÊñ∞ÂèëÂ∏É</div>
                                <div class="dropdown-item" data-value="oldest">ÊúÄÊó©ÂèëÂ∏É</div>
                                <div class="dropdown-item" data-value="name">ÊåâÂêçÁß∞</div>
                                <div class="dropdown-item" data-value="author">Êåâ‰ΩúËÄÖ</div>
                            </div>
                        </div>
                        
                        <button class="search-btn" onclick="searchApps()">üîç</button>
                    </div>
                </div>
            </div>
            
            <div id="apps-container">
                <div class="apps-grid" id="apps-grid">
                    <!-- Â∫îÁî®Âç°ÁâáÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
                </div>
                
                <div class="empty-state" id="empty-state" style="display: none;">
                    <h3>ÊöÇÊó†‰ΩúÂìÅ</h3>
                    <p>Êù•Â±ïÁ§∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰ΩúÂìÅÂêßÔºÅ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂèëÂ∏É/ÁºñËæëÂ∫îÁî®ÊåâÈíÆ -->
    <button class="publish-btn" id="publish-btn" onclick="showPublishModal()" style="display: none;" title="ÂèëÂ∏ÉÂ∫îÁî®">+</button>

    <!-- ÁßªÂä®Á´ØËèúÂçï -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-nav-menu" id="mobile-nav-menu">
        <div class="mobile-nav-header">
            <div class="mobile-nav-title">ËèúÂçï</div>
            <button class="mobile-nav-close" onclick="closeMobileMenu()">&times;</button>
        </div>
        
        <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅËèúÂçï -->
        <div id="mobile-guest-nav" style="display: none;">
            <div class="mobile-nav-items">
                <button class="mobile-nav-item" onclick="showLogin(); closeMobileMenu();">
                    üë§ ÁôªÂΩï
                </button>
                <button class="mobile-nav-item" onclick="showRegister(); closeMobileMenu();">
                    ‚ûï Ê≥®ÂÜå
                </button>
            </div>
        </div>
        
        <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅËèúÂçï -->
        <div id="mobile-user-nav" style="display: none;">
            <div class="mobile-user-info">
                <div class="user-avatar" id="mobile-user-avatar"></div>
                <span id="mobile-user-name"></span>
            </div>
            <div class="mobile-nav-items">
                <button class="mobile-nav-item" onclick="goHome(); closeMobileMenu();">
                    È¶ñÈ°µ
                </button>
                <button class="mobile-nav-item" onclick="showPublishModal(); closeMobileMenu();" style="background: linear-gradient(45deg, #ff9500, #ff6600); color: white; border-color: #ff9500;">
                    ÂèëÂ∏É‰ΩúÂìÅ
                </button>
                <button class="mobile-nav-item" onclick="showMyApps(); closeMobileMenu();">
                    ÊàëÁöÑÂ∫îÁî®
                </button>
                <button class="mobile-nav-item" onclick="showMyFavorites(); closeMobileMenu();">
                    ÊàëÁöÑÊî∂Ëóè
                </button>
                <button class="mobile-nav-item" onclick="showLogViewer(); closeMobileMenu();" style="display: none;" id="mobile-log-viewer-btn">
                    Êü•ÁúãÊó•Âøó
                </button>
                <button class="mobile-nav-item" onclick="showSnapshotViewer(); closeMobileMenu();" style="display: none;" id="mobile-snapshot-viewer-btn">
                    Êï∞ÊçÆÂø´ÁÖß
                </button>
                <button class="mobile-nav-item" onclick="logout(); closeMobileMenu();">
                    ÈÄÄÂá∫ÁôªÂΩï
                </button>
            </div>
        </div>
    </div>

    <!-- ÂèëÂ∏É/ÁºñËæëÂ∫îÁî®Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="publish-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="publish-modal-title">ÂèëÂ∏É‰ΩúÂìÅ</h2>
                <button class="close-btn" onclick="closeModal('publish-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="app-name">‰ΩúÂìÅÂêçÁß∞ *</label>
                    <input type="text" id="app-name" placeholder="Áªô‰Ω†ÁöÑ‰ΩúÂìÅËµ∑‰∏™ÂêçÂ≠ó" onchange="updatePublishButtonState()" oninput="updatePublishButtonState()">
                </div>
                <div class="form-group">
                    <label for="app-url">‰ΩúÂìÅÈìæÊé• *</label>
                    <input type="url" id="app-url" placeholder="https://example.com" onchange="updatePublishButtonState()" oninput="updatePublishButtonState()">
                </div>
                <div class="form-group">
                    <label for="app-description">‰ΩúÂìÅÊèèËø∞ *</label>
                    <textarea id="app-description" placeholder="‰ªãÁªç‰∏Ä‰∏ã‰Ω†ÁöÑ‰ΩúÂìÅÔºåÊØîÂ¶ÇÂàõ‰ΩúÁÅµÊÑü„ÄÅ‰∏ªË¶ÅÂäüËÉΩÁ≠â..." onchange="updatePublishButtonState()" oninput="updatePublishButtonState()"></textarea>
                </div>
                <div class="form-group">
                    <label for="app-category">ÂàÜÁ±ª</label>
                    <select id="app-category">
                        <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        <option value="Â∑•ÂÖ∑">Â∑•ÂÖ∑</option>
                        <option value="Â≠¶‰π†">Â≠¶‰π†</option>
                        <option value="Ê∏∏Êàè">Ê∏∏Êàè</option>
                        <option value="Ëâ∫ÊúØ">Ëâ∫ÊúØ</option>
                        <option value="ÁßëÊäÄ">ÁßëÊäÄ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Â∫îÁî®Êà™Âõæ</label>
                    <div class="screenshot-preview" id="screenshot-preview">
                        <div class="placeholder">
                            <div style="font-size: 2rem;">üì∏</div>
                            <div>ÈÄâÊã©Êà™ÂõæÊñπÂºè</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <div style="margin-bottom: 0.5rem;">
                            <label style="font-weight: normal; font-size: 0.9rem;">Êà™ÂõæÊñπÂºèÔºö</label>
                        </div>
                        <div class="capture-method-row">
                            <label>
                                <input type="radio" name="screenshot-method" value="api" checked onchange="toggleScreenshotMethod()">
                                <span>Ëá™Âä®ÁîüÊàêÊà™Âõæ</span>
                            </label>
                            <label>
                                <input type="radio" name="screenshot-method" value="upload" onchange="toggleScreenshotMethod()">
                                <span>‰∏ä‰º†Êú¨Âú∞ÂõæÁâá</span>
                            </label>
                        </div>
                        <div id="screenshot-api-section" style="display: block;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="generateScreenshot()">
                                    ÁîüÊàêÁΩëÈ°µÊà™Âõæ
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearScreenshot()" style="background: #dc3545; color: white;">
                                    Ê∏ÖÈô§Êà™Âõæ
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                Ê†πÊçÆÂ∫îÁî®ÈìæÊé•Ëá™Âä®ÁîüÊàêÁΩëÈ°µÊà™Âõæ
                            </div>
                        </div>
                        <div id="screenshot-upload-section" style="display: none;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('screenshot-upload').click()">
                                    ‰∏ä‰º†ÂõæÁâáÊñá‰ª∂
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearScreenshot()" style="background: #dc3545; color: white;">
                                    Ê∏ÖÈô§Êà™Âõæ
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF Ê†ºÂºèÔºåÊúÄÂ§ß 5MB
                            </div>
                        </div>
                    </div>
                    <input type="file" id="screenshot-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('publish-modal')">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" id="save-app-btn" onclick="handleSaveApp()">ÂèëÂ∏É</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Áî®Êà∑ÁôªÂΩï</h2>
                <button class="close-btn" onclick="closeModal('login-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="login-username">Áî®Êà∑Âêç</label>
                    <input type="text" id="login-username" placeholder="ËæìÂÖ•Áî®Êà∑Âêç">
                </div>
                <div class="form-group">
                    <label for="login-password">ÂØÜÁ†Å</label>
                    <input type="password" id="login-password" placeholder="ËæìÂÖ•ÂØÜÁ†Å">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('login-modal')">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="handleLogin()">ÁôªÂΩï</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê≥®ÂÜåÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Áî®Êà∑Ê≥®ÂÜå</h2>
                <button class="close-btn" onclick="closeModal('register-modal')">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label for="register-username">Áî®Êà∑Âêç</label>
                    <input type="text" id="register-username" placeholder="ËæìÂÖ•Áî®Êà∑Âêç">
                </div>
                <div class="form-group">
                    <label for="register-email">ÈÇÆÁÆ±</label>
                    <input type="email" id="register-email" placeholder="ËæìÂÖ•ÈÇÆÁÆ±">
                </div>
                <div class="form-group">
                    <label for="register-password">ÂØÜÁ†Å</label>
                    <input type="password" id="register-password" placeholder="Ëá≥Â∞ë6‰∏™Â≠óÁ¨¶">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('register-modal')">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="handleRegister()">Ê≥®ÂÜå</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Êó•ÂøóÊü•ÁúãÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="log-viewer-modal">
        <div class="modal-content" style="max-width: 800px; height: 80vh;">
            <div class="modal-header">
                <h2 class="modal-title">Á≥ªÁªüÊó•Âøó</h2>
                <button class="close-btn" onclick="closeModal('log-viewer-modal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(80vh - 120px);">
                <!-- ÈÄâÈ°πÂç° -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
                    <div style="display: flex;">
                        <button id="local-logs-tab" class="log-tab active" onclick="switchLogTab('local')" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500;">
                            Êú¨Âú∞Êó•Âøó
                        </button>
                        <button id="cloud-logs-tab" class="log-tab" onclick="switchLogTab('cloud')" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500;">
                            ‰∫ëÁ´ØÊó•Âøó
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; padding: 0.5rem;">
                        ‰∫ëÁ´ØÊó•ÂøóËá™Âä®‰øùÁïô48Â∞èÊó∂
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
                    <select id="log-level-filter" onchange="refreshLogs()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">ÂÖ®ÈÉ®Á∫ßÂà´</option>
                        <option value="INFO">‰ø°ÊÅØ</option>
                        <option value="WARN">Ë≠¶Âëä</option>
                        <option value="ERROR">ÈîôËØØ</option>
                    </select>
                    <input type="text" id="log-username-filter" placeholder="ÊåâÁî®Êà∑ÂêçÁ≠õÈÄâ..." onchange="refreshLogs()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn btn-secondary" onclick="refreshLogs()">Âà∑Êñ∞</button>
                    <button class="btn btn-secondary" onclick="clearCurrentLogs()">Ê∏ÖÁ©∫Êó•Âøó</button>
                    <button class="btn btn-secondary" onclick="manualCleanup()" style="background: #28a745; color: white;">Ê∏ÖÁêÜËøáÊúü</button>
                    <button class="btn btn-secondary" onclick="exportLogs()">ÂØºÂá∫Êó•Âøó</button>
                    <button class="btn btn-secondary" onclick="retryFailedLogs()" style="background: #17a2b8; color: white;">ÈáçËØïÂ§±Ë¥•</button>
                </div>
                <div id="log-content" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.9rem; background: #f8f9fa;">
                    <!-- Êó•ÂøóÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Âø´ÁÖßÊü•ÁúãÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="snapshot-viewer-modal">
        <div class="modal-content" style="max-width: 900px; height: 85vh;">
            <div class="modal-header">
                <h2 class="modal-title">Êï∞ÊçÆÂø´ÁÖßÁÆ°ÁêÜ</h2>
                <button class="close-btn" onclick="closeModal('snapshot-viewer-modal')">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; height: calc(85vh - 120px);">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
                    <select id="snapshot-type-filter" onchange="refreshSnapshots()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">ÂÖ®ÈÉ®Á±ªÂûã</option>
                        <option value="app_edit_before">Â∫îÁî®ÁºñËæëÂâç</option>
                        <option value="app_delete_before">Â∫îÁî®Âà†Èô§Ââç</option>
                        <option value="apps_before_add">Êñ∞Â∫îÁî®ÂèëÂ∏ÉÂâç</option>
                        <option value="users_before_add">Áî®Êà∑Ê≥®ÂÜåÂâç</option>
                        <option value="full_before_sync">Êï∞ÊçÆÂêåÊ≠•Ââç</option>
                        <option value="local_before_merge">Êï∞ÊçÆÂêàÂπ∂Ââç(Êú¨Âú∞)</option>
                        <option value="remote_before_merge">Êï∞ÊçÆÂêàÂπ∂Ââç(ËøúÁ®ã)</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshSnapshots()">Âà∑Êñ∞Âø´ÁÖß</button>
                    <button class="btn btn-secondary" onclick="clearSnapshots()">Ê∏ÖÁ©∫Âø´ÁÖß</button>
                    <button class="btn btn-secondary" onclick="exportSnapshots()">ÂØºÂá∫Âø´ÁÖß</button>
                </div>
                <div id="snapshot-content" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; background: #f8f9fa;">
                    <!-- Âø´ÁÖßÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Âø´ÁÖßÊÅ¢Â§çÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="snapshot-restore-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Á°ÆËÆ§Êï∞ÊçÆÊÅ¢Â§ç</h2>
                <button class="close-btn" onclick="closeModal('snapshot-restore-modal')">&times;</button>
            </div>
            <div>
                <div id="restore-info" style="margin-bottom: 1.5rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                    <!-- ÊÅ¢Â§ç‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="restore-type" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ÊÅ¢Â§çËåÉÂõ¥Ôºö</label>
                    <select id="restore-type" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="full">ÂÆåÊï¥ÊÅ¢Â§çÔºàÂ∫îÁî®+Áî®Êà∑Ôºâ</option>
                        <option value="apps">‰ªÖÊÅ¢Â§çÂ∫îÁî®Êï∞ÊçÆ</option>
                        <option value="users">‰ªÖÊÅ¢Â§çÁî®Êà∑Êï∞ÊçÆ</option>
                    </select>
                </div>
                <div style="color: #dc3545; font-size: 0.9rem; margin-bottom: 1rem;">
                    ‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞ÜË¶ÜÁõñÂΩìÂâçÊï∞ÊçÆÔºåÊó†Ê≥ïÊí§ÈîÄÔºÅÂª∫ËÆÆÂÖàÂàõÂª∫ÂΩìÂâçÊï∞ÊçÆÁöÑÂø´ÁÖß„ÄÇ
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('snapshot-restore-modal')">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="confirmRestore()" style="background: #dc3545;">Á°ÆËÆ§ÊÅ¢Â§ç</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‰∫ëÂ≠òÂÇ®ÈÖçÁΩÆ - ‰ΩøÁî®JSONBinÂÖçË¥πÊúçÂä°
        const CLOUD_CONFIG = {
            // JSONBinÈÖçÁΩÆ
            binId: '', // Â∞ÜÂú® Netlify ÂáΩÊï∞‰∏≠ËÆæÁΩÆ
            apiKey: '', // Â∞ÜÂú® Netlify ÂáΩÊï∞‰∏≠ËÆæÁΩÆ
            baseUrl: 'https://api.jsonbin.io/v3/b'
        };

        // ÂÖ®Â±ÄÂèòÈáè
        let currentUser = null;
        let currentEditingAppId = null; // Áî®‰∫éË∑üË∏™Ê≠£Âú®ÁºñËæëÁöÑÂ∫îÁî®ID
        let isScreenshotReady = false; // Ë∑üË∏™Êà™Âõæ/ÂõæÁâáÊòØÂê¶ÂáÜÂ§áÂ∞±Áª™
        let cloudData = {
            users: [],
            apps: [],
            lastSync: null
        };

        // üî• Ê≠•È™§20: ÈáçËØïÈÖçÁΩÆ
        const RETRY_CONFIG = {
            maxRetries: 3,
            retryDelay: [1000, 2000, 5000], // ÈÄíÂ¢ûÂª∂Ëøü
            operations: ['like', 'favorite', 'comment', 'sync']
        };

        // ‰∫ëÂ≠òÂÇ®APIÁ±ª
        class CloudStorage {
            constructor() {
                this.baseUrl = '/.netlify/functions/jsonbin-proxy';
            }

            async saveData(data) {
                try {
                    const response = await fetch(this.baseUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('‰øùÂ≠òÂ§±Ë¥•');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('‰øùÂ≠òÂà∞‰∫ëÁ´ØÂ§±Ë¥•:', error);
                    throw error;
                }
            }

            async loadData() {
                try {
                    // Â¢ûÂä†ÁßªÂä®Á´ØÁöÑË∂ÖÊó∂Êó∂Èó¥
                    const isMobile = navigator.userAgent.includes('Mobile');
                    const timeoutMs = isMobile ? 15000 : 10000; // ÁßªÂä®Á´Ø15ÁßíÔºåÊ°åÈù¢Á´Ø10Áßí
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const response = await fetch(this.baseUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`Âä†ËΩΩÂ§±Ë¥•`);
                    }
                    
                    const result = await response.json();
                    return result.record || { users: [], apps: [], lastSync: null };
                } catch (error) {
                    console.error('‰ªé‰∫ëÁ´ØÂä†ËΩΩÂ§±Ë¥•:', error);
                    throw error;
                }
            }
        }

        const cloudStorage = new CloudStorage();

        // üî• Ê≠•È™§3&4: Êú¨Âú∞Â≠òÂÇ®ÁÆ°ÁêÜÂô®Á±ª
        class LocalStorageManager {
            constructor() {
                this.key = 'beestoreLocalBackup';
            }
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveToLocal(data) {
                try {
                    // üî• Ê≠•È™§16: ‰øùÂ≠òÂâçÁ°Æ‰øùÊï∞ÊçÆÂÆåÊï¥ÊÄß
                    const cleanData = ensureDataIntegrity(data);
                    const backup = {
                        data: cleanData,
                        timestamp: new Date().toISOString(),
                        version: '1.0'
                    };
                    localStorage.setItem(this.key, JSON.stringify(backup));
                    console.log('[BeeStore] Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®');
                    return true;
                } catch (error) {
                    console.error('[BeeStore] Êú¨Âú∞Â≠òÂÇ®Â§±Ë¥•:', error);
                    return false;
                }
            }
            
            // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩ
            loadFromLocal() {
                try {
                    const backup = localStorage.getItem(this.key);
                    if (backup) {
                        const parsed = JSON.parse(backup);
                        // üî• Ê≠•È™§17: Âä†ËΩΩÊó∂Á°Æ‰øùÊï∞ÊçÆÂÆåÊï¥ÊÄß
                        return ensureDataIntegrity(parsed.data);
                    }
                    return null;
                } catch (error) {
                    console.error('[BeeStore] Êú¨Âú∞Â≠òÂÇ®ËØªÂèñÂ§±Ë¥•:', error);
                    return null;
                }
            }
            
            // Ê∏ÖÁ©∫Êú¨Âú∞Â≠òÂÇ®
            clearLocal() {
                localStorage.removeItem(this.key);
            }
        }

        const localStorageManager = new LocalStorageManager();

        // üî• Ê≠•È™§3: Êï∞ÊçÆÁâàÊú¨ÊéßÂà∂ÂáΩÊï∞
        function updateAppLastModified(appId, operationType) {
            const app = cloudData.apps.find(app => app.id === appId);
            if (app) {
                app.lastModified = new Date().toISOString();
                console.log(`[BeeStore] Êõ¥Êñ∞Â∫îÁî® ${appId} ÊúÄÂêé‰øÆÊîπÊó∂Èó¥: ${operationType}`);
            }
        }
        
        // üî• Ê≠•È™§4: Áî®Êà∑Êï∞ÊçÆÁâàÊú¨ÊéßÂà∂ÂáΩÊï∞
        function updateUserLastModified(userId, operationType) {
            const user = cloudData.users.find(user => user.id === userId);
            if (user) {
                user.lastModified = new Date().toISOString();
                console.log(`[BeeStore] Êõ¥Êñ∞Áî®Êà∑ ${userId} ÊúÄÂêé‰øÆÊîπÊó∂Èó¥: ${operationType}`);
            }
        }
        
        // üî• Ê≠•È™§13: Êï∞ÊçÆÂÆåÊï¥ÊÄßÊ£ÄÊü•ÂáΩÊï∞
        function ensureDataIntegrity(data) {
            if (!data) return data;
            
            // Á°Æ‰øùÊâÄÊúâÂ∫îÁî®ÈÉΩÊúâlastModifiedÂ≠óÊÆµ
            if (data.apps) {
                data.apps.forEach(app => {
                    if (!app.lastModified) {
                        app.lastModified = app.createdAt || new Date().toISOString();
                        console.log(`[BeeStore] ‰∏∫Â∫îÁî® ${app.id} Ê∑ªÂä†lastModifiedÂ≠óÊÆµ`);
                    }
                });
            }
            
            // Á°Æ‰øùÊâÄÊúâÁî®Êà∑ÈÉΩÊúâlastModifiedÂ≠óÊÆµ
            if (data.users) {
                data.users.forEach(user => {
                    if (!user.lastModified) {
                        user.lastModified = user.createdAt || new Date().toISOString();
                        console.log(`[BeeStore] ‰∏∫Áî®Êà∑ ${user.id} Ê∑ªÂä†lastModifiedÂ≠óÊÆµ`);
                    }
                });
            }
            
            return data;
        }
        
        // üî• Ê≠•È™§5: Êï∞ÊçÆÂÜ≤Á™ÅÊ£ÄÊµãÂáΩÊï∞
        function detectDataConflicts(localData, remoteData) {
            const conflicts = [];
            
            // Ê£ÄÊü•Â∫îÁî®Êï∞ÊçÆÂÜ≤Á™Å
            if (localData.apps && remoteData.apps) {
                localData.apps.forEach(localApp => {
                    const remoteApp = remoteData.apps.find(app => app.id === localApp.id);
                    if (remoteApp) {
                        const localLastModified = new Date(localApp.lastModified || localApp.createdAt);
                        const remoteLastModified = new Date(remoteApp.lastModified || remoteApp.createdAt);
                        
                        // Â¶ÇÊûúÊó∂Èó¥Â∑ÆÂ∞è‰∫é5ÂàÜÈíüÔºåÂèØËÉΩÂ≠òÂú®ÂÜ≤Á™Å
                        if (Math.abs(localLastModified - remoteLastModified) < 5 * 60 * 1000) {
                            conflicts.push({
                                type: 'app',
                                appId: localApp.id,
                                appName: localApp.name,
                                localLastModified,
                                remoteLastModified
                            });
                        }
                    }
                });
            }
            
            return conflicts;
        }
        
        // üî• Ê≠•È™§21: ÈÄöÁî®ÈáçËØïÂáΩÊï∞
        async function retryOperation(operationType, operationFn, ...args) {
            let lastError;
            
            for (let attempt = 0; attempt <= RETRY_CONFIG.maxRetries; attempt++) {
                try {
                    return await operationFn(...args);
                } catch (error) {
                    lastError = error;
                    console.warn(`[BeeStore] ${operationType} Êìç‰ΩúÂ§±Ë¥• (Â∞ùËØï ${attempt + 1}/${RETRY_CONFIG.maxRetries + 1}):`, error);
                    
                    if (attempt < RETRY_CONFIG.maxRetries) {
                        const delay = RETRY_CONFIG.retryDelay[attempt] || RETRY_CONFIG.retryDelay[RETRY_CONFIG.retryDelay.length - 1];
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw lastError;
        }

        // Êó•ÂøóËÆ∞ÂΩïÁ≥ªÁªü
        class Logger {
            constructor() {
                this.logs = JSON.parse(localStorage.getItem('beestoreLogs') || '[]');
                this.maxLogs = 1000; // ÊúÄÂ§ö‰øùÂ≠ò1000Êù°Êó•Âøó
            }

            getFormattedLog(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const userInfo = currentUser ? {
                    id: currentUser.id,
                    username: currentUser.username
                } : { id: null, username: 'guest' };

                return {
                    timestamp,
                    level,
                    message,
                    user: userInfo,
                    data,
                    id: Date.now() + Math.random()
                };
            }

            info(message, data = null) {
                const log = this.getFormattedLog('INFO', message, data);
                this.logs.unshift(log);
                console.log(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // ÂºÇÊ≠•ÂèëÈÄÅÂà∞‰∫ëÁ´ØÔºà‰∏çÈòªÂ°û‰∏ªÊµÅÁ®ãÔºâ
                this.sendToCloud(log).catch(e => console.warn('ÂèëÈÄÅÊó•ÂøóÂà∞‰∫ëÁ´ØÂ§±Ë¥•:', e));
                
                return log;
            }

            warn(message, data = null) {
                const log = this.getFormattedLog('WARN', message, data);
                this.logs.unshift(log);
                console.warn(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // ÂºÇÊ≠•ÂèëÈÄÅÂà∞‰∫ëÁ´ØÔºà‰∏çÈòªÂ°û‰∏ªÊµÅÁ®ãÔºâ
                this.sendToCloud(log).catch(e => console.warn('ÂèëÈÄÅÊó•ÂøóÂà∞‰∫ëÁ´ØÂ§±Ë¥•:', e));
                
                return log;
            }

            error(message, data = null) {
                const log = this.getFormattedLog('ERROR', message, data);
                this.logs.unshift(log);
                console.error(`[BeeStore] ${message}`, data);
                this.saveLogs();
                
                // ÂºÇÊ≠•ÂèëÈÄÅÂà∞‰∫ëÁ´ØÔºà‰∏çÈòªÂ°û‰∏ªÊµÅÁ®ãÔºâ
                this.sendToCloud(log).catch(e => console.warn('ÂèëÈÄÅÊó•ÂøóÂà∞‰∫ëÁ´ØÂ§±Ë¥•:', e));
                
                return log;
            }

            saveLogs() {
                // ÈôêÂà∂Êó•ÂøóÊï∞Èáè
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(0, this.maxLogs);
                }
                localStorage.setItem('beestoreLogs', JSON.stringify(this.logs));
            }

            // ÂèëÈÄÅÂÖ≥ÈîÆÊó•ÂøóÂà∞‰∫ëÁ´ØÔºà‰æõadminÊü•ÁúãÔºâ
            async sendToCloud(log) {
                // Âè™ÂèëÈÄÅÂÖ≥ÈîÆÁöÑÈîôËØØÂíåÈáçË¶ÅÊìç‰ΩúÂà∞‰∫ëÁ´Ø
                const shouldSendToCloud = this.shouldSendToCloud(log);
                
                if (!shouldSendToCloud) return;

                try {
                                         // Ëé∑Âèñ‰∫ëÁ´ØÊó•ÂøóÂπ∂Ê∏ÖÁêÜËøáÊúüÊó•Âøó
                    let cloudLogs = [];
                    try {
                        const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (response.ok) {
                            const result = await response.json();
                            const allLogs = result.record?.centralLogs || [];
                            
                            // Ê∏ÖÁêÜË∂ÖËøá48Â∞èÊó∂ÁöÑÊó•Âøó
                            cloudLogs = this.cleanExpiredLogs(allLogs);
                        }
                    } catch (e) {
                        console.warn('Ëé∑Âèñ‰∫ëÁ´ØÊó•ÂøóÂ§±Ë¥•ÔºåÂ∞ÜÂàõÂª∫Êñ∞ÁöÑÊó•ÂøóËÆ∞ÂΩï');
                    }

                    // Ê∑ªÂä†Êñ∞Êó•ÂøóÂà∞‰∫ëÁ´Ø
                    cloudLogs.unshift({
                        ...log,
                        cloudId: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString(),
                            url: window.location.href
                        }
                    });

                    // ÈôêÂà∂‰∫ëÁ´ØÊó•ÂøóÊï∞ÈáèÔºàÊúÄÂ§ö500Êù°Ôºâ
                    if (cloudLogs.length > 500) {
                        const removedCount = cloudLogs.length - 500;
                        cloudLogs = cloudLogs.slice(0, 500);
                        console.log(`[BeeStore] ‰∫ëÁ´ØÊó•ÂøóÊï∞ÈáèË∂ÖÈôêÔºåÁßªÈô§ÊúÄÊóßÁöÑ ${removedCount} Êù°Êó•Âøó`);
                    }

                    // ÊûÑÂª∫ÂÆåÊï¥ÁöÑ‰∫ëÁ´ØÊï∞ÊçÆ
                    let fullCloudData = {
                        users: [],
                        apps: [],
                        lastSync: null,
                        centralLogs: cloudLogs
                    };

                    // Â∞ùËØï‰øùÊåÅÁé∞ÊúâÁöÑÊï∞ÊçÆÁªìÊûÑ
                    try {
                        const existingResponse = await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (existingResponse.ok) {
                            const existingData = await existingResponse.json();
                            if (existingData.record) {
                                fullCloudData = {
                                    ...existingData.record,
                                    centralLogs: cloudLogs
                                };
                            }
                        }
                    } catch (e) {
                        console.warn('Ëé∑ÂèñÁé∞Êúâ‰∫ëÁ´ØÊï∞ÊçÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÁªìÊûÑ');
                    }

                    // ÂèëÈÄÅÂà∞‰∫ëÁ´Ø
                    await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullCloudData)
                    });

                } catch (error) {
                    console.error('ÂèëÈÄÅÊó•ÂøóÂà∞‰∫ëÁ´ØÂ§±Ë¥•:', error);
                    // Â§±Ë¥•Êó∂‰øùÂ≠òÂà∞Êú¨Âú∞ÂæÖÂèëÈÄÅÈòüÂàó
                    this.saveToRetryQueue(log);
                }
            }

            shouldSendToCloud(log) {
                // ÂÆö‰πâÈúÄË¶ÅÂèëÈÄÅÂà∞‰∫ëÁ´ØÁöÑÊó•ÂøóÁ±ªÂûãÔºàÂè™ËÆ∞ÂΩïÊ†∏ÂøÉÊìç‰ΩúÔºâ
                const criticalMessages = [
                    // Â∫îÁî®Áõ∏ÂÖ≥Êìç‰Ωú
                    'Â∫îÁî®ÂèëÂ∏É',
                    'Â∫îÁî®ÁºñËæë',
                    'Â∫îÁî®Âà†Èô§',
                    
                    // ÂõæÁâá/Êà™ÂõæÁõ∏ÂÖ≥
                    '‰∏ä‰º†ÂõæÁâáÂ§±Ë¥•',
                    'Êà™Âõæ‰∏ä‰º†Â§±Ë¥•', 
                    'Êà™ÂõæÁîüÊàêÂ§±Ë¥•',
                    'ÂõæÁâá‰∏ä‰º†ÊàêÂäü',
                    'Êà™ÂõæÁîüÊàêÂπ∂‰∏ä‰º†ÊàêÂäü',
                    
                    // Áî®Êà∑‰∫íÂä®
                    'ÁÇπËµûÊìç‰Ωú',
                    'Êî∂ËóèÊìç‰Ωú', 
                    'Ê∑ªÂä†ËØÑËÆ∫',
                    'Âà†Èô§ËØÑËÆ∫',
                    
                    // Á≥ªÁªüÂÖ≥ÈîÆÈîôËØØ
                    'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•',
                    'Êï∞ÊçÆÊÅ¢Â§ç'
                ];

                // Âè™ÂèëÈÄÅERRORÁ∫ßÂà´‰∏≠‰∏é‰∏äËø∞Êìç‰ΩúÁõ∏ÂÖ≥ÁöÑÊó•Âøó
                if (log.level === 'ERROR') {
                    return criticalMessages.some(msg => log.message.includes(msg));
                }

                // ÈáçË¶ÅÊìç‰ΩúÁöÑ‰ø°ÊÅØÁ∫ßÊó•Âøó
                if (log.level === 'INFO' && criticalMessages.some(msg => log.message.includes(msg))) {
                    return true;
                }

                // ‰∏éÊ†∏ÂøÉÊìç‰ΩúÁõ∏ÂÖ≥ÁöÑË≠¶ÂëäÊó•Âøó
                if (log.level === 'WARN' && criticalMessages.some(msg => log.message.includes(msg))) {
                    return true;
                }

                return false;
            }

            saveToRetryQueue(log) {
                try {
                    const retryQueue = JSON.parse(localStorage.getItem('beestoreLogRetryQueue') || '[]');
                    retryQueue.push({
                        ...log,
                        retryAttempts: 0,
                        queuedAt: new Date().toISOString()
                    });
                    
                    // ÈôêÂà∂ÈáçËØïÈòüÂàóÂ§ßÂ∞è
                    if (retryQueue.length > 100) {
                        retryQueue.splice(100);
                    }
                    
                    localStorage.setItem('beestoreLogRetryQueue', JSON.stringify(retryQueue));
                } catch (e) {
                    console.error('‰øùÂ≠òÈáçËØïÈòüÂàóÂ§±Ë¥•:', e);
                }
            }

            async retryFailedLogs() {
                try {
                    const retryQueue = JSON.parse(localStorage.getItem('beestoreLogRetryQueue') || '[]');
                    if (retryQueue.length === 0) return;

                    const successfullyRetried = [];
                    
                    for (const queuedLog of retryQueue) {
                        if (queuedLog.retryAttempts < 3) {
                            try {
                                await this.sendToCloud(queuedLog);
                                successfullyRetried.push(queuedLog);
                            } catch (e) {
                                queuedLog.retryAttempts++;
                            }
                        } else {
                            // Ë∂ÖËøáÈáçËØïÊ¨°Êï∞ÔºåÁßªÈô§
                            successfullyRetried.push(queuedLog);
                        }
                    }

                    // Êõ¥Êñ∞ÈáçËØïÈòüÂàó
                    const remainingQueue = retryQueue.filter(log => !successfullyRetried.includes(log));
                    localStorage.setItem('beestoreLogRetryQueue', JSON.stringify(remainingQueue));

                } catch (e) {
                    console.error('ÈáçËØïÂ§±Ë¥•ÁöÑÊó•ÂøóÊó∂Âá∫Èîô:', e);
                }
            }

            // Ê∏ÖÁêÜË∂ÖËøá48Â∞èÊó∂ÁöÑÊó•Âøó
            cleanExpiredLogs(logs) {
                if (!Array.isArray(logs)) return [];
                
                const fortyEightHoursAgo = new Date();
                fortyEightHoursAgo.setHours(fortyEightHoursAgo.getHours() - 48);
                
                const validLogs = logs.filter(log => {
                    try {
                        const logTime = new Date(log.timestamp);
                        return logTime > fortyEightHoursAgo;
                    } catch (e) {
                        // Â¶ÇÊûúÊó∂Èó¥Êà≥Ëß£ÊûêÂ§±Ë¥•Ôºå‰øùÁïôÊó•ÂøóÔºàÂÆâÂÖ®Ëµ∑ËßÅÔºâ
                        return true;
                    }
                });
                
                const removedCount = logs.length - validLogs.length;
                if (removedCount > 0) {
                    console.log(`[BeeStore] Ê∏ÖÁêÜ‰∫Ü ${removedCount} Êù°Ë∂ÖËøá48Â∞èÊó∂ÁöÑ‰∫ëÁ´ØÊó•ÂøóÔºåÂâ©‰Ωô ${validLogs.length} Êù°`);
                    
                    // ËÆ∞ÂΩïÊ∏ÖÁêÜÊìç‰ΩúÂà∞Êú¨Âú∞Êó•ÂøóÔºà‰∏çÂèëÈÄÅÂà∞‰∫ëÁ´ØÈÅøÂÖçÂæ™ÁéØÔºâ
                    const cleanupLog = this.getFormattedLog('INFO', `Ëá™Âä®Ê∏ÖÁêÜËøáÊúüÊó•Âøó`, {
                        removedCount: removedCount,
                        remainingCount: validLogs.length,
                        operation: 'Á≥ªÁªüÁª¥Êä§'
                    });
                    this.logs.unshift(cleanupLog);
                    this.saveLogs();
                }
                
                return validLogs;
            }

            // ÂÆöÊúüÊ∏ÖÁêÜ‰∫ëÁ´ØÊó•ÂøóÔºàÂÆöÊó∂‰ªªÂä°Ôºâ
            async cleanupCloudLogs() {
                try {
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) return;
                    
                    const result = await response.json();
                    const allLogs = result.record?.centralLogs || [];
                    const cleanedLogs = this.cleanExpiredLogs(allLogs);
                    
                    // Â¶ÇÊûúÊ∏ÖÁêÜ‰∫ÜÊó•ÂøóÔºåÊõ¥Êñ∞‰∫ëÁ´ØÊï∞ÊçÆ
                    if (cleanedLogs.length < allLogs.length) {
                        const fullCloudData = {
                            ...result.record,
                            centralLogs: cleanedLogs
                        };
                        
                        await fetch('/.netlify/functions/jsonbin-proxy', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(fullCloudData)
                        });
                        
                        const removedCount = allLogs.length - cleanedLogs.length;
                        console.log(`[BeeStore] ÂÆöÊúüÊ∏ÖÁêÜÂÆåÊàêÔºåÁßªÈô§ ${removedCount} Êù°ËøáÊúüÊó•ÂøóÔºåÂâ©‰Ωô ${cleanedLogs.length} Êù°`);
                        
                        // ËÆ∞ÂΩïÂÆöÊúüÊ∏ÖÁêÜÊìç‰ΩúÂà∞Êú¨Âú∞Êó•Âøó
                        const cleanupLog = this.getFormattedLog('INFO', `ÂÆöÊúüÊ∏ÖÁêÜ‰∫ëÁ´ØÊó•Âøó`, {
                            removedCount: removedCount,
                            remainingCount: cleanedLogs.length,
                            operation: 'Á≥ªÁªüÁª¥Êä§'
                        });
                        this.logs.unshift(cleanupLog);
                        this.saveLogs();
                    }
                } catch (error) {
                    console.warn('ÂÆöÊúüÊ∏ÖÁêÜ‰∫ëÁ´ØÊó•ÂøóÂ§±Ë¥•:', error);
                }
            }

            getLogs(limit = 100, level = null, username = null) {
                let filteredLogs = this.logs;

                if (level) {
                    filteredLogs = filteredLogs.filter(log => log.level === level);
                }

                if (username) {
                    filteredLogs = filteredLogs.filter(log => log.user.username === username);
                }

                return filteredLogs.slice(0, limit);
            }

            clearLogs() {
                this.logs = [];
                localStorage.removeItem('beestoreLogs');
                console.log('[BeeStore] Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫');
            }

            // Ëé∑Âèñ‰∫ëÁ´ØÊó•ÂøóÔºà‰ªÖadminÂèØÁî®Ôºâ
            async getCloudLogs(limit = 100, level = null, username = null) {
                try {
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ëé∑Âèñ‰∫ëÁ´ØÊó•ÂøóÂ§±Ë¥•');
                    }
                    
                    const result = await response.json();
                    const allLogs = result.record?.centralLogs || [];
                    
                    // Ê∏ÖÁêÜËøáÊúüÊó•Âøó
                    let cloudLogs = this.cleanExpiredLogs(allLogs);
                    
                    // Â∫îÁî®Á≠õÈÄâ
                    if (level) {
                        cloudLogs = cloudLogs.filter(log => log.level === level);
                    }
                    
                    if (username) {
                        cloudLogs = cloudLogs.filter(log => 
                            log.user && log.user.username && log.user.username.toLowerCase().includes(username.toLowerCase())
                        );
                    }
                    
                    return cloudLogs.slice(0, limit);
                } catch (error) {
                    console.error('Ëé∑Âèñ‰∫ëÁ´ØÊó•ÂøóÂ§±Ë¥•:', error);
                    throw error;
                }
            }

            // Ê∏ÖÁ©∫‰∫ëÁ´ØÊó•ÂøóÔºà‰ªÖadminÂèØÁî®Ôºâ
            async clearCloudLogs() {
                try {
                    // Ëé∑ÂèñÁé∞ÊúâÊï∞ÊçÆÁªìÊûÑ
                    const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    let fullCloudData = {
                        users: [],
                        apps: [],
                        lastSync: null,
                        centralLogs: []
                    };
                    
                    if (response.ok) {
                        const existingData = await response.json();
                        if (existingData.record) {
                            fullCloudData = {
                                ...existingData.record,
                                centralLogs: []
                            };
                        }
                    }
                    
                    // ‰øùÂ≠òÊ∏ÖÁ©∫ÂêéÁöÑÊï∞ÊçÆ
                    await fetch('/.netlify/functions/jsonbin-proxy', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullCloudData)
                    });
                    
                    console.log('[BeeStore] ‰∫ëÁ´ØÊó•ÂøóÂ∑≤Ê∏ÖÁ©∫');
                } catch (error) {
                    console.error('Ê∏ÖÁ©∫‰∫ëÁ´ØÊó•ÂøóÂ§±Ë¥•:', error);
                    throw error;
                }
            }

            // Êï∞ÊçÆÂø´ÁÖßÂäüËÉΩ
            snapshot(description, data, metadata = {}) {
                try {
                    // üî• Ê≠•È™§5-7: ÂàõÂª∫Ê∑±Êã∑Ë¥ùÂπ∂Á°Æ‰øùÂåÖÂê´ÂÆåÊï¥‰ø°ÊÅØ
                    const snapshotData = JSON.parse(JSON.stringify(data));
                    
                    // ‰∏∫Âø´ÁÖßÊï∞ÊçÆÊ∑ªÂä†ÂÆåÊï¥ÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                    const enrichedData = {
                        ...snapshotData,
                        snapshotContext: {
                            currentUser: currentUser ? {
                                id: currentUser.id,
                                username: currentUser.username
                            } : null,
                            timestamp: new Date().toISOString(),
                            totalApps: cloudData.apps ? cloudData.apps.length : 0,
                            totalUsers: cloudData.users ? cloudData.users.length : 0
                        }
                    };
                    
                    const compressedData = this.compressData(enrichedData);
                    
                    const snapshot = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString(),
                        description,
                        data: compressedData,
                        metadata: {
                            ...metadata,
                            dataSize: JSON.stringify(enrichedData).length,
                            compressedSize: JSON.stringify(compressedData).length,
                            user: currentUser ? {
                                id: currentUser.id,
                                username: currentUser.username
                            } : { id: null, username: 'guest' },
                            // Ê∑ªÂä†Êõ¥Â§ö‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                            environment: {
                                userAgent: navigator.userAgent,
                                url: window.location.href,
                                timestamp: new Date().toISOString()
                            }
                        },
                        type: 'SNAPSHOT'
                    };

                    // Ëé∑ÂèñÁé∞ÊúâÂø´ÁÖß
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    snapshots.unshift(snapshot);

                    // ÈôêÂà∂Âø´ÁÖßÊï∞Èáè (ÊúÄÂ§ö‰øùÂ≠ò50‰∏™Âø´ÁÖß)
                    if (snapshots.length > 50) {
                        snapshots.splice(50);
                    }

                    localStorage.setItem('beestoreSnapshots', JSON.stringify(snapshots));
                    
                    this.info(`Êï∞ÊçÆÂø´ÁÖßÂ∑≤ÂàõÂª∫: ${description}`, {
                        snapshotId: snapshot.id,
                        dataSize: snapshot.metadata.dataSize,
                        compressedSize: snapshot.metadata.compressedSize,
                        operation: 'Êï∞ÊçÆÂø´ÁÖß'
                    });

                    return snapshot;
                } catch (error) {
                    this.error('ÂàõÂª∫Êï∞ÊçÆÂø´ÁÖßÂ§±Ë¥•', { error: error.message, description });
                    throw error;
                }
            }

            compressData(data) {
                // ÁÆÄÂçïÁöÑÊï∞ÊçÆÂéãÁº©ÔºöÁßªÈô§‰∏çÂøÖË¶ÅÁöÑÂ≠óÊÆµÔºå‰øùÁïôÊ†∏ÂøÉÊï∞ÊçÆ
                if (Array.isArray(data)) {
                    return data.map(item => this.compressData(item));
                }
                
                if (typeof data === 'object' && data !== null) {
                    const compressed = {};
                    for (const [key, value] of Object.entries(data)) {
                        // Ë∑≥Ëøá‰∏Ä‰∫õ‰∏¥Êó∂Êàñ‰∏çÈáçË¶ÅÁöÑÂ≠óÊÆµ
                        if (!['lastSync', 'id'].includes(key) || key === 'id') {
                            compressed[key] = this.compressData(value);
                        }
                    }
                    return compressed;
                }
                
                return data;
            }

            decompressData(compressedData) {
                // Ëß£ÂéãÁº©Êï∞ÊçÆÔºàÂΩìÂâçÂÆûÁé∞‰∏≠ÂéãÁº©Á®ãÂ∫¶ÊúâÈôêÔºå‰∏ªË¶ÅÊòØÊï∞ÊçÆÁªìÊûÑ‰øùÊåÅÔºâ
                return JSON.parse(JSON.stringify(compressedData));
            }

            getSnapshots(limit = 50, type = null) {
                try {
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    
                    let filteredSnapshots = snapshots;
                    if (type) {
                        filteredSnapshots = snapshots.filter(snapshot => 
                            snapshot.metadata.snapshotType === type
                        );
                    }

                    return filteredSnapshots.slice(0, limit);
                } catch (error) {
                    this.error('Ëé∑ÂèñÂø´ÁÖßÂàóË°®Â§±Ë¥•', { error: error.message });
                    return [];
                }
            }

            restoreFromSnapshot(snapshotId, targetType = 'full') {
                try {
                    const snapshots = JSON.parse(localStorage.getItem('beestoreSnapshots') || '[]');
                    const snapshot = snapshots.find(s => s.id === snapshotId);
                    
                    if (!snapshot) {
                        throw new Error('Âø´ÁÖß‰∏çÂ≠òÂú®');
                    }

                    // Ëß£ÂéãÁº©Êï∞ÊçÆ
                    const restoredData = this.decompressData(snapshot.data);
                    
                    this.info(`ÂºÄÂßã‰ªéÂø´ÁÖßÊÅ¢Â§çÊï∞ÊçÆ: ${snapshot.description}`, {
                        snapshotId: snapshotId,
                        targetType: targetType,
                        operation: 'Êï∞ÊçÆÊÅ¢Â§ç'
                    });

                    // Ê†πÊçÆÁõÆÊ†áÁ±ªÂûãÊÅ¢Â§çÊï∞ÊçÆ
                    switch (targetType) {
                        case 'apps':
                            if (restoredData.apps) {
                                cloudData.apps = restoredData.apps;
                            } else if (Array.isArray(restoredData)) {
                                cloudData.apps = restoredData;
                            }
                            break;
                        case 'users':
                            if (restoredData.users) {
                                cloudData.users = restoredData.users;
                            } else if (Array.isArray(restoredData)) {
                                cloudData.users = restoredData;
                            }
                            break;
                        case 'full':
                        default:
                            if (restoredData.apps) cloudData.apps = restoredData.apps;
                            if (restoredData.users) cloudData.users = restoredData.users;
                            if (restoredData.lastSync) cloudData.lastSync = restoredData.lastSync;
                            break;
                    }

                    this.info(`Êï∞ÊçÆÊÅ¢Â§çÂÆåÊàê: ${snapshot.description}`, {
                        snapshotId: snapshotId,
                        targetType: targetType,
                        restoredApps: cloudData.apps?.length || 0,
                        restoredUsers: cloudData.users?.length || 0,
                        operation: 'Êï∞ÊçÆÊÅ¢Â§çÂÆåÊàê'
                    });

                    return restoredData;
                } catch (error) {
                    this.error('Êï∞ÊçÆÊÅ¢Â§çÂ§±Ë¥•', { 
                        snapshotId, 
                        targetType, 
                        error: error.message 
                    });
                    throw error;
                }
            }

            clearSnapshots() {
                localStorage.removeItem('beestoreSnapshots');
                this.info('ÊâÄÊúâÊï∞ÊçÆÂø´ÁÖßÂ∑≤Ê∏ÖÁ©∫', { operation: 'Ê∏ÖÁ©∫Âø´ÁÖß' });
            }
        }

        const logger = new Logger();

        // Êú¨Âú∞ÁºìÂ≠òÁÆ°ÁêÜÁ±ª
        class LocalCache {
            constructor() {
                this.cacheKey = 'beestoreCloudData';
                this.metaKey = 'beestoreCloudMeta';
            }

            saveToLocal(data) {
                try {
                    const cacheData = {
                        data: data,
                        lastModified: new Date().toISOString(),
                        version: Date.now()
                    };
                    
                    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    
                    const meta = {
                        syncStatus: 'pending',
                        lastSyncAttempt: null,
                        pendingOperations: this.getPendingOperations().length
                    };
                    localStorage.setItem(this.metaKey, JSON.stringify(meta));
                    
                    return true;
                } catch (error) {
                    logger.error('‰øùÂ≠òÊú¨Âú∞ÁºìÂ≠òÂ§±Ë¥•', { error: error.message });
                    return false;
                }
            }

            loadFromLocal() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (!cached) return null;
                    
                    const cacheData = JSON.parse(cached);
                    return cacheData.data;
                } catch (error) {
                    logger.error('Âä†ËΩΩÊú¨Âú∞ÁºìÂ≠òÂ§±Ë¥•', { error: error.message });
                    return null;
                }
            }

            getLocalMeta() {
                try {
                    const meta = localStorage.getItem(this.metaKey);
                    return meta ? JSON.parse(meta) : null;
                } catch (error) {
                    return null;
                }
            }

            isCacheFresh() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (!cached) return false;
                    
                    const cacheData = JSON.parse(cached);
                    const cacheTime = new Date(cacheData.lastModified);
                    const now = new Date();
                    
                    // ÁßªÂä®Á´ØÁºìÂ≠òÊó∂Èó¥Á®çÈïø‰∏Ä‰∫õÔºà10ÂàÜÈíüÔºâÔºåÂõ†‰∏∫ÁßªÂä®Á´ØÁΩëÁªú‰∏çÁ®≥ÂÆö
                    const isMobile = navigator.userAgent.includes('Mobile');
                    const cacheValidTime = isMobile ? 10 * 60 * 1000 : 5 * 60 * 1000; // ÁßªÂä®Á´Ø10ÂàÜÈíüÔºåÊ°åÈù¢Á´Ø5ÂàÜÈíü
                    const validTimeAgo = new Date(now.getTime() - cacheValidTime);
                    
                    return cacheTime > validTimeAgo;
                } catch (error) {
                    return false;
                }
            }

            isLocalNewer(localTime, remoteTime) {
                if (!localTime || !remoteTime) return false;
                return new Date(localTime) > new Date(remoteTime);
            }

            markSynced() {
                try {
                    const meta = this.getLocalMeta() || {};
                    meta.syncStatus = 'synced';
                    meta.lastSyncAttempt = new Date().toISOString();
                    localStorage.setItem(this.metaKey, JSON.stringify(meta));
                } catch (error) {
                    logger.error('Ê†áËÆ∞ÂêåÊ≠•Áä∂ÊÄÅÂ§±Ë¥•', { error: error.message });
                }
            }

            addPendingOperation(operation) {
                try {
                    const operations = this.getPendingOperations();
                    operations.push({
                        ...operation,
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('beestorePendingOps', JSON.stringify(operations));
                } catch (error) {
                    logger.error('Ê∑ªÂä†ÂæÖÂêåÊ≠•Êìç‰ΩúÂ§±Ë¥•', { error: error.message });
                }
            }

            getPendingOperations() {
                try {
                    const ops = localStorage.getItem('beestorePendingOps');
                    return ops ? JSON.parse(ops) : [];
                } catch (error) {
                    return [];
                }
            }

            clearPendingOperations() {
                localStorage.removeItem('beestorePendingOps');
            }
        }

        // ÂºÇÊ≠•ÂêåÊ≠•ÈòüÂàóÁÆ°ÁêÜÁ±ª
        class SyncQueue {
            constructor(localCache) {
                this.localCache = localCache;
                this.isProcessing = false;
                this.maxRetries = 3;
                this.retryDelay = 2000; // 2Áßí
            }

            async addOperation(operation) {
                // ÂØπ‰∫éÂèØÂàáÊç¢Êìç‰ΩúÔºàÁÇπËµû„ÄÅÊî∂ËóèÔºâÔºåÁßªÈô§ÂÜ≤Á™ÅÁöÑÊóßÊìç‰Ωú
                this.removeConflictingOperations(operation);
                
                // Ê£ÄÊü•Êìç‰ΩúÂéªÈáç
                if (this.isDuplicateOperation(operation)) {
                    logger.info('Ë∑≥ËøáÈáçÂ§çÊìç‰Ωú', { 
                        type: operation.type,
                        target: operation.appId || operation.userId,
                        operation: 'Êìç‰ΩúÂéªÈáç'
                    });
                    return;
                }
                
                // Ê∑ªÂä†Âà∞Êú¨Âú∞ÈòüÂàó
                this.localCache.addPendingOperation(operation);
                
                // Ëß¶ÂèëÂºÇÊ≠•Â§ÑÁêÜ
                this.processQueueAsync();
            }

            isDuplicateOperation(newOperation) {
                const pendingOps = this.localCache.getPendingOperations();
                
                // ÁîüÊàêÊìç‰ΩúÂîØ‰∏ÄÊ†áËØÜ
                const newOpKey = this.generateOperationKey(newOperation);
                
                // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®Áõ∏ÂêåÊìç‰ΩúÔºà5ÂàÜÈíüÂÜÖÁöÑÊìç‰ΩúËÆ§‰∏∫ÊòØÈáçÂ§çÔºâ
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                
                return pendingOps.some(op => {
                    const opTime = new Date(op.timestamp);
                    const opKey = this.generateOperationKey(op);
                    
                    return opKey === newOpKey && opTime > fiveMinutesAgo;
                });
            }

            generateOperationKey(operation) {
                // Ê†πÊçÆÊìç‰ΩúÁ±ªÂûãÁîüÊàêÂîØ‰∏ÄÊ†áËØÜ
                switch (operation.type) {
                    case 'like':
                    case 'favorite':
                        return `${operation.type}_${operation.appId}_${operation.userId}`;
                    case 'comment_add':
                        // ËØÑËÆ∫ÊåâÂÜÖÂÆπÂéªÈáçÔºàÈò≤Ê≠¢Áü≠Êó∂Èó¥ÂÜÖÈáçÂ§çÊèê‰∫§Áõ∏ÂêåËØÑËÆ∫Ôºâ
                        return `${operation.type}_${operation.appId}_${operation.userId}_${operation.data?.commentContent}`;
                    case 'comment_delete':
                        return `${operation.type}_${operation.commentId}_${operation.userId}`;
                    case 'app_publish':
                    case 'app_edit':
                        return `${operation.type}_${operation.appId}_${operation.userId}`;
                    case 'user_register':
                        return `${operation.type}_${operation.userId}`;
                    default:
                        // ÈªòËÆ§ÊåâÁ±ªÂûã+Áî®Êà∑+Êó∂Èó¥ÂéªÈáç
                        return `${operation.type}_${operation.userId}_${Math.floor(Date.now() / 60000)}`; // ÊåâÂàÜÈíüÂéªÈáç
                }
            }

            removeConflictingOperations(newOperation) {
                // ÂØπ‰∫éÂèØÂàáÊç¢ÁöÑÊìç‰ΩúÔºàÁÇπËµû„ÄÅÊî∂ËóèÔºâÔºåÁßªÈô§Âêå‰∏ÄÁõÆÊ†áÁöÑÊóßÊìç‰Ωú
                if (newOperation.type === 'like' || newOperation.type === 'favorite') {
                    try {
                        const operations = this.localCache.getPendingOperations();
                        const conflictKey = `${newOperation.type}_${newOperation.appId}_${newOperation.userId}`;
                        
                        const filteredOps = operations.filter(op => {
                            const opKey = this.generateOperationKey(op);
                            return opKey !== conflictKey;
                        });
                        
                        const removedCount = operations.length - filteredOps.length;
                        if (removedCount > 0) {
                            localStorage.setItem('beestorePendingOps', JSON.stringify(filteredOps));
                            logger.info('ÁßªÈô§ÂÜ≤Á™ÅÁöÑÂæÖÂêåÊ≠•Êìç‰Ωú', {
                                type: newOperation.type,
                                target: newOperation.appId,
                                removedCount: removedCount,
                                operation: 'Êìç‰ΩúÂÜ≤Á™ÅÂ§ÑÁêÜ'
                            });
                        }
                    } catch (error) {
                        logger.error('ÁßªÈô§ÂÜ≤Á™ÅÊìç‰ΩúÂ§±Ë¥•', { 
                            error: error.message,
                            operation: 'Êìç‰ΩúÂÜ≤Á™ÅÂ§ÑÁêÜÂ§±Ë¥•'
                        });
                    }
                }
            }

            async processQueueAsync() {
                if (this.isProcessing) return;
                
                // Âª∂ËøüÂ§ÑÁêÜÔºåÈÅøÂÖçÈ¢ëÁπÅÂêåÊ≠•
                setTimeout(() => {
                    this.processQueue();
                }, 500);
            }

            async processQueue() {
                if (this.isProcessing) return;
                this.isProcessing = true;

                try {
                    const operations = this.localCache.getPendingOperations();
                    if (operations.length === 0) {
                        this.isProcessing = false;
                        return;
                    }

                    logger.info('ÂºÄÂßãÂ§ÑÁêÜÂêåÊ≠•ÈòüÂàó', { 
                        operationsCount: operations.length,
                        operation: 'ÈòüÂàóÂêåÊ≠•'
                    });

                    updateStatus('‚òÅÔ∏è ÂêéÂè∞ÂêåÊ≠•‰∏≠...', 'syncing-background');

                    // Â∞ùËØïÂêéÂè∞ÂêåÊ≠•
                    await syncData(0, true);
                    
                    // ÂêåÊ≠•ÊàêÂäüÔºåÊ∏ÖÁ©∫ÈòüÂàóÂπ∂Ê∏ÖÁêÜËøáÊúüÊìç‰Ωú
                    this.localCache.clearPendingOperations();
                    this.localCache.markSynced();
                    this.cleanupExpiredOperations();
                    
                    updateStatus('‚òÅÔ∏è ÂêåÊ≠•ÂÆåÊàê', 'connected');
                    
                    logger.info('ÂêåÊ≠•ÈòüÂàóÂ§ÑÁêÜÂÆåÊàê', { 
                        processedCount: operations.length,
                        operation: 'ÈòüÂàóÂêåÊ≠•ÂÆåÊàê'
                    });

                } catch (error) {
                    logger.error('ÂêåÊ≠•ÈòüÂàóÂ§ÑÁêÜÂ§±Ë¥•', { 
                        error: error.message,
                        operation: 'ÈòüÂàóÂêåÊ≠•Â§±Ë¥•'
                    });
                    
                    updateStatus('‚ö†Ô∏è ÂêåÊ≠•Â§±Ë¥•ÔºåÂ∞ÜÈáçËØï', 'sync-failed');
                    
                    // ËÆæÁΩÆÈáçËØï
                    setTimeout(() => {
                        this.retryFailedSync();
                    }, this.retryDelay);
                    
                } finally {
                    this.isProcessing = false;
                }
            }

            async retryFailedSync() {
                const operations = this.localCache.getPendingOperations();
                if (operations.length > 0) {
                    logger.info('ÈáçËØïÂ§±Ë¥•ÁöÑÂêåÊ≠•Êìç‰Ωú', { 
                        operationsCount: operations.length,
                        operation: 'ÂêåÊ≠•ÈáçËØï'
                    });
                    await this.processQueue();
                }
            }

            cleanupExpiredOperations() {
                try {
                    const operations = this.localCache.getPendingOperations();
                    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000); // 24Â∞èÊó∂Ââç
                    
                    const validOperations = operations.filter(op => {
                        try {
                            const opTime = new Date(op.timestamp);
                            return opTime > oneDayAgo;
                        } catch (e) {
                            // Êó∂Èó¥Êà≥Ëß£ÊûêÂ§±Ë¥•Ôºå‰øùÁïôÊìç‰ΩúÔºàÂÆâÂÖ®Ëµ∑ËßÅÔºâ
                            return true;
                        }
                    });
                    
                    const removedCount = operations.length - validOperations.length;
                    if (removedCount > 0) {
                        localStorage.setItem('beestorePendingOps', JSON.stringify(validOperations));
                        logger.info('Ê∏ÖÁêÜËøáÊúüÁöÑÂæÖÂêåÊ≠•Êìç‰Ωú', {
                            removedCount: removedCount,
                            remainingCount: validOperations.length,
                            operation: 'Êìç‰ΩúÈòüÂàóÊ∏ÖÁêÜ'
                        });
                    }
                } catch (error) {
                    logger.error('Ê∏ÖÁêÜËøáÊúüÊìç‰ΩúÂ§±Ë¥•', { 
                        error: error.message,
                        operation: 'Êìç‰ΩúÈòüÂàóÊ∏ÖÁêÜÂ§±Ë¥•'
                    });
                }
            }
        }

        const localCache = new LocalCache();
        const syncQueue = new SyncQueue(localCache);

        // ÁïåÈù¢ÂàùÂßãÂåñÂáΩÊï∞
        function initializeInterface() {
            // Á°Æ‰øùÊï∞ÊçÆÁªìÊûÑÂÖºÂÆπÊÄßÔºà‰∏∫ÊóßÊï∞ÊçÆÊ∑ªÂä†Êñ∞Â≠óÊÆµÔºâ
            if (cloudData.apps) {
                cloudData.apps.forEach(app => {
                    if (!app.likes) app.likes = [];
                    if (!app.favorites) app.favorites = [];
                    if (!app.comments) app.comments = [];
                });
            }
            
            // Ê£ÄÊü•Êú¨Âú∞ÁôªÂΩïÁä∂ÊÄÅ
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    // È™åËØÅÁî®Êà∑ÊòØÂê¶‰ªçÁÑ∂Â≠òÂú®
                    let user = cloudData.users.find(u => u.id === userData.id);
                    
                    if (user) {
                        // Áî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄßÈ™åËØÅ
                        if (!user.id || !user.username || !user.email) {
                            logger.warn('Ê£ÄÊµãÂà∞Áî®Êà∑Áä∂ÊÄÅ‰∏çÂÆåÊï¥ÔºåÊ∏ÖÈô§Êú¨Âú∞ÁôªÂΩïÁä∂ÊÄÅ', {
                                userId: user.id,
                                username: user.username,
                                hasEmail: !!user.email,
                                operation: 'Áî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄßÊ£ÄÊü•'
                            });
                            localStorage.removeItem('currentUser');
                            showGuestNav();
                        } else {
                            currentUser = user;
                            showUserNav();
                        }
                    } else {
                        showGuestNav();
                    }
                } catch (error) {
                    logger.error('Ëß£ÊûêÊú¨Âú∞Áî®Êà∑Êï∞ÊçÆÂ§±Ë¥•', { error: error.message });
                    localStorage.removeItem('currentUser');
                    showGuestNav();
                }
            } else {
                showGuestNav();
            }

            // Âä†ËΩΩÂ∫îÁî®ÂíåÊõ¥Êñ∞ÁªüËÆ°
            loadApps();
            updateStats();
            
            // ËÆæÁΩÆÊêúÁ¥¢‰∫ã‰ª∂
            setupSearchEvents();
            
            // ÂàùÂßãÂåñËá™ÂÆö‰πâ‰∏ãÊãâËèúÂçïÁä∂ÊÄÅ
            initDropdowns();
        }

        // Êï∞ÊçÆÂêàÂπ∂ÂáΩÊï∞
        function mergeCloudData(remoteData) {
            logger.info('ÂºÄÂßãÂêàÂπ∂‰∫ëÁ´ØÂíåÊú¨Âú∞Êï∞ÊçÆ', { 
                localUsers: cloudData?.users?.length || 0,
                localApps: cloudData?.apps?.length || 0,
                remoteUsers: remoteData?.users?.length || 0,
                remoteApps: remoteData?.apps?.length || 0,
                operation: 'Êï∞ÊçÆÂêàÂπ∂'
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâÊú¨Âú∞Êï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®ËøúÁ®ãÊï∞ÊçÆ
            if (!cloudData || !cloudData.users || !cloudData.apps) {
                logger.info('Êó†Êú¨Âú∞Êï∞ÊçÆÔºå‰ΩøÁî®ËøúÁ®ãÊï∞ÊçÆ', { operation: 'Êï∞ÊçÆÂêàÂπ∂' });
                return remoteData || { users: [], apps: [], lastSync: null };
            }

            // Â¶ÇÊûúÊ≤°ÊúâËøúÁ®ãÊï∞ÊçÆÔºå‰øùÊåÅÊú¨Âú∞Êï∞ÊçÆ
            if (!remoteData || !remoteData.users || !remoteData.apps) {
                logger.info('Êó†ËøúÁ®ãÊï∞ÊçÆÔºå‰øùÊåÅÊú¨Âú∞Êï∞ÊçÆ', { operation: 'Êï∞ÊçÆÂêàÂπ∂' });
                return cloudData;
            }

            // Âú®Êï∞ÊçÆÂêàÂπ∂ÂâçÂàõÂª∫Âø´ÁÖß
            try {
                logger.snapshot('Êï∞ÊçÆÂêàÂπ∂ÂâçÊú¨Âú∞Êï∞ÊçÆÂø´ÁÖß', cloudData, {
                    snapshotType: 'local_before_merge',
                    operation: 'Êï∞ÊçÆÂêàÂπ∂ÂâçÊú¨Âú∞',
                    localUsers: cloudData.users.length,
                    localApps: cloudData.apps.length
                });
                
                logger.snapshot('Êï∞ÊçÆÂêàÂπ∂ÂâçËøúÁ®ãÊï∞ÊçÆÂø´ÁÖß', remoteData, {
                    snapshotType: 'remote_before_merge',
                    operation: 'Êï∞ÊçÆÂêàÂπ∂ÂâçËøúÁ®ã',
                    remoteUsers: remoteData.users.length,
                    remoteApps: remoteData.apps.length
                });
            } catch (snapshotError) {
                logger.warn('ÂàõÂª∫ÂêàÂπ∂ÂâçÂø´ÁÖßÂ§±Ë¥•ÔºåÁªßÁª≠ÊâßË°åÂêàÂπ∂', { 
                    error: snapshotError.message 
                });
            }

            const merged = {
                users: [],
                apps: [],
                lastSync: remoteData.lastSync || new Date().toISOString()
            };

            // üî• Ê≠•È™§1: ÂêàÂπ∂Áî®Êà∑Êï∞ÊçÆÔºàÂü∫‰∫éIDÂíålastModifiedÊó∂Èó¥Ôºâ
            const allUsers = [...cloudData.users, ...remoteData.users];
            const userMap = new Map();
            
            allUsers.forEach(user => {
                const existing = userMap.get(user.id);
                const userLastModified = user.lastModified || user.createdAt;
                const existingLastModified = existing?.lastModified || existing?.createdAt;
                
                if (!existing || new Date(userLastModified) >= new Date(existingLastModified)) {
                    userMap.set(user.id, user);
                }
            });
            merged.users = Array.from(userMap.values());

            // üî• Ê≠•È™§2: ÂêàÂπ∂Â∫îÁî®Êï∞ÊçÆÔºàÂü∫‰∫éIDÂíålastModifiedÊó∂Èó¥Ôºâ
            const allApps = [...cloudData.apps, ...remoteData.apps];
            const appMap = new Map();
            
            allApps.forEach(app => {
                const existing = appMap.get(app.id);
                const appLastModified = app.lastModified || app.createdAt;
                const existingLastModified = existing?.lastModified || existing?.createdAt;
                
                if (!existing || new Date(appLastModified) >= new Date(existingLastModified)) {
                    appMap.set(app.id, app);
                }
            });
            merged.apps = Array.from(appMap.values());

            logger.info('Êï∞ÊçÆÂêàÂπ∂ÂÆåÊàê', { 
                finalUsers: merged.users.length,
                finalApps: merged.apps.length,
                operation: 'Êï∞ÊçÆÂêàÂπ∂ÂÆåÊàê'
            });

            return merged;
        }

        // Áä∂ÊÄÅÁÆ°ÁêÜ - ‰øùÁïôÁî®‰∫éÂÜÖÈÉ®Êó•ÂøóÔºå‰∏çÊòæÁ§∫ÁªôÁî®Êà∑
        function updateStatus(message, type = 'syncing') {
            // Âè™ËÆ∞ÂΩïÂà∞ÊéßÂà∂Âè∞Ôºå‰∏çÊòæÁ§∫UIÁä∂ÊÄÅ
            console.log(`[BeeStore Status] ${type.toUpperCase()}: ${message}`);
            
            // ËÆ∞ÂΩïÁä∂ÊÄÅÂèòÂåñÂà∞Êó•ÂøóÔºàÁî®‰∫éË∞ÉËØïÔºâ
            if (type === 'error' || type === 'sync-failed') {
                logger.warn('Á≥ªÁªüÁä∂ÊÄÅÂèòÂåñ', { 
                    message: message, 
                    type: type,
                    operation: 'Áä∂ÊÄÅÊõ¥Êñ∞'
                });
            }
        }

        // üî• Ê≠•È™§18: ÊèêÂèñÁôªÂΩïÁä∂ÊÄÅÊ£ÄÊü•ÈÄªËæë
        function checkLoginStatus() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                const userData = JSON.parse(storedUser);
                let user = cloudData.users.find(u => u.id === userData.id);
                
                if (user) {
                    currentUser = user;
                    showUserNav();
                } else {
                    // Â§ÑÁêÜÁî®Êà∑Êï∞ÊçÆÂêåÊ≠•ÈóÆÈ¢ò
                    const existingUserByName = cloudData.users.find(u => u.username === userData.username);
                    if (existingUserByName) {
                        currentUser = existingUserByName;
                        localStorage.setItem('currentUser', JSON.stringify(existingUserByName));
                        showUserNav();
                    } else {
                        localStorage.removeItem('currentUser');
                        showGuestNav();
                    }
                }
            } else {
                showGuestNav();
            }
        }

        // üî• ‰øÆÊîπ‰∏∫Á∫Ø‰∫ëÁ´ØÊ®°Âºè - ÂÆåÂÖ®‰∏ç‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ
        async function init() {
            logger.info('Bee Store Â∫îÁî®ÂêØÂä® - Á∫Ø‰∫ëÁ´ØÊ®°Âºè', { 
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                operation: 'Â∫îÁî®ÂêØÂä® - Á∫Ø‰∫ëÁ´Ø'
            });
            
            updateStatus('‚òÅÔ∏è ‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ...', 'syncing');
            
            try {
                // ‚òÅÔ∏è Áõ¥Êé•‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆÔºå‰∏ç‰ΩøÁî®‰ªª‰ΩïÊú¨Âú∞ÁºìÂ≠ò
                console.log('[BeeStore] üöÄ ÂêØÂä®Á∫Ø‰∫ëÁ´ØÊ®°ÂºèÔºåË∑≥ËøáÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆ');
                
                const remoteData = await cloudStorage.loadData();
                if (!remoteData || !remoteData.users || !remoteData.apps) {
                    throw new Error('‰∫ëÁ´ØÊï∞ÊçÆÊ†ºÂºèÈîôËØØÊàñ‰∏∫Á©∫');
                }
                
                // Áõ¥Êé•‰ΩøÁî®‰∫ëÁ´ØÊï∞ÊçÆÔºå‰∏çËøõË°å‰ªª‰ΩïÂêàÂπ∂
                cloudData = ensureDataIntegrity(remoteData);
                console.log(`[BeeStore] ‚òÅÔ∏è ‰∫ëÁ´ØÊï∞ÊçÆÂä†ËΩΩÊàêÂäü: ${cloudData.apps.length} ‰∏™‰ΩúÂìÅ, ${cloudData.users.length} ‰∏™Áî®Êà∑`);
                
                // Ê∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Â≠òÂÇ®ÔºàÁ°Æ‰øù‰∏çÂèóÊóßÊï∞ÊçÆÂΩ±ÂìçÔºâ
                try {
                    localStorage.removeItem('beestoreLocalBackup');
                    console.log('[BeeStore] üßπ Â∑≤Ê∏ÖÈô§Êú¨Âú∞Â§á‰ªΩÊï∞ÊçÆ');
                } catch (clearError) {
                    console.warn('Ê∏ÖÈô§Êú¨Âú∞Êï∞ÊçÆÊó∂Âá∫Èîô:', clearError);
                }
                
                // üî• Á°Æ‰øùÊï∞ÊçÆÁªìÊûÑÂÖºÂÆπÊÄßÔºà‰∏∫ÊóßÊï∞ÊçÆÊ∑ªÂä†Êñ∞Â≠óÊÆµÔºâ
                if (cloudData.apps) {
                    cloudData.apps.forEach(app => {
                        if (!app.likes) app.likes = [];
                        if (!app.favorites) app.favorites = [];
                        if (!app.comments) app.comments = [];
                        if (!app.lastModified) app.lastModified = app.createdAt;
                    });
                }
                
                if (cloudData.users) {
                    cloudData.users.forEach(user => {
                        if (!user.lastModified) user.lastModified = user.createdAt;
                    });
                }
                
                // Êõ¥Êñ∞UI
                checkLoginStatus();
                loadApps();
                updateStats();
                updateStatus('‚òÅÔ∏è Á∫Ø‰∫ëÁ´ØÊ®°Âºè', 'connected');
                
                // ÂàùÂßãÂåñ‰∏ãÊãâËèúÂçïÁä∂ÊÄÅ
                updateDropdownSelection('category', '');
                updateDropdownSelection('sort', 'newest');
                updateDropdownSelection('category-mobile', '');
                updateDropdownSelection('sort-mobile', 'newest');
                
            } catch (cloudError) {
                console.error('‰∫ëÁ´ØÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', cloudError);
                
                // Á∫Ø‰∫ëÁ´ØÊ®°Âºè‰∏ãÔºåÂ¶ÇÊûú‰∫ëÁ´ØÂ§±Ë¥•Â∞±ÂàùÂßãÂåñÁ©∫Êï∞ÊçÆ
                initLocalData();
                updateStatus('‚ùå ‰∫ëÁ´ØËøûÊé•Â§±Ë¥•Ôºå‰ΩøÁî®Á©∫Êï∞ÊçÆ', 'error');
                checkLoginStatus();
                loadApps();
                updateStats();
                
                // ÂàùÂßãÂåñ‰∏ãÊãâËèúÂçïÁä∂ÊÄÅ
                updateDropdownSelection('category', '');
                updateDropdownSelection('sort', 'newest');
                updateDropdownSelection('category-mobile', '');
                updateDropdownSelection('sort-mobile', 'newest');
                
                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØÁªôÁî®Êà∑
                alert(`‰∫ëÁ´ØÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ${cloudError.message}\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÂÜçËØï„ÄÇ`);
            }
        }

        // ÂàùÂßãÂåñÊú¨Âú∞Êï∞ÊçÆ
        function initLocalData() {
            cloudData = {
                users: [
                    {
                        id: 1,
                        username: 'demo',
                        email: 'demo@example.com',
                        password: 'demo123',
                        createdAt: new Date().toISOString()
                    }
                ],
                apps: [
                    {
                        id: 1,
                        name: '2Brain',
                        url: 'https://portal.2brain.ai/',
                        description: 'Áü•ËØÜÂ∫ìÂûãAIÂπ≥Âè∞ÔºåÂª∫Á´ãÁü•ËØÜÂ∫ì„ÄÅÊô∫ËÉΩ‰ΩìÔºåÂåÖÊã¨Ê®°ÊùøÂÜô‰Ωú„ÄÅËá™ÁÑ∂ËØ≠Ë®ÄexcelÂàÜÊûê„ÄÅÊô∫ËÉΩÂá∫È¢òËÄÉËØïÂà§Âç∑Á≠âÂäüËÉΩ',
                        category: 'Â∑•ÂÖ∑',
                        author: 'Beebee AI',
                        authorId: 1,
                        screenshot: '',
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Beebee Trademate',
                        url: 'https://beebee.com',
                        description: 'ÂïÜÊú∫ÂåÖÔºåÂïÜÊú∫ÊêúÁ¥¢ÂºïÊìéÔºåÊîØÊåÅËá™ÁÑ∂ËØ≠Ë®ÄÊêúÁ¥¢„ÄÅAIÁîüÊàêÈÇÆ‰ª∂‰∏ÄÈîÆÂèëÈÄÅ',
                        category: 'Â∑•ÂÖ∑',
                        author: 'Beebee AI',
                        authorId: 1,
                        screenshot: '',
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    }
                ],
                lastSync: new Date().toISOString()
            };
        }

        // ÂêåÊ≠•Êï∞ÊçÆÂà∞‰∫ëÁ´Ø
        async function syncData(retryCount = 0, isBackground = false) {
            const maxRetries = 3;
            
            if (retryCount === 0) {
                logger.info('ÂºÄÂßãÊï∞ÊçÆÂêåÊ≠•Âà∞‰∫ëÁ´Ø', { 
                    usersCount: cloudData.users.length,
                    appsCount: cloudData.apps.length,
                    isBackground: isBackground,
                    operation: 'Êï∞ÊçÆÂêåÊ≠•'
                });
                
                if (isBackground) {
                    updateStatus('üîÑ ÂêéÂè∞ÂêåÊ≠•‰∏≠...', 'syncing-background');
                } else {
                    updateStatus('‚òÅÔ∏è Ê≠£Âú®ÂêåÊ≠•...', 'syncing');
                }
            } else {
                logger.warn(`Êï∞ÊçÆÂêåÊ≠•ÈáçËØï ${retryCount}/${maxRetries}`, { 
                    retryCount: retryCount,
                    maxRetries: maxRetries,
                    isBackground: isBackground,
                    operation: 'Êï∞ÊçÆÂêåÊ≠•ÈáçËØï'
                });
                
                if (isBackground) {
                    updateStatus(`üîÑ ÂêéÂè∞ÈáçËØï (${retryCount}/${maxRetries})...`, 'syncing-background');
                } else {
                    updateStatus(`‚òÅÔ∏è ÈáçËØïÂêåÊ≠• (${retryCount}/${maxRetries})...`, 'syncing');
                }
            }
            
            try {
                // Áî®Êà∑Êï∞ÊçÆ‰∏ÄËá¥ÊÄßÊ£ÄÊü•
                if (currentUser) {
                    const userInData = cloudData.users.find(u => u.id === currentUser.id);
                    if (!userInData) {
                        logger.warn('ÂêåÊ≠•Êó∂ÂèëÁé∞Áî®Êà∑Êï∞ÊçÆ‰∏ç‰∏ÄËá¥ÔºåÊ∑ªÂä†ÂΩìÂâçÁî®Êà∑Âà∞cloudData', {
                            currentUserId: currentUser.id,
                            currentUserName: currentUser.username,
                            operation: 'Áî®Êà∑Êï∞ÊçÆ‰∏ÄËá¥ÊÄß‰øÆÂ§ç'
                        });
                        cloudData.users.push(currentUser);
                    } else if (userInData.username !== currentUser.username) {
                        logger.warn('ÂêåÊ≠•Êó∂ÂèëÁé∞Áî®Êà∑Âêç‰∏ç‰∏ÄËá¥ÔºåÊõ¥Êñ∞cloudData‰∏≠ÁöÑÁî®Êà∑‰ø°ÊÅØ', {
                            currentUserId: currentUser.id,
                            cloudUsername: userInData.username,
                            currentUsername: currentUser.username,
                            operation: 'Áî®Êà∑Êï∞ÊçÆ‰∏ÄËá¥ÊÄß‰øÆÂ§ç'
                        });
                        userInData.username = currentUser.username;
                        userInData.email = currentUser.email;
                    }
                }
                
                cloudData.lastSync = new Date().toISOString();
                
                // Ê£ÄÊü•Êï∞ÊçÆÂ§ßÂ∞è
                const dataSize = JSON.stringify(cloudData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB ÈôêÂà∂
                
                logger.info('Êï∞ÊçÆÂ§ßÂ∞èÊ£ÄÊü•', { 
                    dataSize: dataSize,
                    dataSizeMB: Math.round(dataSize / 1024 / 1024 * 100) / 100,
                    maxSizeMB: Math.round(maxSize / 1024 / 1024),
                    operation: 'Êï∞ÊçÆÂ§ßÂ∞èÊ£ÄÊü•'
                });
                
                if (dataSize > maxSize) {
                    logger.error('Êï∞ÊçÆÂ§ßÂ∞èË∂ÖËøáÈôêÂà∂', { 
                        dataSize: dataSize,
                        dataSizeMB: Math.round(dataSize / 1024 / 1024 * 100) / 100,
                        maxSizeMB: Math.round(maxSize / 1024 / 1024),
                        operation: 'Êï∞ÊçÆÂ§ßÂ∞èË∂ÖÈôê'
                    });
                    console.warn(`Êï∞ÊçÆÂ§ßÂ∞èËøáÂ§ß: ${Math.round(dataSize / 1024 / 1024 * 100) / 100}MB`);
                    updateStatus('‚ö†Ô∏è Êï∞ÊçÆËøáÂ§ßÔºåÂª∫ËÆÆÊ∏ÖÁêÜ', 'error');
                    throw new Error(`Êï∞ÊçÆÂ§ßÂ∞è ${Math.round(dataSize / 1024 / 1024 * 100) / 100}MB Ë∂ÖËøáÈôêÂà∂ ${Math.round(maxSize / 1024 / 1024)}MB`);
                }
                
                // Âú®ÂêåÊ≠•ÂâçÂàõÂª∫Âø´ÁÖß
                try {
                    logger.snapshot('Êï∞ÊçÆÂêåÊ≠•ÂâçÂø´ÁÖß', cloudData, {
                        snapshotType: 'full_before_sync',
                        operation: 'Êï∞ÊçÆÂêåÊ≠•Ââç',
                        usersCount: cloudData.users.length,
                        appsCount: cloudData.apps.length,
                        retryCount: retryCount
                    });
                } catch (snapshotError) {
                    logger.warn('ÂàõÂª∫ÂêåÊ≠•ÂâçÂø´ÁÖßÂ§±Ë¥•ÔºåÁªßÁª≠ÊâßË°åÂêåÊ≠•', { 
                        retryCount: retryCount,
                        error: snapshotError.message 
                    });
                }
                
                await cloudStorage.saveData(cloudData);
                logger.info('Êï∞ÊçÆÂêåÊ≠•ÊàêÂäü', { 
                    usersCount: cloudData.users.length,
                    appsCount: cloudData.apps.length,
                    retryCount: retryCount,
                    isBackground: isBackground,
                    operation: 'Êï∞ÊçÆÂêåÊ≠•ÊàêÂäü'
                });
                
                if (isBackground) {
                    updateStatus('‚úÖ ÂêéÂè∞ÂêåÊ≠•ÂÆåÊàê', 'connected');
                } else {
                    updateStatus('‚òÅÔ∏è ÂêåÊ≠•ÊàêÂäü', 'connected');
                }
                updateStats();
                return true;
            } catch (error) {
                logger.error(`Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥• (Â∞ùËØï ${retryCount + 1}/${maxRetries + 1})`, { 
                    error: error.message,
                    retryCount: retryCount,
                    maxRetries: maxRetries,
                    operation: 'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•'
                });
                console.error(`ÂêåÊ≠•Â§±Ë¥• (Â∞ùËØï ${retryCount + 1}/${maxRetries + 1}):`, error);
                
                if (retryCount < maxRetries) {
                    // ÊåáÊï∞ÈÄÄÈÅøÈáçËØïÔºöÁ¨¨‰∏ÄÊ¨°1ÁßíÔºåÁ¨¨‰∫åÊ¨°2ÁßíÔºåÁ¨¨‰∏âÊ¨°4Áßí
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return await syncData(retryCount + 1, isBackground);
                } else {
                    if (isBackground) {
                        updateStatus('‚ö†Ô∏è ÂêéÂè∞ÂêåÊ≠•Â§±Ë¥•', 'sync-failed');
                    } else {
                        updateStatus('‚ùå ÂêåÊ≠•Â§±Ë¥•', 'error');
                    }
                    throw error;
                }
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats() {
            const totalAppsElement = document.getElementById('nav-total-apps');
            const totalUsersElement = document.getElementById('nav-total-users');
            
            if (totalAppsElement) {
                totalAppsElement.textContent = cloudData.apps ? cloudData.apps.length : 0;
            }
            if (totalUsersElement) {
                totalUsersElement.textContent = cloudData.users ? cloudData.users.length : 0;
            }
            
            console.log(`[BeeStore] üìä ÁªüËÆ°Êõ¥Êñ∞: ${cloudData.apps ? cloudData.apps.length : 0} ‰∏™‰ΩúÂìÅ, ${cloudData.users ? cloudData.users.length : 0} ‰∏™Áî®Êà∑`);
        }

        // ËÆæÁΩÆÊêúÁ¥¢‰∫ã‰ª∂
        function setupSearchEvents() {
            // Ê°åÈù¢Á´ØÊêúÁ¥¢Ê°Ü
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchApps();
                    }
                });
                searchInput.addEventListener('input', debounce(searchApps, 300));
            }

            // ÁßªÂä®Á´ØÊêúÁ¥¢Ê°Ü
            const searchInputMobile = document.getElementById('search-input-mobile');
            if (searchInputMobile) {
                searchInputMobile.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchApps();
                    }
                });
                searchInputMobile.addEventListener('input', debounce(searchApps, 300));
            }

            // ÂêåÊ≠•ÊêúÁ¥¢Ê°ÜÂÜÖÂÆπ
            function syncSearchInputs() {
                const desktopValue = searchInput ? searchInput.value : '';
                const mobileValue = searchInputMobile ? searchInputMobile.value : '';
                
                if (searchInput && searchInputMobile) {
                    if (document.activeElement === searchInput) {
                        searchInputMobile.value = desktopValue;
                    } else if (document.activeElement === searchInputMobile) {
                        searchInput.value = mobileValue;
                    }
                }
            }

            if (searchInput) searchInput.addEventListener('input', syncSearchInputs);
            if (searchInputMobile) searchInputMobile.addEventListener('input', syncSearchInputs);

            // ‰∏∫ÁßªÂä®Á´ØÁ≠õÈÄâÂô®Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            const categoryFilterMobile = document.getElementById('category-filter-mobile');
            const sortFilterMobile = document.getElementById('sort-filter-mobile');
            
            if (categoryFilterMobile) {
                categoryFilterMobile.addEventListener('change', searchApps);
            }
            if (sortFilterMobile) {
                sortFilterMobile.addEventListener('change', searchApps);
            }

            // ÂêåÊ≠•Ê°åÈù¢Á´ØÂíåÁßªÂä®Á´ØÁöÑÁ≠õÈÄâÂô®ÂÄº
            function syncFilters() {
                const categoryFilter = document.getElementById('category-filter');
                const sortFilter = document.getElementById('sort-filter');
                
                if (categoryFilter && categoryFilterMobile) {
                    categoryFilter.addEventListener('change', function() {
                        categoryFilterMobile.value = this.value;
                        searchApps();
                    });
                    categoryFilterMobile.addEventListener('change', function() {
                        categoryFilter.value = this.value;
                    });
                }
                
                if (sortFilter && sortFilterMobile) {
                    sortFilter.addEventListener('change', function() {
                        sortFilterMobile.value = this.value;
                        searchApps();
                    });
                    sortFilterMobile.addEventListener('change', function() {
                        sortFilter.value = this.value;
                    });
                }
            }
            
            syncFilters();
        }

        // Èò≤ÊäñÂáΩÊï∞
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ÊêúÁ¥¢Â∫îÁî®
        function searchApps() {
            loadApps();
        }

        // Ëé∑ÂèñÂΩìÂâçÊêúÁ¥¢Êù°‰ª∂Ôºà‰ºòÂÖàÁßªÂä®Á´ØÔºåÂ¶ÇÊûúÁßªÂä®Á´ØÂèØËßÅÁöÑËØùÔºâ
        function getCurrentSearchTerms() {
            const isMobile = window.innerWidth <= 1024;
            
            let searchTerm = '';
            let categoryFilter = '';
            let sortFilter = '';
            
            if (isMobile) {
                // ÁßªÂä®Á´Ø
                const searchInputMobile = document.getElementById('search-input-mobile');
                const categoryFilterMobile = document.getElementById('category-filter-mobile');
                const sortFilterMobile = document.getElementById('sort-filter-mobile');
                
                searchTerm = searchInputMobile ? searchInputMobile.value.toLowerCase() : '';
                categoryFilter = categoryFilterMobile ? categoryFilterMobile.value : '';
                sortFilter = sortFilterMobile ? sortFilterMobile.value : '';
            } else {
                // Ê°åÈù¢Á´Ø
                const searchInput = document.getElementById('search-input');
                const categoryFilterDesktop = document.getElementById('category-filter');
                const sortFilterDesktop = document.getElementById('sort-filter');
                
                searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                categoryFilter = categoryFilterDesktop ? categoryFilterDesktop.value : '';
                sortFilter = sortFilterDesktop ? sortFilterDesktop.value : '';
            }
            
            return { searchTerm, categoryFilter, sortFilter };
        }

        // Âä†ËΩΩÂ∫îÁî®
        function loadApps() {
            const { searchTerm, categoryFilter, sortFilter } = getCurrentSearchTerms();

            let filteredApps = cloudData.apps;

            // ÊêúÁ¥¢ËøáÊª§
            if (searchTerm) {
                filteredApps = filteredApps.filter(app => 
                    app.name.toLowerCase().includes(searchTerm) ||
                    app.description.toLowerCase().includes(searchTerm) ||
                    app.author.toLowerCase().includes(searchTerm)
                );
            }

            // ÂàÜÁ±ªËøáÊª§
            if (categoryFilter) {
                filteredApps = filteredApps.filter(app => app.category === categoryFilter);
            }

            // ÊéíÂ∫è
            switch (sortFilter) {
                case 'newest':
                    filteredApps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'oldest':
                    filteredApps.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'name':
                    filteredApps.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'author':
                    filteredApps.sort((a, b) => a.author.localeCompare(b.author));
                    break;
            }

            displayApps(filteredApps);
        }

        // ÂàáÊç¢ÊèèËø∞Â±ïÂºÄ/Êî∂Ëµ∑
        function toggleDescription(appId) {
            const descElement = document.getElementById(`desc-${appId}`);
            const toggleButton = document.getElementById(`toggle-${appId}`);
            
            if (descElement.classList.contains('collapsed')) {
                // Â±ïÂºÄ
                descElement.classList.remove('collapsed');
                descElement.classList.add('expanded');
                descElement.style.cursor = 'default';
                if (toggleButton) toggleButton.style.display = 'inline-block';
            } else {
                // Êî∂Ëµ∑
                descElement.classList.remove('expanded');
                descElement.classList.add('collapsed');
                descElement.style.cursor = 'pointer';
                if (toggleButton) toggleButton.style.display = 'none';
            }
        }

        // Ê£ÄÊü•ÊèèËø∞ÊòØÂê¶ÈúÄË¶ÅÂ±ïÂºÄÊåâÈíÆ
        function checkDescriptionOverflow() {
            // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùDOMÂ∑≤Ê∏≤Êüì
            setTimeout(() => {
                const descriptions = document.querySelectorAll('.app-description.collapsed');
                descriptions.forEach(desc => {
                    const appId = desc.id.replace('desc-', '');
                    const toggleButton = document.getElementById(`toggle-${appId}`);
                    
                    // Ëé∑ÂèñÁ∫ØÊñáÊú¨ÂÜÖÂÆπ
                    const textContent = desc.textContent.trim();
                    
                    // ÂàõÂª∫‰∏¥Êó∂ÂÖÉÁ¥†Êù•ÊµãÈáèÂÆåÊï¥ÊñáÊú¨È´òÂ∫¶
                    const tempDiv = document.createElement('div');
                    tempDiv.style.cssText = `
                        position: absolute;
                        visibility: hidden;
                        width: ${desc.offsetWidth}px;
                        font-size: ${window.getComputedStyle(desc).fontSize};
                        font-family: ${window.getComputedStyle(desc).fontFamily};
                        line-height: ${window.getComputedStyle(desc).lineHeight};
                        padding: 0;
                        margin: 0;
                        border: none;
                    `;
                    tempDiv.textContent = textContent;
                    document.body.appendChild(tempDiv);
                    
                    const fullHeight = tempDiv.offsetHeight;
                    document.body.removeChild(tempDiv);
                    
                    // Ëé∑Âèñ2Ë°åÁöÑÈ¢ÑÊúüÈ´òÂ∫¶ÔºàË°åÈ´ò * 2Ôºâ
                    const lineHeight = parseFloat(window.getComputedStyle(desc).lineHeight);
                    const twoLineHeight = lineHeight * 2;
                    
                    // Â¶ÇÊûúÂÆåÊï¥È´òÂ∫¶Ë∂ÖËøá2Ë°åÈ´òÂ∫¶ÔºåÊòæÁ§∫Â±ïÂºÄÂäüËÉΩ
                    if (fullHeight > twoLineHeight + 5) { // 5pxÂÆπÂ∑Æ
                        desc.classList.add('has-overflow');
                        desc.style.cursor = 'pointer';
                        
                        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†Ôºâ
                        if (!desc.hasAttribute('data-click-added')) {
                            desc.addEventListener('click', function() {
                                toggleDescription(appId);
                            });
                            desc.setAttribute('data-click-added', 'true');
                        }
                        
                        if (toggleButton) toggleButton.style.display = 'none';
                    } else {
                        desc.classList.remove('has-overflow');
                        desc.style.cursor = 'default';
                        if (toggleButton) toggleButton.style.display = 'none';
                    }
                });
            }, 200);
        }

        // ÊòæÁ§∫Â∫îÁî®
        function displayApps(apps, showActions = false) {
            const appsGrid = document.getElementById('apps-grid');
            const emptyState = document.getElementById('empty-state');

            if (apps.length === 0) {
                appsGrid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            appsGrid.innerHTML = apps.map(app => {
                const isLiked = currentUser && app.likes && app.likes.includes(currentUser.id);
                const isFavorited = currentUser && app.favorites && app.favorites.includes(currentUser.id);
                const likesCount = app.likes ? app.likes.length : 0;
                const commentsCount = app.comments ? app.comments.length : 0;
                
                return `
                <div class="app-card">
                    ${showActions && currentUser && currentUser.id === app.authorId ? `
                        <div class="app-actions">
                            <button class="app-action-btn edit-btn" onclick="showEditModal(${app.id})" title="ÁºñËæë">‚úèÔ∏è</button>
                            <button class="app-action-btn" onclick="deleteApp(${app.id})" title="Âà†Èô§">üóëÔ∏è</button>
                        </div>
                    ` : ''}
                    <div class="app-screenshot">
                        ${app.screenshot && app.screenshot.trim() ? 
                            `<img src="${app.screenshot}" alt="${app.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'placeholder\\'><div style=\\'font-size: 2rem;\\'>üåê</div><div>ÊöÇÊó†Êà™Âõæ</div></div>'">` :
                            '<div class="placeholder"><div style="font-size: 2rem;">üåê</div><div>ÊöÇÊó†Êà™Âõæ</div></div>'
                        }
                    </div>
                    <div class="app-info">
                        <h3>${app.name}</h3>
                        <div class="app-description collapsed" id="desc-${app.id}" data-full-text="${app.description.replace(/"/g, '&quot;')}">${app.description}</div>
                        <button class="description-toggle" onclick="toggleDescription(${app.id})" id="toggle-${app.id}" style="display: none;">Êî∂Ëµ∑</button>
                        <div class="app-meta">
                            <span>üë§ ${app.author}</span>
                            <span>üìÖ ${new Date(app.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="app-meta">
                            <span>üè∑Ô∏è ${app.category}</span>
                            <a href="${app.url}" target="_blank" class="app-url" title="ËÆøÈóÆÈìæÊé•Ôºö${app.url}">üîó ËÆøÈóÆÈìæÊé•</a>
                        </div>
                        
                        <!-- ‰∫íÂä®ÊåâÈíÆ -->
                        <div class="app-interactions">
                            <div class="interaction-group">
                                <button class="interaction-btn ${isLiked ? 'active' : ''}" onclick="toggleLike(${app.id})" ${!currentUser ? 'disabled title="ËØ∑ÂÖàÁôªÂΩï"' : ''}>
                                    ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${likesCount}
                                </button>
                                <button class="interaction-btn" onclick="showComments(${app.id})" ${!currentUser ? 'disabled title="ËØ∑ÂÖàÁôªÂΩï"' : ''}>
                                    üí¨ ${commentsCount}
                                </button>
                                <button class="interaction-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite(${app.id})" ${!currentUser ? 'disabled title="ËØ∑ÂÖàÁôªÂΩï"' : ''}>
                                    ${isFavorited ? '‚≠ê' : '‚òÜ'} Êî∂Ëóè
                                </button>
                            </div>
                        </div>
                        
                        <!-- ËØÑËÆ∫Âå∫Âüü -->
                        <div class="comments-section" id="comments-${app.id}" style="display: none;">
                            <div id="comments-list-${app.id}">
                                ${app.comments ? app.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">${comment.author}</span>
                                            <div>
                                                <span>${new Date(comment.createdAt).toLocaleDateString()}</span>
                                                ${currentUser && currentUser.id === comment.authorId ? `
                                                    <button class="comment-delete" onclick="deleteComment(${app.id}, ${comment.id})">Âà†Èô§</button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="comment-content">${comment.content}</div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            ${currentUser ? `
                                <div class="comment-input">
                                    <input type="text" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..." id="comment-input-${app.id}" onkeypress="if(event.key==='Enter') addComment(${app.id})">
                                    <button onclick="addComment(${app.id})">ÂèëÈÄÅ</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // Ê£ÄÊü•Âì™‰∫õÊèèËø∞ÈúÄË¶ÅÂ±ïÂºÄÊåâÈíÆ
            checkDescriptionOverflow();
        }

        // Âà†Èô§Â∫îÁî®
        async function deleteApp(appId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â∫îÁî®ÂêóÔºü')) return;

            try {
                // Âú®Âà†Èô§ÂâçÂàõÂª∫Âø´ÁÖß
                const appToDelete = cloudData.apps.find(app => app.id === appId);
                if (appToDelete) {
                    try {
                        logger.snapshot(`Âà†Èô§Â∫îÁî®ÂâçÂø´ÁÖß: ${appToDelete.name}`, appToDelete, {
                            snapshotType: 'app_delete_before',
                            appId: appId,
                            operation: 'Â∫îÁî®Âà†Èô§Ââç'
                        });
                    } catch (snapshotError) {
                        logger.warn('ÂàõÂª∫Âà†Èô§ÂâçÂø´ÁÖßÂ§±Ë¥•ÔºåÁªßÁª≠ÊâßË°åÂà†Èô§', { 
                            appId: appId, 
                            error: snapshotError.message 
                        });
                    }

                    // ËÆ∞ÂΩïÂà†Èô§Êìç‰Ωú
                    logger.info('Â∫îÁî®Âà†Èô§', {
                        appId: appId,
                        appName: appToDelete.name,
                        appUrl: appToDelete.url,
                        authorId: appToDelete.authorId,
                        operation: 'Â∫îÁî®ÁÆ°ÁêÜ'
                    });
                }

                cloudData.apps = cloudData.apps.filter(app => app.id !== appId);
                
                // üî• Ê≠•È™§24: Á´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                localStorageManager.saveToLocal(cloudData);
                
                // Á´ãÂç≥Êõ¥Êñ∞UI
                loadApps();
                
                // ÂºÇÊ≠•ÂêåÊ≠•Âà∞‰∫ëÁ´Ø
                try {
                    await syncData();
                    alert('Âà†Èô§ÊàêÂäüÔºÅ');
                } catch (error) {
                    alert('Âà†Èô§ÊàêÂäüÔºÅ‰ΩÜ‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•ÔºåÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞„ÄÇ');
                }
            } catch (error) {
                logger.error('Â∫îÁî®Âà†Èô§Â§±Ë¥•', {
                    appId: appId,
                    error: error.message,
                    operation: 'Â∫îÁî®ÁÆ°ÁêÜÂ§±Ë¥•'
                });
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        // ÊòæÁ§∫ÊàëÁöÑÂ∫îÁî®
        function showMyApps() {
            if (!currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            // È™åËØÅÁî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄß
            if (!currentUser.id || !currentUser.username) {
                alert('Áî®Êà∑Áä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            const myApps = cloudData.apps.filter(app => app.authorId === currentUser.id);
            displayApps(myApps, true);
        }

        // ÊòæÁ§∫ÊàëÁöÑÊî∂Ëóè
        function showMyFavorites() {
            if (!currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            // È™åËØÅÁî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄß
            if (!currentUser.id || !currentUser.username) {
                alert('Áî®Êà∑Áä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            const myFavorites = cloudData.apps.filter(app => 
                app.favorites && app.favorites.includes(currentUser.id)
            );
            displayApps(myFavorites, false);
        }

        // ÁÇπËµûÂäüËÉΩ
        async function toggleLike(appId) {
            if (!currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            // È™åËØÅÁî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄß
            if (!currentUser.id || !currentUser.username) {
                alert('Áî®Êà∑Áä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            // È™åËØÅÁî®Êà∑Âú®‰∫ëÁ´ØÊï∞ÊçÆ‰∏≠ÁöÑÂ≠òÂú®ÊÄß
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('Áî®Êà∑Êï∞ÊçÆÂêåÊ≠•ÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.likes) app.likes = [];

                const likedIndex = app.likes.indexOf(currentUser.id);
                const isLiking = likedIndex === -1;
                
                if (likedIndex > -1) {
                    app.likes.splice(likedIndex, 1);
                } else {
                    app.likes.push(currentUser.id);
                }

                // üî• Ê≠•È™§6: Êõ¥Êñ∞Â∫îÁî®ÊúÄÂêé‰øÆÊîπÊó∂Èó¥
                updateAppLastModified(appId, isLiking ? 'ÁÇπËµû' : 'ÂèñÊ∂àÁÇπËµû');

                // üî• Ê≠•È™§8: Á´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                localStorageManager.saveToLocal(cloudData);
                
                // üî• Ê≠•È™§9: Á´ãÂç≥Êõ¥Êñ∞UI
                loadApps();
                
                // üî• Ê≠•È™§23: ÂºÇÊ≠•ÂêåÊ≠•Âà∞‰∫ëÁ´ØÔºà‰∏çÈòªÂ°ûÁî®Êà∑‰ΩìÈ™åÔºâ
                updateStatus('‚òÅÔ∏è Ê≠£Âú®ÂêåÊ≠•ÁÇπËµûÊï∞ÊçÆ...', 'syncing');
                
                // ‰ΩøÁî®ÈáçËØïÊú∫Âà∂ËøõË°åÂêåÊ≠•
                retryOperation('ÁÇπËµûÂêåÊ≠•', syncData).then(() => {
                    updateStatus('‚òÅÔ∏è ÁÇπËµûÂêåÊ≠•ÊàêÂäü', 'connected');
                }).catch((error) => {
                    console.error('ÁÇπËµûÂêåÊ≠•ÊúÄÁªàÂ§±Ë¥•:', error);
                    updateStatus('‚ö†Ô∏è ÁÇπËµûÂ∑≤‰øùÂ≠òÊú¨Âú∞Ôºå‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•', 'error');
                });

                // ËÆ∞ÂΩïÁÇπËµûÊìç‰Ωú
                logger.info('ÁÇπËµûÊìç‰Ωú', {
                    appId: appId,
                    appName: app.name,
                    action: isLiking ? 'ÁÇπËµû' : 'ÂèñÊ∂àÁÇπËµû',
                    authorId: app.authorId,
                    operation: 'Áî®Êà∑‰∫íÂä®'
                });

            } catch (error) {
                logger.error('ÁÇπËµûÊìç‰ΩúÂ§±Ë¥•', {
                    appId: appId,
                    error: error.message,
                    operation: 'Áî®Êà∑‰∫íÂä®Â§±Ë¥•'
                });
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // Êî∂ËóèÂäüËÉΩ
        async function toggleFavorite(appId) {
            if (!currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            // È™åËØÅÁî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄß
            if (!currentUser.id || !currentUser.username) {
                alert('Áî®Êà∑Áä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            // È™åËØÅÁî®Êà∑Âú®‰∫ëÁ´ØÊï∞ÊçÆ‰∏≠ÁöÑÂ≠òÂú®ÊÄß
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('Áî®Êà∑Êï∞ÊçÆÂêåÊ≠•ÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.favorites) app.favorites = [];

                const favoritedIndex = app.favorites.indexOf(currentUser.id);
                const isFavoriting = favoritedIndex === -1;
                
                if (favoritedIndex > -1) {
                    app.favorites.splice(favoritedIndex, 1);
                } else {
                    app.favorites.push(currentUser.id);
                }

                // üî• Ê≠•È™§7: Êõ¥Êñ∞Â∫îÁî®ÊúÄÂêé‰øÆÊîπÊó∂Èó¥
                updateAppLastModified(appId, isFavoriting ? 'Êî∂Ëóè' : 'ÂèñÊ∂àÊî∂Ëóè');

                // üî• Ê≠•È™§12: Á´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                localStorageManager.saveToLocal(cloudData);
                
                // üî• Ê≠•È™§12: Á´ãÂç≥Êõ¥Êñ∞UI
                loadApps();
                
                // üî• Ê≠•È™§23: ÂºÇÊ≠•ÂêåÊ≠•Âà∞‰∫ëÁ´ØÔºà‰∏çÈòªÂ°ûÁî®Êà∑‰ΩìÈ™åÔºâ
                updateStatus('‚òÅÔ∏è Ê≠£Âú®ÂêåÊ≠•Êî∂ËóèÊï∞ÊçÆ...', 'syncing');
                
                // ‰ΩøÁî®ÈáçËØïÊú∫Âà∂ËøõË°åÂêåÊ≠•
                retryOperation('Êî∂ËóèÂêåÊ≠•', syncData).then(() => {
                    updateStatus('‚òÅÔ∏è Êî∂ËóèÂêåÊ≠•ÊàêÂäü', 'connected');
                }).catch((error) => {
                    console.error('Êî∂ËóèÂêåÊ≠•ÊúÄÁªàÂ§±Ë¥•:', error);
                    updateStatus('‚ö†Ô∏è Êî∂ËóèÂ∑≤‰øùÂ≠òÊú¨Âú∞Ôºå‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•', 'error');
                });

                // ËÆ∞ÂΩïÊî∂ËóèÊìç‰Ωú
                logger.info('Êî∂ËóèÊìç‰Ωú', {
                    appId: appId,
                    appName: app.name,
                    action: isFavoriting ? 'Êî∂Ëóè' : 'ÂèñÊ∂àÊî∂Ëóè',
                    authorId: app.authorId,
                    operation: 'Áî®Êà∑‰∫íÂä®'
                });

            } catch (error) {
                logger.error('Êî∂ËóèÊìç‰ΩúÂ§±Ë¥•', {
                    appId: appId,
                    error: error.message,
                    operation: 'Áî®Êà∑‰∫íÂä®Â§±Ë¥•'
                });
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÊòæÁ§∫/ÈöêËóèËØÑËÆ∫
        function showComments(appId) {
            const commentsSection = document.getElementById(`comments-${appId}`);
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
            } else {
                commentsSection.style.display = 'none';
            }
        }

        // Ê∑ªÂä†ËØÑËÆ∫
        async function addComment(appId) {
            if (!currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            // È™åËØÅÁî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄß
            if (!currentUser.id || !currentUser.username) {
                alert('Áî®Êà∑Áä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            // È™åËØÅÁî®Êà∑Âú®‰∫ëÁ´ØÊï∞ÊçÆ‰∏≠ÁöÑÂ≠òÂú®ÊÄß
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('Áî®Êà∑Êï∞ÊçÆÂêåÊ≠•ÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            const input = document.getElementById(`comment-input-${appId}`);
            const content = input.value.trim();
            
            if (!content) {
                alert('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ');
                return;
            }

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app) return;

                if (!app.comments) app.comments = [];

                const newComment = {
                    id: Date.now(),
                    content,
                    author: currentUser.username,
                    authorId: currentUser.id,
                    createdAt: new Date().toISOString()
                };

                app.comments.push(newComment);
                input.value = '';

                // üî• Ê≠•È™§8: Êõ¥Êñ∞Â∫îÁî®ÊúÄÂêé‰øÆÊîπÊó∂Èó¥
                updateAppLastModified(appId, 'Ê∑ªÂä†ËØÑËÆ∫');

                // üî• Ê≠•È™§13: Á´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                localStorageManager.saveToLocal(cloudData);
                
                // üî• Ê≠•È™§13: Á´ãÂç≥Êõ¥Êñ∞UI
                loadApps();
                
                // üî• Ê≠•È™§23: ÂºÇÊ≠•ÂêåÊ≠•Âà∞‰∫ëÁ´ØÔºà‰∏çÈòªÂ°ûÁî®Êà∑‰ΩìÈ™åÔºâ
                updateStatus('‚òÅÔ∏è Ê≠£Âú®ÂêåÊ≠•ËØÑËÆ∫Êï∞ÊçÆ...', 'syncing');
                
                // ‰ΩøÁî®ÈáçËØïÊú∫Âà∂ËøõË°åÂêåÊ≠•
                retryOperation('ËØÑËÆ∫ÂêåÊ≠•', syncData).then(() => {
                    updateStatus('‚òÅÔ∏è ËØÑËÆ∫ÂêåÊ≠•ÊàêÂäü', 'connected');
                }).catch((error) => {
                    console.error('ËØÑËÆ∫ÂêåÊ≠•ÊúÄÁªàÂ§±Ë¥•:', error);
                    updateStatus('‚ö†Ô∏è ËØÑËÆ∫Â∑≤‰øùÂ≠òÊú¨Âú∞Ôºå‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•', 'error');
                });

                // ËÆ∞ÂΩïËØÑËÆ∫Êìç‰Ωú
                logger.info('Ê∑ªÂä†ËØÑËÆ∫', {
                    appId: appId,
                    appName: app.name,
                    commentId: newComment.id,
                    commentContent: content.substring(0, 50) + (content.length > 50 ? '...' : ''),
                    authorId: app.authorId,
                    operation: 'Áî®Êà∑‰∫íÂä®'
                });

            } catch (error) {
                logger.error('Ê∑ªÂä†ËØÑËÆ∫Â§±Ë¥•', {
                    appId: appId,
                    error: error.message,
                    operation: 'Áî®Êà∑‰∫íÂä®Â§±Ë¥•'
                });
                alert('ËØÑËÆ∫Â§±Ë¥•: ' + error.message);
            }
        }

        // Âà†Èô§ËØÑËÆ∫
        async function deleteComment(appId, commentId) {
            if (!currentUser) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                return;
            }

            // È™åËØÅÁî®Êà∑Áä∂ÊÄÅÂÆåÊï¥ÊÄß
            if (!currentUser.id || !currentUser.username) {
                alert('Áî®Êà∑Áä∂ÊÄÅÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            // È™åËØÅÁî®Êà∑Âú®‰∫ëÁ´ØÊï∞ÊçÆ‰∏≠ÁöÑÂ≠òÂú®ÊÄß
            const userExists = cloudData.users.find(u => u.id === currentUser.id);
            if (!userExists) {
                alert('Áî®Êà∑Êï∞ÊçÆÂêåÊ≠•ÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                logout();
                return;
            }

            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü')) return;

            try {
                const app = cloudData.apps.find(app => app.id === appId);
                if (!app || !app.comments) return;

                const comment = app.comments.find(c => c.id === commentId);
                if (!comment || comment.authorId !== currentUser.id) {
                    alert('Âè™ËÉΩÂà†Èô§Ëá™Â∑±ÁöÑËØÑËÆ∫');
                    return;
                }

                app.comments = app.comments.filter(c => c.id !== commentId);

                // ËÆ∞ÂΩïÂà†Èô§ËØÑËÆ∫Êìç‰Ωú
                logger.info('Âà†Èô§ËØÑËÆ∫', {
                    appId: appId,
                    appName: app.name,
                    commentId: commentId,
                    deletedContent: comment.content.substring(0, 50) + (comment.content.length > 50 ? '...' : ''),
                    authorId: app.authorId,
                    operation: 'Áî®Êà∑‰∫íÂä®'
                });

                // Êú¨Âú∞‰ºòÂÖàÁ≠ñÁï•ÔºöÁ´ãÂç≥Êõ¥Êñ∞UIÂíåÊú¨Âú∞ÁºìÂ≠ò
                localCache.saveToLocal(cloudData);
                loadApps(); // Á´ãÂç≥Êõ¥Êñ∞UIÔºåÁî®Êà∑ÁúãÂà∞Âç≥Êó∂ÊïàÊûú
                
                // Ê∑ªÂä†Âà∞ÂºÇÊ≠•ÂêåÊ≠•ÈòüÂàó
                await syncQueue.addOperation({
                    type: 'comment_delete',
                    appId: appId,
                    userId: currentUser.id,
                    commentId: commentId,
                    action: 'Âà†Èô§ËØÑËÆ∫',
                    data: {
                        appName: app.name,
                        deletedContent: comment.content.substring(0, 50) + (comment.content.length > 50 ? '...' : ''),
                        authorId: app.authorId
                    }
                });

                // ÊòæÁ§∫Êìç‰ΩúÂÆåÊàêÁä∂ÊÄÅ
                updateStatus('‚úÖ ËØÑËÆ∫Â∑≤Âà†Èô§', 'connected');
            } catch (error) {
                logger.error('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•', {
                    appId: appId,
                    commentId: commentId,
                    error: error.message,
                    operation: 'Áî®Êà∑‰∫íÂä®Â§±Ë¥•'
                });
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        // ÁßªÂä®Á´ØËèúÂçïÊéßÂà∂
        function toggleMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            const isOpen = menu.classList.contains('active');
            
            if (isOpen) {
                closeMobileMenu();
            } else {
                openMobileMenu();
            }
        }

        function openMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            hamburger.classList.add('active');
            overlay.style.display = 'block';
            
            // Âª∂ËøüÊ∑ªÂä†activeÁ±ª‰ª•Ëß¶ÂèëÂä®Áîª
            setTimeout(() => {
                overlay.classList.add('active');
                menu.classList.add('active');
            }, 10);
            
            // Á¶ÅÊ≠¢ËÉåÊôØÊªöÂä®
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const menu = document.getElementById('mobile-nav-menu');
            
            hamburger.classList.remove('active');
            overlay.classList.remove('active');
            menu.classList.remove('active');
            
            // Âª∂ËøüÈöêËóèÈÅÆÁΩ©Â±Ç‰ª•ÂÆåÊàêÂä®Áîª
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            
            // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
            document.body.style.overflow = '';
        }

        // ÊòæÁ§∫ÂØºËà™
        function showGuestNav() {
            // Ê°åÈù¢Á´ØÂØºËà™
            document.getElementById('guest-nav').style.display = 'flex';
            document.getElementById('user-nav').style.display = 'none';
            document.getElementById('publish-btn').style.display = 'none';
            
            // ÁßªÂä®Á´ØÂØºËà™
            document.getElementById('mobile-guest-nav').style.display = 'block';
            document.getElementById('mobile-user-nav').style.display = 'none';
        }

        function showUserNav() {
            // Ê°åÈù¢Á´ØÂØºËà™
            document.getElementById('guest-nav').style.display = 'none';
            document.getElementById('user-nav').style.display = 'flex';
            document.getElementById('publish-btn').style.display = 'block';

            if (currentUser) {
                // Ê°åÈù¢Á´ØÁî®Êà∑‰ø°ÊÅØ
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
                
                // ÁßªÂä®Á´ØÁî®Êà∑‰ø°ÊÅØ
                document.getElementById('mobile-user-name').textContent = currentUser.username;
                document.getElementById('mobile-user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
            }
            
            // ÁßªÂä®Á´ØÂØºËà™
            document.getElementById('mobile-guest-nav').style.display = 'none';
            document.getElementById('mobile-user-nav').style.display = 'block';
        }

        // Ê®°ÊÄÅÊ°ÜÊìç‰Ωú
        function showModal(modalId) {
            document.body.classList.add('no-scroll');
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.body.classList.remove('no-scroll');
            document.getElementById(modalId).style.display = 'none';
            
            // Â¶ÇÊûúÊòØÂèëÂ∏ÉÊ®°ÊÄÅÊ°ÜÔºåÈáçÁΩÆË°®ÂçïÂíåÁä∂ÊÄÅ
            if (modalId === 'publish-modal') {
                resetPublishModal();
                currentEditingAppId = null;
            }
        }

        function resetPublishModal() {
            document.getElementById('app-name').value = '';
            document.getElementById('app-url').value = '';
            document.getElementById('app-description').value = '';
            document.getElementById('app-category').value = 'ÂÖ∂‰ªñ';
            document.getElementById('screenshot-upload').value = '';
            document.getElementById('screenshot-preview').innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">üì∏</div><div>ÈÄâÊã©Êà™ÂõæÊñπÂºè</div></div>';
            
            // ÈáçÁΩÆÊà™ÂõæÊñπÂºè‰∏∫APIÁîüÊàê
            document.querySelector('input[name="screenshot-method"][value="api"]').checked = true;
            toggleScreenshotMethod();
            
            // ÈáçÁΩÆÊà™ÂõæÂáÜÂ§áÁä∂ÊÄÅ‰∏∫trueÔºàÂÖÅËÆ∏Êó†Êà™ÂõæÂèëÂ∏ÉÔºâ
            isScreenshotReady = true;
            updatePublishButtonState();
        }

        // Êõ¥Êñ∞ÂèëÂ∏ÉÊåâÈíÆÁä∂ÊÄÅ
        function updatePublishButtonState() {
            const publishBtn = document.getElementById('save-app-btn');
            if (!publishBtn) return;
            
            const name = document.getElementById('app-name').value.trim();
            const url = document.getElementById('app-url').value.trim();
            const description = document.getElementById('app-description').value.trim();
            
            // Ê£ÄÊü•ÂøÖÂ°´Â≠óÊÆµÂíåÊà™ÂõæÁä∂ÊÄÅ
            const allFieldsValid = name && url && description;
            const hasScreenshot = hasScreenshotContent();
            const canPublish = allFieldsValid && (isScreenshotReady || !hasScreenshot);
            
            publishBtn.disabled = !canPublish;
            
            if (!canPublish) {
                publishBtn.style.opacity = '0.6';
                publishBtn.style.cursor = 'not-allowed';
                publishBtn.style.transform = 'none';
                publishBtn.style.boxShadow = 'none';
                
                if (!allFieldsValid) {
                    const missingFields = [];
                    if (!name) missingFields.push('ÂêçÁß∞');
                    if (!url) missingFields.push('ÈìæÊé•');
                    if (!description) missingFields.push('ÊèèËø∞');
                    publishBtn.textContent = `ËØ∑Â°´ÂÜô: ${missingFields.join('„ÄÅ')}`;
                } else if (!isScreenshotReady && hasScreenshot) {
                    publishBtn.textContent = '‚è≥ Êà™ÂõæÂ§ÑÁêÜ‰∏≠...';
                }
            } else {
                publishBtn.style.opacity = '1';
                publishBtn.style.cursor = 'pointer';
                publishBtn.style.transform = '';
                publishBtn.style.boxShadow = '';
                publishBtn.textContent = currentEditingAppId ? 'üíæ ‰øùÂ≠òÊõ¥Êîπ' : 'üöÄ ÂèëÂ∏É';
            }
        }

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊà™ÂõæÂÜÖÂÆπÔºà‰ΩÜÊú™ÂáÜÂ§áÂ∞±Áª™Ôºâ
        function hasScreenshotContent() {
            const preview = document.getElementById('screenshot-preview');
            const hasImg = preview.querySelector('img');
            const hasLoading = preview.querySelector('.loading');
            return hasImg || hasLoading;
        }

        // ËÆæÁΩÆÊà™ÂõæÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
        function setScreenshotReady(ready = true) {
            isScreenshotReady = ready;
            updatePublishButtonState();
        }

        // Ê∏ÖÈô§Êà™Âõæ
        function clearScreenshot() {
            const preview = document.getElementById('screenshot-preview');
            const uploadInput = document.getElementById('screenshot-upload');
            
            // ÈáçÁΩÆÈ¢ÑËßàÂå∫Âüü
            preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">üì∏</div><div>ÈÄâÊã©Êà™ÂõæÊñπÂºè</div></div>';
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
            if (uploadInput) {
                uploadInput.value = '';
            }
            
            // ÈáçÁΩÆÊà™ÂõæÁä∂ÊÄÅ‰∏∫ÂáÜÂ§áÂ∞±Áª™ÔºàÂÖÅËÆ∏Êó†Êà™ÂõæÂèëÂ∏ÉÔºâ
            setScreenshotReady(true);
        }

        function showLogin() {
            showModal('login-modal');
        }

        function showRegister() {
            showModal('register-modal');
        }

        function showPublishModal() {
            currentEditingAppId = null;
            document.getElementById('publish-modal-title').textContent = 'ÂèëÂ∏É‰ΩúÂìÅ';
            document.getElementById('save-app-btn').textContent = 'ÂèëÂ∏É';
            
            // Á°Æ‰øùURLÂ≠óÊÆµÂèØÁºñËæë
            document.getElementById('app-url').readOnly = false;
            document.getElementById('app-url').style.background = '';
            
            // ÈáçÁΩÆË°®ÂçïÂπ∂ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÔºàresetPublishModal‰∏≠Â∑≤ÂåÖÂê´Áä∂ÊÄÅÈáçÁΩÆÔºâ
            resetPublishModal();
            showModal('publish-modal');
        }

        function showEditModal(appId) {
            currentEditingAppId = appId;
            const app = cloudData.apps.find(a => a.id === appId);
            if (!app) return;

            document.getElementById('publish-modal-title').textContent = 'ÁºñËæë‰ΩúÂìÅ';
            document.getElementById('save-app-btn').textContent = '‰øùÂ≠òÊõ¥Êîπ';
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('app-name').value = app.name;
            document.getElementById('app-url').value = app.url;
            document.getElementById('app-description').value = app.description;
            document.getElementById('app-category').value = app.category;
            
            const preview = document.getElementById('screenshot-preview');
            if (app.screenshot && app.screenshot.trim()) {
                preview.innerHTML = `<img src="${app.screenshot}" alt="Â∫îÁî®Êà™Âõæ" data-url="${app.screenshot}">`;
                // ÁºñËæëÊ®°Âºè‰∏ãÔºåÂ¶ÇÊûúÂ∑≤ÊúâÊà™ÂõæÔºåÊ†áËÆ∞‰∏∫ÂáÜÂ§áÂ∞±Áª™
                setScreenshotReady(true);
            } else {
                preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">üì∏</div><div>ÈÄâÊã©Êà™ÂõæÊñπÂºè</div></div>';
                // Ê≤°ÊúâÊà™ÂõæÊó∂ÔºåÊ†áËÆ∞‰∏∫ÂáÜÂ§áÂ∞±Áª™ÔºàÂèØ‰ª•‰∏çÈúÄË¶ÅÊà™ÂõæÂèëÂ∏ÉÔºâ
                setScreenshotReady(true);
            }

            // URLÂú®ÁºñËæëÊó∂‰∏çÂèØÊõ¥Êîπ
            document.getElementById('app-url').readOnly = true;
            document.getElementById('app-url').style.background = '#f1f1f1';

            // Êõ¥Êñ∞ÂèëÂ∏ÉÊåâÈíÆÁä∂ÊÄÅ
            updatePublishButtonState();

            showModal('publish-modal');
        }

        // Â§ÑÁêÜÁôªÂΩï
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!username || !password) {
                alert('ËØ∑Â°´ÂÜôÁî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                return;
            }

            // Ê£ÄÊü•Êï∞ÊçÆÁä∂ÊÄÅ
            console.log('ÁôªÂΩïÂ∞ùËØï:', username);

            // Á°Æ‰øùcloudDataÂ∑≤ÂàùÂßãÂåñ
            if (!cloudData || !cloudData.users || cloudData.users.length === 0) {
                logger.warn('ÁôªÂΩïÊó∂ÂèëÁé∞cloudDataÊú™ÂàùÂßãÂåñÔºåÂ∞ùËØïÈáçÊñ∞Âä†ËΩΩ', {
                    username: username,
                    cloudDataExists: !!cloudData,
                    usersExists: !!(cloudData?.users),
                    operation: 'ÁôªÂΩïÊï∞ÊçÆÊ£ÄÊü•'
                });
                
                // Â∞ùËØïÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                try {
                    updateStatus('üîÑ Ê≠£Âú®Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ...', 'syncing');
                    const remoteData = await cloudStorage.loadData();
                    if (remoteData && remoteData.users) {
                        cloudData = remoteData;
                        logger.info('ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÊàêÂäü', { 
                            usersCount: cloudData.users.length,
                            operation: 'ÁôªÂΩïÊó∂Êï∞ÊçÆÈáçËΩΩ'
                        });
                    }
                } catch (error) {
                    logger.error('ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•', { 
                        error: error.message,
                        operation: 'ÁôªÂΩïÊó∂Êï∞ÊçÆÈáçËΩΩÂ§±Ë¥•'
                    });
                    alert('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                    return;
                }
            }

            const user = cloudData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showUserNav();
                closeModal('login-modal');
                
                // üî• Ê≠•È™§2: ÈáçÊñ∞Âä†ËΩΩÂ∫îÁî®ÂàóË°®‰ª•Êõ¥Êñ∞‰∫íÂä®ÊåâÈíÆÁä∂ÊÄÅ
                loadApps();
                
                alert('ÁôªÂΩïÊàêÂäüÔºÅ');
                
                // ÁôªÂΩïÊàêÂäüÂêéÂà∑Êñ∞Â∫îÁî®ÂàóË°®ÔºåÁ°Æ‰øùÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ
                loadApps();
            } else {
                logger.warn('ÁôªÂΩïÂ§±Ë¥•', {
                    username: username,
                    availableUsers: cloudData.users.map(u => u.username),
                    operation: 'ÁôªÂΩïÂ§±Ë¥•'
                });
                alert('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
            }
        }

        // Â§ÑÁêÜÊ≥®ÂÜå
        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();



            if (!username || !email || !password) {
                alert('ËØ∑Â°´ÂÜôÊâÄÊúâÂ≠óÊÆµ');
                return;
            }

            if (password.length < 6) {
                alert('ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å6‰∏™Â≠óÁ¨¶');
                return;
            }

            // Ê£ÄÊü•Áî®Êà∑ÂêçÊòØÂê¶Â∑≤Â≠òÂú®
            if (cloudData.users.some(u => u.username === username)) {
                alert('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®');
                return;
            }

            // Ê£ÄÊü•ÈÇÆÁÆ±ÊòØÂê¶Â∑≤Â≠òÂú®
            if (cloudData.users.some(u => u.email === email)) {
                alert('ÈÇÆÁÆ±Â∑≤Â≠òÂú®');
                return;
            }

            let newUser;
            try {
                newUser = {
                    id: Date.now(),
                    username,
                    email,
                    password,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString() // üî• Ê≠•È™§11: ÂàùÂßãÂåñÊñ∞Áî®Êà∑ÁöÑlastModifiedÂ≠óÊÆµ
                };

                // Âú®Ê∑ªÂä†Áî®Êà∑ÂâçÂàõÂª∫Âø´ÁÖß
                try {
                    logger.snapshot('Áî®Êà∑Ê≥®ÂÜåÂâçÂø´ÁÖß', cloudData.users, {
                        snapshotType: 'users_before_add',
                        operation: 'Áî®Êà∑Ê≥®ÂÜåÂâç',
                        usersCount: cloudData.users.length,
                        newUsername: username
                    });
                } catch (snapshotError) {
                    logger.warn('ÂàõÂª∫Áî®Êà∑Ê≥®ÂÜåÂâçÂø´ÁÖßÂ§±Ë¥•ÔºåÁªßÁª≠ÊâßË°åÊ≥®ÂÜå', { 
                        username: username, 
                        error: snapshotError.message 
                    });
                }

                // Ê∑ªÂä†Áî®Êà∑Âà∞Êú¨Âú∞Êï∞ÊçÆ
                cloudData.users.push(newUser);
                
                // üî• Ê≠•È™§24: Á´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®ÔºàÁ°Æ‰øùÊï∞ÊçÆ‰∏ç‰∏¢Â§±Ôºâ
                localStorageManager.saveToLocal(cloudData);
                
                // Á´ãÂç≥ËÆæÁΩÆÂΩìÂâçÁî®Êà∑ÂíåÊú¨Âú∞Â≠òÂÇ®ÔºàÁ°Æ‰øùÂç≥‰ΩøÂêåÊ≠•Â§±Ë¥•‰πüËÉΩ‰øùÊåÅÁôªÂΩïÁä∂ÊÄÅÔºâ
                currentUser = newUser;
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                showUserNav();
                closeModal('register-modal');
                updateStats();
                
                // üî• Ê≠•È™§1: ÈáçÊñ∞Âä†ËΩΩÂ∫îÁî®ÂàóË°®‰ª•Êõ¥Êñ∞‰∫íÂä®ÊåâÈíÆÁä∂ÊÄÅ
                loadApps();

                // Â∞ùËØïÂêåÊ≠•Âà∞‰∫ëÁ´ØÔºå‰ΩÜ‰∏çÈòªÂ°ûÁî®Êà∑‰ΩìÈ™å
                updateStatus('‚òÅÔ∏è Ê≠£Âú®‰øùÂ≠òÁî®Êà∑Êï∞ÊçÆ...', 'syncing');
                
                try {
                    await syncData();
                    alert('Ê≥®ÂÜåÊàêÂäüÔºÅÁî®Êà∑Êï∞ÊçÆÂ∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´Ø');
                } catch (syncError) {
                    console.error('Áî®Êà∑Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•:', syncError);
                    alert('Ê≥®ÂÜåÊàêÂäüÔºÅ‰ΩÜÊï∞ÊçÆÂêåÊ≠•Â§±Ë¥•ÔºåÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ');
                    updateStatus('‚ö†Ô∏è Êï∞ÊçÆ‰ªÖ‰øùÂ≠òÂú®Êú¨Âú∞', 'error');
                    
                    // ËÆæÁΩÆÂÆöÊó∂ÈáçËØïÂêåÊ≠•
                    setTimeout(async () => {
                        try {
                            await syncData();
                            updateStatus('‚òÅÔ∏è Êï∞ÊçÆÂêåÊ≠•ÊàêÂäü', 'connected');
                        } catch (retryError) {
                            console.error('ÈáçËØïÂêåÊ≠•Â§±Ë¥•:', retryError);
                        }
                    }, 5000); // 5ÁßíÂêéÈáçËØï
                }

            } catch (error) {
                // ÁßªÈô§Â∑≤Ê∑ªÂä†ÁöÑÁî®Êà∑Êï∞ÊçÆÔºàÂ¶ÇÊûúÊ∑ªÂä†Â§±Ë¥•Ôºâ
                cloudData.users = cloudData.users.filter(u => u.id !== newUser?.id);
                alert('Ê≥®ÂÜåÂ§±Ë¥•: ' + error.message);
            }
        }

        // Â§ÑÁêÜÂèëÂ∏É/ÁºñËæëÂ∫îÁî®
        async function handleSaveApp() {
            const name = document.getElementById('app-name').value.trim();
            const url = document.getElementById('app-url').value.trim();
            const description = document.getElementById('app-description').value.trim();
            const category = document.getElementById('app-category').value;

            if (!name || !url || !description) {
                alert('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÈúÄÂ≠óÊÆµ');
                return;
            }

            // ËÆ∞ÂΩïÂ∫îÁî®‰øùÂ≠òÊìç‰ΩúÂºÄÂßã
            const operationType = currentEditingAppId ? 'ÁºñËæëÂ∫îÁî®' : 'ÂèëÂ∏ÉÊñ∞Â∫îÁî®';
            logger.info(`${operationType}Êìç‰ΩúÂºÄÂßã`, {
                appId: currentEditingAppId,
                appName: name,
                appUrl: url,
                category: category,
                operation: operationType
            });

            // Ëé∑ÂèñÊà™ÂõæÊï∞ÊçÆ
            const previewImg = document.querySelector('#screenshot-preview img');
            let screenshot = '';
            
            if (previewImg) {
                // Âè™‰ΩøÁî® data-url Â±ûÊÄßÔºåÁ°Æ‰øùÂè™Â≠òÂÇ®URL
                const urlData = previewImg.getAttribute('data-url');
                const base64Data = previewImg.getAttribute('data-base64');
                
                if (urlData) {
                    screenshot = urlData;
                    logger.info('‰ΩøÁî®Â∑≤‰∏ä‰º†ÁöÑÊà™ÂõæURL', { screenshotUrl: urlData, source: 'Â§ñÈÉ®Â≠òÂÇ®' });
                } else if (base64Data) {
                    // Â¶ÇÊûúÂ≠òÂú®Base64Êï∞ÊçÆÔºåÂÖà‰∏ä‰º†ÂêéËé∑ÂèñURL
                    logger.info('Ê£ÄÊµãÂà∞Base64Êà™ÂõæÊï∞ÊçÆÔºåÂºÄÂßã‰∏ä‰º†', { source: 'Base64ËΩ¨Êç¢' });
                    try {
                        screenshot = await uploadImageToStorage(base64Data, true);
                        logger.info('Base64Êà™Âõæ‰∏ä‰º†ÊàêÂäü', { screenshotUrl: screenshot });
                    } catch (error) {
                        logger.error('Base64Êà™Âõæ‰∏ä‰º†Â§±Ë¥•', { error: error.message });
                        console.error('‰∏ä‰º†Êà™ÂõæÂ§±Ë¥•:', error);
                        alert('Êà™Âõæ‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©Êà™Âõæ');
                        return;
                    }
                }
            }
            
            // ËÆ∞ÂΩïÊà™ÂõæÊù•Ê∫ê‰ø°ÊÅØ
            const screenshotSource = previewImg ? 
                (previewImg.getAttribute('data-url') ? 'Â§ñÈÉ®Â≠òÂÇ®URL' : 
                 previewImg.getAttribute('data-base64') ? 'APIÁîüÊàêÊà™Âõæ' : 'Êó†Êà™Âõæ') : 'Êó†Êà™Âõæ';
            logger.info('Êà™Âõæ‰ø°ÊÅØÁ°ÆËÆ§', { 
                hasScreenshot: !!screenshot, 
                source: screenshotSource,
                screenshotUrl: screenshot ? screenshot.substring(0, 100) + '...' : null 
            });
            
            // Âú®Êï∞ÊçÆ‰øÆÊîπÂâçÂàõÂª∫Âø´ÁÖß
            try {
                if (currentEditingAppId) {
                    // ÁºñËæëÊ®°ÂºèÔºö‰øùÂ≠ò‰øÆÊîπÂâçÁöÑÂ∫îÁî®Êï∞ÊçÆ
                    const originalApp = cloudData.apps.find(a => a.id === currentEditingAppId);
                    if (originalApp) {
                        logger.snapshot(`ÁºñËæëÂ∫îÁî®ÂâçÂø´ÁÖß: ${originalApp.name}`, originalApp, {
                            snapshotType: 'app_edit_before',
                            appId: currentEditingAppId,
                            operation: 'Â∫îÁî®ÁºñËæëÂâç'
                        });
                    }
                } else {
                    // ÂèëÂ∏ÉÊñ∞Â∫îÁî®Ê®°ÂºèÔºö‰øùÂ≠òÊ∑ªÂä†ÂâçÁöÑappsÊï∞ÁªÑÁä∂ÊÄÅ
                    logger.snapshot('ÂèëÂ∏ÉÊñ∞Â∫îÁî®ÂâçÂø´ÁÖß', cloudData.apps, {
                        snapshotType: 'apps_before_add',
                        operation: 'Êñ∞Â∫îÁî®ÂèëÂ∏ÉÂâç',
                        appsCount: cloudData.apps.length
                    });
                }
            } catch (snapshotError) {
                logger.warn('ÂàõÂª∫Êï∞ÊçÆÂø´ÁÖßÂ§±Ë¥•ÔºåÁªßÁª≠ÊâßË°åÊìç‰Ωú', { error: snapshotError.message });
            }
            
            try {
                if (currentEditingAppId) {
                    // ÁºñËæëÊ®°Âºè
                    const app = cloudData.apps.find(a => a.id === currentEditingAppId);
                    if (app) {
                        app.name = name;
                        app.description = description;
                        app.category = category;
                        app.screenshot = screenshot;
                        app.lastModified = new Date().toISOString(); // üî• Ê≠•È™§10: Êõ¥Êñ∞ÁºñËæëÂ∫îÁî®ÁöÑlastModified
                    }
                } else {
                    // ÂèëÂ∏ÉÊñ∞Â∫îÁî®Ê®°Âºè
                    const newApp = {
                        id: Date.now(),
                        name,
                        url,
                        description,
                        category,
                        author: currentUser.username,
                        authorId: currentUser.id,
                        screenshot,
                        likes: [],
                        favorites: [],
                        comments: [],
                        createdAt: new Date().toISOString(),
                        lastModified: new Date().toISOString() // üî• Ê≠•È™§9: ÂàùÂßãÂåñlastModifiedÂ≠óÊÆµ
                    };
                    cloudData.apps.push(newApp);
                }

                // üî• Ê≠•È™§24: Á´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®ÔºàÁ°Æ‰øùÊï∞ÊçÆ‰∏ç‰∏¢Â§±Ôºâ
                localStorageManager.saveToLocal(cloudData);
                
                // ÂÖàÊõ¥Êñ∞UIÔºåÁ°Æ‰øùÁî®Êà∑ËÉΩÁ´ãÂç≥ÁúãÂà∞ÂèòÂåñ
                closeModal('publish-modal');
                updateStats();
                loadApps();

                // Ê∑ªÂä†Âà∞ÂºÇÊ≠•ÂêåÊ≠•ÈòüÂàó
                await syncQueue.addOperation({
                    type: currentEditingAppId ? 'app_edit' : 'app_publish',
                    appId: currentEditingAppId || Date.now(),
                    userId: currentUser.id,
                    action: currentEditingAppId ? 'ÁºñËæëÂ∫îÁî®' : 'ÂèëÂ∏ÉÂ∫îÁî®',
                    data: {
                        appName: name,
                        appUrl: url,
                        category: category,
                        hasScreenshot: !!screenshot
                    }
                });

                // ÊòæÁ§∫Êìç‰ΩúÂÆåÊàêÁä∂ÊÄÅ
                updateStatus(currentEditingAppId ? '‚úÖ Â∫îÁî®Â∑≤Êõ¥Êñ∞' : '‚úÖ Â∫îÁî®Â∑≤ÂèëÂ∏É', 'connected');
                alert(currentEditingAppId ? 'Â∫îÁî®Êõ¥Êñ∞ÊàêÂäüÔºÅ' : 'Â∫îÁî®ÂèëÂ∏ÉÊàêÂäüÔºÅ');

            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            } finally {
                currentEditingAppId = null; // Êìç‰ΩúÂÆåÊàêÂêéÈáçÁΩÆ
            }
        }

        // Áªü‰∏ÄÂõæÁâá‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
        async function uploadImageToStorage(imageData, isBase64 = false) {
            logger.info('ÂºÄÂßãÂõæÁâá‰∏ä‰º†Â§ÑÁêÜ', { 
                dataType: isBase64 ? 'Base64' : 'URL',
                dataSize: imageData ? imageData.length : 0,
                operation: 'ÂõæÁâá‰∏ä‰º†'
            });
            
            try {
                let base64Payload;
                
                if (isBase64) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØBase64ÔºåÊèêÂèñpayloadÈÉ®ÂàÜ
                    if (imageData.startsWith('data:')) {
                        base64Payload = imageData.split(',')[1];
                    } else {
                        base64Payload = imageData;
                    }
                } else {
                    // Â¶ÇÊûúÊòØURLÔºåÂÖàËΩ¨Êç¢‰∏∫Base64
                    const response = await fetch(imageData);
                    const blob = await response.blob();
                    
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            base64Payload = e.target.result.split(',')[1];
                            
                            try {
                                const res = await fetch('/.netlify/functions/upload-image', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ image: base64Payload })
                                });
                                const result = await res.json();
                                if (!res.ok) throw new Error(result.error || 'Upload failed');
                                resolve(result.url);
                            } catch (err) {
                                reject(err);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                }
                
                // ‰∏ä‰º†Base64Êï∞ÊçÆ
                const res = await fetch('/.netlify/functions/upload-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Payload })
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Upload failed');
                
                logger.info('ÂõæÁâá‰∏ä‰º†ÊàêÂäü', { 
                    uploadedUrl: result.url,
                    operation: 'ÂõæÁâá‰∏ä‰º†ÊàêÂäü'
                });
                return result.url;
            } catch (error) {
                logger.error('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•', { 
                    error: error.message,
                    operation: 'ÂõæÁâá‰∏ä‰º†Â§±Ë¥•'
                });
                console.error('‰∏ä‰º†ÂõæÁâáÂ§±Ë¥•:', error);
                throw error;
            }
        }

        // ÁîüÊàêÊà™Âõæ
        function generateScreenshot() {
            const url = document.getElementById('app-url').value.trim();
            if (!url) {
                alert('ËØ∑ÂÖàÂ°´ÂÜô"‰ΩúÂìÅÈìæÊé•"Â≠óÊÆµÔºåÁÑ∂ÂêéÂÜçÁîüÊàêÊà™Âõæ');
                return;
            }

            // È™åËØÅURLÊ†ºÂºè
            try {
                new URL(url);
            } catch (e) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁΩëÂùÄÈìæÊé•ÔºàÂ¶ÇÔºöhttps://example.comÔºâ');
                return;
            }

            // ËÆæÁΩÆÊà™ÂõæÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
            setScreenshotReady(false);

            // ËÆ∞ÂΩïÊà™ÂõæAPIË∞ÉÁî®ÂºÄÂßã
            logger.info('ÂºÄÂßãË∞ÉÁî®Êà™ÂõæAPI', { 
                targetUrl: url, 
                timestamp: new Date().toISOString(),
                operation: 'Ëá™Âä®ÁîüÊàêÊà™Âõæ'
            });

            const preview = document.getElementById('screenshot-preview');
            preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">Ê≠£Âú®ÁîüÊàêÊà™Âõæ...</span>';

            // ‰ΩøÁî®Â§ö‰∏™Â§áÁî®Êà™ÂõæÊúçÂä°
            const screenshotServices = [
                `/.netlify/functions/screenshot-proxy?url=${encodeURIComponent(url)}`,
                `https://image.thum.io/get/width/1200/crop/800/noanimate/${encodeURIComponent(url)}`,
                `https://mini.s-shot.ru/1200x800/PNG/?${encodeURIComponent(url)}`
            ];

            let currentServiceIndex = 0;

            function tryNextService() {
                if (currentServiceIndex >= screenshotServices.length) {
                    logger.error('ÊâÄÊúâÊà™ÂõæÊúçÂä°ÈÉΩÂ§±Ë¥•', { 
                        targetUrl: url, 
                        attemptedServices: screenshotServices.length,
                        operation: 'Êà™ÂõæAPIË∞ÉÁî®Â§±Ë¥•'
                    });
                    preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">‚ùå</div><div>Êà™ÂõæÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®‰∏ä‰º†ÂõæÁâá</div></div>';
                    
                    // ÊâÄÊúâÊà™ÂõæÊúçÂä°ÈÉΩÂ§±Ë¥•ÔºåÊà™ÂõæÊú™ÂáÜÂ§áÂ∞±Áª™
                    setScreenshotReady(false);
                    return;
                }

                const screenshotUrl = screenshotServices[currentServiceIndex];
                logger.info(`Â∞ùËØïÊà™ÂõæÊúçÂä° ${currentServiceIndex + 1}`, { 
                    service: screenshotUrl, 
                    serviceIndex: currentServiceIndex,
                    operation: 'Êà™ÂõæÊúçÂä°Ë∞ÉÁî®'
                });
                const img = new Image();
                
                img.onload = function() {
                    preview.innerHTML = `<img src="${screenshotUrl}" alt="ÁΩëÁ´ôÊà™Âõæ">`;
                    
                    // ÊòæÁ§∫ËΩ¨Êç¢Áä∂ÊÄÅ
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(255,149,0,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                    statusDiv.textContent = 'Ê≠£Âú®‰ºòÂåñÊà™Âõæ...';
                    preview.style.position = 'relative';
                    preview.appendChild(statusDiv);
                    
                    // ‰∏ä‰º†Êà™ÂõæÂà∞Â§ñÈÉ®Â≠òÂÇ®
                    uploadImageToStorage(screenshotUrl, false).then(function(uploadedUrl) {
                        // ÁßªÈô§Áä∂ÊÄÅÊèêÁ§∫
                        if (statusDiv.parentNode) {
                            statusDiv.remove();
                        }
                        
                        if (uploadedUrl) {
                            // Â¶ÇÊûú‰∏ä‰º†ÊàêÂäüÔºåËÆæÁΩÆURLÂπ∂Ê†áËÆ∞Êà™ÂõæÂáÜÂ§áÂ∞±Áª™
                            logger.info('Êà™ÂõæÁîüÊàêÂπ∂‰∏ä‰º†ÊàêÂäü', { 
                                service: screenshotUrl, 
                                serviceIndex: currentServiceIndex,
                                uploadedUrl: uploadedUrl,
                                operation: 'Êà™ÂõæAPIÊàêÂäü'
                            });
                            const previewImg = preview.querySelector('img');
                            if (previewImg) {
                                previewImg.setAttribute('data-url', uploadedUrl);
                                
                                // ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
                                const successDiv = document.createElement('div');
                                successDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(40,167,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                                successDiv.textContent = '‚úì Êà™ÂõæÂ∑≤Â∞±Áª™';
                                preview.appendChild(successDiv);
                                
                                // ËÆæÁΩÆÊà™ÂõæÂáÜÂ§áÂ∞±Áª™
                                setScreenshotReady(true);
                                
                                // 3ÁßíÂêéÁßªÈô§ÊàêÂäüÊèêÁ§∫
                                setTimeout(() => {
                                    if (successDiv.parentNode) {
                                        successDiv.remove();
                                    }
                                }, 3000);
                            }
                        } else {
                            // ‰∏ä‰º†Â§±Ë¥•ÔºåÊà™ÂõæÊú™ÂáÜÂ§áÂ∞±Áª™
                            logger.warn('Êà™ÂõæÁîüÊàêÊàêÂäü‰ΩÜ‰∏ä‰º†Â§±Ë¥•', { 
                                service: screenshotUrl, 
                                serviceIndex: currentServiceIndex,
                                operation: 'Êà™Âõæ‰∏ä‰º†Â§±Ë¥•'
                            });
                            const errorDiv = document.createElement('div');
                            errorDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(220,53,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                            errorDiv.textContent = '‚ö† Êà™Âõæ‰∏ä‰º†Â§±Ë¥•';
                            preview.appendChild(errorDiv);
                            
                            // Êà™Âõæ‰∏ä‰º†Â§±Ë¥•Ôºå‰øùÊåÅÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
                            setScreenshotReady(false);
                            
                            // 5ÁßíÂêéÁßªÈô§ÈîôËØØÊèêÁ§∫
                            setTimeout(() => {
                                if (errorDiv.parentNode) {
                                    errorDiv.remove();
                                }
                            }, 5000);
                        }
                    }).catch(function(error) {
                        // ÁßªÈô§Áä∂ÊÄÅÊèêÁ§∫
                        if (statusDiv.parentNode) {
                            statusDiv.remove();
                        }
                        
                        logger.error('Êà™Âõæ‰∏ä‰º†ÂºÇÂ∏∏', { 
                            service: screenshotUrl, 
                            serviceIndex: currentServiceIndex,
                            error: error.message,
                            operation: 'Êà™Âõæ‰∏ä‰º†ÂºÇÂ∏∏'
                        });
                        console.error('Êà™Âõæ‰∏ä‰º†Â§±Ë¥•:', error);
                        const errorDiv = document.createElement('div');
                        errorDiv.style.cssText = 'position: absolute; bottom: 8px; left: 8px; background: rgba(220,53,69,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;';
                        errorDiv.textContent = '‚ö† Êà™Âõæ‰∏ä‰º†Â§±Ë¥•';
                        preview.appendChild(errorDiv);
                        
                        // Êà™Âõæ‰∏ä‰º†Â§±Ë¥•Ôºå‰øùÊåÅÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
                        setScreenshotReady(false);
                        
                        // 5ÁßíÂêéÁßªÈô§ÈîôËØØÊèêÁ§∫
                        setTimeout(() => {
                            if (errorDiv.parentNode) {
                                errorDiv.remove();
                            }
                        }, 5000);
                    });
                };
                
                img.onerror = function() {
                    logger.warn(`Êà™ÂõæÊúçÂä° ${currentServiceIndex + 1} Â§±Ë¥•`, { 
                        service: screenshotUrl, 
                        serviceIndex: currentServiceIndex,
                        operation: 'Êà™ÂõæÊúçÂä°Â§±Ë¥•',
                        nextAttempt: currentServiceIndex + 1 < screenshotServices.length
                    });
                    console.log(`Êà™ÂõæÊúçÂä° ${currentServiceIndex + 1} Â§±Ë¥•: ${screenshotUrl}`);
                    currentServiceIndex++;
                    setTimeout(tryNextService, 1000);
                };
                
                img.src = screenshotUrl;
            }

            setTimeout(tryNextService, 2000);
        }

        // ÂàáÊç¢Êà™ÂõæÊñπÂºè
        function toggleScreenshotMethod() {
            const apiSection = document.getElementById('screenshot-api-section');
            const uploadSection = document.getElementById('screenshot-upload-section');
            const selectedMethod = document.querySelector('input[name="screenshot-method"]:checked').value;

            if (selectedMethod === 'api') {
                apiSection.style.display = 'block';
                uploadSection.style.display = 'none';
            } else {
                apiSection.style.display = 'none';
                uploadSection.style.display = 'block';
            }
        }

        // Â§ÑÁêÜÂõæÁâá‰∏ä‰º†
        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // ËÆæÁΩÆÊà™ÂõæÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
            setScreenshotReady(false);

            // ËÆ∞ÂΩïÊâãÂä®‰∏ä‰º†ÂºÄÂßã
            logger.info('Áî®Êà∑ÂºÄÂßãÊâãÂä®‰∏ä‰º†ÂõæÁâá', { 
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                operation: 'ÊâãÂä®‰∏ä‰º†ÂõæÁâá'
            });

            if (!file.type.startsWith('image/')) {
                logger.warn('Áî®Êà∑Â∞ùËØï‰∏ä‰º†ÈùûÂõæÁâáÊñá‰ª∂', { fileName: file.name, fileType: file.type });
                alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
                // ‰∏ä‰º†Â§±Ë¥•Ôºå‰øùÊåÅÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
                setScreenshotReady(false);
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB ÂàùÂßãÈôêÂà∂ÔºåÂêéÁª≠‰ºöËá™Âä®ÂéãÁº©
                logger.warn('Áî®Êà∑‰∏ä‰º†Êñá‰ª∂ËøáÂ§ß', { fileName: file.name, fileSize: file.size });
                alert('ÂõæÁâáÊñá‰ª∂‰∏çËÉΩË∂ÖËøá10MB');
                // ‰∏ä‰º†Â§±Ë¥•Ôºå‰øùÊåÅÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
                setScreenshotReady(false);
                return;
            }
            
            const preview = document.getElementById('screenshot-preview');
            preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">Ê≠£Âú®ÂéãÁº©ÂõæÁâá...</span>';

            const options = {
                maxSizeMB: 0.2, // ÂéãÁº©Âà∞Á∫¶200KB
                maxWidthOrHeight: 1024,
                fileType: 'image/jpeg',
                useWebWorker: true,
                onProgress: (p) => {
                    const progressSpan = preview.querySelector('span');
                    if (progressSpan) {
                        progressSpan.textContent = `Ê≠£Âú®ÂéãÁº©ÂõæÁâá... ${p}%`;
                    }
                },
            };

            try {
                const compressedFile = await imageCompression(file, options);
                
                logger.info('ÂõæÁâáÂéãÁº©ÊàêÂäü', { 
                    originalSize: file.size,
                    compressedSize: compressedFile.size,
                    compressionRatio: Math.round((1 - compressedFile.size / file.size) * 100),
                    operation: 'ÂõæÁâáÂéãÁº©ÊàêÂäü'
                });
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64DataFull = e.target.result;
                    const base64Payload = base64DataFull.split(',')[1];

                    preview.innerHTML = '<div class="loading"></div><span style="margin-left: 10px;">Ê≠£Âú®‰∏ä‰º†ÂõæÁâá...</span>';

                    try {
                        const res = await fetch('/.netlify/functions/upload-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: base64Payload })
                        });
                        const result = await res.json();
                        if (!res.ok) throw new Error(result.error || 'Upload failed');

                        const imgUrl = result.url;
                        logger.info('ÊâãÂä®‰∏ä‰º†ÂõæÁâáÊàêÂäü', { 
                            uploadedUrl: imgUrl,
                            finalSize: compressedFile.size,
                            operation: 'ÊâãÂä®‰∏ä‰º†ÊàêÂäü'
                        });
                        const img = `<img src="${imgUrl}" alt="‰∏ä‰º†ÁöÑÊà™Âõæ" data-url="${imgUrl}">`;
                        preview.innerHTML = img;

                        // ÂõæÁâá‰∏ä‰º†ÊàêÂäüÔºåËÆæÁΩÆÊà™ÂõæÂáÜÂ§áÂ∞±Áª™
                        setScreenshotReady(true);

                    } catch (err) {
                        logger.error('ÊâãÂä®‰∏ä‰º†ÂõæÁâáÂ§±Ë¥•', { 
                            error: err.message,
                            operation: 'ÊâãÂä®‰∏ä‰º†Â§±Ë¥•'
                        });
                        console.error(err);
                        alert('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•');
                        preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">‚ùå</div><div>‰∏ä‰º†Â§±Ë¥•</div></div>';
                        
                        // ÂõæÁâá‰∏ä‰º†Â§±Ë¥•Ôºå‰øùÊåÅÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
                        setScreenshotReady(false);
                    }
                };
                reader.readAsDataURL(compressedFile);

            } catch (error) {
                console.error(error);
                alert('ÂõæÁâáÂéãÁº©Â§±Ë¥•ÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÂõæÁâáÊàñÊç¢‰∏™ÊµèËßàÂô®„ÄÇ');
                preview.innerHTML = '<div class="placeholder"><div style="font-size: 2rem;">‚ùå</div><div>ÂéãÁº©Â§±Ë¥•</div></div>';
                
                // ÂõæÁâáÂéãÁº©Â§±Ë¥•Ôºå‰øùÊåÅÊú™ÂáÜÂ§áÂ∞±Áª™Áä∂ÊÄÅ
                setScreenshotReady(false);
            }
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showGuestNav();
            loadApps();
        }

        // ÈáçÁΩÆÊâÄÊúâÊêúÁ¥¢Êù°‰ª∂
        function resetSearchConditions() {
            // Ê°åÈù¢Á´Ø
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');
            const sortFilter = document.getElementById('sort-filter');
            
            if (searchInput) searchInput.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (sortFilter) sortFilter.value = 'newest';
            
            // ÁßªÂä®Á´Ø
            const searchInputMobile = document.getElementById('search-input-mobile');
            const categoryFilterMobile = document.getElementById('category-filter-mobile');
            const sortFilterMobile = document.getElementById('sort-filter-mobile');
            
            if (searchInputMobile) searchInputMobile.value = '';
            if (categoryFilterMobile) categoryFilterMobile.value = '';
            if (sortFilterMobile) sortFilterMobile.value = 'newest';

            // ÈáçÁΩÆËá™ÂÆö‰πâ‰∏ãÊãâËèúÂçïÁöÑÊòæÁ§∫Áä∂ÊÄÅ
            updateDropdownSelection('category', '');
            updateDropdownSelection('sort', 'newest');
            updateDropdownSelection('category-mobile', '');
            updateDropdownSelection('sort-mobile', 'newest');
        }

        // ËøîÂõûÈ¶ñÈ°µ
        function goHome() {
            resetSearchConditions();
            loadApps();
        }

        // Âà∑Êñ∞Êï∞ÊçÆ
        async function forceRefreshData() {
            try {
                updateStatus('üîÑ Ê≠£Âú®Âà∑Êñ∞...', 'syncing');
                
                // Ê∏ÖÈô§Êú¨Âú∞ÁºìÂ≠ò
                localCache.clearPendingOperations();
                localStorage.removeItem('beestoreCloudData');
                localStorage.removeItem('beestoreCloudMeta');
                
                // ÈáçÊñ∞Âä†ËΩΩ‰∫ëÁ´ØÊï∞ÊçÆ
                const remoteData = await cloudStorage.loadData();
                
                if (remoteData && remoteData.users && Array.isArray(remoteData.users)) {
                    cloudData = remoteData;
                    localCache.saveToLocal(cloudData);
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÁïåÈù¢
                    initializeInterface();
                    
                    logger.info('Âà∑Êñ∞Êï∞ÊçÆÊàêÂäü', {
                        usersCount: cloudData.users?.length || 0,
                        appsCount: cloudData.apps?.length || 0,
                        operation: 'Âà∑Êñ∞Êï∞ÊçÆ'
                    });
                    
                    updateStatus('üì± Â∑≤ËøûÊé•', 'connected');
                } else {
                    throw new Error('Êï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏');
                }
            } catch (error) {
                logger.error('Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•', {
                    error: error.message,
                    operation: 'Âà∑Êñ∞Â§±Ë¥•'
                });
                updateStatus('üì± Â∑≤ËøûÊé•', 'connected');
            }
        }



        // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂Â§ÑÁêÜ
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1024) {
                // Ê°åÈù¢Á´ØÊ®°Âºè‰∏ãÂÖ≥Èó≠ÁßªÂä®Á´ØËèúÂçï
                closeMobileMenu();
            }
        });

        // ÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });

        // Ëá™ÂÆö‰πâ‰∏ãÊãâËèúÂçïÂäüËÉΩ
        function toggleDropdown(type) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            const isShow = dropdown.classList.contains('show');
            
            // ÂÖ≥Èó≠ÊâÄÊúâÂÖ∂‰ªñ‰∏ãÊãâËèúÂçï
            closeAllDropdowns();
            
            if (!isShow) {
                dropdown.classList.add('show');
                trigger.classList.add('active');
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Âà∞‰∏ãÊãâËèúÂçïÈ°π
                const items = dropdown.querySelectorAll('.dropdown-item');
                items.forEach(item => {
                    item.onclick = function() {
                        selectDropdownItem(type, this);
                    };
                });
            }
        }

        function selectDropdownItem(type, item) {
            const value = item.getAttribute('data-value');
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            dropdown.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            // Êõ¥Êñ∞ÈöêËóèÁöÑselectÂÄº
            if (type.includes('category')) {
                const selectId = type.includes('mobile') ? 'category-filter-mobile' : 'category-filter';
                document.getElementById(selectId).value = value;
                
                // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†áÔºàÂèØÈÄâÔºâ
                if (value) {
                    const emoji = item.textContent.split(' ')[0]; // Ëé∑Âèñemoji
                    trigger.textContent = emoji;
                } else {
                    trigger.textContent = 'üè∑Ô∏è';
                }
            } else if (type.includes('sort')) {
                const selectId = type.includes('mobile') ? 'sort-filter-mobile' : 'sort-filter';
                document.getElementById(selectId).value = value;
                
                // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†á
                if (value === 'newest' || value === 'oldest') {
                    trigger.textContent = 'üìÖ';
                } else if (value === 'name') {
                    trigger.textContent = 'üî§';
                } else if (value === 'author') {
                    trigger.textContent = 'üë§';
                }
            }
            
            // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
            dropdown.classList.remove('show');
            trigger.classList.remove('active');
            
            // Ëß¶ÂèëÊêúÁ¥¢
            searchApps();
        }

        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            const triggers = document.querySelectorAll('.dropdown-trigger');
            
            dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
            triggers.forEach(trigger => trigger.classList.remove('active'));
        }

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-dropdown')) {
                closeAllDropdowns();
            }
        });

        // ÂêåÊ≠•Ê°åÈù¢Á´ØÂíåÁßªÂä®Á´ØÁöÑÁ≠õÈÄâÂô®ÈÄâÊã©
        function syncCustomDropdowns() {
            // ÂêåÊ≠•ÂàÜÁ±ªÈÄâÊã©
            const categoryDesktop = document.getElementById('category-filter').value;
            const categoryMobile = document.getElementById('category-filter-mobile').value;
            
            if (categoryDesktop !== categoryMobile) {
                // Êõ¥Êñ∞ÁßªÂä®Á´Ø
                updateDropdownSelection('category-mobile', categoryDesktop);
                document.getElementById('category-filter-mobile').value = categoryDesktop;
            }
            
            // ÂêåÊ≠•ÊéíÂ∫èÈÄâÊã©
            const sortDesktop = document.getElementById('sort-filter').value;
            const sortMobile = document.getElementById('sort-filter-mobile').value;
            
            if (sortDesktop !== sortMobile) {
                // Êõ¥Êñ∞ÁßªÂä®Á´Ø
                updateDropdownSelection('sort-mobile', sortDesktop);
                document.getElementById('sort-filter-mobile').value = sortDesktop;
            }
        }

        function updateDropdownSelection(type, value) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            const trigger = document.getElementById(`${type}-trigger`);
            
            if (!dropdown || !trigger) return;
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            dropdown.querySelectorAll('.dropdown-item').forEach(i => {
                i.classList.remove('selected');
                if (i.getAttribute('data-value') === value) {
                    i.classList.add('selected');
                    
                    // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†á
                    if (type.includes('category')) {
                        if (value) {
                            const emoji = i.textContent.split(' ')[0];
                            trigger.textContent = emoji;
                        } else {
                            trigger.textContent = 'üè∑Ô∏è';
                        }
                    } else if (type.includes('sort')) {
                        if (value === 'newest' || value === 'oldest') {
                            trigger.textContent = 'üìÖ';
                        } else if (value === 'name') {
                            trigger.textContent = 'üî§';
                        } else if (value === 'author') {
                            trigger.textContent = 'üë§';
                        }
                    }
                }
            });
        }

        // Êó•ÂøóÊü•ÁúãÂäüËÉΩ
        let currentLogTab = 'local'; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊó•ÂøóÈÄâÈ°πÂç°

        function showLogViewer() {
            // Âè™ÊúâadminË¥¶Âè∑ÂèØ‰ª•Êü•ÁúãÊó•Âøó
            if (!currentUser || currentUser.username !== 'admin') {
                alert('ÊÇ®Ê≤°ÊúâÊùÉÈôêÊü•ÁúãÁ≥ªÁªüÊó•ÂøóÔºå‰ªÖÈôêadminË¥¶Âè∑ËÆøÈóÆ');
                return;
            }
            
            showModal('log-viewer-modal');
            // ÂêØÂä®ÈáçËØïÊú∫Âà∂
            logger.retryFailedLogs().catch(e => console.warn('ÈáçËØïÂ§±Ë¥•Êó•ÂøóÊó∂Âá∫Èîô:', e));
            refreshLogs();
        }

        function switchLogTab(tab) {
            currentLogTab = tab;
            
            // Êõ¥Êñ∞ÈÄâÈ°πÂç°Ê†∑Âºè
            document.getElementById('local-logs-tab').classList.toggle('active', tab === 'local');
            document.getElementById('cloud-logs-tab').classList.toggle('active', tab === 'cloud');
            
            // Âà∑Êñ∞Êó•ÂøóÂÜÖÂÆπ
            refreshLogs();
        }

        async function refreshLogs() {
            const levelFilter = document.getElementById('log-level-filter').value;
            const usernameFilter = document.getElementById('log-username-filter').value.trim();
            const logContent = document.getElementById('log-content');
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            logContent.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;"><div class="loading" style="margin: 0 auto;"></div><br/>Ê≠£Âú®Âä†ËΩΩÊó•Âøó...</div>';
            
            let logs = [];
            
            try {
                if (currentLogTab === 'cloud') {
                    // Ëé∑Âèñ‰∫ëÁ´ØÊó•Âøó
                    logs = await logger.getCloudLogs(200, levelFilter || null, usernameFilter || null);
                } else {
                    // Ëé∑ÂèñÊú¨Âú∞Êó•Âøó
                    logs = logger.getLogs(200, levelFilter || null, usernameFilter || null);
                }
            } catch (error) {
                logContent.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 2rem;">
                    <div style="font-size: 2rem;">‚ùå</div>
                    <div>Âä†ËΩΩÊó•ÂøóÂ§±Ë¥•: ${error.message}</div>
                    <button onclick="refreshLogs()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ÈáçËØï</button>
                </div>`;
                return;
            }
            
            if (logs.length === 0) {
                const tabName = currentLogTab === 'cloud' ? '‰∫ëÁ´Ø' : 'Êú¨Âú∞';
                logContent.innerHTML = `<div style="text-align: center; color: #666; padding: 2rem;">ÊöÇÊó†${tabName}Êó•ÂøóËÆ∞ÂΩï</div>`;
                return;
            }
            
            const logHtml = logs.map(log => {
                const levelColor = {
                    'INFO': '#28a745',
                    'WARN': '#ffc107', 
                    'ERROR': '#dc3545'
                }[log.level] || '#6c757d';
                
                const timeStr = new Date(log.timestamp).toLocaleString('zh-CN');
                const dataStr = log.data ? JSON.stringify(log.data, null, 2) : '';
                
                // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Âø´ÁÖßID
                const hasSnapshot = log.data && log.data.snapshotId && log.message.includes('Êï∞ÊçÆÂø´ÁÖßÂ∑≤ÂàõÂª∫');
                const snapshotButton = hasSnapshot ? 
                    `<button onclick="openSnapshotFromLog('${log.data.snapshotId}')" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">üì∏ Êü•ÁúãÂø´ÁÖß</button>` : '';
                
                // ‰∫ëÁ´ØÊó•ÂøóÈ¢ùÂ§ñ‰ø°ÊÅØ
                const isCloudLog = currentLogTab === 'cloud' && log.deviceInfo;
                const cloudBadge = isCloudLog ? '<span style="margin-left: 0.5rem; background: #17a2b8; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">üåê ‰∫ëÁ´Ø</span>' : '';
                const deviceInfo = isCloudLog ? 
                    `<div style="margin-bottom: 0.25rem; font-size: 0.85rem; color: #666;">
                        <strong>ËÆæÂ§á‰ø°ÊÅØ:</strong> ${log.deviceInfo.userAgent.split(' ')[0]}... | 
                        <strong>È°µÈù¢:</strong> ${new URL(log.deviceInfo.url).pathname}
                    </div>` : '';
                
                return `
                    <div style="margin-bottom: 1rem; padding: 0.5rem; border-left: 4px solid ${levelColor}; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                            <div style="display: flex; align-items: center;">
                                <span style="font-weight: bold; color: ${levelColor};">[${log.level}]</span>
                                ${cloudBadge}
                                ${hasSnapshot ? '<span style="margin-left: 0.5rem; background: #17a2b8; color: white; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.7rem;">üì∏ Âø´ÁÖß</span>' : ''}
                            </div>
                            <span style="color: #666; font-size: 0.8rem;">${timeStr}</span>
                        </div>
                        <div style="margin-bottom: 0.25rem;">
                            <strong>Áî®Êà∑:</strong> ${log.user.username} (ID: ${log.user.id})
                        </div>
                        ${deviceInfo}
                        <div style="margin-bottom: 0.25rem; display: flex; align-items: center;">
                            <strong>Ê∂àÊÅØ:</strong> ${log.message}
                            ${snapshotButton}
                        </div>
                        ${dataStr ? `<details style="margin-top: 0.5rem;"><summary style="cursor: pointer; color: #007bff;">Êü•ÁúãËØ¶ÁªÜÊï∞ÊçÆ</summary><pre style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; overflow-x: auto;">${dataStr}</pre></details>` : ''}
                    </div>
                `;
            }).join('');
            
            logContent.innerHTML = logHtml;
        }

        async function clearCurrentLogs() {
            const tabName = currentLogTab === 'cloud' ? '‰∫ëÁ´Ø' : 'Êú¨Âú∞';
            if (confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâ${tabName}Êó•ÂøóÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                try {
                    if (currentLogTab === 'cloud') {
                        await logger.clearCloudLogs();
                    } else {
                        logger.clearLogs();
                    }
                    await refreshLogs();
                    alert(`${tabName}Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫`);
                } catch (error) {
                    alert(`Ê∏ÖÁ©∫${tabName}Êó•ÂøóÂ§±Ë¥•: ` + error.message);
                }
            }
        }

        async function retryFailedLogs() {
            try {
                await logger.retryFailedLogs();
                alert('ÈáçËØïÂÆåÊàêÔºÅËØ∑Âà∑Êñ∞‰∫ëÁ´ØÊó•ÂøóÊü•ÁúãÁªìÊûú„ÄÇ');
                if (currentLogTab === 'cloud') {
                    await refreshLogs();
                }
            } catch (error) {
                alert('ÈáçËØïÂ§±Ë¥•: ' + error.message);
            }
        }

        async function manualCleanup() {
            if (currentLogTab === 'cloud') {
                if (confirm('Á°ÆÂÆöË¶ÅÊâãÂä®Ê∏ÖÁêÜËøáÊúüÁöÑ‰∫ëÁ´ØÊó•ÂøóÂêóÔºüÂ∞ÜÁßªÈô§Ë∂ÖËøá48Â∞èÊó∂ÁöÑÊó•ÂøóËÆ∞ÂΩï„ÄÇ')) {
                    try {
                        await logger.cleanupCloudLogs();
                        alert('Ê∏ÖÁêÜÂÆåÊàêÔºÅËØ∑Âà∑Êñ∞Êü•ÁúãÁªìÊûú„ÄÇ');
                        await refreshLogs();
                    } catch (error) {
                        alert('Ê∏ÖÁêÜÂ§±Ë¥•: ' + error.message);
                    }
                }
            } else {
                alert('Ê∏ÖÁêÜËøáÊúüÊó•ÂøóÂäüËÉΩ‰ªÖÈÄÇÁî®‰∫é‰∫ëÁ´ØÊó•Âøó');
            }
        }

        async function exportLogs() {
            try {
                let logs = [];
                const tabName = currentLogTab === 'cloud' ? '‰∫ëÁ´Ø' : 'Êú¨Âú∞';
                
                if (currentLogTab === 'cloud') {
                    logs = await logger.getCloudLogs(1000);
                } else {
                    logs = logger.getLogs(1000);
                }
                
                const logText = logs.map(log => {
                    const timeStr = new Date(log.timestamp).toISOString();
                    const dataStr = log.data ? JSON.stringify(log.data) : '';
                    const deviceStr = log.deviceInfo ? `[${log.deviceInfo.userAgent}]` : '';
                    return `[${timeStr}] [${log.level}] ${log.user.username}: ${log.message} ${deviceStr} ${dataStr}`;
                }).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bee-store-${currentLogTab}-logs-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                alert('ÂØºÂá∫Êó•ÂøóÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÊòæÁ§∫Êó•ÂøóÊü•ÁúãÊåâÈíÆÔºà‰ªÖadminË¥¶Âè∑Ôºâ
        function updateLogViewerVisibility() {
            const showLogBtn = currentUser && currentUser.username === 'admin';
            const logBtn = document.getElementById('log-viewer-btn');
            const mobileLogBtn = document.getElementById('mobile-log-viewer-btn');
            const snapshotBtn = document.getElementById('snapshot-viewer-btn');
            const mobileSnapshotBtn = document.getElementById('mobile-snapshot-viewer-btn');
            
            if (logBtn) logBtn.style.display = showLogBtn ? 'inline-block' : 'none';
            if (mobileLogBtn) mobileLogBtn.style.display = showLogBtn ? 'block' : 'none';
            if (snapshotBtn) snapshotBtn.style.display = showLogBtn ? 'inline-block' : 'none';
            if (mobileSnapshotBtn) mobileSnapshotBtn.style.display = showLogBtn ? 'block' : 'none';
        }

        // Âø´ÁÖßÊü•ÁúãÂíåÊÅ¢Â§çÂäüËÉΩ
        let currentRestoreSnapshotId = null;

        function showSnapshotViewer() {
            // Âè™ÊúâadminË¥¶Âè∑ÂèØ‰ª•Êü•ÁúãÂø´ÁÖß
            if (!currentUser || currentUser.username !== 'admin') {
                alert('ÊÇ®Ê≤°ÊúâÊùÉÈôêÊü•ÁúãÊï∞ÊçÆÂø´ÁÖßÔºå‰ªÖÈôêadminË¥¶Âè∑ËÆøÈóÆ');
                return;
            }
            
            showModal('snapshot-viewer-modal');
            refreshSnapshots();
        }

        function refreshSnapshots() {
            const typeFilter = document.getElementById('snapshot-type-filter').value;
            const snapshotContent = document.getElementById('snapshot-content');
            
            const snapshots = logger.getSnapshots(100, typeFilter || null);
            
            if (snapshots.length === 0) {
                snapshotContent.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">ÊöÇÊó†Êï∞ÊçÆÂø´ÁÖß</div>';
                return;
            }
            
            const snapshotHtml = snapshots.map(snapshot => {
                const timeStr = new Date(snapshot.timestamp).toLocaleString('zh-CN');
                const typeColor = {
                    'app_edit_before': '#007bff',
                    'app_delete_before': '#dc3545',
                    'apps_before_add': '#28a745',
                    'users_before_add': '#17a2b8',
                    'full_before_sync': '#6f42c1',
                    'local_before_merge': '#fd7e14',
                    'remote_before_merge': '#20c997'
                }[snapshot.metadata.snapshotType] || '#6c757d';
                
                const dataPreview = JSON.stringify(snapshot.data, null, 2).substring(0, 200) + '...';
                
                return `
                    <div style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid ${typeColor}; background: white; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div>
                                <h4 style="margin: 0; color: ${typeColor};">${snapshot.description}</h4>
                                <small style="color: #666;">${timeStr} | Áî®Êà∑: ${snapshot.metadata.user.username}</small>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="viewSnapshotDetails('${snapshot.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">ËØ¶ÊÉÖ</button>
                                <button class="btn btn-primary" onclick="prepareRestore('${snapshot.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #28a745;">ÊÅ¢Â§ç</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <strong>Á±ªÂûã:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            <strong>Â§ßÂ∞è:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB 
                            (ÂéãÁº©Âêé: ${Math.round(snapshot.metadata.compressedSize / 1024)}KB)
                        </div>
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: #007bff;">È¢ÑËßàÊï∞ÊçÆ</summary>
                            <pre style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; overflow-x: auto; font-size: 0.8rem;">${dataPreview}</pre>
                        </details>
                    </div>
                `;
            }).join('');
            
            snapshotContent.innerHTML = snapshotHtml;
        }

        function getSnapshotTypeLabel(type) {
            const labels = {
                'app_edit_before': 'Â∫îÁî®ÁºñËæëÂâç',
                'app_delete_before': 'Â∫îÁî®Âà†Èô§Ââç',
                'apps_before_add': 'Êñ∞Â∫îÁî®ÂèëÂ∏ÉÂâç',
                'users_before_add': 'Áî®Êà∑Ê≥®ÂÜåÂâç',
                'full_before_sync': 'Êï∞ÊçÆÂêåÊ≠•Ââç',
                'local_before_merge': 'Êï∞ÊçÆÂêàÂπ∂Ââç(Êú¨Âú∞)',
                'remote_before_merge': 'Êï∞ÊçÆÂêàÂπ∂Ââç(ËøúÁ®ã)'
            };
            return labels[type] || type;
        }

        function viewSnapshotDetails(snapshotId) {
            const snapshots = logger.getSnapshots(1000);
            const snapshot = snapshots.find(s => s.id === snapshotId);
            
            if (!snapshot) {
                alert('Âø´ÁÖß‰∏çÂ≠òÂú®');
                return;
            }
            
            const detailsWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            detailsWindow.document.write(`
                <html>
                <head>
                    <title>Âø´ÁÖßËØ¶ÊÉÖ - ${snapshot.description}</title>
                    <style>
                        body { font-family: 'Courier New', monospace; margin: 20px; }
                        .header { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${snapshot.description}</h2>
                        <p><strong>Êó∂Èó¥:</strong> ${new Date(snapshot.timestamp).toLocaleString('zh-CN')}</p>
                        <p><strong>Áî®Êà∑:</strong> ${snapshot.metadata.user.username}</p>
                        <p><strong>Á±ªÂûã:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}</p>
                        <p><strong>Êï∞ÊçÆÂ§ßÂ∞è:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB</p>
                    </div>
                    <h3>Êï∞ÊçÆÂÜÖÂÆπ:</h3>
                    <pre>${JSON.stringify(snapshot.data, null, 2)}</pre>
                </body>
                </html>
            `);
        }

        function prepareRestore(snapshotId) {
            const snapshots = logger.getSnapshots(1000);
            const snapshot = snapshots.find(s => s.id === snapshotId);
            
            if (!snapshot) {
                alert('Âø´ÁÖß‰∏çÂ≠òÂú®');
                return;
            }
            
            currentRestoreSnapshotId = snapshotId;
            
            const restoreInfo = document.getElementById('restore-info');
            restoreInfo.innerHTML = `
                <h4>${snapshot.description}</h4>
                <p><strong>ÂàõÂª∫Êó∂Èó¥:</strong> ${new Date(snapshot.timestamp).toLocaleString('zh-CN')}</p>
                <p><strong>ÂàõÂª∫Áî®Êà∑:</strong> ${snapshot.metadata.user.username}</p>
                <p><strong>Âø´ÁÖßÁ±ªÂûã:</strong> ${getSnapshotTypeLabel(snapshot.metadata.snapshotType)}</p>
                <p><strong>Êï∞ÊçÆÂ§ßÂ∞è:</strong> ${Math.round(snapshot.metadata.dataSize / 1024)}KB</p>
            `;
            
            // Ê†πÊçÆÂø´ÁÖßÁ±ªÂûãËÆæÁΩÆÈªòËÆ§ÊÅ¢Â§çÈÄâÈ°π
            const restoreType = document.getElementById('restore-type');
            if (snapshot.metadata.snapshotType?.includes('app')) {
                restoreType.value = 'apps';
            } else if (snapshot.metadata.snapshotType?.includes('user')) {
                restoreType.value = 'users';
            } else {
                restoreType.value = 'full';
            }
            
            showModal('snapshot-restore-modal');
        }

        function confirmRestore() {
            if (!currentRestoreSnapshotId) {
                alert('Êú™ÈÄâÊã©Âø´ÁÖß');
                return;
            }
            
            const restoreType = document.getElementById('restore-type').value;
            
            if (!confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜË¶ÜÁõñÂΩìÂâçÊï∞ÊçÆÔºÅ')) {
                return;
            }
            
            try {
                // Âú®ÊÅ¢Â§çÂâçÂàõÂª∫ÂΩìÂâçÊï∞ÊçÆÁöÑÂ§á‰ªΩÂø´ÁÖß
                logger.snapshot('Êï∞ÊçÆÊÅ¢Â§çÂâçËá™Âä®Â§á‰ªΩ', cloudData, {
                    snapshotType: 'auto_backup_before_restore',
                    operation: 'ÊÅ¢Â§çÂâçËá™Âä®Â§á‰ªΩ',
                    restoreSnapshotId: currentRestoreSnapshotId
                });
                
                // ÊâßË°åÊÅ¢Â§ç
                logger.restoreFromSnapshot(currentRestoreSnapshotId, restoreType);
                
                // Êõ¥Êñ∞UI
                updateStats();
                loadApps();
                
                closeModal('snapshot-restore-modal');
                closeModal('snapshot-viewer-modal');
                
                alert('Êï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜÂà∑Êñ∞‰ª•ÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ');
                
                // Âà∑Êñ∞È°µÈù¢‰ª•Á°Æ‰øùUIÂÆåÂÖ®Êõ¥Êñ∞
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                alert('Êï∞ÊçÆÊÅ¢Â§çÂ§±Ë¥•: ' + error.message);
            } finally {
                currentRestoreSnapshotId = null;
            }
        }

        function clearSnapshots() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂø´ÁÖßÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                logger.clearSnapshots();
                refreshSnapshots();
                alert('Âø´ÁÖßÂ∑≤Ê∏ÖÁ©∫');
            }
        }

        function exportSnapshots() {
            const snapshots = logger.getSnapshots(1000);
            const exportData = {
                exportTime: new Date().toISOString(),
                totalSnapshots: snapshots.length,
                snapshots: snapshots
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bee-store-snapshots-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ‰ªéÊó•ÂøóÂø´ÈÄüËÆøÈóÆÂø´ÁÖß
        function openSnapshotFromLog(snapshotId) {
            closeModal('log-viewer-modal');
            showSnapshotViewer();
            
            // Á≠âÂæÖÂø´ÁÖßÊü•ÁúãÂô®Âä†ËΩΩÂÆåÊàêÂêéÂÆö‰ΩçÂà∞ÁâπÂÆöÂø´ÁÖß
            setTimeout(() => {
                const snapshotContent = document.getElementById('snapshot-content');
                const targetElement = snapshotContent.querySelector(`[onclick*="${snapshotId}"]`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // È´ò‰∫ÆÊòæÁ§∫ÁõÆÊ†áÂø´ÁÖß
                    const snapshotDiv = targetElement.closest('div[style*="border-left"]');
                    if (snapshotDiv) {
                        snapshotDiv.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.6)';
                        snapshotDiv.style.background = '#fff3cd';
                        setTimeout(() => {
                            snapshotDiv.style.boxShadow = '';
                            snapshotDiv.style.background = 'white';
                        }, 3000);
                    }
                }
            }, 500);
        }

        // ‰øÆÊîπshowUserNavÂáΩÊï∞‰ª•ÂåÖÂê´Êó•ÂøóÊåâÈíÆÂèØËßÅÊÄßÊõ¥Êñ∞
        const originalShowUserNav = showUserNav;
        showUserNav = function() {
            originalShowUserNav();
            updateLogViewerVisibility();
        };

        const originalShowGuestNav = showGuestNav;
        showGuestNav = function() {
            originalShowGuestNav();
            updateLogViewerVisibility();
        };

        // ÂàùÂßãÂåñÂ∫îÁî®
        init();

        // ÂêØÂä®ÂÆöÊúüÈáçËØïÊú∫Âà∂ÔºàÊØè5ÂàÜÈíüÈáçËØï‰∏ÄÊ¨°Â§±Ë¥•ÁöÑÊó•ÂøóÔºâ
        setInterval(() => {
            logger.retryFailedLogs().catch(e => console.warn('ÂÆöÊúüÈáçËØïÂ§±Ë¥•:', e));
        }, 5 * 60 * 1000);

        // ÂêØÂä®ÂÆöÊúüÊ∏ÖÁêÜÊú∫Âà∂ÔºàÊØè12Â∞èÊó∂Ê∏ÖÁêÜ‰∏ÄÊ¨°ËøáÊúüÊó•ÂøóÔºâ
        setInterval(() => {
            logger.cleanupCloudLogs().catch(e => console.warn('ÂÆöÊúüÊ∏ÖÁêÜÂ§±Ë¥•:', e));
        }, 12 * 60 * 60 * 1000);

        // ÂêØÂä®ÂÆöÊúüÂêéÂè∞ÂêåÊ≠•Êú∫Âà∂ÔºàÊØè1Â∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°ÂæÖÂêåÊ≠•Êìç‰ΩúÔºâ
        setInterval(() => {
            const pendingOps = localCache.getPendingOperations();
            if (pendingOps.length > 0) {
                logger.info('ÂÆöÊúüÊ£ÄÊü•ÔºöÂèëÁé∞ÂæÖÂêåÊ≠•Êìç‰Ωú', { 
                    operationsCount: pendingOps.length,
                    operation: 'ÂÆöÊúüÂêåÊ≠•Ê£ÄÊü•'
                });
                syncQueue.retryFailedSync().catch(e => console.warn('ÂÆöÊúüÂêåÊ≠•Â§±Ë¥•:', e));
            }
        }, 60 * 60 * 1000); // ÊØè1Â∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°

        // ÂêØÂä®ÂÆöÊúüÊìç‰ΩúÈòüÂàóÊ∏ÖÁêÜÊú∫Âà∂ÔºàÊØèÂ∞èÊó∂Ê∏ÖÁêÜ‰∏ÄÊ¨°ËøáÊúüÊìç‰ΩúÔºâ
        setInterval(() => {
            syncQueue.cleanupExpiredOperations();
        }, 60 * 60 * 1000); // ÊØèÂ∞èÊó∂Ê∏ÖÁêÜ‰∏ÄÊ¨°

        // Â∫îÁî®ÂêØÂä®Êó∂ÊâßË°å‰∏ÄÊ¨°Ê∏ÖÁêÜ
        setTimeout(() => {
            logger.cleanupCloudLogs().catch(e => console.warn('ÂêØÂä®Ê∏ÖÁêÜÂ§±Ë¥•:', e));
        }, 10000); // 10ÁßíÂêéÊâßË°åÔºåÁ°Æ‰øùÂ∫îÁî®ÂàùÂßãÂåñÂÆåÊàê
    </script>
</body>
</html>

