<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ é™¤æŒ‡å®šä½œå“å·¥å…·</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            padding: 2rem; 
            max-width: 1000px; 
            margin: 0 auto; 
            background: #f5f5f7;
        }
        .container { 
            background: white; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .button { 
            background: #007AFF; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px; 
            font-size: 16px;
            transition: all 0.2s;
        }
        .button:hover { background: #0056CC; }
        .button.danger { background: #FF3B30; }
        .button.danger:hover { background: #CC0000; }
        .button.success { background: #34C759; }
        .button.success:hover { background: #28A745; }
        .output { 
            background: #f8f9fa; 
            padding: 16px; 
            border-radius: 8px; 
            margin: 16px 0; 
            font-family: monospace; 
            border-left: 4px solid #007AFF;
        }
        .item { 
            background: #fff; 
            border: 1px solid #e1e5e9; 
            border-radius: 8px; 
            padding: 16px; 
            margin: 12px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .item.deleted { 
            background: #f8f9fa; 
            opacity: 0.6; 
            border-color: #28a745;
        }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 18px; color: #1d1d1f; }
        .item-author { color: #6c757d; margin-top: 4px; }
        .item-id { color: #8e8e93; font-size: 14px; }
        .progress { 
            background: #e9ecef; 
            border-radius: 4px; 
            height: 8px; 
            overflow: hidden; 
            margin: 16px 0;
        }
        .progress-bar { 
            background: #007AFF; 
            height: 100%; 
            transition: width 0.3s;
        }
        .status { 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-weight: 500; 
            display: inline-block;
        }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.deleting { background: #cce5ff; color: #004085; }
        .status.deleted { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—‘ï¸ åˆ é™¤æŒ‡å®šä½œå“å·¥å…·</h1>
        
        <div class="output">
            <strong>ç›®æ ‡ä½œå“ï¼š</strong><br>
            â€¢ 2Brain (ä½œè€…: Beebee AI)<br>
            â€¢ Beebee Trademate (ä½œè€…: Beebee AI)
        </div>

        <div style="margin: 24px 0;">
            <button class="button" onclick="loadData()">1. åŠ è½½å½“å‰æ•°æ®</button>
            <button class="button" onclick="findTargetApps()">2. æŸ¥æ‰¾ç›®æ ‡ä½œå“</button>
            <button class="button danger" onclick="deleteTargetApps()" id="deleteBtn" disabled>3. åˆ é™¤ä½œå“</button>
            <button class="button success" onclick="saveData()" id="saveBtn" disabled>4. ä¿å­˜æ›´æ”¹</button>
        </div>

        <div class="progress" style="display: none;" id="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>

        <div id="targetApps" style="display: none;">
            <h3>ğŸ¯ æ‰¾åˆ°çš„ç›®æ ‡ä½œå“ï¼š</h3>
            <div id="appsList"></div>
        </div>

        <div class="output" id="output">
            <strong>æ“ä½œæ—¥å¿—ï¼š</strong><br>
            ç­‰å¾…å¼€å§‹æ“ä½œ...
        </div>
    </div>

    <script>
        let currentData = null;
        let targetApps = [];
        let deletedIds = [];

        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<br>[${timestamp}] ${message}`;
            console.log(message);
        }

        function updateProgress(percent) {
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            progress.style.display = 'block';
            progressBar.style.width = percent + '%';
        }

        async function loadData() {
            try {
                log('æ­£åœ¨åŠ è½½æ•°æ®...');
                const response = await fetch('/.netlify/functions/jsonbin-proxy');
                const data = await response.json();
                
                if (data.record) {
                    currentData = data.record;
                    log(`âœ… æ•°æ®åŠ è½½æˆåŠŸï¼å…± ${currentData.apps.length} ä¸ªä½œå“`);
                    updateProgress(25);
                } else {
                    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                log(`âŒ åŠ è½½æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }

        function findTargetApps() {
            if (!currentData) {
                log('âŒ è¯·å…ˆåŠ è½½æ•°æ®');
                return;
            }

            const targetNames = ['2Brain', 'Beebee Trademate'];
            const targetAuthor = 'Beebee AI';
            
            targetApps = currentData.apps.filter(app => 
                targetNames.includes(app.name) && app.author === targetAuthor
            );

            log(`ğŸ” æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${targetApps.length} ä¸ªç›®æ ‡ä½œå“`);
            
            if (targetApps.length > 0) {
                displayTargetApps();
                document.getElementById('deleteBtn').disabled = false;
                updateProgress(50);
            } else {
                log('â„¹ï¸ æœªæ‰¾åˆ°éœ€è¦åˆ é™¤çš„ä½œå“');
            }
        }

        function displayTargetApps() {
            const container = document.getElementById('targetApps');
            const appsList = document.getElementById('appsList');
            
            appsList.innerHTML = '';
            
            targetApps.forEach(app => {
                const item = document.createElement('div');
                item.className = 'item';
                item.id = `app-${app.id}`;
                
                item.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${app.name}</div>
                        <div class="item-author">ä½œè€…: ${app.author}</div>
                        <div class="item-id">ID: ${app.id}</div>
                    </div>
                    <div class="status pending" id="status-${app.id}">å¾…åˆ é™¤</div>
                `;
                
                appsList.appendChild(item);
            });
            
            container.style.display = 'block';
        }

        function updateAppStatus(appId, status, statusText) {
            const item = document.getElementById(`app-${appId}`);
            const statusEl = document.getElementById(`status-${appId}`);
            
            if (item && statusEl) {
                statusEl.className = `status ${status}`;
                statusEl.textContent = statusText;
                
                if (status === 'deleted') {
                    item.className = 'item deleted';
                }
            }
        }

        async function deleteTargetApps() {
            if (targetApps.length === 0) {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°è¦åˆ é™¤çš„ä½œå“');
                return;
            }

            log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ä½œå“...');
            
            for (let i = 0; i < targetApps.length; i++) {
                const app = targetApps[i];
                updateAppStatus(app.id, 'deleting', 'åˆ é™¤ä¸­...');
                
                // ä»æ•°ç»„ä¸­åˆ é™¤
                currentData.apps = currentData.apps.filter(a => a.id !== app.id);
                deletedIds.push(app.id);
                
                updateAppStatus(app.id, 'deleted', 'å·²åˆ é™¤');
                log(`âœ… å·²åˆ é™¤: ${app.name} (ID: ${app.id})`);
                
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            log(`ğŸ‰ åˆ é™¤å®Œæˆï¼å…±åˆ é™¤ ${deletedIds.length} ä¸ªä½œå“`);
            document.getElementById('saveBtn').disabled = false;
            updateProgress(75);
        }

        async function saveData() {
            if (!currentData) {
                log('âŒ æ²¡æœ‰æ•°æ®å¯ä¿å­˜');
                return;
            }

            try {
                log('ğŸ’¾ æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...');
                
                // æ·»åŠ åˆ é™¤è®°å½•åˆ°æ•°æ®ä¸­
                currentData.lastModified = new Date().toISOString();
                currentData.deleteInfo = {
                    deletedAt: new Date().toISOString(),
                    deletedApps: deletedIds.length,
                    deletedBy: 'Admin',
                    reason: 'åˆ é™¤æŒ‡å®šä½œå“: 2Brain, Beebee Trademate'
                };

                const response = await fetch('/.netlify/functions/jsonbin-proxy', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentData)
                });

                if (response.ok) {
                    log('âœ… æ•°æ®ä¿å­˜æˆåŠŸï¼');
                    log(`ğŸ“Š å½“å‰ä½œå“æ€»æ•°: ${currentData.apps.length}`);
                    updateProgress(100);
                } else {
                    throw new Error(`ä¿å­˜å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹
        window.onload = function() {
            log('ğŸš€ åˆ é™¤å·¥å…·å·²å°±ç»ª');
            log('âš ï¸ è¯·æŒ‰é¡ºåºç‚¹å‡»æŒ‰é’®æ‰§è¡Œæ“ä½œ');
        };
    </script>
</body>
</html> 