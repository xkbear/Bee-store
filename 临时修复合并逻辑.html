<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤ Bee Store æ•°æ®åˆå¹¶é—®é¢˜</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            padding: 2rem; 
            max-width: 800px; 
            margin: 0 auto; 
            background: #f5f5f7;
        }
        .container { 
            background: white; 
            padding: 2rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .button { 
            background: #007AFF; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px; 
            font-size: 16px;
            transition: all 0.2s;
        }
        .button:hover { background: #0056CC; }
        .button.danger { background: #FF3B30; }
        .button.danger:hover { background: #CC0000; }
        .output { 
            background: #f8f9fa; 
            padding: 1rem; 
            border-radius: 8px; 
            margin-top: 1rem; 
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ä¿®å¤ Bee Store æ•°æ®åˆå¹¶é—®é¢˜</h1>
        
        <div class="warning">
            <strong>âš ï¸ é—®é¢˜è¯´æ˜ï¼š</strong><br>
            Bee Storeçš„æ•°æ®åˆå¹¶é€»è¾‘ä¼šä¿ç•™æœ¬åœ°çš„æ—§æ•°æ®ï¼Œå¯¼è‡´å·²åˆ é™¤çš„ä½œå“é‡æ–°å‡ºç°ã€‚
            æ­¤å·¥å…·å°†å¼ºåˆ¶ä½¿ç”¨äº‘ç«¯çš„æœ€æ–°æ•°æ®ã€‚
        </div>
        
        <div>
            <button class="button" onclick="checkStatus()">ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€</button>
            <button class="button danger" onclick="forceCloudSync()">ğŸš€ å¼ºåˆ¶åŒæ­¥äº‘ç«¯æ•°æ®</button>
            <button class="button" onclick="clearAndReload()">ğŸ§¹ æ¸…é™¤ç¼“å­˜å¹¶é‡è½½</button>
        </div>
        
        <div id="output" class="output"></div>
    </div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `[${time}] ${message}<br>`;
            output.scrollTop = output.scrollHeight;
        }

        async function checkStatus() {
            log('=== æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€ ===');
            
            try {
                // æ£€æŸ¥æœ¬åœ°ç¼“å­˜
                const localData = localStorage.getItem('beestoreCloudData');
                if (localData) {
                    const data = JSON.parse(localData);
                    log(`ğŸ“± æœ¬åœ°ç¼“å­˜: ${data.users?.length || 0} ç”¨æˆ·, ${data.apps?.length || 0} ä½œå“`);
                    
                    const problematicApps = data.apps?.filter(app => 
                        app.name === '2Brain' || app.name === 'Beebee Trademate'
                    ) || [];
                    
                    if (problematicApps.length > 0) {
                        log(`ğŸš¨ æœ¬åœ°ç¼“å­˜é—®é¢˜: å‘ç° ${problematicApps.length} ä¸ªåº”è¯¥åˆ é™¤çš„ä½œå“`);
                        problematicApps.forEach(app => {
                            log(`   - ${app.name} (ID: ${app.id})`);
                        });
                    } else {
                        log(`âœ… æœ¬åœ°ç¼“å­˜æ­£å¸¸: æœªå‘ç°é—®é¢˜ä½œå“`);
                    }
                } else {
                    log(`ğŸ“± æœ¬åœ°ç¼“å­˜: æœªæ‰¾åˆ°æ•°æ®`);
                }
                
                // æ£€æŸ¥äº‘ç«¯æ•°æ®
                const response = await fetch('/.netlify/functions/jsonbin-proxy');
                const cloudData = await response.json();
                
                if (cloudData.record) {
                    const data = cloudData.record;
                    log(`â˜ï¸ äº‘ç«¯æ•°æ®: ${data.users?.length || 0} ç”¨æˆ·, ${data.apps?.length || 0} ä½œå“`);
                    
                    const problematicApps = data.apps?.filter(app => 
                        app.name === '2Brain' || app.name === 'Beebee Trademate'
                    ) || [];
                    
                    if (problematicApps.length > 0) {
                        log(`ğŸš¨ äº‘ç«¯æ•°æ®é—®é¢˜: å‘ç° ${problematicApps.length} ä¸ªæœªåˆ é™¤çš„ä½œå“`);
                    } else {
                        log(`âœ… äº‘ç«¯æ•°æ®æ­£å¸¸: å·²åˆ é™¤é—®é¢˜ä½œå“`);
                    }
                }
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        async function forceCloudSync() {
            log('=== å¼€å§‹å¼ºåˆ¶åŒæ­¥äº‘ç«¯æ•°æ® ===');
            
            try {
                // 1. è·å–äº‘ç«¯æ•°æ®
                log('ğŸ“¡ æ­£åœ¨è·å–äº‘ç«¯æ•°æ®...');
                const response = await fetch('/.netlify/functions/jsonbin-proxy');
                const cloudData = await response.json();
                
                if (!cloudData.record) {
                    throw new Error('äº‘ç«¯æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                const remoteData = cloudData.record;
                log(`â˜ï¸ äº‘ç«¯æ•°æ®: ${remoteData.users?.length || 0} ç”¨æˆ·, ${remoteData.apps?.length || 0} ä½œå“`);
                
                // 2. ç›´æ¥ä½¿ç”¨äº‘ç«¯æ•°æ®æ›¿æ¢æœ¬åœ°æ•°æ®
                log('ğŸ’¾ æ­£åœ¨æ›´æ–°æœ¬åœ°ç¼“å­˜...');
                
                // æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜
                const cacheKeys = [
                    'beestoreLocalBackup',
                    'beestoreCloudData', 
                    'beestoreCloudMeta'
                ];
                
                cacheKeys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`ğŸ—‘ï¸ å·²æ¸…é™¤: ${key}`);
                });
                
                // ç›´æ¥ä¿å­˜äº‘ç«¯æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜
                localStorage.setItem('beestoreCloudData', JSON.stringify(remoteData));
                localStorage.setItem('beestoreCloudMeta', JSON.stringify({
                    lastSync: remoteData.lastSync || new Date().toISOString(),
                    syncMethod: 'force_cloud_sync',
                    timestamp: new Date().toISOString()
                }));
                
                log(`âœ… å¼ºåˆ¶åŒæ­¥å®Œæˆ: ${remoteData.users?.length || 0} ç”¨æˆ·, ${remoteData.apps?.length || 0} ä½œå“`);
                log('ğŸ”„ è¯·è¿”å› Bee Store é¡µé¢å¹¶åˆ·æ–°æŸ¥çœ‹ç»“æœ');
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const container = document.querySelector('.container');
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `
                    <strong>âœ… å¼ºåˆ¶åŒæ­¥æˆåŠŸï¼</strong><br>
                    ç°åœ¨è¿”å› Bee Store é¡µé¢å¹¶åˆ·æ–°ï¼ˆCmd+Rï¼‰ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ­£ç¡®çš„æ•°æ®äº†ã€‚<br>
                    <small>äº‘ç«¯æ•°æ®ï¼š${remoteData.users?.length || 0} ç”¨æˆ·ï¼Œ${remoteData.apps?.length || 0} ä½œå“</small>
                `;
                container.appendChild(successDiv);
                
            } catch (error) {
                log(`âŒ å¼ºåˆ¶åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }

        function clearAndReload() {
            log('=== æ¸…é™¤æ‰€æœ‰ç¼“å­˜å¹¶é‡è½½ ===');
            
            // æ¸…é™¤æ‰€æœ‰Bee Storeç›¸å…³çš„localStorage
            const allKeys = Object.keys(localStorage);
            const beeStoreKeys = allKeys.filter(key => key.startsWith('beestore') || key === 'currentUser');
            
            beeStoreKeys.forEach(key => {
                localStorage.removeItem(key);
                log(`ğŸ—‘ï¸ å·²æ¸…é™¤: ${key}`);
            });
            
            log(`âœ… å·²æ¸…é™¤ ${beeStoreKeys.length} ä¸ªç¼“å­˜é¡¹ç›®`);
            log('ğŸ”„ æ­£åœ¨é‡æ–°æ‰“å¼€ Bee Store...');
            
            // å»¶è¿Ÿåé‡æ–°æ‰“å¼€Bee Store
            setTimeout(() => {
                window.open('/', '_blank');
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            log('ğŸš€ æ•°æ®ä¿®å¤å·¥å…·å·²å°±ç»ª');
            checkStatus();
        };
    </script>
</body>
</html> 